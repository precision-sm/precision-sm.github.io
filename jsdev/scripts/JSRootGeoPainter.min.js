(function(a){if(typeof define==="function"&&define.amd){define(["JSRootPainter","d3","threejs","dat.gui","JSRoot3DPainter","JSRootGeoBase"],a)}else{if(typeof exports==="object"&&typeof module!=="undefined"){var b=require("./JSRootCore.js");if(!b.nodejs&&(typeof window!="undefined")){require("./dat.gui.min.js")}a(b,require("./d3.min.js"),require("./three.min.js"),require("./JSRoot3DPainter.js"),require("./JSRootGeoBase.js"),b.nodejs||(typeof document=="undefined")?b.nodejs_document:document)}else{if(typeof JSROOT=="undefined"){throw new Error("JSROOT is not defined","JSRootGeoPainter.js")}if(typeof JSROOT.Painter!="object"){throw new Error("JSROOT.Painter is not defined","JSRootGeoPainter.js")}if(typeof d3=="undefined"){throw new Error("d3 is not defined","JSRootGeoPainter.js")}if(typeof THREE=="undefined"){throw new Error("THREE is not defined","JSRootGeoPainter.js")}if(typeof dat=="undefined"){throw new Error("dat.gui is not defined","JSRootGeoPainter.js")}a(JSROOT,d3,THREE)}}}(function(b,e,g,f,h,a){b.sources.push("geom");if((typeof a=="undefined")&&(typeof window=="object")){a=window.document}if(typeof define==="function"&&define.amd){b.loadScript("$$$style/JSRootGeoPainter.css")}if(typeof b.GEO!=="object"){console.error("JSROOT.GEO namespace is not defined")}function c(i,j,k){this.bright=k;if((i!==undefined)&&(typeof i.append=="function")){this.element=i.append("div").attr("class","jsroot");this.addButtons(j)}}c.prototype.addButtons=function(j){var i=this;this.buttonsNames=[];j.forEach(function(k){var l=i.element.append("div").attr("class","toolbar-group");k.forEach(function(n){var m=n.name;if(!m){throw new Error("must provide button 'name' in button config")}if(i.buttonsNames.indexOf(m)!==-1){throw new Error("button name '"+m+"' is taken")}i.buttonsNames.push(m);i.createButton(l,n)})})};c.prototype.createButton=function(k,i){var l=i.title;if(l===undefined){l=i.name}if(typeof i.click!=="function"){throw new Error("must provide button 'click' function in button config")}var j=k.append("a").attr("class",this.bright?"toolbar-btn-bright":"toolbar-btn").attr("rel","tooltip").attr("data-title",l).on("click",i.click);this.createIcon(j,i.icon||b.ToolbarIcons.question)};c.prototype.changeBrightness=function(i){this.bright=i;if(!this.element){return}this.element.selectAll(i?".toolbar-btn":".toolbar-btn-bright").attr("class",!i?"toolbar-btn":"toolbar-btn-bright")};c.prototype.createIcon=function(l,j){var k=j.size||512,p=j.scale||1,i=l.append("svg:svg").attr("height","1em").attr("width","1em").attr("viewBox",[0,0,k,k].join(" "));if("recs" in j){var o={};for(var q=0;q<j.recs.length;++q){b.extend(o,j.recs[q]);i.append("rect").attr("x",o.x).attr("y",o.y).attr("width",o.w).attr("height",o.h).attr("fill",o.f)}}else{var m=i.append("svg:path").attr("d",j.path);if(p!==1){m.attr("transform","scale("+p+" "+p+")")}}};c.prototype.removeAllButtons=function(){this.element.remove()};function d(i){if(i&&(i._typename==="TGeoManager")){this.geo_manager=i;i=i.fMasterVolume}if(i&&(i._typename.indexOf("TGeoVolume")===0)){i={_typename:"TGeoNode",fVolume:i,fName:i.fName,$geoh:i.$geoh,_proxy:true}}b.TObjectPainter.call(this,i);this.no_default_title=true;this.mode3d=true;this.Cleanup(true)}d.prototype=Object.create(b.TObjectPainter.prototype);d.prototype.CreateToolbar=function(j){if(this._toolbar||this._usesvg||this._usesvgimg){return}var i=this;var k=[{name:"toImage",title:"Save as PNG",icon:b.ToolbarIcons.camera,click:function(){i.Render3D(0);var n=i._renderer.domElement.toDataURL("image/png");n.replace("image/png","image/octet-stream");var m=a.createElement("a");if(typeof m.download==="string"){a.body.appendChild(m);m.download="geometry.png";m.href=n;m.click();a.body.removeChild(m)}}}];k.push({name:"control",title:"Toggle control UI",icon:b.ToolbarIcons.rect,click:function(){i.showControlOptions("toggle")}});k.push({name:"enlarge",title:"Enlarge geometry drawing",icon:b.ToolbarIcons.circle,click:function(){i.ToggleEnlarge()}});if(b.gStyle.ContextMenu){k.push({name:"menu",title:"Show context menu",icon:b.ToolbarIcons.question,click:function(){e.event.preventDefault();e.event.stopPropagation();var m=e.event;if(!b.Painter.closeMenu()){b.Painter.createMenu(i,function(n){n.painter.FillContextMenu(n);n.show(m)})}}})}var l=new g.Color(this.options.background);this._toolbar=new c(this.select_main(),[k],(l.r+l.g+l.b)<1)};d.prototype.GetGeometry=function(){return this.GetObject()};d.prototype.ModifyVisisbility=function(j,i){if(b.GEO.NodeKind(this.GetGeometry())!==0){return}if(j==""){return b.GEO.SetBit(this.GetGeometry().fVolume,b.GEO.BITS.kVisThis,(i==="+"))}var l,k=false;if(j.indexOf("*")<0){l=new RegExp("^"+j+"$");k=true}else{l=new RegExp("^"+j.split("*").join(".*")+"$");k=false}this.FindNodeWithVolume(l,function(m){b.GEO.InvisibleAll.call(m.node.fVolume,(i!=="+"));return k?m:null})};d.prototype.decodeOptions=function(k){var u={_grid:false,_bound:false,_debug:false,_full:false,_axis:false,_axis_center:false,_count:false,wireframe:false,scale:new g.Vector3(1,1,1),zoom:1,more:1,maxlimit:100000,maxnodeslimit:3000,use_worker:false,update_browser:true,show_controls:false,highlight:false,highlight_scene:false,select_in_view:false,project:"",is_main:false,tracks:false,ortho_camera:false,clipx:false,clipy:false,clipz:false,ssao:false,script_name:"",transparency:0,autoRotate:false,background:"#FFFFFF",depthMethod:"box"};var r=b.GetUrlOption("_grid");if(r!==null&&r=="true"){u._grid=true}var r=b.GetUrlOption("_debug");if(r!==null&&r=="true"){u._debug=true;u._grid=true}if(r!==null&&r=="bound"){u._debug=true;u._grid=true;u._bound=true}if(r!==null&&r=="full"){u._debug=true;u._grid=true;u._full=true;u._bound=true}var o=k.indexOf("macro:");if(o>=0){var p=k.indexOf(";",o+6);if(p<0){p=k.length}u.script_name=k.substr(o+6,p-o-6);k=k.substr(0,o)+k.substr(p+1);console.log("script",u.script_name,"rest",k)}while(true){var l=k.indexOf("+"),q=k.indexOf("-");if((l<0)&&(q<0)){break}var w=l,n="+";if((w<0)||((q>=0)&&(q<l))){w=q;n="-"}var v=w+1,t=new RegExp("[,; .]");while((v<k.length)&&!t.test(k[v])&&(k[v]!="+")&&(k[v]!="-")){v++}var i=k.substring(w+1,v);k=k.substr(0,w)+k.substr(v);this.ModifyVisisbility(i,n)}var s=new b.DrawOptions(k);if(s.check("MAIN")){u.is_main=true}if(s.check("TRACKS")){u.tracks=true}if(s.check("ORTHO_CAMERA")){u.ortho_camera=true}if(s.check("DEPTHRAY")||s.check("DRAY")){u.depthMethod="ray"}if(s.check("DEPTHBOX")||s.check("DBOX")){u.depthMethod="box"}if(s.check("DEPTHPNT")||s.check("DPNT")){u.depthMethod="pnt"}if(s.check("DEPTHSIZE")||s.check("DSIZE")){u.depthMethod="size"}if(s.check("DEPTHDFLT")||s.check("DDFLT")){u.depthMethod="dflt"}if(s.check("ZOOM",true)){u.zoom=s.partAsInt(0,100)/100}if(s.check("BLACK")){u.background="#000000"}if(s.check("WHITE")){u.background="#FFFFFF"}if(s.check("BKGR_",true)){var j=null;if(s.partAsInt(1)>0){j=b.Painter.root_colors[s.partAsInt()]}else{for(var m=0;m<8;++m){if(b.Painter.root_colors[m].toUpperCase()===s.part){j=b.Painter.root_colors[m]}}}if(j){u.background="#"+new g.Color(j).getHexString()}}if(s.check("MORE3")){u.more=3}if(s.check("MORE")){u.more=2}if(s.check("ALL")){u.more=100}if(s.check("CONTROLS")||s.check("CTRL")){u.show_controls=true}if(s.check("CLIPXYZ")){u.clipx=u.clipy=u.clipz=true}if(s.check("CLIPX")){u.clipx=true}if(s.check("CLIPY")){u.clipy=true}if(s.check("CLIPZ")){u.clipz=true}if(s.check("CLIP")){u.clipx=u.clipy=u.clipz=true}if(s.check("PROJX",true)){u.project="x";if(s.partAsInt(1)>0){u.projectPos=s.partAsInt()}}if(s.check("PROJY",true)){u.project="y";if(s.partAsInt(1)>0){u.projectPos=s.partAsInt()}}if(s.check("PROJZ",true)){u.project="z";if(s.partAsInt(1)>0){u.projectPos=s.partAsInt()}}if(s.check("DFLT_COLORS")||s.check("DFLT")){this.SetRootDefaultColors()}if(s.check("SSAO")){u.ssao=true}if(s.check("NOWORKER")){u.use_worker=-1}if(s.check("WORKER")){u.use_worker=1}if(s.check("NOHIGHLIGHT")||s.check("NOHIGH")){u.highlight=u.highlight_scene=0}if(s.check("HIGHLIGHT")){u.highlight_scene=u.highlight=true}if(s.check("HSCENEONLY")){u.highlight_scene=true;u.highlight=0}if(s.check("NOHSCENE")){u.highlight_scene=0}if(s.check("HSCENE")){u.highlight_scene=true}if(s.check("WIRE")){u.wireframe=true}if(s.check("ROTATE")){u.autoRotate=true}if(s.check("INVX")||s.check("INVERTX")){u.scale.x=-1}if(s.check("INVY")||s.check("INVERTY")){u.scale.y=-1}if(s.check("INVZ")||s.check("INVERTZ")){u.scale.z=-1}if(s.check("COUNT")){u._count=true}if(s.check("TRANSP",true)){u.transparency=s.partAsInt(0,100)/100}if(s.check("OPACITY",true)){u.transparency=1-s.partAsInt(0,100)/100}if(s.check("AXISCENTER")||s.check("AC")){u._axis=true;u._axis_center=true}if(s.check("AXIS")||s.check("A")){u._axis=true}if(s.check("D")){u._debug=true}if(s.check("G")){u._grid=true}if(s.check("B")){u._bound=true}if(s.check("W")){u.wireframe=true}if(s.check("F")){u._full=true}if(s.check("Y")){u._yup=true}if(s.check("Z")){u._yup=false}return u};d.prototype.ActiavteInBrowser=function(j,i){if(typeof j=="string"){j=[j]}if(this._hpainter){this._hpainter.actiavte(j,i);if(!this.options.update_browser){setTimeout(this._hpainter.activate.bind(this._hpainter,[]),2000)}}};d.prototype.TestMatrixes=function(){var k=this,m=0,j=0,n=0;var i={domatrix:true,func:function(p){var u=this.getmatrix();var t=this.CopyStack();var w=k._clones.CreateObject3D(t.stack,k._toplevel,"mesh");if(!w){return true}j++;var v=w.matrixWorld,r,o;if(v.equals(u)){return true}if((v.determinant()>0)&&(u.determinant()<-0.9)){r=g.Vector3(1,1,-1);o=u;u=u.clone().scale(r);if(v.equals(u)){return true}}var s=0;for(var q=0;q<16;++q){s=Math.max(s,Math.abs(v.elements[q]-u.elements[q]))}n=Math.max(s,n);if(s<0.0001){return true}console.log(k._clones.ResolveStack(t.stack).name,"maxdiff",s,"determ",v.determinant(),u.determinant());m++;return false}};tm1=new Date().getTime();var l=this._clones.ScanVisible(i);tm2=new Date().getTime();console.log("Compare matrixes total",j,"errors",m,"takes",tm2-tm1,"maxdiff",n)};d.prototype.FillContextMenu=function(i){i.add("header: Draw options");i.addchk(this.options.update_browser,"Browser update",function(){this.options.update_browser=!this.options.update_browser;if(!this.options.update_browser){this.ActiavteInBrowser([])}});i.addchk(this.options.show_controls,"Show Controls",function(){this.showControlOptions("toggle")});i.addchk(this.TestAxisVisibility,"Show axes",function(){this.toggleAxisDraw()});i.addchk(this.options.wireframe,"Wire frame",function(){this.options.wireframe=!this.options.wireframe;this.changeWireFrame(this._scene,this.options.wireframe)});i.addchk(this.options.highlight,"Highlight volumes",function(){this.options.highlight=!this.options.highlight});i.addchk(this.options.highlight_scene,"Highlight scene",function(){this.options.highlight_scene=!this.options.highlight_scene});i.add("Reset camera position",function(){this.focusCamera();this.Render3D()});if(!this.options.project){i.addchk(this.options.autoRotate,"Autorotate",function(){this.options.autoRotate=!this.options.autoRotate;this.autorotate(2.5)})}i.addchk(this.options.select_in_view,"Select in view",function(){this.options.select_in_view=!this.options.select_in_view;if(this.options.select_in_view){this.startDrawGeometry()}})};d.prototype.changeGlobalTransparency=function(i,j){var k=1-i;this._toplevel.traverse(function(l){if(l instanceof g.Mesh){if(l.material.alwaysTransparent!==undefined){if(!l.material.alwaysTransparent){l.material.transparent=k!==1}l.material.opacity=Math.min(k,l.material.inherentOpacity)}}});if(!j){this.Render3D(0)}};d.prototype.showControlOptions=function(p){if(p==="toggle"){p=!this._datgui}this.options.show_controls=p;if(this._datgui){if(p){return}e.select(this._datgui.domElement).remove();this._datgui.destroy();delete this._datgui;return}if(!p){return}var r=this;this._datgui=new dat.GUI({autoPlace:false,width:Math.min(650,r._renderer.domElement.width/2)});var m=this.select_main();if(m.style("position")=="static"){m.style("position","relative")}e.select(this._datgui.domElement).style("position","absolute").style("top",0).style("right",0);m.node().appendChild(this._datgui.domElement);if(this.options.project){var l=this.getGeomBoundingBox(this.getProjectionSource(),0.01);var k=this.options.project;if(this.options.projectPos===undefined){this.options.projectPos=(l.min[k]+l.max[k])/2}this._datgui.add(this.options,"projectPos",l.min[k],l.max[k]).name(k.toUpperCase()+" projection").onChange(function(u){r.startDrawGeometry()})}else{var l=this.getGeomBoundingBox(this._toplevel,0.01);var o=this._datgui.addFolder("Clipping");for(var q=0;q<3;++q){var k=!q?"x":((q===1)?"y":"z"),i=k.toUpperCase();o.add(this,"enable"+i).name("Enable "+i).listen().onChange(function(u){r._enableSSAO=u?false:r._enableSSAO;r.updateClipping()});var j="clip"+i;if(this[j]===0){this[j]=(l.min[k]+l.max[k])/2}var t=o.add(this,j,l.min[k],l.max[k]).name(i+" Position").onChange(function(u){if(r[this.enbale_flag]){r.updateClipping()}});t.enbale_flag="enable"+i}}var n=this._datgui.addFolder("Appearance");if(this._webgl){n.add(this,"_enableSSAO").name("Smooth Lighting (SSAO)").onChange(function(u){r._renderer.antialias=!r._renderer.antialias;r.enableX=u?false:r.enableX;r.enableY=u?false:r.enableY;r.enableZ=u?false:r.enableZ;r.updateClipping()}).listen()}n.add(this.options,"highlight").name("Highlight Selection").listen().onChange(function(u){if(!u){r.HighlightMesh(null)}});n.add(this.options,"transparency",0,1).listen().onChange(this.changeGlobalTransparency.bind(this));n.add(this.options,"wireframe").name("Wireframe").listen().onChange(function(u){r.changeWireFrame(r._scene,r.options.wireframe)});n.addColor(this.options,"background").name("Background").onChange(function(){r._renderer.setClearColor(r.options.background,1);r.Render3D(0);var u=new g.Color(r.options.background);r._toolbar.changeBrightness((u.r+u.g+u.b)<1)});n.add(this,"focusCamera").name("Reset camera position");if(this._webgl){var s=this._datgui.addFolder("Advanced");s.add(this._advceOptions,"aoClamp",0,1).listen().onChange(function(u){r._ssaoPass.uniforms.aoClamp.value=u;r._enableSSAO=true;r.Render3D(0)});s.add(this._advceOptions,"lumInfluence",0,1).listen().onChange(function(u){r._ssaoPass.uniforms.lumInfluence.value=u;r._enableSSAO=true;r.Render3D(0)});s.add(this._advceOptions,"clipIntersection").listen().onChange(function(u){r.clipIntersection=u;r.updateClipping()});s.add(this._advceOptions,"depthTest").onChange(function(u){r._toplevel.traverse(function(v){if(v instanceof g.Mesh){v.material.depthTest=u}});r.Render3D(0)}).listen();s.add(this,"resetAdvanced").name("Reset")}};d.prototype.OrbitContext=function(j,i){b.Painter.createMenu(this,function(m){var v=0,q=0,p=0;if(i){for(var o=0;o<i.length;++o){if(i[o].object.stack){q++}if(i[o].object.geo_name){v++}}}if(q+v===0){m.painter.FillContextMenu(m)}else{var l=(q+v)>1;if(l){m.add("header:"+((v>0)?"Items":"Nodes"))}for(var o=0;o<i.length;++o){var r=i[o].object,k,t,u;if(r.geo_name){t=r.geo_name;k=t.substr(t.lastIndexOf("/")+1);if(!k){k=t}u=k}else{if(r.stack){k=m.painter._clones.ResolveStack(r.stack).name;t=m.painter.GetStackFullName(r.stack);u=m.painter.GetItemName();if(k.indexOf("Nodes/")===0){u=k.substr(6)}else{if(k.length>0){u=k}else{if(!u){u="header"}}}}else{continue}}m.add((l?"sub:":"header:")+u,t,function(n){this.ActiavteInBrowser([n],true)});m.add("Browse",t,function(n){this.ActiavteInBrowser([n],true)});if(m.painter._hpainter){m.add("Inspect",t,function(n){this._hpainter.display(t,"inspect")})}if(r.geo_name){m.add("Hide",o,function(n){var w=i[n].object;w.visible=false;if(w.geo_object){w.geo_object.$hidden_via_menu=true}m.painter.Render3D()});if(l){m.add("endsub:")}continue}var s=m.painter.accessObjectWireFrame(r);if(s!==undefined){m.addchk(s,"Wireframe",o,function(w){var n=i[w].object.material;n.wireframe=!n.wireframe;this.Render3D()})}if(++p>1){m.add("Manifest",o,function(w){if(this._last_manifest){this._last_manifest.wireframe=!this._last_manifest.wireframe}if(this._last_hidden){this._last_hidden.forEach(function(x){x.visible=true})}this._last_hidden=[];for(var n=0;n<w;++n){this._last_hidden.push(i[n].object)}this._last_hidden.forEach(function(x){x.visible=false});this._last_manifest=i[w].object.material;this._last_manifest.wireframe=!this._last_manifest.wireframe;this.Render3D()})}m.add("Focus",o,function(n){this.focusCamera(i[n].object)});m.add("Hide",o,function(n){var w=m.painter._clones.ResolveStack(i[n].object.stack);if(w.obj&&(w.node.kind===0)&&w.obj.fVolume){b.GEO.SetBit(w.obj.fVolume,b.GEO.BITS.kVisThis,false);b.GEO.updateBrowserIcons(w.obj.fVolume,this._hpainter)}else{if(w.obj&&(w.node.kind===1)){w.obj.fRnrSelf=false;b.GEO.updateBrowserIcons(w.obj,this._hpainter)}}this.testGeomChanges()});if(l){m.add("endsub:")}}}m.show(j)})};d.prototype.FilterIntersects=function(r){for(var j=0;j<r.length;++j){if(r[j].object.geo_highlight){r[j].object=r[j].object.geo_highlight}}for(var j=r.length-1;j>=0;--j){var p=r[j].object;var m=(p.stack!==undefined)||(p.geo_name!==undefined);for(var l=0;(l<j)&&m;++l){if(r[l].object===p){m=false}}if(!m){r.splice(j,1)}}if(this.enableX||this.enableY||this.enableZ){var t=[];for(var q=0;q<r.length;++q){var o=false;var s=r[q].point;if(this.enableX&&this._clipPlanes[0].normal.dot(s)>this._clipPlanes[0].constant){o=true}if(this.enableY&&this._clipPlanes[1].normal.dot(s)>this._clipPlanes[1].constant){o=true}if(this.enableZ&&this._clipPlanes[2].normal.dot(s)>this._clipPlanes[2].constant){o=true}if(o){t.push(r[q])}}r=t}return r};d.prototype.testCameraPositionChange=function(){if(!this.options.select_in_view||this._draw_all_nodes){return}var i=b.GEO.CreateProjectionMatrix(this._camera);var j=b.GEO.CreateFrustum(i);if(!j.CheckBox(this.getGeomBoundingBox(this._toplevel))){this.startDrawGeometry()}};d.prototype.ResolveStack=function(i){return this._clones&&i?this._clones.ResolveStack(i):null};d.prototype.GetStackFullName=function(j){var i=this.GetItemName(),k=this.ResolveStack(j);if(!k||!k.name){return i}return i?(i+"/"+k.name):k.name};d.prototype.HighlightMesh=function(j,m,v,q,r){if(!v&&j&&j.geo_object){v=j.geo_object}if(v){j=j?[j]:[];var l=this.getExtrasContainer();if(l&&l.children){for(var n=0;n<l.children.length;++n){if(l.children[n].geo_object===v){var i=l.children[n].geo_highlight||l.children[n];if(j.indexOf(i)<0){j.push(i)}}}}}else{if(q&&this._toplevel){j=[];this._toplevel.traverse(function(k){if((k instanceof g.Mesh)&&(k.stack===q)){j.push(k)}})}else{j=j?[j]:[]}}if(!j.length){j=null}if(j){if(j[0].geo_object){if(!this.options.highlight_scene){j=null}}else{if(!this.options.highlight){j=null}}}if(!r){if(j){if(!v){v=j[0].geo_object}if(!q){q=j[0].stack}}var p=this._highlight_handlers||(!this._main_painter?this._slave_painters:this._main_painter._slave_painters.concat([this._main_painter]));for(var n=0;n<p.length;++n){if(p[n]!==this){p[n].HighlightMesh(null,m,v,q,true)}}}var o=this._selected_mesh;if(!o&&!j){return}var u=false;if(o&&j&&(o.length==j.length)){u=true;for(var n=0;n<o.length;++n){if(o[n]!==j[n]){u=false}}}if(u){return}if(o){for(var n=0;n<o.length;++n){var s=o[n];if(!s.material){continue}s.material.color=s.originalColor;delete s.originalColor;if(s.normalLineWidth){s.material.linewidth=s.normalLineWidth}if(s.normalMarkerSize){s.material.size=s.normalMarkerSize}}}this._selected_mesh=j;if(j){for(var n=0;n<j.length;++n){var t=j[n];if(!t.material){continue}t.originalColor=t.material.color;t.material.color=new g.Color(m||16755251);if(t.hightlightLineWidth){t.material.linewidth=t.hightlightLineWidth}if(t.highlightMarkerSize){t.material.size=t.highlightMarkerSize}}}this.Render3D(0)};d.prototype.addOrbitControls=function(){if(this._controls||this._usesvg||b.BatchMode){return}var i=this;this.tooltip_allowed=(b.gStyle.Tooltip>0);this._controls=b.Painter.CreateOrbitControl(this,this._camera,this._scene,this._renderer,this._lookat);if(this.options.project||this.options.ortho_camera){this._controls.enableRotate=false}this._controls.ContextMenu=this.OrbitContext.bind(this);this._controls.ProcessMouseMove=function(o){var l=null,s=null,q=null,p=[];for(var m=0;m<o.length;++m){var n=o[m].object,j=null;if(!n){continue}if(n.geo_object){j=n.geo_name}else{if(n.stack){j=i.GetStackFullName(n.stack)}}if(j===null){continue}if(j.indexOf("<prnt>")==0){j=i.GetItemName()+j.substr(6)}p.push(j);if(!l){l=n;s=j;if(l.stack){q=i.ResolveStack(l.stack)}}}i.HighlightMesh(l);if(i.options.update_browser){if(i.options.highlight&&s){p=[s]}i.ActiavteInBrowser(p)}if(!q||!q.obj){return s}var r=b.GEO.provideInfo(q.obj);r.unshift(s);return{name:q.obj.fName,title:q.obj.fTitle||q.obj._typename,lines:r}};this._controls.ProcessMouseLeave=function(){if(i.options.update_browser){i.ActiavteInBrowser([])}};this._controls.ProcessDblClick=function(){if(i._last_manifest){i._last_manifest.wireframe=!i._last_manifest.wireframe;if(i._last_hidden){i._last_hidden.forEach(function(j){j.visible=true})}delete i._last_hidden;delete i._last_manifest;i.Render3D()}else{i.adjustCameraPosition()}}};d.prototype.addTransformControl=function(){if(this._tcontrols){return}if(!this.options._debug&&!this.options._grid){return}this._tcontrols=new g.TransformControls(this._camera,this._renderer.domElement);this._scene.add(this._tcontrols);this._tcontrols.attach(this._toplevel);var i=this;window.addEventListener("keydown",function(j){switch(j.keyCode){case 81:i._tcontrols.setSpace(i._tcontrols.space==="local"?"world":"local");break;case 17:i._tcontrols.setTranslationSnap(Math.ceil(i._overall_size)/50);i._tcontrols.setRotationSnap(g.Math.degToRad(15));break;case 84:i._tcontrols.setMode("translate");break;case 82:i._tcontrols.setMode("rotate");break;case 83:i._tcontrols.setMode("scale");break;case 187:case 107:i._tcontrols.setSize(i._tcontrols.size+0.1);break;case 189:case 109:i._tcontrols.setSize(Math.max(i._tcontrols.size-0.1,0.1));break}});window.addEventListener("keyup",function(j){switch(j.keyCode){case 17:i._tcontrols.setTranslationSnap(null);i._tcontrols.setRotationSnap(null);break}});this._tcontrols.addEventListener("change",function(){i.Render3D(0)})};d.prototype.nextDrawAction=function(){if(!this._clones||(this.drawing_stage==0)){return false}if(this.drawing_stage==1){if(this.options.use_worker>0){if(!this._worker){this.startWorker();return 1}if(!this._worker_ready){return 1}}var w=this._clones.MarkVisisble(),C=null,v=null;if(this.options.select_in_view&&!this._first_drawing){C=b.GEO.CreateProjectionMatrix(this._camera);v=b.GEO.CreateFrustum(C);if(v.CheckBox(this.getGeomBoundingBox(this._toplevel))){C=null;v=null}}this._current_face_limit=this.options.maxlimit;this._current_nodes_limit=this.options.maxnodeslimit;if(C){this._current_face_limit*=1.25;this._current_nodes_limit*=1.25}var z=!b.BatchMode&&((w>10000)||(C&&(this._clones.ScanVisible()>100000)));if(z&&b.source_dir.indexOf("file://")==0){console.log("disable worker for jsroot from file system");z=false}if(z&&!this._worker&&(this.options.use_worker>=0)){this.startWorker()}if(!z||!this._worker_ready){var I=this._clones.CollectVisibles(this._current_face_limit,v,this._current_nodes_limit);this._new_draw_nodes=I.lst;this._draw_all_nodes=I.complete;this.drawing_stage=3;return true}var s={collect:this._current_face_limit,collect_nodes:this._current_nodes_limit,visible:this._clones.GetVisibleFlags(),matrix:C?C.elements:null};this.submitToWorker(s);this.drawing_stage=2;this.drawing_log="Worker select visibles";return 2}if(this.drawing_stage==2){this.drawing_log="Worker select visibles";return 2}if(this.drawing_stage==3){this.drawing_log="Analyse visibles";if(this._draw_nodes){var u=this._clones.MergeVisibles(this._new_draw_nodes,this._draw_nodes);for(var B=0;B<u.length;++B){this._clones.CreateObject3D(u[B].stack,this._toplevel,"delete_mesh")}if(u.length>0){this.drawing_log="Delete "+u.length+" nodes"}}this._draw_nodes=this._new_draw_nodes;delete this._new_draw_nodes;this.drawing_stage=4;return true}if(this.drawing_stage===4){this.drawing_log="Collect shapes";var A=this._clones.CollectShapes(this._draw_nodes);this._build_shapes=this._clones.MergeShapesLists(this._build_shapes,A);this.drawing_stage=5;return true}if(this.drawing_stage===5){if(this.canSubmitToWorker()){var s={limit:this._current_face_limit,shapes:[]},D=0;for(var B=0;B<this._build_shapes.length;++B){var G=null,F=this._build_shapes[B];if(F.ready||F.geom){G={id:F.id,ready:true,nfaces:b.GEO.numGeometryFaces(F.geom),refcnt:F.refcnt}}else{G=b.clone(F,null,true);D++}s.shapes.push(G)}if(D>0){this.submitToWorker(s);this.drawing_log="Worker build shapes";this.drawing_stage=6;return 2}}this.drawing_stage=7}if(this.drawing_stage===6){return 2}if((this.drawing_stage===7)||(this.drawing_stage===8)){if(this.drawing_stage===7){var I=this._clones.BuildShapes(this._build_shapes,this._current_face_limit,500);if(I.done){this.drawing_stage=8}else{this.drawing_log="Creating: "+I.shapes+" / "+this._build_shapes.length+" shapes,  "+I.faces+" faces";if(I.notusedshapes<30){return true}}}var q=new Date().getTime(),x=true,y=this.options.project?this._full_geom:this._toplevel;for(var B=0;B<this._draw_nodes.length;++B){var l=this._draw_nodes[B];if(l.done){continue}var k=this._build_shapes[l.shapeid];if(!k.ready){if(this.drawing_stage===8){console.warn("shape marked as not ready when should")}x=false;continue}l.done=true;k.used=true;if(!k.geom||(k.nfaces===0)){this._clones.CreateObject3D(l.stack,y,"delete_mesh");continue}var r=this._clones.origin[l.nodeid];var G=this._clones.nodes[l.nodeid];var m=b.GEO.getNodeProperties(G.kind,r,true);this._num_meshes++;this._num_faces+=k.nfaces;var H=this._clones.CreateObject3D(l.stack,y,this.options);m.material.wireframe=this.options.wireframe;m.material.side=this.bothSides?g.DoubleSide:g.FrontSide;var j;if(H.matrixWorld.determinant()>-0.9){j=new g.Mesh(k.geom,m.material)}else{j=b.GEO.createFlippedMesh(H,k,m.material)}H.add(j);j.stack=l.stack;j.renderOrder=this._clones.maxdepth-l.stack.length;j.$jsroot_order=H.$jsroot_depth;if(this.options._debug||this.options._full){var t=new g.WireframeGeometry(j.geometry),p=new g.LineBasicMaterial({color:m.fillcolor,linewidth:(r&&r.fVolume)?r.fVolume.fLineWidth:1}),i=new g.LineSegments(t,p);H.add(i)}if(this.options._bound||this.options._full){var E=new g.BoxHelper(j);H.add(E)}var o=new Date().getTime();if(o-q>500){x=false;break}}if(x){if(this.options.project){this.drawing_log="Build projection";this.drawing_stage=10;return true}this.drawing_log="Building done";this.drawing_stage=0;return false}if(this.drawing_stage>7){this.drawing_log="Building meshes "+this._num_meshes+" / "+this._num_faces}return true}if(this.drawing_stage===9){if(!this._main_painter){console.warn("MAIN PAINTER DISAPPER");this.drawing_stage=0;return false}if(!this._main_painter._drawing_ready){return 1}this.drawing_stage=10}if(this.drawing_stage===10){this.doProjection();this.drawing_log="Building done";this.drawing_stage=0;return false}console.error("never come here stage = "+this.drawing_stage);return false};d.prototype.getProjectionSource=function(){if(this._clones_owner){return this._full_geom}if(!this._main_painter){console.warn("MAIN PAINTER DISAPPER");return null}if(!this._main_painter._drawing_ready){console.warn("MAIN PAINTER NOT READY WHEN DO PROJECTION");return null}return this._main_painter._toplevel};d.prototype.getGeomBoundingBox=function(l,j){var i=new g.Box3(),k=!this._clones;if(!l){i.min.x=i.min.y=i.min.z=-1;i.max.x=i.max.y=i.max.z=1;return i}i.makeEmpty();l.traverse(function(m){if(k||((m instanceof g.Mesh)&&m.stack)){b.GEO.getBoundingBox(m,i)}});if(j!==undefined){i.expandByVector(i.getSize().multiplyScalar(j))}return i};d.prototype.doProjection=function(){var o=this.getProjectionSource(),k=this;if(!o){return false}b.Painter.DisposeThreejsObject(this._toplevel,true);var n=this.options.project;if(this.options.projectPos===undefined){var m=this.getGeomBoundingBox(o),l=m.min[this.options.project],i=m.max[this.options.project],j=(l+i)/2;if((l<0)&&(i>0)&&(Math.abs(j)<0.2*Math.max(-l,i))){j=0}this.options.projectPos=j}o.traverse(function(r){if(!(r instanceof g.Mesh)||!r.stack){return}var q=b.GEO.projectGeometry(r.geometry,r.parent.matrixWorld,k.options.project,k.options.projectPos,r._flippedMesh);if(!q){return}var p=new g.Mesh(q,r.material.clone());k._toplevel.add(p);p.stack=r.stack});return true};d.prototype.SameMaterial=function(k,i){if((k===null)||(i===null)){return k===i}if(k.fVolume.fLineColor>=0){return(k.fVolume.fLineColor===i.fVolume.fLineColor)}var l=(k.fVolume.fMedium!==null)?k.fVolume.fMedium.fMaterial:null;var j=(i.fVolume.fMedium!==null)?i.fVolume.fMedium.fMaterial:null;if(l===j){return true}if((l===null)||(j===null)){return false}return(l.fFillStyle===j.fFillStyle)&&(l.fFillColor===j.fFillColor)};d.prototype.createScene=function(j,m){this._scene=new g.Scene();this._scene.fog=new g.Fog(16777215,1,10000);this._scene.overrideMaterial=new g.MeshLambertMaterial({color:7340287,transparent:true,opacity:0.2,depthTest:false});this._scene_width=j;this._scene_height=m;if(this.options.ortho_camera){this._camera=new g.OrthographicCamera(-600,600,-600,600,1,10000)}else{this._camera=new g.PerspectiveCamera(25,j/m,1,10000);this._camera.up=this.options._yup?new g.Vector3(0,1,0):new g.Vector3(0,0,1)}this._scene.add(this._camera);this._selected_mesh=null;this._overall_size=10;this._toplevel=new g.Object3D();this._scene.add(this._toplevel);var o=b.Painter.Create3DRenderer(j,m,this._usesvg,this._usesvgimg,this._webgl,{antialias:true,logarithmicDepthBuffer:false,preserveDrawingBuffer:true});this._webgl=o.usewebgl;this._renderer=o.renderer;if(this._renderer.setPixelRatio&&!b.nodejs){this._renderer.setPixelRatio(window.devicePixelRatio)}this._renderer.setSize(j,m,!this._fit_main_area);this._renderer.localClippingEnabled=true;this._renderer.setClearColor(this.options.background,1);if(this._fit_main_area&&!this._usesvg){this._renderer.domElement.style.width="100%";this._renderer.domElement.style.height="100%";var i=this.select_main();if(i.style("position")=="static"){i.style("position","relative")}}this._animating=false;this.clipIntersection=true;this.bothSides=false;this.enableX=this.enableY=this.enableZ=false;this.clipX=this.clipY=this.clipZ=0;this._clipPlanes=[new g.Plane(new g.Vector3(1,0,0),this.clipX),new g.Plane(new g.Vector3(0,this.options._yup?-1:1,0),this.clipY),new g.Plane(new g.Vector3(0,0,this.options._yup?1:-1),this.clipZ)];this._pointLight=new g.PointLight(15724527,1);this._camera.add(this._pointLight);this._pointLight.position.set(10,10,10);this._defaultAdvanced={aoClamp:0.7,lumInfluence:0.4,clipIntersection:true,depthTest:true};this._enableSSAO=this.options.ssao;if(this._webgl){var n=new g.RenderPass(this._scene,this._camera);this._depthMaterial=new g.MeshDepthMaterial({side:g.DoubleSide});this._depthMaterial.depthPacking=g.RGBADepthPacking;this._depthMaterial.blending=g.NoBlending;var l={minFilter:g.LinearFilter,magFilter:g.LinearFilter};this._depthRenderTarget=new g.WebGLRenderTarget(j,m,l);this._ssaoPass=new g.ShaderPass(g.SSAOShader);this._ssaoPass.renderToScreen=true;this._ssaoPass.uniforms.tDepth.value=this._depthRenderTarget.texture;this._ssaoPass.uniforms.size.value.set(j,m);this._ssaoPass.uniforms.cameraNear.value=this._camera.near;this._ssaoPass.uniforms.cameraFar.value=this._camera.far;this._ssaoPass.uniforms.onlyAO.value=false;this._ssaoPass.uniforms.aoClamp.value=this._defaultAdvanced.aoClamp;this._ssaoPass.uniforms.lumInfluence.value=this._defaultAdvanced.lumInfluence;this._effectComposer=new g.EffectComposer(this._renderer);this._effectComposer.addPass(n);this._effectComposer.addPass(this._ssaoPass)}this._advceOptions={};this.resetAdvanced();if(this._fit_main_area&&(this._usesvg||this._usesvgimg)){var k=a.createElementNS("http://www.w3.org/2000/svg","svg");k.appendChild(o.dom);return k}return o.dom};d.prototype.startDrawGeometry=function(i){if(!i&&(this.drawing_stage!==0)){this._draw_nodes_again=true;return}this._startm=new Date().getTime();this._last_render_tm=this._startm;this._last_render_meshes=0;this.drawing_stage=1;this._drawing_ready=false;this.drawing_log="collect visible";this._num_meshes=0;this._num_faces=0;this._selected_mesh=null;if(this.options.project){if(this._clones_owner){if(this._full_geom){this.drawing_stage=10;this.drawing_log="build projection"}else{this._full_geom=new g.Object3D()}}else{this.drawing_stage=9;this.drawing_log="wait for main painter"}}delete this._last_manifest;delete this._last_hidden;delete this._draw_nodes_again;this.continueDraw()};d.prototype.resetAdvanced=function(){if(this._webgl){this._advceOptions.aoClamp=this._defaultAdvanced.aoClamp;this._advceOptions.lumInfluence=this._defaultAdvanced.lumInfluence;this._ssaoPass.uniforms.aoClamp.value=this._defaultAdvanced.aoClamp;this._ssaoPass.uniforms.lumInfluence.value=this._defaultAdvanced.lumInfluence}this._advceOptions.depthTest=this._defaultAdvanced.depthTest;this._advceOptions.clipIntersection=this._defaultAdvanced.clipIntersection;this.clipIntersection=this._defaultAdvanced.clipIntersection;var i=this;this._toplevel.traverse(function(j){if(j instanceof g.Mesh){j.material.depthTest=i._defaultAdvanced.depthTest}});this.Render3D(0)};d.prototype.updateMaterialSide=function(i,j){if((this.bothSides===i)&&!j){return}this._scene.traverse(function(k){if(k.hasOwnProperty("material")&&("emissive" in k.material)){k.material.side=i?g.DoubleSide:g.FrontSide;k.material.needsUpdate=true}});this.bothSides=i};d.prototype.updateClipping=function(j){this._clipPlanes[0].constant=this.clipX;this._clipPlanes[1].constant=-this.clipY;this._clipPlanes[2].constant=this.options._yup?-this.clipZ:this.clipZ;var i=this;this._scene.traverse(function(k){if(k instanceof g.Mesh){k.material.clipIntersection=i.clipIntersection;k.material.clippingPlanes=[];if(i.enableX){k.material.clippingPlanes.push(i._clipPlanes[0])}if(i.enableY){k.material.clippingPlanes.push(i._clipPlanes[1])}if(i.enableZ){k.material.clippingPlanes.push(i._clipPlanes[2])}}});this.updateMaterialSide(this.enableX||this.enableY||this.enableZ);if(!j){this.Render3D(0)}};d.prototype.getGeomBox=function(){var j=this.getExtrasContainer("collect");var l=this.getGeomBoundingBox(this._toplevel);if(j){for(var i=0;i<j.length;++i){this._toplevel.add(j[i])}}return l};d.prototype.adjustCameraPosition=function(p){if(!this._toplevel){return}var n=this.getGeomBoundingBox(this._toplevel);var r=n.max.x-n.min.x,q=n.max.y-n.min.y,o=n.max.z-n.min.z,m=(n.max.x+n.min.x)/2,l=(n.max.y+n.min.y)/2,i=(n.max.z+n.min.z)/2;this._overall_size=2*Math.max(r,q,o);this._scene.fog.near=this._overall_size*2;this._camera.near=this._overall_size/350;this._scene.fog.far=this._overall_size*12;this._camera.far=this._overall_size*12;if(this._webgl){this._ssaoPass.uniforms.cameraNear.value=this._camera.near;this._ssaoPass.uniforms.cameraFar.value=this._camera.far}if(p){this.clipX=m;this.clipY=l;this.clipZ=i}if(this.options.ortho_camera){this._camera.left=n.min.x;this._camera.right=n.max.x;this._camera.top=n.min.y;this._camera.bottom=n.max.y}this._camera.updateProjectionMatrix();var j=2*this.options.zoom;if(this.options.ortho_camera){this._camera.position.set(0,0,Math.max(q,o))}else{if(this.options.project){switch(this.options.project){case"x":this._camera.position.set(j*1.5*Math.max(q,o),0,0);break;case"y":this._camera.position.set(0,j*1.5*Math.max(r,o),0);break;case"z":this._camera.position.set(0,0,j*1.5*Math.max(r,q));break}}else{if(this.options._yup){this._camera.position.set(m-j*Math.max(r,o),l+j*q,i-j*Math.max(r,o))}else{this._camera.position.set(m-j*Math.max(r,q),l-j*Math.max(r,q),i+j*o)}}}this._lookat=new g.Vector3(m,l,i);this._camera.lookAt(this._lookat);this._pointLight.position.set(r/5,q/5,o/5);if(this._controls){this._controls.target.copy(this._lookat);this._controls.update()}if(this.options.select_in_view){this.startDrawGeometry()}};d.prototype.focusOnItem=function(k){if(!k||!this._clones){return}var i=this._clones.FindStackByName(k);if(!i){return}var j=this._clones.ResolveStack(i,true);this.focusCamera(j,false)};d.prototype.focusCamera=function(s,B){if(this.options.project){return this.adjustCameraPosition()}var w=B===undefined?false:B;var q=new g.Box3();if(s===undefined){q=this.getGeomBoundingBox(this._toplevel)}else{if(s instanceof g.Mesh){q.setFromObject(s)}else{var G=new g.Vector3().setFromMatrixPosition(s.matrix),v=s.node,t=new g.Vector3(v.fDX,v.fDY,v.fDZ).multiplyScalar(0.5);q.min=G.clone().sub(t);q.max=G.clone().add(t)}}var F=q.max.x-q.min.x,D=q.max.y-q.min.y,C=q.max.z-q.min.z,A=(q.max.x+q.min.x)/2,z=(q.max.y+q.min.y)/2,x=(q.max.z+q.min.z)/2;var I;if(this.options._yup){I=new g.Vector3(A-2*Math.max(F,C),z+2*D,x-2*Math.max(F,C))}else{I=new g.Vector3(A-2*Math.max(F,D),z-2*Math.max(F,D),x+2*C)}var H=new g.Vector3(A,z,x);var u=this._camera.position.distanceTo(H);var y=this._controls.target;var r=200;var o=0;var l=I.sub(this._camera.position).divideScalar(r);var p=H.sub(y).divideScalar(r);if(w){var m=this.getGeomBoundingBox(this._toplevel);this.clipX=this.enableX?this.clipX:m.min.x;this.clipY=this.enableY?this.clipY:m.min.y;this.clipZ=this.enableZ?this.clipZ:m.min.z;this.enableX=this.enableY=this.enableZ=true;var k=((q.max.x+q.min.x)/2-this.clipX)/r,j=((q.max.y+q.min.y)/2-this.clipY)/r,i=((q.max.z+q.min.z)/2-this.clipZ)/r;this.updateClipping()}var E=this;this._animating=true;function n(){if(E._animating===undefined){return}if(E._animating){requestAnimationFrame(n)}else{E.startDrawGeometry()}var J=-Math.cos((2*Math.PI*o)/r)+1;E._camera.position.add(l.clone().multiplyScalar(J));y.add(p.clone().multiplyScalar(J));E._lookat=y;E._camera.lookAt(E._lookat);E._camera.updateProjectionMatrix();if(w){E.clipX+=k*J;E.clipY+=j*J;E.clipZ+=i*J;E.updateClipping()}else{E.Render3D()}o++;E._animating=o<r}n()};d.prototype.autorotate=function(m){var k=(m===undefined)?2:m,i=this,l=new Date();function j(){if(!i._renderer||!i.options){return}var n=new Date();if(i.options.autoRotate){requestAnimationFrame(j)}if(i._controls){i._controls.autoRotate=i.options.autoRotate;i._controls.autoRotateSpeed=k*(n.getTime()-l.getTime())/16.6666;i._controls.update()}l=new Date();i.Render3D(0)}if(this._webgl){j()}};d.prototype.completeScene=function(){if(this.options._debug||this.options._grid){if(this.options._full){var i=new g.BoxHelper(this._toplevel);this._scene.add(i)}this._scene.add(new g.AxisHelper(2*this._overall_size));this._scene.add(new g.GridHelper(Math.ceil(this._overall_size),Math.ceil(this._overall_size)/50));this.helpText("<font face='verdana' size='1' color='red'><center>Transform Controls<br>'T' translate | 'R' rotate | 'S' scale<br>'+' increase size | '-' decrease size<br>'W' toggle wireframe/solid display<br>keep 'Ctrl' down to snap to grid</center></font>")}};d.prototype.drawCount=function(q,m){var n="Unique nodes: "+this._clones.nodes.length+"<br/>Unique visible: "+q+"<br/>Time to clone: "+m+"ms <br/>";this._clones.ScanVisible();var p=this,r=0;var s={cnt:[],func:function(t){if(this.cnt[this.last]===undefined){this.cnt[this.last]=1}else{this.cnt[this.last]++}r+=b.GEO.CountNumShapes(p._clones.GetNodeShape(t.id));return true}};var j=new Date().getTime();var l=this._clones.ScanVisible(s);var i=new Date().getTime();n+="Total visible nodes: "+l+"<br/>";n+="Total shapes: "+r+"<br/>";for(var o=0;o<s.cnt.length;++o){if(s.cnt[o]!==undefined){n+=("  lvl"+o+": "+s.cnt[o]+"<br/>")}}n+="Time to scan: "+(i-j)+"ms <br/>";n+="<br/><br/>Check timing for matrix calculations ...<br/>";var k=this.select_main().style("overflow","auto").html(n);setTimeout(function(){s.domatrix=true;j=new Date().getTime();l=p._clones.ScanVisible(s);i=new Date().getTime();k.append("p").text("Time to scan with matrix: "+(i-j)+"ms");p.DrawingReady()},100);return this};d.prototype.PerformDrop=function(o,p,j,k,n){console.log("Calling perform drop");if(o&&(o.$kind==="TTree")){var i="extract_geo_tracks";if(k&&k.indexOf("$")>0){i=k.substr(0,k.indexOf("$"));k=k.substr(k.indexOf("$")+1)}var m=b.findFunction(i);if(!m){return b.CallBack(n)}var l=this;return m(o,k,function(q){if(q){l.drawExtras(q,"",false);l.Render3D(100)}b.CallBack(n)})}if(this.drawExtras(o,p)){if(j){j._painter=this}}b.CallBack(n)};d.prototype.MouseOverHierarchy=function(i,l,j){if(!this.options){return}var k=j._obj;if(this.options._debug){console.log("Mouse over",i,l,(k?k._typename:"---"))}if(!k||(k._typename!=="TEveTrack"&&k._typename!=="TEvePointSet"&&k._typename!=="TPolyMarker3D")){return}this.HighlightMesh(null,65280,i?k:null)};d.prototype.clearExtras=function(){this.getExtrasContainer("delete");delete this._extraObjects;this.Render3D()};d.prototype.addExtra=function(i,j){if(this._extraObjects===undefined){this._extraObjects=b.Create("TList")}if(this._extraObjects.arr.indexOf(i)>=0){return false}this._extraObjects.Add(i,j);delete i.$hidden_via_menu;return true};d.prototype.ExtraObjectVisible=function(m,j,i){if(!this._extraObjects){return}var p=m.itemFullName(j),l=this._extraObjects.opt.indexOf(p);if((l<0)&&j._obj){l=this._extraObjects.arr.indexOf(j._obj);if(l>=0){this._extraObjects.opt[l]=p}}if(l<0){return}var n=this._extraObjects.arr[l],k=n.$hidden_via_menu?false:true;if(i){n.$hidden_via_menu=k;k=!k;var o=null;this._toplevel.traverse(function(q){if(q.geo_object===n){o=q}});if(o){o.visible=k}else{if(k){this.drawExtras(n,"",false)}}if(o||k){this.Render3D()}}return k};d.prototype.drawExtras=function(l,q,o){if(!l||l._typename===undefined){return false}if(!o&&l.$hidden_via_menu){return false}var k=false,m=false;if(o===undefined){o=true;m=true}if((l._typename==="TList")||(l._typename==="TObjArray")){if(!l.arr){return false}for(var p=0;p<l.arr.length;++p){var j=l.arr[p];var i=(q===undefined)?l.opt[p]:(q+"/["+p+"]");if(this.drawExtras(j,i,o)){k=true}}}else{if(l._typename==="THREE.Mesh"){this.getExtrasContainer().add(l);k=true}else{if(l._typename==="TGeoTrack"){if(o&&!this.addExtra(l,q)){return false}k=this.drawGeoTrack(l,q)}else{if((l._typename==="TEveTrack")||(l._typename==="ROOT::Experimental::TEveTrack")){if(o&&!this.addExtra(l,q)){return false}k=this.drawEveTrack(l,q)}else{if((l._typename==="TEvePointSet")||(l._typename==="ROOT::Experimental::TEvePointSet")||(l._typename==="TPolyMarker3D")){if(o&&!this.addExtra(l,q)){return false}k=this.drawHit(l,q)}else{if((l._typename==="TEveGeoShapeExtract")||(l._typename==="ROOT::Experimental::TEveGeoShapeExtract")){if(o&&!this.addExtra(l,q)){return false}k=this.drawExtraShape(l,q)}}}}}}if(k&&m){this.Render3D(100)}return k};d.prototype.getExtrasContainer=function(p,l){if(!this._toplevel){return null}if(!l){l="tracks"}var m=null,i=[];for(var q=0;q<this._toplevel.children.length;++q){var o=this._toplevel.children[q];if(!o._extras){continue}if(p==="collect"){i.push(o);continue}if(o._extras===l){m=o;break}}if(p==="collect"){for(var j=0;j<i.length;++j){this._toplevel.remove(i[j])}return i}if(p==="delete"){if(m){this._toplevel.remove(m)}b.Painter.DisposeThreejsObject(m);return null}if((p!=="get")&&!m){m=new g.Object3D();m._extras=l;this._toplevel.add(m)}return m};d.prototype.drawGeoTrack=function(l,r){if(!l||!l.fNpoints){return false}var v=l.fLineWidth||1,i=b.Painter.root_colors[l.fLineColor]||"rgb(255,0,255)";if(b.browser.isWin){v=1}var t=Math.round(l.fNpoints/4),j=new Float32Array((t-1)*6),u=0,s=this.options.projectPos,q=(this.options.project==="x"),p=(this.options.project==="y"),o=(this.options.project==="z");for(var n=0;n<t-1;++n){j[u]=q?s:l.fPoints[n*4];j[u+1]=p?s:l.fPoints[n*4+1];j[u+2]=o?s:l.fPoints[n*4+2];j[u+3]=q?s:l.fPoints[n*4+4];j[u+4]=p?s:l.fPoints[n*4+5];j[u+5]=o?s:l.fPoints[n*4+6];u+=6}var m=new g.LineBasicMaterial({color:i,linewidth:v}),w=b.Painter.createLineSegments(j,m);w.geo_name=r;w.geo_object=l;if(!b.browser.isWin){w.hightlightLineWidth=v*3;w.normalLineWidth=v}this.getExtrasContainer().add(w);return true};d.prototype.drawEveTrack=function(l,r){if(!l||(l.fN<=0)){return false}var u=l.fLineWidth||1,i=b.Painter.root_colors[l.fLineColor]||"rgb(255,0,255)";if(b.browser.isWin){u=1}var j=new Float32Array((l.fN-1)*6),t=0,s=this.options.projectPos,q=(this.options.project==="x"),p=(this.options.project==="y"),o=(this.options.project==="z");for(var n=0;n<l.fN-1;++n){j[t]=q?s:l.fP[n*3];j[t+1]=p?s:l.fP[n*3+1];j[t+2]=o?s:l.fP[n*3+2];j[t+3]=q?s:l.fP[n*3+3];j[t+4]=p?s:l.fP[n*3+4];j[t+5]=o?s:l.fP[n*3+5];t+=6}var m=new g.LineBasicMaterial({color:i,linewidth:u}),v=b.Painter.createLineSegments(j,m);v.geo_name=r;v.geo_object=l;if(!b.browser.isWin){v.hightlightLineWidth=u*3;v.normalLineWidth=u}this.getExtrasContainer().add(v);return true};d.prototype.drawHit=function(j,p){if(!j||!j.fN||(j.fN<0)){return false}var q=8*j.fMarkerSize,t=j.fN,r=this.options.projectPos,o=(this.options.project==="x"),n=(this.options.project==="y"),m=(this.options.project==="z"),k=new b.Painter.PointsCreator(t,this._webgl,q);for(var l=0;l<t;l++){k.AddPoint(o?r:j.fP[l*3],n?r:j.fP[l*3+1],m?r:j.fP[l*3+2])}var s=k.CreatePoints(b.Painter.root_colors[j.fMarkerColor]||"rgb(0,0,255)");s.highlightMarkerSize=q*3;s.normalMarkerSize=q;s.geo_name=p;s.geo_object=j;this.getExtrasContainer().add(s);return true};d.prototype.drawExtraShape=function(j,k){var i=b.GEO.build(j);if(!i){return false}i.geo_name=k;i.geo_object=j;this.getExtrasContainer().add(i);return true};d.prototype.FindNodeWithVolume=function(i,m,l,p,r){var k=false,q=null;if(!l){l=this.GetGeometry();if(!l&&(b.GEO.NodeKind(l)!==0)){return null}p=this.geo_manager?l.fName:"";k=true;r=[]}else{if(p.length>0){p+="/"}p+=l.fName}if(!l.fVolume||l.fVolume._searched){return null}if(i.test(l.fVolume.fName)){q=m({node:l,item:p});if(q){return q}}l.fVolume._searched=true;r.push(l.fVolume);if(l.fVolume.fNodes){for(var j=0;j<l.fVolume.fNodes.arr.length;++j){q=this.FindNodeWithVolume(i,m,l.fVolume.fNodes.arr[j],p,r);if(q){break}}}if(k){for(var j=0,o=r.length;j<o;++j){delete r[j]._searched}}return q};d.prototype.SetRootDefaultColors=function(){var n={kWhite:0,kBlack:1,kGray:920,kRed:632,kGreen:416,kBlue:600,kYellow:400,kMagenta:616,kCyan:432,kOrange:800,kSpring:820,kTeal:840,kAzure:860,kViolet:880,kPink:900};var j=110,l=[];for(var m=0;m<j;m++){l.push(n.kGray)}l[3]=n.kYellow-10;l[4]=l[5]=n.kGreen-10;l[6]=l[7]=n.kBlue-7;l[8]=l[9]=n.kMagenta-3;l[10]=l[11]=n.kRed-10;l[12]=n.kGray+1;l[13]=n.kBlue-10;l[14]=n.kOrange+7;l[16]=n.kYellow+1;l[20]=n.kYellow-10;l[24]=l[25]=l[26]=n.kBlue-8;l[29]=n.kOrange+9;l[79]=n.kOrange-2;var k={test:function(){return true}};this.FindNodeWithVolume(k,function(i){var p=i.node.fVolume;var q=p.fMedium;if(!q){return null}var o=q.fMaterial;var r=Math.round(o.fZ);p.fLineColor=l[r];if(o.fDensity<0.1){o.fFillStyle=3000+60}})};d.prototype.checkScript=function(n,l){var i=this,m=this.GetGeometry(),j="";if(this.geo_manager){j=m.fName}if(!n||(n.length<3)||(b.GEO.NodeKind(m)!==0)){return b.CallBack(l,m,j)}var k={GetVolume:function(p){var q=new RegExp("^"+p+"$");var o=i.FindNodeWithVolume(q,function(r){return r});if(!o){console.log("Did not found "+p+" volume")}return{found:o,fVolume:o?o.node.fVolume:null,InvisibleAll:function(r){b.GEO.InvisibleAll.call(this.fVolume,r)},Draw:function(){if(!this.found||!this.fVolume){return}m=this.found.node;j=this.found.item;console.log("Select volume for drawing",this.fVolume.fName,j)},SetTransparency:function(r){if(this.fVolume&&this.fVolume.fMedium&&this.fVolume.fMedium.fMaterial){this.fVolume.fMedium.fMaterial.fFillStyle=3000+r}},SetLineColor:function(r){if(this.fVolume){this.fVolume.fLineColor=r}}}},DefaultColors:function(){i.SetRootDefaultColors()},SetMaxVisNodes:function(o){console.log("Automatic visible depth for "+o+" nodes");if(o>0){i.options.maxnodeslimit=o}}};b.progress("Loading macro "+n);b.NewHttpRequest(n,"text",function(p){if(!p||(p.length==0)){return b.CallBack(l,m,j)}var o=p.split("\n");q(0);function q(v){var w=new Date().getTime();while(v<o.length){var r=o[v++].trim();if(r.indexOf("//")==0){continue}if(r.indexOf("gGeoManager")<0){continue}r=r.replace("->GetVolume",".GetVolume");r=r.replace("->InvisibleAll",".InvisibleAll");r=r.replace("->SetMaxVisNodes",".SetMaxVisNodes");r=r.replace("->DefaultColors",".DefaultColors");r=r.replace("->Draw",".Draw");r=r.replace("->SetTransparency",".SetTransparency");r=r.replace("->SetLineColor",".SetLineColor");if(r.indexOf("->")>=0){continue}try{var u=new Function("gGeoManager",r);u(k)}catch(t){console.error("Problem by processing "+r)}var s=new Date().getTime();if(s-w>300){b.progress("exec "+r);return setTimeout(q.bind(this,v),1)}}b.CallBack(l,m,j)}}).send()};d.prototype.prepareObjectDraw=function(n,j){delete this._clones;if(this._main_painter){this._clones_owner=false;this._clones=this._main_painter._clones;console.log("Reuse clones",this._clones.nodes.length,"from main painter")}else{if(!n){this._clones_owner=false;this._clones=null}else{this._start_drawing_time=new Date().getTime();this._clones_owner=true;this._clones=new b.GEO.ClonedNodes(n);this._clones.name_prefix=j;var k=this._clones.MarkVisisble(true);if(k<=0){k=this._clones.MarkVisisble(false)}else{k=this._clones.MarkVisisble(true,true)}var m=new Date().getTime()-this._start_drawing_time;console.log("Creating clones",this._clones.nodes.length,"takes",m,"uniquevis",k);if(this.options._count){return this.drawCount(k,m)}}}if(!this._scene){this.options.maxlimit=(this._webgl?200000:100000)*this.options.more;this._first_drawing=true;if(this.options.use_worker>0){this.startWorker()}var i=this.size_for_3d(this._usesvg?3:undefined);this._fit_main_area=(i.can3d===-1);var l=this.createScene(i.width,i.height);this.add_3d_canvas(i,l);this.AccessTopPainter(true)}this.CreateToolbar();if(this._clones){this.showDrawInfo("Drawing geometry");this.startDrawGeometry(true)}else{this.completeDraw()}};d.prototype.showDrawInfo=function(l){if(!this._first_drawing||!this._start_drawing_time){return}var i=this._renderer.domElement.parentNode,j=e.select(i).select(".geo_info");if(!l){j.remove()}else{var k=(new Date().getTime()-this._start_drawing_time)*0.001;if(j.empty()){j=e.select(i).append("p").attr("class","geo_info")}j.html(l+", "+k.toFixed(1)+"s")}};d.prototype.continueDraw=function(){if(this.drawing_stage===0){return}var j=new Date().getTime(),i=this._first_drawing?1000:200,k=j;while(true){var l=this.nextDrawAction();if(!l){break}k=new Date().getTime();if(k-this._startm>100000){this.drawing_stage=0;break}if((l===true)&&(k-j<i)){continue}if((k-j>i)||(l===1)||(l===2)){b.progress(this.drawing_log);this.showDrawInfo(this.drawing_log);if(this._first_drawing&&this._webgl&&(this._num_meshes-this._last_render_meshes>100)&&(k-this._last_render_tm>2.5*i)){this.adjustCameraPosition();this.Render3D(-1);this._last_render_tm=new Date().getTime();this._last_render_meshes=this._num_meshes}if(l!==2){setTimeout(this.continueDraw.bind(this),(l===1)?100:1)}return}}var m=k-this._startm;if(this._first_drawing){b.console("Create tm = "+m+" meshes "+this._num_meshes+" faces "+this._num_faces)}if(m>300){b.progress("Rendering geometry");this.showDrawInfo("Rendering");return setTimeout(this.completeDraw.bind(this,true),10)}this.completeDraw(true)};d.prototype.TestCameraPosition=function(){this._camera.updateMatrixWorld();var i=this._camera.position.clone();if(this._last_camera_position){var j=this._last_camera_position.distanceTo(i);if(j<(this._overall_size||1000)/10000){return}}this._last_camera_position=i;if(this._webgl){b.GEO.produceRenderOrder(this._toplevel,i,this.options.depthMethod,this._clones)}};d.prototype.Render3D=function(l,k){if(!this._renderer){console.warn("renderer object not exists - check code");return}if(l===undefined){l=5}if((l<=0)||this._usesvg){if("render_tmout" in this){clearTimeout(this.render_tmout)}else{if(l===-2222){return}}var j=new Date();if(typeof this.TestAxisVisibility==="function"){this.TestAxisVisibility(this._camera,this._toplevel)}this.TestCameraPosition();if(this._webgl&&this._enableSSAO){this._scene.overrideMaterial=this._depthMaterial;this._renderer.render(this._scene,this._camera,this._depthRenderTarget,true);this._scene.overrideMaterial=null;this._effectComposer.render()}else{this._renderer.render(this._scene,this._camera)}var i=new Date();this.last_render_tm=i.getTime()-j.getTime();delete this.render_tmout;if((this.first_render_tm===0)&&k){this.first_render_tm=this.last_render_tm;b.console("First render tm = "+this.first_render_tm)}b.Painter.AfterRender3D(this._renderer);return}if(!this.render_tmout){this.render_tmout=setTimeout(this.Render3D.bind(this,0,k),l)}};d.prototype.startWorker=function(){if(this._worker){return}this._worker_ready=false;this._worker_jobs=0;var i=this;this._worker=new Worker(b.source_dir+"scripts/JSRootGeoWorker.js");this._worker.onmessage=function(j){if(typeof j.data!=="object"){return}if("log" in j.data){return b.console("geo: "+j.data.log)}if("progress" in j.data){return b.progress(j.data.progress)}j.data.tm3=new Date().getTime();if("init" in j.data){i._worker_ready=true;return b.console("Worker ready: "+(j.data.tm3-j.data.tm0))}i.processWorkerReply(j.data)};this._worker.postMessage({init:true,browser:b.browser,tm0:new Date().getTime(),clones:this._clones.nodes,sortmap:this._clones.sortmap})};d.prototype.canSubmitToWorker=function(i){if(!this._worker){return false}return this._worker_ready&&((this._worker_jobs==0)||i)};d.prototype.submitToWorker=function(i){if(!this._worker){return false}this._worker_jobs++;i.tm0=new Date().getTime();this._worker.postMessage(i)};d.prototype.processWorkerReply=function(k){this._worker_jobs--;if("collect" in k){this._new_draw_nodes=k.new_nodes;this._draw_all_nodes=k.complete;this.drawing_stage=3;return this.continueDraw()}if("shapes" in k){for(var l=0;l<k.shapes.length;++l){var j=k.shapes[l],i=this._build_shapes[l];if(j.buf_pos&&j.buf_norm){if(j.buf_pos.length===0){i.geom=null}else{if(j.buf_pos.length!==j.buf_norm.length){console.error("item.buf_pos",j.buf_pos.length,"item.buf_norm",j.buf_norm.length);i.geom=null}else{i.geom=new g.BufferGeometry();i.geom.addAttribute("position",new g.BufferAttribute(j.buf_pos,3));i.geom.addAttribute("normal",new g.BufferAttribute(j.buf_norm,3))}}i.ready=true;i.nfaces=j.nfaces}}k.tm4=new Date().getTime();this.drawing_stage=7;return this.continueDraw()}};d.prototype.testGeomChanges=function(){if(this._main_painter){console.warn("Get testGeomChanges call for slave painter");return this._main_painter.testGeomChanges()}this.startDrawGeometry();for(var i=0;i<this._slave_painters.length;++i){this._slave_painters[i].startDrawGeometry()}};d.prototype.drawSimpleAxis=function(){var l=this.getGeomBoundingBox(this._toplevel);this.getExtrasContainer("delete","axis");var m=this.getExtrasContainer("create","axis");var j=0.02*Math.max((l.max.x-l.min.x),(l.max.y-l.min.y),(l.max.z-l.min.z)),n=["x","y","z"],x=[0,0,0];if(this.options._axis_center){for(var z=0;z<3;++z){var A=n[z];if((l.min[A]<=0)&&(l.max[A]>=0)){continue}x[z]=(l.min[A]+l.max[A])/2}}for(var z=0;z<3;++z){var w=new Float32Array(6),q,A=n[z];function y(B){var k=l.max[A]-l.min[A];if(k<2){return B.toFixed(3)}if(Math.abs(B)>100000){return B.toExponential(3)}return Math.round(B).toString()}var t=y(l.max[A]);w[0]=l.min.x;w[1]=l.min.y;w[2]=l.min.z;w[3]=l.min.x;w[4]=l.min.y;w[5]=l.min.z;switch(z){case 0:w[3]=l.max.x;q="red";if(this.options._yup){t="X "+t}else{t+=" X"}break;case 1:w[4]=l.max.y;q="green";if(this.options._yup){t+=" Y"}else{t="Y "+t}break;case 2:w[5]=l.max.z;q="blue";t+=" Z";break}if(this.options._axis_center){for(var r=0;r<6;++r){if((r%3)!==z){w[r]=x[r%3]}}}var v=new g.LineBasicMaterial({color:q}),i=b.Painter.createLineSegments(w,v);m.add(i);var s=new g.MeshBasicMaterial({color:q});if((x[z]===0)&&(x[z]>=l.min[A])&&(x[z]<=l.max[A])){if(!this.options._axis_center||(z===0)){var p=new g.SphereBufferGeometry(j*0.25);i=new g.Mesh(p,s);i.translateX((z===0)?x[0]:w[0]);i.translateY((z===1)?x[1]:w[1]);i.translateZ((z===2)?x[2]:w[2]);m.add(i)}}var u=new g.TextGeometry(t,{font:b.threejs_font_helvetiker_regular,size:j,height:0,curveSegments:5});i=new g.Mesh(u,s);var o=new g.Box3().setFromObject(i);i.translateX(w[3]);i.translateY(w[4]);i.translateZ(w[5]);if(this.options._yup){switch(z){case 0:i.rotateY(Math.PI);i.translateX(-o.max.x-j*0.5);i.translateY(-o.max.y/2);break;case 1:i.rotateX(-Math.PI/2);i.rotateY(-Math.PI/2);i.translateX(j*0.5);i.translateY(-o.max.y/2);break;case 2:i.rotateY(-Math.PI/2);i.translateX(j*0.5);i.translateY(-o.max.y/2);break}}else{switch(z){case 0:i.rotateX(Math.PI/2);i.translateY(-o.max.y/2);i.translateX(j*0.5);break;case 1:i.rotateX(Math.PI/2);i.rotateY(-Math.PI/2);i.translateX(-o.max.x-j*0.5);i.translateY(-o.max.y/2);break;case 2:i.rotateX(Math.PI/2);i.rotateZ(Math.PI/2);i.translateX(j*0.5);i.translateY(-o.max.y/2);break}}m.add(i);u=new g.TextGeometry(y(l.min[A]),{font:b.threejs_font_helvetiker_regular,size:j,height:0,curveSegments:5});i=new g.Mesh(u,s);o=new g.Box3().setFromObject(i);i.translateX(w[0]);i.translateY(w[1]);i.translateZ(w[2]);if(this.options._yup){switch(z){case 0:i.rotateY(Math.PI);i.translateX(j*0.5);i.translateY(-o.max.y/2);break;case 1:i.rotateX(-Math.PI/2);i.rotateY(-Math.PI/2);i.translateY(-o.max.y/2);i.translateX(-o.max.x-j*0.5);break;case 2:i.rotateY(-Math.PI/2);i.translateX(-o.max.x-j*0.5);i.translateY(-o.max.y/2);break}}else{switch(z){case 0:i.rotateX(Math.PI/2);i.translateX(-o.max.x-j*0.5);i.translateY(-o.max.y/2);break;case 1:i.rotateX(Math.PI/2);i.rotateY(-Math.PI/2);i.translateY(-o.max.y/2);i.translateX(j*0.5);break;case 2:i.rotateX(Math.PI/2);i.rotateZ(Math.PI/2);i.translateX(-o.max.x-j*0.5);i.translateY(-o.max.y/2);break}}m.add(i)}this.TestAxisVisibility=function(B,k){if(!B){this.getExtrasContainer("delete","axis");delete this.TestAxisVisibility;this.Render3D();return}}};d.prototype.toggleAxisDraw=function(i){if(this.TestAxisVisibility){if(!i){this.TestAxisVisibility(null,this._toplevel)}}else{this.drawSimpleAxis()}};d.prototype.completeDraw=function(j){var l=false,i=true;if(!this.options){console.warn("options object does not exist in completeDraw - something went wrong");return}if(!this._clones){i=false;this.getExtrasContainer("delete");var k=(this._main_painter?this._main_painter._extraObjects:null)||this._extraObjects;this.drawExtras(k,"",false)}if(this._first_drawing){this.adjustCameraPosition(true);this.showDrawInfo();this._first_drawing=false;l=true;if(this._webgl){this.enableX=this.options.clipx;this.enableY=this.options.clipy;this.enableZ=this.options.clipz;this.updateClipping(true)}if(this.options.tracks&&this.geo_manager&&this.geo_manager.fTracks){this.addExtra(this.geo_manager.fTracks,"<prnt>/Tracks")}}if(this.options.transparency!==0){this.changeGlobalTransparency(this.options.transparency,true)}if(l){this.completeScene();if(this.options._axis){this.toggleAxisDraw(true)}}this._scene.overrideMaterial=null;if(i){this.getExtrasContainer("delete");var k=(this._main_painter?this._main_painter._extraObjects:null)||this._extraObjects;this.drawExtras(k,"",false)}this.Render3D(0,true);if(j){b.progress()}this.addOrbitControls();this.addTransformControl();if(l){if(this.options.highlight===false){this.options.highlight=(this.first_render_tm<1000)}if(this.options.highlight_scene===false){this.options.highlight_scene=this.options.highlight}if(this._webgl&&this.options.autoRotate&&!this.options.project){this.autorotate(2.5)}if(!this._usesvg&&this.options.show_controls&&!b.BatchMode){this.showControlOptions(true)}}this.DrawingReady();if(this._draw_nodes_again){return this.startDrawGeometry()}this._drawing_ready=true};d.prototype.Cleanup=function(m){if(!m){this.AccessTopPainter(false);this.helpText();b.Painter.DisposeThreejsObject(this._scene);b.Painter.DisposeThreejsObject(this._full_geom);if(this._tcontrols){this._tcontrols.dispose()}if(this._controls){this._controls.Cleanup()}if(this._context_menu){this._renderer.domElement.removeEventListener("contextmenu",this._context_menu,false)}if(this._datgui){this._datgui.destroy()}if(this._worker){this._worker.terminate()}b.TObjectPainter.prototype.Cleanup.call(this);delete this.options;delete this._animating;var l=this.GetGeometry();if(l&&this.options.is_main){if(l.$geo_painter===this){delete l.$geo_painter}else{if(l.fVolume&&l.fVolume.$geo_painter===this){delete l.fVolume.$geo_painter}}}if(this._main_painter){var n=this._main_painter._slave_painters.indexOf(this);if(n>=0){this._main_painter._slave_painters.splice(n,1)}}for(var j=0;j<this._slave_painters.length;++j){var i=this._slave_painters[j];if(i&&(i._main_painter===this)){i._main_painter=null}}}for(var j in this._slave_painters){var i=this._slave_painters[j];i._main_painter=null;if(i._clones===this._clones){i._clones=null}}this._main_painter=null;this._slave_painters=[];if(this._renderer){if(this._renderer.dispose){this._renderer.dispose()}if(this._renderer.context){delete this._renderer.context}}delete this._scene;this._scene_width=0;this._scene_height=0;this._renderer=null;this._toplevel=null;this._full_geom=null;this._camera=null;this._selected_mesh=null;if(this._clones&&this._clones_owner){this._clones.Cleanup(this._draw_nodes,this._build_shapes)}delete this._clones;delete this._clones_owner;delete this._draw_nodes;delete this._drawing_ready;delete this._build_shapes;delete this._new_draw_nodes;this.first_render_tm=0;this.last_render_tm=2000;this.drawing_stage=0;delete this.drawing_log;delete this._datgui;delete this._controls;delete this._context_menu;delete this._tcontrols;delete this._toolbar;delete this._worker};d.prototype.helpText=function(i){b.progress(i)};d.prototype.CheckResize=function(i){var j=this.canv_painter();if(j){if(!j.CheckCanvasResize(i)){return false}}var k=this.size_for_3d();if((this._scene_width===k.width)&&(this._scene_height===k.height)){return false}if((k.width<10)||(k.height<10)){return}this._scene_width=k.width;this._scene_height=k.height;if(this._camera.type=="OrthographicCamera"){this._camera.left=-k.width;this._camera.right=k.width;this._camera.top=-k.height;this._camera.bottom=k.height}else{this._camera.aspect=this._scene_width/this._scene_height}this._camera.updateProjectionMatrix();this._renderer.setSize(this._scene_width,this._scene_height,!this._fit_main_area);this.Render3D();return true};d.prototype.ToggleEnlarge=function(){if(e.event){e.event.preventDefault();e.event.stopPropagation()}if(this.enlarge_main("toggle")){this.CheckResize()}};d.prototype.ownedByTransformControls=function(j){var i=j.parent;while(i&&!(i instanceof g.TransformControls)){i=i.parent}return(i&&(i instanceof g.TransformControls))};d.prototype.accessObjectWireFrame=function(j,i){if(!j.hasOwnProperty("material")||(j instanceof g.GridHelper)){return}if(this.ownedByTransformControls(j)){return}if((i!==undefined)&&j.stack){j.material.wireframe=i}return j.material.wireframe};d.prototype.changeWireFrame=function(k,j){var i=this;k.traverse(function(l){i.accessObjectWireFrame(l,j)});this.Render3D()};b.Painter.CreateGeoPainter=function(l,k,j){b.GEO.GradPerSegm=b.gStyle.GeoGradPerSegm;b.GEO.CompressComp=b.gStyle.GeoCompressComp;var i=new d(k);i.SetDivId(l,5);i._usesvg=b.Painter.UseSVGFor3D();i._usesvgimg=!i._usesvg&&b.BatchMode;i._webgl=!i._usesvg&&b.Painter.TestWebGL();i.options=i.decodeOptions(j||"");if(i.options._yup===undefined){i.options._yup=i.svg_canvas().empty()}return i};b.Painter.drawGeoObject=function(m,l,k){if(!l){return null}var j=null;if(("fShapeBits" in l)&&("fShapeId" in l)){j=l;l=null}else{if((l._typename==="TGeoVolumeAssembly")||(l._typename==="TGeoVolume")){j=l.fShape}else{if((l._typename==="TEveGeoShapeExtract")||(l._typename==="ROOT::Experimental::TEveGeoShapeExtract")){j=l.fShape}else{if(l._typename==="TGeoManager"){b.GEO.SetBit(l.fMasterVolume,b.GEO.BITS.kVisThis,false);j=l.fMasterVolume.fShape}else{if("fVolume" in l){if(l.fVolume){j=l.fVolume.fShape}}else{l=null}}}}}if(k&&k.indexOf("comp")==0&&j&&(j._typename=="TGeoCompositeShape")&&j.fNode){k=k.substr(4);l=b.GEO.buildCompositeVolume(j)}if(!l&&j){l=b.extend(b.Create("TEveGeoShapeExtract"),{fTrans:null,fShape:j,fRGBA:[0,1,0,1],fElements:null,fRnrSelf:true})}if(!l){return null}var i=b.Painter.CreateGeoPainter(m,l,k);if(i.options.is_main&&!l.$geo_painter){l.$geo_painter=i}if(!i.options.is_main&&i.options.project&&l.$geo_painter){i._main_painter=l.$geo_painter;i._main_painter._slave_painters.push(i)}i.checkScript(i.options.script_name,i.prepareObjectDraw.bind(i));return i};b.Painter.drawGeometry=b.Painter.drawGeoObject;b.GEO.buildCompositeVolume=function(k,m){var l=b.Create("TGeoVolume");if(m&&(k._typename!=="TGeoCompositeShape")){l.fName=m;b.GEO.SetBit(l,b.GEO.BITS.kVisThis,true);l.fLineColor=(m=="Left"?2:3);l.fShape=k;return l}b.GEO.SetBit(l,b.GEO.BITS.kVisDaughters,true);l.$geoh=true;l.fName="";var j=b.Create("TGeoNodeMatrix");j.fName="Left";j.fMatrix=k.fNode.fLeftMat;j.fVolume=b.GEO.buildCompositeVolume(k.fNode.fLeft,"Left");var i=b.Create("TGeoNodeMatrix");i.fName="Right";i.fMatrix=k.fNode.fRightMat;i.fVolume=b.GEO.buildCompositeVolume(k.fNode.fRight,"Right");l.fNodes=b.Create("TList");l.fNodes.Add(j);l.fNodes.Add(i);return l};b.GEO.provideVisStyle=function(k){if((k._typename==="TEveGeoShapeExtract")||(k._typename==="ROOT::Experimental::TEveGeoShapeExtract")){return k.fRnrSelf?" geovis_this":""}var j=!b.GEO.TestBit(k,b.GEO.BITS.kVisNone)&&b.GEO.TestBit(k,b.GEO.BITS.kVisThis);var i=b.GEO.TestBit(k,b.GEO.BITS.kVisDaughters)||b.GEO.TestBit(k,b.GEO.BITS.kVisOneLevel);if(i&&(!k.fNodes||(k.fNodes.arr.length===0))){i=false}if(j&&i){return" geovis_all"}if(j){return" geovis_this"}if(i){return" geovis_daughters"}return""};b.GEO.getBrowserItem=function(i,k,j){if(i._geoobj){i._geoobj.$geoh=true}b.CallBack(j,i,i._geoobj)};b.GEO.createItem=function(n,p,j){var l={_kind:"ROOT."+p._typename,_name:j?j:b.GEO.ObjectName(p),_title:p.fTitle,_parent:n,_geoobj:p,_get:b.GEO.getBrowserItem};var m,i,o,k=false;if(p._typename=="TGeoMaterial"){l._icon="img_geomaterial"}else{if(p._typename=="TGeoMedium"){l._icon="img_geomedium"}else{if(p._typename=="TGeoMixture"){l._icon="img_geomixture"}else{if((p._typename.indexOf("TGeoNode")===0)&&p.fVolume){l._title="node:"+p._typename;if(p.fTitle.length>0){l._title+=" "+p.fTitle}m=p.fVolume}else{if(p._typename.indexOf("TGeoVolume")===0){m=p}else{if((p._typename=="TEveGeoShapeExtract")||(p._typename=="ROOT::Experimental::TEveGeoShapeExtract")){k=true;i=p.fShape;o=p.fElements?p.fElements.arr:null}else{if((p.fShapeBits!==undefined)&&(p.fShapeId!==undefined)){i=p}}}}}}}if(m){i=m.fShape;o=m.fNodes?m.fNodes.arr:null}if(m||i||o){if(m){l._volume=m}if(o){l._more=true;l._expand=b.GEO.expandObject}else{if(i&&(i._typename==="TGeoCompositeShape")&&i.fNode){l._more=true;l._shape=i;l._expand=function(q,r){b.GEO.createItem(q,q._shape.fNode.fLeft,"Left");b.GEO.createItem(q,q._shape.fNode.fRight,"Right");return true}}}if(!l._title&&(p._typename!="TGeoVolume")){l._title=p._typename}if(i){if(l._title==""){l._title=i._typename}l._icon=b.GEO.getShapeIcon(i)}else{l._icon=l._more?"img_geocombi":"img_geobbox"}if(m){l._icon+=b.GEO.provideVisStyle(m)}else{if(k){l._icon+=b.GEO.provideVisStyle(p)}}l._menu=b.GEO.provideMenu;l._icon_click=b.GEO.browserIconClick}if(!n._childs){n._childs=[]}if(!l._name){if(typeof n._name==="string"){l._name=n._name;if(l._name.lastIndexOf("s")===l._name.length-1){l._name=l._name.substr(0,l._name.length-1)}l._name+="_"+n._childs.length}else{l._name="item_"+n._childs.length}}n._childs.push(l);return l};b.GEO.createList=function(k,i,j,m){if(!i||!("arr" in i)||(i.arr.length==0)){return}var l={_name:j,_kind:"ROOT.TList",_title:m,_more:true,_geoobj:i,_parent:k};l._get=function(n,p,o){if("_geoobj" in n){return b.CallBack(o,n,n._geoobj)}b.CallBack(o,n,null)};l._expand=function(p,o){if("fVolume" in o){o=o.fVolume.fNodes}if(!("arr" in o)){return false}p._childs=[];b.GEO.CheckDuplicates(null,o.arr);for(var q in o.arr){b.GEO.createItem(p,o.arr[q])}return true};if(!k._childs){k._childs=[]}k._childs.push(l)};b.GEO.provideMenu=function(i,q,j){if(!q._geoobj){return false}var m=q._geoobj,k=q._volume,l=((m._typename==="TEveGeoShapeExtract")||(m._typename==="ROOT::Experimental::TEveGeoShapeExtract"));if(!k&&!l){return false}i.add("separator");function r(u,t,s){if(!t){t={visible:0,hidden:0}}if(!s){if(t.assign!==undefined){u.fRnrSelf=t.assign}else{if(u.fRnrSelf){t.vis++}else{t.hidden++}}}if(u.fElements){for(var v=0;v<u.fElements.arr.length;++v){r(u.fElements.arr[v],t,false)}}return t}function n(s){if(s==="self"){m.fRnrSelf=!m.fRnrSelf;q._icon=q._icon.split(" ")[0]+b.GEO.provideVisStyle(m);j.UpdateTreeNode(q)}else{r(m,{assign:(s==="true")},true);j.ForEach(function(t){if(t._geoobj&&t._icon){t._icon=q._icon.split(" ")[0]+b.GEO.provideVisStyle(t._geoobj);j.UpdateTreeNode(t)}},q)}b.GEO.findItemWithPainter(q,"testGeomChanges")}function p(s){b.GEO.ToggleBit(k,s);var t=q._icon.split(" ")[0]+b.GEO.provideVisStyle(k);j.ForEach(function(u){if(q._volume===u._volume){u._icon=t;j.UpdateTreeNode(u)}});j.UpdateTreeNode(q);b.GEO.findItemWithPainter(q,"testGeomChanges")}if((q._geoobj._typename.indexOf("TGeoNode")===0)&&b.GEO.findItemWithPainter(q)){i.add("Focus",function(){var t=b.GEO.findItemWithPainter(q);if(!t){return}var s=j.itemFullName(q,t);if(t._painter&&typeof t._painter.focusOnItem=="function"){t._painter.focusOnItem(s)}})}if(l){i.addchk(m.fRnrSelf,"Visible","self",n);var o=r(m,undefined,true);if(o.hidden+o.visible>0){i.addchk((o.hidden==0),"Daughters",(o.hidden!=0)?"true":"false",n)}}else{i.addchk(b.GEO.TestBit(k,b.GEO.BITS.kVisNone),"Invisible",b.GEO.BITS.kVisNone,p);i.addchk(b.GEO.TestBit(k,b.GEO.BITS.kVisThis),"Visible",b.GEO.BITS.kVisThis,p);i.addchk(b.GEO.TestBit(k,b.GEO.BITS.kVisDaughters),"Daughters",b.GEO.BITS.kVisDaughters,p);i.addchk(b.GEO.TestBit(k,b.GEO.BITS.kVisOneLevel),"1lvl daughters",b.GEO.BITS.kVisOneLevel,p)}return true};b.GEO.findItemWithPainter=function(j,i){while(j){if(j._painter&&j._painter._camera){if(i&&typeof j._painter[i]=="function"){j._painter[i]()}return j}j=j._parent}return null};b.GEO.updateBrowserIcons=function(j,i){if(!j||!i){return}i.ForEach(function(k){if((j===k._volume)||(j===k._geoobj)){k._icon=k._icon.split(" ")[0]+b.GEO.provideVisStyle(j);i.UpdateTreeNode(k)}})};b.GEO.browserIconClick=function(j,l){if(j._volume){if(j._more&&j._volume.fNodes&&(j._volume.fNodes.arr.length>0)){b.GEO.ToggleBit(j._volume,b.GEO.BITS.kVisDaughters)}else{b.GEO.ToggleBit(j._volume,b.GEO.BITS.kVisThis)}b.GEO.updateBrowserIcons(j._volume,l);b.GEO.findItemWithPainter(j,"testGeomChanges");return false}if(j._geoobj&&((j._geoobj._typename=="TEveGeoShapeExtract")||(j._geoobj._typename=="ROOT::Experimental::TEveGeoShapeExtract"))){j._geoobj.fRnrSelf=!j._geoobj.fRnrSelf;b.GEO.updateBrowserIcons(j._geoobj,l);b.GEO.findItemWithPainter(j,"testGeomChanges");return false}var k=b.GEO.findItemWithPainter(j);if(!k){return false}var i=k._painter.ExtraObjectVisible(l,j,true);return(i!==undefined)?true:false};b.GEO.getShapeIcon=function(i){switch(i._typename){case"TGeoArb8":return"img_geoarb8";break;case"TGeoCone":return"img_geocone";break;case"TGeoConeSeg":return"img_geoconeseg";break;case"TGeoCompositeShape":return"img_geocomposite";break;case"TGeoTube":return"img_geotube";break;case"TGeoTubeSeg":return"img_geotubeseg";break;case"TGeoPara":return"img_geopara";break;case"TGeoParaboloid":return"img_geoparab";break;case"TGeoPcon":return"img_geopcon";break;case"TGeoPgon":return"img_geopgon";break;case"TGeoShapeAssembly":return"img_geoassembly";break;case"TGeoSphere":return"img_geosphere";break;case"TGeoTorus":return"img_geotorus";break;case"TGeoTrd1":return"img_geotrd1";break;case"TGeoTrd2":return"img_geotrd2";break;case"TGeoXtru":return"img_geoxtru";break;case"TGeoTrap":return"img_geotrap";break;case"TGeoGtra":return"img_geogtra";break;case"TGeoEltu":return"img_geoeltu";break;case"TGeoHype":return"img_geohype";break;case"TGeoCtub":return"img_geoctub";break}return"img_geotube"};b.GEO.getBrowserIcon=function(i,l){var j="";if(i._kind=="ROOT.TEveTrack"){j="img_evetrack"}else{if(i._kind=="ROOT.TEvePointSet"){j="img_evepoints"}else{if(i._kind=="ROOT.TPolyMarker3D"){j="img_evepoints"}}}if(j.length>0){var k=b.GEO.findItemWithPainter(i);if(k){if(k._painter.ExtraObjectVisible(l,i)){j+=" geovis_this"}}}return j};b.GEO.expandObject=function(s,o){if(!s||!o){return false}var p=(o._typename.indexOf("TGeoNode")===0),k=(o._typename.indexOf("TGeoVolume")===0),l=(o._typename==="TGeoManager"),m=((o._typename==="TEveGeoShapeExtract")||(o._typename==="ROOT::Experimental::TEveGeoShapeExtract"));if(!p&&!k&&!l&&!m){return false}if(s._childs){return true}if(l){b.GEO.createList(s,o.fMaterials,"Materials","list of materials");b.GEO.createList(s,o.fMedia,"Media","list of media");b.GEO.createList(s,o.fTracks,"Tracks","list of tracks");b.GEO.SetBit(o.fMasterVolume,b.GEO.BITS.kVisThis,false);b.GEO.createItem(s,o.fMasterVolume);return true}var q,j,r;if(m){j=o.fElements?o.fElements.arr:null;r=o.fShape}else{q=(p?o.fVolume:o);j=q&&q.fNodes?q.fNodes.arr:null;r=q?q.fShape:null}if(!j&&r&&(r._typename==="TGeoCompositeShape")&&r.fNode){if(!s._childs){b.GEO.createItem(s,r.fNode.fLeft,"Left");b.GEO.createItem(s,r.fNode.fRight,"Right")}return true}if(!j){return false}b.GEO.CheckDuplicates(o,j);for(var n=0;n<j.length;++n){b.GEO.createItem(s,j[n])}return true};b.addDrawFunc({name:"TGeoVolumeAssembly",icon:"img_geoassembly",func:b.Painter.drawGeoObject,expand:b.GEO.expandObject,opt:";more;all;count"});b.addDrawFunc({name:"TEvePointSet",icon_get:b.GEO.getBrowserIcon,icon_click:b.GEO.browserIconClick});b.addDrawFunc({name:"TEveTrack",icon_get:b.GEO.getBrowserIcon,icon_click:b.GEO.browserIconClick});b.TGeoPainter=d;return b.Painter}));