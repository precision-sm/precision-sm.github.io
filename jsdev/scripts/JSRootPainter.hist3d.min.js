(function(a){if(typeof define==="function"&&define.amd){define(["JSRootCore","d3","JSRootPainter.hist","threejs","threejs_all"],a)}else{if(typeof exports==="object"&&typeof module!=="undefined"){var b=require("./JSRootCore.js");a(b,require("./d3.min.js"),require("./JSRootPainter.hist.js"),require("./three.min.js"),require("./three.extra.min.js"),b.nodejs||(typeof document=="undefined")?b.nodejs_document:document)}else{if(typeof JSROOT=="undefined"){throw new Error("JSROOT is not defined","JSRootPainter.hist3d.js")}if(typeof d3!="object"){throw new Error("This extension requires d3.js","JSRootPainter.hist3d.js")}if(typeof THREE=="undefined"){throw new Error("THREE is not defined","JSRoot3DPainter.js")}a(JSROOT,d3,JSROOT,THREE,THREE)}}}(function(c,d,h,f,b,a){c.sources.push("hist3d");if((typeof a=="undefined")&&(typeof window=="object")){a=window.document}if(typeof c.THistPainter==="undefined"){throw new Error("JSROOT.THistPainter is not defined","JSRootPainter.hist3d.js")}c.TFramePainter.prototype.Create3DScene=function(r){if((r!==undefined)&&(r<0)){if(!this.mode3d){return}this.TestAxisVisibility(null,this.toplevel);this.clear_3d_canvas();c.Painter.DisposeThreejsObject(this.scene);if(this.control){this.control.Cleanup()}if(this.renderer){if(this.renderer.dispose){this.renderer.dispose()}if(this.renderer.context){delete this.renderer.context}}delete this.size_xy3d;delete this.size_z3d;delete this.tooltip_mesh;delete this.scene;delete this.toplevel;delete this.camera;delete this.pointLight;delete this.renderer;delete this.control;if("render_tmout" in this){clearTimeout(this.render_tmout);delete this.render_tmout}this.mode3d=false;return}this.mode3d=true;if("toplevel" in this){this.scene.remove(this.toplevel);c.Painter.DisposeThreejsObject(this.toplevel);delete this.tooltip_mesh;delete this.toplevel;if(this.control){this.control.HideTooltip()}var o=new f.Object3D();this.scene.add(o);this.toplevel=o;this.Resize3D();return}this.usesvg=c.Painter.UseSVGFor3D();var p=this.size_for_3d(this.usesvg?3:undefined);this.size_z3d=100;this.size_xy3d=(p.height>10)&&(p.width>10)?Math.round(p.width/p.height*this.size_z3d):this.size_z3d;this.scene=new f.Scene();this.toplevel=new f.Object3D();this.scene.add(this.toplevel);this.scene_width=p.width;this.scene_height=p.height;this.camera=new f.PerspectiveCamera(45,this.scene_width/this.scene_height,1,40*this.size_z3d);var k=Math.max(0.75*this.size_xy3d,this.size_z3d);this.camera.position.set(-1.6*k,-3.5*k,1.4*this.size_z3d);var l=this.root_pad();if(l&&(l.fTheta!==undefined)&&(l.fPhi!==undefined)&&(l.fTheta!==30)||(l.fPhi!==30)){k=3*Math.max(this.size_xy3d,this.size_z3d);var m=(-l.fPhi-90)/180*Math.PI,j=l.fTheta/180*Math.PI;this.camera.position.set(k*Math.cos(m)*Math.cos(j),k*Math.sin(m)*Math.cos(j),this.size_z3d+k*Math.sin(j))}this.pointLight=new f.PointLight(16777215,1);this.camera.add(this.pointLight);this.pointLight.position.set(this.size_xy3d/2,this.size_xy3d/2,this.size_z3d/2);var s=new f.Vector3(0,0,0.8*this.size_z3d);this.camera.up=new f.Vector3(0,0,1);this.camera.lookAt(s);this.scene.add(this.camera);var n=c.Painter.Create3DRenderer(this.scene_width,this.scene_height,this.usesvg,(p.can3d==4));this.renderer=n.renderer;this.webgl=n.usewebgl;this.add_3d_canvas(p,n.dom);this.first_render_tm=0;this.enable_highlight=false;this.tooltip_allowed=(c.gStyle.Tooltip>0);if(c.BatchMode){return}this.control=c.Painter.CreateOrbitControl(this,this.camera,this.scene,this.renderer,s);var i=this,q=this.main_painter();this.control.ProcessMouseMove=function(C){var D=null,E=null,v=null;for(var B=0;B<C.length;++B){if(C[B].object.tooltip){D=C[B].object.tooltip(C[B]);if(D){E=C[B].object;break}}else{if(C[B].object.zoom&&!v){v=C[B].object}}}if(D&&!D.use_itself){var w=0.0001*i.size_xy3d,x=0.0001*i.size_z3d;if((D.x1>D.x2)||(D.y1>D.y2)||(D.z1>D.z2)){console.warn("check 3D hints coordinates")}D.x1-=w;D.x2+=w;D.y1-=w;D.y2+=w;D.z1-=x;D.z2+=x}i.BinHighlight3D(D,E);if(!D&&v&&i.Get3DZoomCoord){var t=v.GlobalIntersect(this.raycaster),A=v.zoom,y=i.Get3DZoomCoord(t,A);if((A==="z")&&v.use_y_for_z){A="y"}var u=i.GetAxis(A);var z={name:A,title:"TAxis",line:"any info",only_status:true};if(u){z.name=u.fName;z.title=u.fTitle||"histogram TAxis object"}z.line=A+" : "+i.AxisAsText(A,y);return z}return(D&&D.lines)?D:""};this.control.ProcessMouseLeave=function(){i.BinHighlight3D(null)};this.control.ContextMenu=function(y,u){var t="hist",v=q;if(u){for(var x=0;x<u.length;++x){var w=u[x].object;if(w.zoom){t=w.zoom;break}if(w.painter&&typeof w.painter.ShowContextMenu==="function"){v=w.painter;break}}}v.ShowContextMenu(t,y)}};c.TFramePainter.prototype.Render3D=function(m){if(m===-1111){var l=f.CreateSVGRenderer(false,0,a);l.setSize(this.scene_width,this.scene_height);l.render(this.scene,this.camera);if(l.makeOuterHTML){var k=a.createElement("div");k.innerHTML=l.makeOuterHTML();return k.childNodes[0]}return l.domElement}if(m===undefined){m=5}if((m<=0)||this.usesvg||c.BatchMode){if("render_tmout" in this){clearTimeout(this.render_tmout)}else{if(m===-2222){return}}if(this.renderer===undefined){return}var j=new Date();if(!this.opt3d){this.opt3d={FrontBox:true,BackBox:true}}this.TestAxisVisibility(this.camera,this.toplevel,this.opt3d.FrontBox,this.opt3d.BackBox);this.renderer.render(this.scene,this.camera);c.Painter.AfterRender3D(this.renderer);var i=new Date();delete this.render_tmout;if(this.first_render_tm===0){this.first_render_tm=i.getTime()-j.getTime();this.enable_highlight=(this.first_render_tm<1200)&&this.tooltip_allowed;console.log("First render tm = "+this.first_render_tm)}return}if("render_tmout" in this){return}this.render_tmout=setTimeout(this.Render3D.bind(this,0),m)};c.TFramePainter.prototype.Resize3D=function(){var i=this.size_for_3d(this.access_3d_kind());this.apply_3d_size(i);if((this.scene_width===i.width)&&(this.scene_height===i.height)){return false}if((i.width<10)||(i.height<10)){return false}this.scene_width=i.width;this.scene_height=i.height;this.camera.aspect=this.scene_width/this.scene_height;this.camera.updateProjectionMatrix();this.renderer.setSize(this.scene_width,this.scene_height);return true};c.TFramePainter.prototype.BinHighlight3D=function(s,l){var q=false,t=null,r=true,v=!s||(s.x1===undefined)||!this.enable_highlight;if(this.tooltip_selfmesh){r=(this.tooltip_selfmesh!==l);this.tooltip_selfmesh.material.color=this.tooltip_selfmesh.save_color;delete this.tooltip_selfmesh;q=true}if(this.tooltip_mesh){t=this.tooltip_mesh;this.toplevel.remove(this.tooltip_mesh);delete this.tooltip_mesh;q=true}if(v){if(q){this.Render3D()}this.ProvideUserTooltip(null);return}if(s.use_itself){l.save_color=l.material.color;l.material.color=new f.Color(s.color);this.tooltip_selfmesh=l;q=r}else{q=true;var i=c.Painter.Box3D.Indexes,u=c.Painter.Box3D.Normals,p=c.Painter.Box3D.Vertices,o,n,x=new f.Color(s.color?s.color:16711680),m=s.opacity||1;if(!t){o=new Float32Array(i.length*3);n=new Float32Array(i.length*3);var w=new f.BufferGeometry();w.addAttribute("position",new f.BufferAttribute(o,3));w.addAttribute("normal",new f.BufferAttribute(n,3));var A=new f.MeshBasicMaterial({color:x,opacity:m,shading:f.SmoothShading});t=new f.Mesh(w,A)}else{o=t.geometry.attributes.position.array;t.geometry.attributes.position.needsUpdate=true;t.material.color=x;t.material.opacity=m}if(s.x1===s.x2){console.warn("same tip X",s.x1,s.x2)}if(s.y1===s.y2){console.warn("same tip Y",s.y1,s.y2)}if(s.z1===s.z2){s.z2=s.z1+0.0001}for(var y=0,j=-3;y<i.length;++y){var z=p[i[y]];o[y*3]=s.x1+z.x*(s.x2-s.x1);o[y*3+1]=s.y1+z.y*(s.y2-s.y1);o[y*3+2]=s.z1+z.z*(s.z2-s.z1);if(n){if(y%6===0){j+=3}n[y*3]=u[j];n[y*3+1]=u[j+1];n[y*3+2]=u[j+2]}}this.tooltip_mesh=t;this.toplevel.add(t)}if(q){this.Render3D()}if(this.GetObject()){this.ProvideUserTooltip({obj:this.GetObject(),name:this.GetObject().fName,bin:s.bin,cont:s.value,binx:s.ix,biny:s.iy,binz:s.iz,grx:(s.x1+s.x2)/2,gry:(s.y1+s.y2)/2,grz:(s.z1+s.z2)/2})}};c.TFramePainter.prototype.TestAxisVisibility=function(o,t,k,q){var s;if(t&&t.children){for(var j=0;j<t.children.length;++j){s=t.children[j];if(s.axis_draw){break}s=undefined}}if(!s){return}if(!o){t.remove(s);return}k=k?true:false;q=q?true:false;var p=1,r=o.position;if((r.x<0)&&(r.y>=0)){p=2}if((r.x>=0)&&(r.y>=0)){p=3}if((r.x>=0)&&(r.y<0)){p=4}function l(v,n){if(v<=p){v+=4}return(v>p)&&(v<p+n)}for(var j=0;j<s.children.length;++j){var u=s.children[j];if(u.grid){u.visible=q&&l(u.grid,3)}else{if(u.zid){u.visible=l(u.zid,2)}else{if(u.xyid){u.visible=l(u.xyid,3)}else{if(u.xyboxid){var m=5,i=0;if(q&&!k){m=3;i=-2}else{if(k&&!q){m=3}else{if(!k&&!q){m=(u.bottom?3:0)}}}u.visible=l(u.xyboxid+i,m);if(!u.visible&&u.bottom&&q){u.visible=l(u.xyboxid,3)}}else{if(u.zboxid){var m=2,i=0;if(k&&q){m=5}else{if(q&&!k){m=4}else{if(!q&&k){i=-2;m=4}}}u.visible=l(u.zboxid+i,m)}}}}}}};c.TFramePainter.prototype.Set3DOptions=function(i){this.opt3d=i};c.TFramePainter.prototype.DrawXYZ=function(H,Y){if(!Y){Y={}}var P=-this.size_xy3d,p=this.size_xy3d,O=-this.size_xy3d,o=this.size_xy3d,M=0,k=2*this.size_z3d,aj=Math.round(this.size_z3d*0.05),J=this.root_pad(),y=this.xmin,am=this.xmax,ag=this.ymin,r=this.ymax,l=this.zmin,Z=this.zmax,A=false,F=false;if(!this.size_z3d){P=this.xmin;p=this.xmax;O=this.ymin;o=this.ymax;M=this.zmin;k=this.zmax;aj=(k-M)*0.05}if(("zoom_xmin" in this)&&("zoom_xmax" in this)&&(this.zoom_xmin!==this.zoom_xmax)){y=this.zoom_xmin;am=this.zoom_xmax}if(("zoom_ymin" in this)&&("zoom_ymax" in this)&&(this.zoom_ymin!==this.zoom_ymax)){ag=this.zoom_ymin;r=this.zoom_ymax;A=true}if(("zoom_zmin" in this)&&("zoom_zmax" in this)&&(this.zoom_zmin!==this.zoom_zmax)){l=this.zoom_zmin;Z=this.zoom_zmax;F=true}if(Y.use_y_for_z){this.zmin=this.ymin;this.zmax=this.ymax;l=ag;Z=r;F=A;ag=0;r=1}this.lego_zmin=l;this.lego_zmax=Z;if((Y.zmult!==undefined)&&!F){Z*=Y.zmult}if(J&&J.fLogx){if(am<=0){am=1}if((y<=0)&&this.xaxis){for(var av=0;av<this.xaxis.fNbins;++av){y=Math.max(y,this.xaxis.GetBinLowEdge(av+1));if(y>0){break}}}if(y<=0){y=0.0001*am}this.grx=d.scaleLog();this.x_kind="log"}else{this.grx=d.scaleLinear();if(this.xaxis&&this.xaxis.fLabels){this.x_kind="labels"}else{this.x_kind="normal"}}this.logx=(this.x_kind==="log");this.grx.domain([y,am]).range([P,p]);this.x_handle=new c.TAxisPainter(this.xaxis);this.x_handle.SetAxisConfig("xaxis",this.x_kind,this.grx,this.xmin,this.xmax,y,am);this.x_handle.CreateFormatFuncs();this.scale_xmin=y;this.scale_xmax=am;if(J&&J.fLogy&&!Y.use_y_for_z){if(r<=0){r=1}if((ag<=0)&&this.yaxis){for(var av=0;av<this.yaxis.fNbins;++av){ag=Math.max(ag,this.yaxis.GetBinLowEdge(av+1));if(ag>0){break}}}if(ag<=0){ag=0.0001*r}this.gry=d.scaleLog();this.y_kind="log"}else{this.gry=d.scaleLinear();if(this.yaxis&&this.yaxis.fLabels){this.y_kind="labels"}else{this.y_kind="normal"}}this.logy=(this.y_kind==="log");this.gry.domain([ag,r]).range([O,o]);this.y_handle=new c.TAxisPainter(this.yaxis);this.y_handle.SetAxisConfig("yaxis",this.y_kind,this.gry,this.ymin,this.ymax,ag,r);this.y_handle.CreateFormatFuncs();this.scale_ymin=ag;this.scale_ymax=r;if(J&&J.fLogz){if(Z<=0){Z=1}if(l<=0){l=0.0001*Z}this.grz=d.scaleLog();this.z_kind="log"}else{this.grz=d.scaleLinear();this.z_kind="normal";if(this.zaxis&&this.zaxis.fLabels&&(Y.ndim===3)){this.z_kind="labels"}}this.logz=(this.z_kind==="log");this.grz.domain([l,Z]).range([M,k]);this.SetRootPadRange(J,true);this.z_handle=new c.TAxisPainter(this.zaxis);this.z_handle.SetAxisConfig("zaxis",this.z_kind,this.grz,this.zmin,this.zmax,l,Z);this.z_handle.CreateFormatFuncs();this.scale_zmin=l;this.scale_zmax=Z;this.x_handle.debug=true;var G=new f.MeshBasicMaterial({color:0}),B=new f.LineBasicMaterial({color:0}),ak=aj*0.5,aa,j,X=[],U=1,ai=this.x_handle.CreateTicks(false,true),w=this.y_handle.CreateTicks(false,true),al=this.z_handle.CreateTicks(false,true);var s=new f.Object3D();s.axis_draw=true;H.add(s);var ao=[],ax=0,af=this.xaxis;while(ai.next()){var ae=ai.grpos,ar=(ai.kind===1),N=this.x_handle.format(ai.tick,true,true);if(ai.last_major()){if(!af||!af.fTitle){N="x"}}else{if(N===null){ar=false;N=""}}if(ar&&N&&(N.length>0)){var L=new f.TextGeometry(N,{font:c.threejs_font_helvetiker_regular,size:aj,height:0,curveSegments:5});L.computeBoundingBox();var D=L.boundingBox.max.x-L.boundingBox.min.x,C=L.boundingBox.max.y-L.boundingBox.min.y;L.center=true;ax=Math.max(ax,C);L.grx=ae;X.push(L);if(!ai.last_major()){var aw=(ai.next_major_grpos()-ae);if(D>0){U=Math.min(U,0.9*aw/D)}if(this.x_handle.IsCenterLabels()){L.grx+=aw/2}}}ao.push(ae,0,0,ae,(ar?-ak:-ak*0.6),0)}if(af&&af.fTitle){var L=new f.TextGeometry(af.fTitle,{font:c.threejs_font_helvetiker_regular,size:aj,height:0,curveSegments:5});L.computeBoundingBox();L.center=(af.TestBit(c.EAxisBits.kCenterTitle));L.gry=2;L.grx=(P+p)/2;X.push(L)}this.Get3DZoomCoord=function(m,aA){var aB=m[aA],n=this["scale_"+aA+"min"],i=this["scale_"+aA+"max"];if(aA==="z"){aB=aB/2/this.size_z3d}else{aB=(aB+this.size_xy3d)/2/this.size_xy3d}if(this["log"+aA]){aB=Math.exp(Math.log(n)+aB*(Math.log(i)-Math.log(n)))}else{aB=n+aB*(i-n)}return aB};function an(n,aA,aC){var i=new f.Geometry();if(n==="z"){i.vertices.push(new f.Vector3(0,0,0),new f.Vector3(ak*4,0,0),new f.Vector3(ak*4,0,2*aA),new f.Vector3(0,0,2*aA))}else{i.vertices.push(new f.Vector3(-aA,0,0),new f.Vector3(aA,0,0),new f.Vector3(aA,-ak*4,0),new f.Vector3(-aA,-ak*4,0))}i.faces.push(new f.Face3(0,2,1));i.faces.push(new f.Face3(0,3,2));i.computeFaceNormals();var m=new f.MeshBasicMaterial({transparent:true,vertexColors:f.NoColors,side:f.DoubleSide,opacity:0});var aB=new f.Mesh(i,m);aB.zoom=n;aB.size_3d=aA;aB.use_y_for_z=aC;if(n=="y"){aB.rotateZ(Math.PI/2).rotateX(Math.PI)}aB.GlobalIntersect=function(aF){var aE=new f.Plane(),aH=this.geometry;aE.setFromCoplanarPoints(aH.vertices[0],aH.vertices[1],aH.vertices[2]);aE.applyMatrix4(this.matrixWorld);var aK=aF.ray.origin.clone(),aJ=aK.clone().addScaledVector(aF.ray.direction,10000000000);var aI=aE.intersectLine(new f.Line3(aK,aJ));if(!aI){return undefined}var aG=-this.size_3d,aD=this.size_3d;if(this.zoom==="z"){aG=0;aD=2*this.size_3d}if(aI[this.zoom]<aG){aI[this.zoom]=aG}else{if(aI[this.zoom]>aD){aI[this.zoom]=aD}}return aI};aB.ShowSelection=function(aD,aH){var aG=this.children[0],aE,aF=this.zoom;if(!aD||!aH){if(aG){this.remove(aG);c.Painter.DisposeThreejsObject(aG)}return aG}if(!aG){aE=this.geometry.clone();if(aF==="z"){aE.vertices[1].x=aE.vertices[2].x=ak}else{aE.vertices[2].y=aE.vertices[3].y=-ak}aG=new f.Mesh(aE,new f.MeshBasicMaterial({color:65280,side:f.DoubleSide}));this.add(aG)}else{aE=aG.geometry}if(aF=="z"){aE.vertices[0].z=aE.vertices[1].z=aD[aF];aE.vertices[2].z=aE.vertices[3].z=aH[aF]}else{aE.vertices[0].x=aE.vertices[3].x=aD[aF];aE.vertices[1].x=aE.vertices[2].x=aH[aF]}aE.computeFaceNormals();aE.verticesNeedUpdate=true;aE.normalsNeedUpdate=true;return true};return aB}var ap=new f.Object3D();ap.position.set(0,O,M);ap.rotation.x=1/4*Math.PI;ap.xyid=2;var z=c.Painter.createLineSegments(ao,B);ap.add(z);X.forEach(function(aB){var aA=aB.boundingBox.max.x-aB.boundingBox.min.x,n=aB.center?aB.grx-aA/2:p-aA,i=new f.Matrix4();i.set(U,0,0,n,0,U,0,(-ax*U-1.5*ak)*(aB.gry||1),0,0,1,0,0,0,0,1);var aC=new f.Mesh(aB,G);aC.applyMatrix(i);ap.add(aC)});if(Y.zoom){ap.add(an("x",this.size_xy3d))}s.add(ap);ap=new f.Object3D();ap.position.set(0,o,M);ap.rotation.x=3/4*Math.PI;ap.add(new f.LineSegments(z.geometry,B));X.forEach(function(aB){var aA=aB.boundingBox.max.x-aB.boundingBox.min.x,n=aB.center?aB.grx+aA/2:p,i=new f.Matrix4();i.set(-U,0,0,n,0,U,0,(-ax*U-1.5*ak)*(aB.gry||1),0,0,-1,0,0,0,0,1);var aC=new f.Mesh(aB,G);aC.applyMatrix(i);ap.add(aC)});ap.xyid=4;if(Y.zoom){ap.add(an("x",this.size_xy3d))}s.add(ap);X=[];U=1;ax=0;ao=[];var K=this.yaxis;while(w.next()){var ad=w.grpos,ar=(w.kind===1),N=this.y_handle.format(w.tick,true,true);if(w.last_major()){if(!K||!K.fTitle){N="y"}}else{if(N===null){ar=false;N=""}}if(ar){var L=new f.TextGeometry(N,{font:c.threejs_font_helvetiker_regular,size:aj,height:0,curveSegments:5});L.computeBoundingBox();var D=L.boundingBox.max.x-L.boundingBox.min.x,C=L.boundingBox.max.y-L.boundingBox.min.y;L.center=true;ax=Math.max(ax,C);L.gry=ad;X.push(L);if(!w.last_major()){var aw=(w.next_major_grpos()-ad);if(D>0){U=Math.min(U,0.9*aw/D)}if(this.y_handle.IsCenterLabels()){L.gry+=aw/2}}}ao.push(0,ad,0,(ar?-ak:-ak*0.6),ad,0)}if(K&&K.fTitle){var L=new f.TextGeometry(K.fTitle,{font:c.threejs_font_helvetiker_regular,size:aj,height:0,curveSegments:5});L.computeBoundingBox();L.center=K.TestBit(c.EAxisBits.kCenterTitle);L.grx=2;L.gry=(O+o)/2;X.push(L)}if(!Y.use_y_for_z){var az=c.Painter.createLineSegments(ao,B),ab=new f.Object3D();ab.position.set(P,0,M);ab.rotation.y=-1/4*Math.PI;ab.add(az);X.forEach(function(aA){var n=aA.boundingBox.max.x-aA.boundingBox.min.x,aC=aA.center?aA.gry+n/2:o,i=new f.Matrix4();i.set(0,U,0,(-ax*U-1.5*ak)*(aA.grx||1),-U,0,0,aC,0,0,1,0,0,0,0,1);var aB=new f.Mesh(aA,G);aB.applyMatrix(i);ab.add(aB)});ab.xyid=3;if(Y.zoom){ab.add(an("y",this.size_xy3d))}s.add(ab);ab=new f.Object3D();ab.position.set(p,0,M);ab.rotation.y=-3/4*Math.PI;ab.add(new f.LineSegments(az.geometry,B));X.forEach(function(aA){var n=aA.boundingBox.max.x-aA.boundingBox.min.x,aC=aA.center?aA.gry-n/2:o-n,i=new f.Matrix4();i.set(0,U,0,(-ax*U-1.5*ak)*(aA.grx||1),U,0,0,aC,0,0,-1,0,0,0,0,1);var aB=new f.Mesh(aA,G);aB.applyMatrix(i);ab.add(aB)});ab.xyid=1;if(Y.zoom){ab.add(an("y",this.size_xy3d))}s.add(ab)}X=[];U=1;ao=[];var W=null,V=null,ay=null,q=this.zaxis,T=0;if(this.size_z3d){W=[];V=[]}while(al.next()){var ac=al.grpos,ar=(al.kind==1),N=this.z_handle.format(al.tick,true,true);if(N===null){ar=false;N=""}if(ar&&N){var L=new f.TextGeometry(N,{font:c.threejs_font_helvetiker_regular,size:aj,height:0,curveSegments:5});L.computeBoundingBox();var D=L.boundingBox.max.x-L.boundingBox.min.x,C=L.boundingBox.max.y-L.boundingBox.min.y;L.translate(-D,-C/2,0);L.grz=ac;X.push(L);if((ay!==null)&&(C>0)){U=Math.min(U,0.9*(ac-ay)/C)}T=Math.max(T,D);ay=ac}if(W&&ar){W.push(P,0,ac,p,0,ac)}if(V&&ar){V.push(0,O,ac,0,o,ac)}ao.push(0,0,ac,(ar?ak:ak*0.6),0,ac)}if(W&&(W.length>0)){var au=new f.LineDashedMaterial({color:0,dashSize:2,gapSize:2});var R=c.Painter.createLineSegments(W,au);R.position.set(0,o,0);R.grid=2;R.visible=false;s.add(R);var Q=new f.LineSegments(R.geometry,au);Q.position.set(0,O,0);Q.grid=4;Q.visible=false;s.add(Q)}if(V&&(V.length>0)){var au=new f.LineDashedMaterial({color:0,dashSize:2,gapSize:2});var R=c.Painter.createLineSegments(V,au);R.position.set(p,0,0);R.grid=3;R.visible=false;s.add(R);var Q=new f.LineSegments(R.geometry,au);Q.position.set(P,0,0);Q.grid=1;Q.visible=false;s.add(Q)}var E=[],u=c.Painter.createLineSegments(ao,B);for(var aq=0;aq<4;++aq){E.push(new f.Object3D());X.forEach(function(n){var i=new f.Matrix4();i.set(-U,0,0,2*ak,0,0,1,0,0,U,0,n.grz);var aA=new f.Mesh(n,G);aA.applyMatrix(i);E[aq].add(aA)});if(q&&q.fTitle){var L=new f.TextGeometry(q.fTitle,{font:c.threejs_font_helvetiker_regular,size:aj,height:0,curveSegments:5});L.computeBoundingBox();var D=L.boundingBox.max.x-L.boundingBox.min.x,C=L.boundingBox.max.y-L.boundingBox.min.y,I=q.TestBit(c.EAxisBits.kCenterTitle)?(k+M-D)/2:k-D;L.rotateZ(Math.PI/2);var at=new f.Matrix4();at.set(-U,0,0,3*ak+T,0,0,1,0,0,U,0,I);var S=new f.Mesh(L,G);S.applyMatrix(at);E[aq].add(S)}E[aq].add(aq==0?u:new f.LineSegments(u.geometry,B));if(Y.zoom){E[aq].add(an("z",this.size_z3d,Y.use_y_for_z))}E[aq].zid=aq+2;s.add(E[aq])}E[0].position.set(P,o,0);E[0].rotation.z=3/4*Math.PI;E[1].position.set(p,o,0);E[1].rotation.z=1/4*Math.PI;E[2].position.set(p,O,0);E[2].rotation.z=-1/4*Math.PI;E[3].position.set(P,O,0);E[3].rotation.z=-3/4*Math.PI;if(this.size_z3d===0){return}var t=c.Painter.createLineSegments([P,0,0,p,0,0],B,null,true);for(var aq=0;aq<2;++aq){var x=new f.LineSegments(t,B);x.position.set(0,O,(aq===0)?M:k);x.xyboxid=2;x.bottom=(aq==0);s.add(x);x=new f.LineSegments(t,B);x.position.set(0,o,(aq===0)?M:k);x.xyboxid=4;x.bottom=(aq==0);s.add(x)}var ah=c.Painter.createLineSegments([0,O,0,0,o,0],B,null,true);for(var aq=0;aq<2;++aq){var x=new f.LineSegments(ah,B);x.position.set(P,0,(aq===0)?M:k);x.xyboxid=3;x.bottom=(aq==0);s.add(x);x=new f.LineSegments(ah,B);x.position.set(p,0,(aq===0)?M:k);x.xyboxid=1;x.bottom=(aq==0);s.add(x)}var v=c.Painter.createLineSegments([0,0,M,0,0,k],B,null,true);for(var aq=0;aq<4;++aq){var x=new f.LineSegments(v,B);x.zboxid=E[aq].zid;x.position.copy(E[aq].position);s.add(x)}};c.THistPainter.prototype.Draw3DBins=function(){if(!this.draw_content){return}if(this.IsTH2Poly()&&this.DrawPolyLego){return this.DrawPolyLego()}if((this.Dimension()==2)&&this.options.Contour&&this.DrawContour3D){return this.DrawContour3D(true)}if((this.Dimension()==2)&&this.options.Surf&&this.DrawSurf){return this.DrawSurf()}if((this.Dimension()==2)&&this.options.Error&&this.DrawError){return this.DrawError()}var ae=c.Painter.Box3D.Vertices,Q=c.Painter.Box3D.Indexes,aK=c.Painter.Box3D.Normals,aE=c.Painter.Box3D.Segments,J=[0,1,1,2,2,3,3,0],aM=[new f.Vector3(0,0,0),new f.Vector3(0,1,0),new f.Vector3(1,1,0),new f.Vector3(1,0,0)],A=this.frame_painter(),aG=A.grz.domain()[0],z=A.grz.domain()[1],aj=this.PrepareColorDraw({rounding:false,use3d:true,extra:1}),an=aj.i1,am=aj.i2,ac=aj.j1,ab=aj.j2,T,S,F,E,s,r,at,ar,ai,ao,aC,m=this,t=this.GetHisto(),Z=t?t.$baseh:null,ad=(this.options.Lego===11)||(this.options.Lego===13);if((an>=am)||(ac>=ab)){return}function ax(i,j,v){ar=t.getBinContent(i+1,j+1);if(Z){at=Z.getBinContent(i+1,j+1)}else{if(m.options.BaseLine!==false){at=m.options.BaseLine}else{at=m.options.Zero?aG:0}}if(ar<at){var k=at;at=ar;ar=k}if((at>=O)||(ar<y)){return false}ai=(ar===y)||(at>=ar);if(!ai||(v>0)){return true}if(t["$baseh"]){return false}if(m.options.Zero||(aG>0)){return true}return m._show_empty_bins}var N=(this.histo.getBin(am,ab)<65535),ah=[aG,z],U=null,ay=0;if((this.options.Lego===12)||(this.options.Lego===14)){ah=this.CreateContour(t.fContour?t.fContour.length:20,A.lego_zmin,A.lego_zmax);U=this.GetPalette()}for(var av=0;av<ah.length-1;++av){var y=ah[av],O=ah[av+1],aH=0,aF=0,l=0,C=0;if(U&&(av==ah.length-2)&&O<z){O=z}var aq=A.grz(y),aL=A.grz(O);for(T=an;T<am;++T){for(S=ac;S<ab;++S){if(!ax(T,S,av)){continue}ao=!ai&&(av>0);aC=!ai&&(ar>O)&&(av<ah.length-2);l+=(ai?12:Q.length);if(ao){l-=6}if(aC){l-=6}if(ad&&!ai){l-=12;C+=12}}}ay+=l+C;var u=new Float32Array(l*3),aD=new Float32Array(l*3),ak=N?new Uint16Array(l):new Uint32Array(l),X=null,al=null,B=null,L=0,ag=0,az,H,R,af;if(C>0){X=new Float32Array(C*3);al=new Float32Array(C*3);B=N?new Uint16Array(C):new Uint32Array(C)}for(T=an;T<am;++T){F=aj.grx[T]+aj.xbar1*(aj.grx[T+1]-aj.grx[T]);E=aj.grx[T]+aj.xbar2*(aj.grx[T+1]-aj.grx[T]);for(S=ac;S<ab;++S){if(!ax(T,S,av)){continue}ao=!ai&&(av>0);aC=!ai&&(ar>O)&&(av<ah.length-2);s=aj.gry[S]+aj.ybar1*(aj.gry[S+1]-aj.gry[S]);r=aj.gry[S]+aj.ybar2*(aj.gry[S+1]-aj.gry[S]);aH=(at<=y)?aq:A.grz(at);aF=(ar>O)?aL:A.grz(ar);af=0;R=0;if(ai){af+=12;R+=24}var M=Q.length,n=this.histo.getBin(T+1,S+1);if(ao){M-=6}while(R<M){az=ae[Q[R]];if(ad&&(R<12)){X[ag]=F+az.x*(E-F);X[ag+1]=s+az.y*(r-s);X[ag+2]=aH+az.z*(aF-aH);al[ag]=aK[af];al[ag+1]=aK[af+1];al[ag+2]=aK[af+2];B[ag/3]=n;ag+=3}else{u[L]=F+az.x*(E-F);u[L+1]=s+az.y*(r-s);u[L+2]=aH+az.z*(aF-aH);aD[L]=aK[af];aD[L+1]=aK[af+1];aD[L+2]=aK[af+2];ak[L/3]=n;L+=3}++R;if(R%6===0){af+=3;if(aC&&(R===Q.length-12)){R+=6;af+=3}}}}}var ap=new f.BufferGeometry();ap.addAttribute("position",new f.BufferAttribute(u,3));ap.addAttribute("normal",new f.BufferAttribute(aD,3));var au=t.fFillColor,x=this.get_color(au);if(U){x=U.calcColor(av,ah.length)}else{if((this.options.Lego===1)||(au<2)){au=1;x="white"}}var aJ=new f.MeshBasicMaterial({color:x,shading:f.SmoothShading});var W=new f.Mesh(ap,aJ);W.bins_index=ak;W.painter=this;W.zmin=aG;W.zmax=z;W.baseline=(this.options.BaseLine===false)?aG:this.options.BaseLine;W.tip_color=(au===3)?16711680:65280;W.handle=aj;W.tooltip=function(j){if((j.index<0)||(j.index>=this.bins_index.length)){return null}var i=this.painter,aQ=this.handle,k=i.frame_painter(),aO=i.GetHisto(),aR=i.Get3DToolTip(this.bins_index[j.index]);aR.x1=Math.max(-k.size_xy3d,aQ.grx[aR.ix-1]+aQ.xbar1*(aQ.grx[aR.ix]-aQ.grx[aR.ix-1]));aR.x2=Math.min(k.size_xy3d,aQ.grx[aR.ix-1]+aQ.xbar2*(aQ.grx[aR.ix]-aQ.grx[aR.ix-1]));aR.y1=Math.max(-k.size_xy3d,aQ.gry[aR.iy-1]+aQ.ybar1*(aQ.gry[aR.iy]-aQ.gry[aR.iy-1]));aR.y2=Math.min(k.size_xy3d,aQ.gry[aR.iy-1]+aQ.ybar2*(aQ.gry[aR.iy]-aQ.gry[aR.iy-1]));var aP=this.baseline,aN=aR.value;if(aO["$baseh"]){aP=aO["$baseh"].getBinContent(aR.ix,aR.iy)}if(aN<aP){var aS=aP;aP=aN;aN=aS}aR.z1=k.grz(Math.max(this.zmin,aP));aR.z2=k.grz(Math.min(this.zmax,aN));aR.color=this.tip_color;return aR};A.toplevel.add(W);if(C>0){var aw=new f.BufferGeometry();aw.addAttribute("position",new f.BufferAttribute(X,3));aw.addAttribute("normal",new f.BufferAttribute(al,3));var q=(au<2)?new f.Color(16711680):new f.Color(d.rgb(x).darker(0.5).toString());var aA=new f.MeshBasicMaterial({color:q,shading:f.SmoothShading});var I=new f.Mesh(aw,aA);I.bins_index=B;I.painter=this;I.tooltip=W.tooltip;I.zmin=W.zmin;I.zmax=W.zmax;I.baseline=W.baseline;I.tip_color=W.tip_color;A.toplevel.add(I)}}if(this.options.Lego>12){return}var aI=0,K=0,aa=true,G=0;O=z;y=aG;for(T=an;T<am;++T){for(S=ac;S<ab;++S){if(!ax(T,S,0)){G++;continue}aI+=(ai?aM.length:ae.length);K+=(ai?J.length:aE.length)}}if(aI>65520){aa=false}if(!aa){aI=K*3}var D=new Float32Array(aI*3),o=aa?new Uint16Array(K):null,aq=A.grz(aG),aL=A.grz(z),aH=0,aF=0,aB=0,P=0;for(T=an;T<am;++T){F=aj.grx[T]+aj.xbar1*(aj.grx[T+1]-aj.grx[T]);E=aj.grx[T]+aj.xbar2*(aj.grx[T+1]-aj.grx[T]);for(S=ac;S<ab;++S){if(!ax(T,S,0)){continue}s=aj.gry[S]+aj.ybar1*(aj.gry[S+1]-aj.gry[S]);r=aj.gry[S]+aj.ybar2*(aj.gry[S+1]-aj.gry[S]);aH=(at<=aG)?aq:A.grz(at);aF=(ar>z)?aL:A.grz(ar);var V=ai?J:aE,Y=ai?aM:ae;if(aa){for(R=0;R<V.length;++R){o[P++]=aB/3+V[R]}for(R=0;R<Y.length;++R){az=Y[R];D[aB]=F+az.x*(E-F);D[aB+1]=s+az.y*(r-s);D[aB+2]=aH+az.z*(aF-aH);aB+=3}}else{for(R=0;R<V.length;++R){az=Y[V[R]];D[aB]=F+az.x*(E-F);D[aB+1]=s+az.y*(r-s);D[aB+2]=aH+az.z*(aF-aH);aB+=3}}}}var p=this.get_color(t.fLineColor);aJ=new f.LineBasicMaterial({color:new f.Color(p)});if(!c.browser.isIE){aJ.linewidth=t.fLineWidth}var w=c.Painter.createLineSegments(D,aJ,aa?o:null);A.toplevel.add(w)};c.Painter.drawAxis3D=function(l,k,j){var i=new c.TObjectPainter(k);if(!("_main" in k)){i.SetDivId(l)}i.Draw3DAxis=function(){var m=this.frame_painter();if(!m||!m._toplevel){return console.warn("no geo object found for 3D axis drawing")}var n=new f.Box3().setFromObject(m._toplevel);this.xmin=n.min.x;this.xmax=n.max.x;this.ymin=n.min.y;this.ymax=n.max.y;this.zmin=n.min.z;this.zmax=n.max.z;this.size_xy3d=this.size_z3d=0;this.DrawXYZ=c.TFramePainter.prototype.DrawXYZ;this.DrawXYZ(m._toplevel);m.adjustCameraPosition();m.Render3D()};i.Draw3DAxis();return i.DrawingReady()};c.TH1Painter.prototype.Draw3D=function(m,k){this.mode3d=true;var i=this.frame_painter(),l=this.is_main_painter(),j=this.GetHisto();if(k){if(l&&i.Resize3D()){i.Render3D()}}else{this.DeleteAtt();this.ScanContent(true);if(l){i.Create3DScene();i.SetAxesRanges(j.fXaxis,this.xmin,this.xmax,j.fYaxis,this.ymin,this.ymax,j.fZaxis,0,0);i.Set3DOptions(this.options);i.DrawXYZ(i.toplevel,{use_y_for_z:true,zmult:1.1,zoom:c.gStyle.Zooming,ndim:1})}this.Draw3DBins();i.Render3D();this.UpdateStatWebCanvas();i.AddKeysHandler()}if(l){this.DrawColorPalette(this.options.Zscale&&((this.options.Lego===12)||(this.options.Lego===14)));this.DrawTitle()}c.CallBack(m)};c.TH2Painter.prototype.Draw3D=function(n,l){this.mode3d=true;var i=this.frame_painter(),m=this.is_main_painter(),j=this.GetHisto();if(l){if(m&&i.Resize3D()){i.Render3D()}}else{var o=this.root_pad();this.zmin=o.fLogz?this.gminposbin*0.3:this.gminbin;this.zmax=this.gmaxbin;var k=1.1;if(this.options.minimum!==-1111){this.zmin=this.options.minimum}if(this.options.maximum!==-1111){this.zmax=this.options.maximum;k=1}if(o.fLogz&&(this.zmin<=0)){this.zmin=this.zmax*0.00001}this.DeleteAtt();if(m){i.Create3DScene();i.SetAxesRanges(j.fXaxis,this.xmin,this.xmax,j.fYaxis,this.ymin,this.ymax,j.fZaxis,this.zmin,this.zmax);i.Set3DOptions(this.options);i.DrawXYZ(i.toplevel,{zmult:k,zoom:c.gStyle.Zooming,ndim:2})}this.Draw3DBins();i.Render3D();this.UpdateStatWebCanvas();i.AddKeysHandler()}if(m){this.DrawColorPalette(this.options.Zscale&&((this.options.Lego===12)||(this.options.Lego===14)||(this.options.Surf===11)||(this.options.Surf===12)));this.DrawTitle()}c.CallBack(n)};c.TH2Painter.prototype.DrawContour3D=function(o){var k=this.frame_painter(),n=this.PrepareColorDraw({rounding:false,use3d:true,extra:100,middle:0}),m=this.GetHisto(),p=this.GetContour(),j=this.GetPalette(),i=2*k.size_z3d,l=[];this.BuildContour(n,p,j,function(r,w,x,t,s,v){if(s-t<3){return}if(o){i=k.grz(p[v]);if((i<0)||(i>2*k.size_z3d)){return}}for(var u=t;u<s;++u){l.push(w[u],x[u],i);l.push(w[u+1],x[u+1],i)}});var q=c.Painter.createLineSegments(l,c.Painter.Create3DLineMaterial(this,m));k.toplevel.add(q)};c.TH2Painter.prototype.DrawSurf=function(){var A=this.GetHisto(),r=this.frame_painter(),L=this.PrepareColorDraw({rounding:false,use3d:true,extra:1,middle:0.5}),ai,af,D,ao,C,am,J,H,p,l,I=r.grz.domain()[0],ae=r.grz.domain()[1];var N=!r.logz?r.grz:function(i){return i<I?-0.1:r.grz(i)};if((L.i2-L.i1<2)||(L.j2-L.j1<2)){return}var S=null,K=null,t=true,an=false,U=false,ah=null;switch(this.options.Surf){case 11:S=this.GetContour();ah=this.GetPalette();break;case 12:case 15:case 17:S=this.GetContour();ah=this.GetPalette();t=false;break;case 14:t=false;U=true;break;case 16:S=this.GetContour();an=true;t=false;break;default:S=r.z_handle.CreateTicks(true);an=true;break}if(S){K=new Float32Array(S.length);for(var Q=0;Q<S.length;++Q){K[Q]=N(S[Q])}}else{K=[0,2*r.size_z3d]}var q,o=[],P=[],O=[],s=0,ak=null,aj=0,m=0,X=null,z=0,G=null;function al(k,j,i){if(k<j){return -1}if(k>i){return 1}return 0}function w(n,at,aq,k,ar,ap){if(!t){return}var j=al(aq,0,2*r.size_z3d),i=al(ap,0,2*r.size_z3d);if((j===i)&&(j!==0)){return}if(!q){return ++s}if(j!==0){var au=ap-aq;aq=(j<0)?0:2*r.size_z3d;n=k-(k-n)/au*(ap-aq);at=ar-(ar-at)/au*(ap-aq)}if(i!==0){var au=aq-ap;ap=(i<0)?0:2*r.size_z3d;k=n-(n-k)/au*(aq-ap);ar=at-(at-ar)/au*(aq-ap)}ak[aj]=n;ak[aj+1]=at;ak[aj+2]=aq;aj+=3;ak[aj]=k;ak[aj+1]=ar;ak[aj+2]=ap;aj+=3}var V=new Float32Array(6*3),ad=0,R=0;var F=new Float32Array(2*3),aa=0;function E(aq,j,av,ap,i,au,ar,at){if(ad>=V.length){console.log("more than 6 points???")}var n=(ar-av)/(au-av),k=3;if((R!==0)&&(Math.abs(n)<Math.abs(R))){V[ad]=V[ad-3];V[ad+1]=V[ad-2];V[ad+2]=V[ad-1];ad-=3;k=6}V[ad]=aq+n*(ap-aq);V[ad+1]=j+n*(i-j);V[ad+2]=ar;if(at&&X){F[aa]=V[ad];F[aa+1]=V[ad+1];F[aa+2]=V[ad+2];aa+=3}ad+=k;R=n}function ag(n,j,k){var i=((j-L.i1)*(L.j2-L.j1)+(k-L.j1))*8;if(G[i]>=0){return console.error("More than 8 vertexes for the bin")}var ap=i+8+G[i];G[i]--;G[ap]=n}function v(aq){for(var av=L.i1;av<L.i2;++av){for(var at=L.j1;at<L.j2;++at){var aw=((av-L.i1)*(L.j2-L.j1)+(at-L.j1))*8;if(G[aw]===-1){continue}var au=(G[aw]>=0)?aw:aw+9+G[aw],ap=aw+8,n=0,k=0,j=0;for(var i=au;i<ap;++i){var ar=G[i];if(ar<0){return console.error("FAILURE in NORMALS RECALCULATIONS")}n+=aq[ar];k+=aq[ar+1];j+=aq[ar+2]}n=n/(ap-au);k=k/(ap-au);j=j/(ap-au);for(var i=au;i<ap;++i){var ar=G[i];aq[ar]=n;aq[ar+1]=k;aq[ar+2]=j}}}}function W(aC,k,ax,aB,j,aw,aA,i,au,aF){for(var az=1;az<K.length;++az){var aq=al(ax,K[az-1],K[az]),ap=al(aw,K[az-1],K[az]),n=al(au,K[az-1],K[az]),av=aq+ap+n;if(av===3){continue}if(av===-3){return}if(!q){var at=Math.abs(ap-aq)+Math.abs(n-ap)+Math.abs(aq-n);if(aq===0){++at}if(ap===0){++at}if(n===0){++at}if((at===1)||(at===2)){console.error("FOND npnts",at)}if(at>2){if(o[az]===undefined){o[az]=0}o[az]+=at-2}if(((aq>0)||(ap>0)||(n>0))&&((aq!==ap)||(ap!==n)||(n!==aq))){++m}continue}aa=0;ad=0;if(aq===0){V[ad]=aC;V[ad+1]=k;V[ad+2]=ax;ad+=3}if(aq!==ap){R=0;if((aq<0)||(ap<0)){E(aC,k,ax,aB,j,aw,K[az-1])}if((aq>0)||(ap>0)){E(aC,k,ax,aB,j,aw,K[az],true)}}if(ap===0){V[ad]=aB;V[ad+1]=j;V[ad+2]=aw;ad+=3}if(ap!==n){R=0;if((ap<0)||(n<0)){E(aB,j,aw,aA,i,au,K[az-1])}if((ap>0)||(n>0)){E(aB,j,aw,aA,i,au,K[az],true)}}if(n===0){V[ad]=aA;V[ad+1]=i;V[ad+2]=au;ad+=3}if(n!==aq){R=0;if((n<0)||(aq<0)){E(aA,i,au,aC,k,ax,K[az-1])}if((n>0)||(aq>0)){E(aA,i,au,aC,k,ax,K[az],true)}}if(ad===0){continue}if(ad<9){console.log("found less than 3 points",ad/3);continue}if(X&&(aa===6)){for(var aD=0;aD<6;++aD){X[z+aD]=F[aD]}z+=6}var aE=P[az],ay=O[az];if(U&&(ad===9)){ag(ay,ai,af);ag(ay+3,ai+1,aF?af+1:af);ag(ay+6,aF?ai:ai+1,af+1)}for(var ar=3;ar<ad-3;ar+=3){aE[ay]=V[0];aE[ay+1]=V[1];aE[ay+2]=V[2];ay+=3;aE[ay]=V[ar];aE[ay+1]=V[ar+1];aE[ay+2]=V[ar+2];ay+=3;aE[ay]=V[ar+3];aE[ay+1]=V[ar+4];aE[ay+2]=V[ar+5];ay+=3}O[az]=ay}}if(U){G=new Int32Array((L.i2-L.i1)*(L.j2-L.j1)*8);for(var Z=0;Z<G.length;++Z){G[Z]=-1}}for(q=0;q<2;++q){if(q){for(var ab=1;ab<K.length;++ab){if(o[ab]){P[ab]=new Float32Array(o[ab]*9);O[ab]=0}}if(t&&(s>0)){ak=new Float32Array(s*6)}if(an&&(m>0)){X=new Float32Array(m*6)}}for(ai=L.i1;ai<L.i2-1;++ai){D=L.grx[ai];C=L.grx[ai+1];for(af=L.j1;af<L.j2-1;++af){ao=L.gry[af];am=L.gry[af+1];J=N(A.getBinContent(ai+1,af+1));H=N(A.getBinContent(ai+1,af+2));p=N(A.getBinContent(ai+2,af+1));l=N(A.getBinContent(ai+2,af+2));W(D,ao,J,C,am,l,D,am,H,true);W(D,ao,J,C,ao,p,C,am,l,false);w(D,am,H,D,ao,J);w(D,ao,J,C,ao,p);if(ai===L.i2-2){w(C,ao,p,C,am,l)}if(af===L.j2-2){w(D,am,H,C,am,l)}}}}for(var ab=1;ab<K.length;++ab){if(P[ab]){if(O[ab]!==o[ab]*9){console.error("SURF faces missmatch lvl",ab,"faces",o[ab],"index",O[ab],"check",o[ab]*9-O[ab])}var B=new f.BufferGeometry();B.addAttribute("position",new f.BufferAttribute(P[ab],3));B.computeVertexNormals();if(U&&(ab===1)){v(B.getAttribute("normal").array)}var u,ac;if(ah){u=ah.calcColor(ab,K.length)}else{u=A.fFillColor>1?this.get_color(A.fFillColor):"white";if((this.options.Surf===14)&&(A.fFillColor<2)){u=this.get_color(48)}}if(this.options.Surf===14){ac=new f.MeshLambertMaterial({color:u,side:f.DoubleSide})}else{ac=new f.MeshBasicMaterial({color:u,side:f.DoubleSide})}var M=new f.Mesh(B,ac);r.toplevel.add(M);M.painter=this}}if(ak){if(s*6!==aj){console.error("SURF lines mismmatch nsegm",s," lindx",aj,"difference",s*6-aj)}var y=this.get_color(A.fLineColor),ac=new f.LineBasicMaterial({color:new f.Color(y)});if(!c.browser.isIE){ac.linewidth=A.fLineWidth}var x=c.Painter.createLineSegments(ak,ac);x.painter=this;r.toplevel.add(x)}if(X){if(m*6!==z){console.error("SURF grid draw mismatch ngridsegm",m,"gindx",z,"diff",m*6-z)}var ac;if(this.options.Surf===1){ac=new f.LineDashedMaterial({color:0,dashSize:2,gapSize:2})}else{ac=new f.LineBasicMaterial({color:new f.Color(this.get_color(A.fLineColor))})}var x=c.Painter.createLineSegments(X,ac);x.painter=this;r.toplevel.add(x)}if(this.options.Surf===17){this.DrawContour3D()}if(this.options.Surf===13){L=this.PrepareColorDraw({rounding:false,use3d:true,extra:100,middle:0});var K=this.GetContour(),ah=this.GetPalette(),Y=-1,T=2*r.size_z3d;this.BuildContour(L,K,ah,function(au,aw,aD,aF,aA){if(aA-aF<3){return}var az=[];for(var aC=aF;aC<=aA;++aC){if((aC===aF)||(aw[aC]!==aw[aC-1])||(aD[aC]!==aD[aC-1])){az.push(new f.Vector2(aw[aC],aD[aC]))}}if(az.length<3){return}var k=f.ShapeUtils.triangulateShape(az,[]);if(!k||(k.length===0)){return}if((Y<0)||(Y!==au)){Y=au;T+=0.0001*r.size_z3d}var at=new Float32Array(k.length*9),ar=new Float32Array(k.length*9),aG=0;for(var aB=0;aB<k.length;++aB){var av=k[aB];for(var ax=0;ax<3;++ax){var aE=az[av[ax]];at[aG]=aE.x;at[aG+1]=aE.y;at[aG+2]=T;ar[aG]=0;ar[aG+1]=0;ar[aG+2]=1;aG+=3}}var aq=new f.BufferGeometry();aq.addAttribute("position",new f.BufferAttribute(at,3));aq.addAttribute("normal",new f.BufferAttribute(ar,3));var ap=ah.getColor(au);var ay=new f.MeshBasicMaterial({color:ap,shading:f.SmoothShading,side:f.DoubleSide,opacity:0.5});var j=new f.Mesh(aq,ay);j.painter=this;r.toplevel.add(j)})}};c.TH2Painter.prototype.DrawError=function(){var n=this,o=this.frame_painter(),F=this.PrepareColorDraw({rounding:false,use3d:true,extra:1}),D=o.grz.domain()[0],H=o.grz.domain()[1],A,z,y,w,q,C,m,B,l,u,t,k=0,p=null,r=null,x=0;function G(){if(n.options.Zero||(D>0)){return false}return !n._show_empty_bins}for(var E=0;E<2;++E){for(A=F.i1;A<F.i2;++A){C=F.grx[A];B=F.grx[A+1];for(z=F.j1;z<F.j2;++z){w=this.histo.getBinContent(A+1,z+1);if((w<D)||(w>H)){continue}if((w===D)&&G()){continue}if(E===0){k+=3;continue}y=this.histo.getBin(A+1,z+1);q=this.histo.getBinError(y);r[x/18]=y;m=F.gry[z];l=F.gry[z+1];u=o.grz((w-q<D)?D:w-q);t=o.grz((w+q>H)?H:w+q);p[x]=C;p[x+3]=B;p[x+1]=p[x+4]=(m+l)/2;p[x+2]=p[x+5]=(u+t)/2;x+=6;p[x]=p[x+3]=(C+B)/2;p[x+1]=m;p[x+4]=l;p[x+2]=p[x+5]=(u+t)/2;x+=6;p[x]=p[x+3]=(C+B)/2;p[x+1]=p[x+4]=(m+l)/2;p[x+2]=u;p[x+5]=t;x+=6}}if(E===0){if(k===0){return}p=new Float32Array(k*6);r=new Int32Array(k/3)}}var I=this.get_color(this.GetObject().fLineColor),v=new f.LineBasicMaterial({color:new f.Color(I)}),s=c.Painter.createLineSegments(p,v);if(!c.browser.isIE){v.linewidth=this.GetObject().fLineWidth}s.painter=this;s.intersect_index=r;s.zmin=D;s.zmax=H;s.tip_color=(this.GetObject().fLineColor===3)?16711680:65280;s.tooltip=function(j){var M=Math.floor(j.index/6);if((M<0)||(M>=this.intersect_index.length)){return null}var L=this.painter,J=L.GetHisto(),i=L.frame_painter(),K=L.Get3DToolTip(this.intersect_index[M]);K.x1=Math.max(-i.size_xy3d,i.grx(J.fXaxis.GetBinLowEdge(K.ix)));K.x2=Math.min(i.size_xy3d,i.grx(J.fXaxis.GetBinLowEdge(K.ix+1)));K.y1=Math.max(-i.size_xy3d,i.gry(J.fYaxis.GetBinLowEdge(K.iy)));K.y2=Math.min(i.size_xy3d,i.gry(J.fXaxis.GetBinLowEdge(K.iy+1)));K.z1=i.grz(K.value-K.error<this.zmin?this.zmin:K.value-K.error);K.z2=i.grz(K.value+K.error>this.zmax?this.zmax:K.value+K.error);K.color=this.tip_color;return K};o.toplevel.add(s)};c.TH2Painter.prototype.DrawPolyLego=function(){var B=this.GetHisto(),J=this.frame_painter(),F=J.grz.domain()[0],aa=J.grz.domain()[1],L,t,ab,G=B.fBins.arr.length,H=0,m=0,P=J.grz(F),O=P;this.fContour=null;this.fCustomContour=false;this.maxbin=this.gmaxbin;this.minbin=this.gminbin;this.minposbin=this.gminposbin;for(ab=0;ab<G;++ab){t=B.fBins.arr[ab];if(t.fContent<F){continue}L=this.getContourColor(t.fContent,true);if(L===null){continue}if((t.fXmin>J.scale_xmax)||(t.fXmax<J.scale_xmin)||(t.fYmin>J.scale_ymax)||(t.fYmax<J.scale_ymin)){continue}O=J.grz((t.fContent>aa)?aa:t.fContent);var S=[],E=[],ac=1,s=t.fPoly,k=0;if(s._typename=="TMultiGraph"){ac=t.fPoly.fGraphs.arr.length;s=null}for(var K=0;K<ac;++K){if(!s||(K>0)){s=t.fPoly.fGraphs.arr[K]}var o=s.fNpoints,R=s.fX,Q=s.fY;while((o>2)&&(R[0]===R[o-1])&&(Q[0]===Q[o-1])){--o}var q,A;for(var u=0;u<2;++u){var U,T,z,v,l=J.size_xy3d*J.size_z3d,j=(u>0)?0:l/1000000;q=[];A=null;for(var D=0;D<o;++D){z=J.grx(R[D]);v=J.gry(Q[D]);if(D>0){l=(z-U)*(z-U)+(v-T)*(v-T)}if(l>j){q.push(new f.Vector2(z,v));U=z;T=v}}try{if(q.length>2){A=f.ShapeUtils.triangulateShape(q,[])}}catch(ad){A=null}if(A&&(A.length>q.length-3)){break}}if(A&&A.length&&q){S.push(q);E.push(A);k+=A.length*2;if(O>P){k+=q.length*2}}}var N=new Float32Array(k*9),M=0;for(var K=0;K<S.length;++K){var q=S[K],A=E[K];for(var p=0;p<2;++p){for(var V=0;V<A.length;++V){var w=A[V],Z=q[w[0]],Y=q[w[(p===0)?2:1]],W=q[w[(p===0)?1:2]];N[M]=Z.x;N[M+1]=Z.y;N[M+2]=p?O:P;M+=3;N[M]=Y.x;N[M+1]=Y.y;N[M+2]=p?O:P;M+=3;N[M]=W.x;N[M+1]=W.y;N[M+2]=p?O:P;M+=3}}if(O>P){for(var V=0;V<q.length;++V){var Z=q[V],Y=q[(V>0)?V-1:q.length-1];N[M]=Z.x;N[M+1]=Z.y;N[M+2]=P;M+=3;N[M]=Y.x;N[M+1]=Y.y;N[M+2]=P;M+=3;N[M]=Y.x;N[M+1]=Y.y;N[M+2]=O;M+=3;N[M]=Z.x;N[M+1]=Z.y;N[M+2]=P;M+=3;N[M]=Y.x;N[M+1]=Y.y;N[M+2]=O;M+=3;N[M]=Z.x;N[M+1]=Z.y;N[M+2]=O;M+=3}}}var C=new f.BufferGeometry();C.addAttribute("position",new f.BufferAttribute(N,3));C.computeVertexNormals();var r=this.fPalette.getColor(L);var X=new f.MeshBasicMaterial({color:r,shading:f.SmoothShading});var I=new f.Mesh(C,X);J.toplevel.add(I);I.painter=this;I.bins_index=ab;I.draw_z0=P;I.draw_z1=O;I.tip_color=65280;I.tooltip=function(x){var ae=this.painter,i=ae.frame_painter(),n=ae.GetObject().fBins.arr[this.bins_index];var y={use_itself:true,x1:i.grx(n.fXmin),x2:i.grx(n.fXmax),y1:i.gry(n.fYmin),y2:i.gry(n.fYmax),z1:this.draw_z0,z2:this.draw_z1,bin:this.bins_index,value:n.fContent,color:this.tip_color,lines:ae.ProvidePolyBinHints(this.bins_index)};return y};m+=k;H++}};function g(i){c.THistPainter.call(this,i);this.mode3d=true}g.prototype=Object.create(c.THistPainter.prototype);g.prototype.ScanContent=function(p){if(p&&this.nbinsx&&this.nbinsy&&this.nbinsz){return}var m=this.GetObject();this.nbinsx=m.fXaxis.fNbins;this.nbinsy=m.fYaxis.fNbins;this.nbinsz=m.fZaxis.fNbins;this.xmin=m.fXaxis.fXmin;this.xmax=m.fXaxis.fXmax;this.ymin=m.fYaxis.fXmin;this.ymax=m.fYaxis.fXmax;this.zmin=m.fZaxis.fXmin;this.zmax=m.fZaxis.fXmax;this.gminbin=this.gmaxbin=m.getBinContent(1,1,1);for(var o=0;o<this.nbinsx;++o){for(var n=0;n<this.nbinsy;++n){for(var l=0;l<this.nbinsz;++l){var q=m.getBinContent(o+1,n+1,l+1);if(q<this.gminbin){this.gminbin=q}else{if(q>this.gmaxbin){this.gmaxbin=q}}}}}this.draw_content=this.gmaxbin>0;this.CreateAxisFuncs(true,true)};g.prototype.CountStat=function(){var z=this.GetHisto(),o=z.fXaxis,H=z.fYaxis,y=z.fZaxis,p=0,x=0,F=0,l=0,u=0,D=0,k=0,E=this.GetSelectIndex("x","left"),C=this.GetSelectIndex("x","right"),j=this.GetSelectIndex("y","left"),i=this.GetSelectIndex("y","right"),w=this.GetSelectIndex("z","left"),t=this.GetSelectIndex("z","right"),s=this.frame_painter(),K={name:z.fName,entries:0,integral:0,meanx:0,meany:0,meanz:0,rmsx:0,rmsy:0,rmsz:0},B,J,r,q,n,A,G,I,v,m;for(B=0;B<this.nbinsx+2;++B){q=o.GetBinCoord(B-0.5);n=(B<E)?0:(B>C?2:1);for(J=0;J<this.nbinsy+2;++J){A=H.GetBinCoord(J-0.5);G=(J<j)?0:(J>i?2:1);for(r=0;r<this.nbinsz+2;++r){I=y.GetBinCoord(r-0.5);v=(r<w)?0:(r>t?2:1);m=z.getBinContent(B,J,r);K.entries+=m;if((n==1)&&(G==1)&&(v==1)){p+=m;x+=q*m;F+=A*m;l+=I*m;u+=q*q*m;D+=A*A*m;k+=I*I*m}}}}if((z.fTsumw>0)&&!s.IsAxisZoomed("x")&&!s.IsAxisZoomed("y")&&!s.IsAxisZoomed("z")){p=z.fTsumw;x=z.fTsumwx;u=z.fTsumwx2;F=z.fTsumwy;D=z.fTsumwy2;l=z.fTsumwz;k=z.fTsumwz2}if(p>0){K.meanx=x/p;K.meany=F/p;K.meanz=l/p;K.rmsx=Math.sqrt(Math.abs(u/p-K.meanx*K.meanx));K.rmsy=Math.sqrt(Math.abs(D/p-K.meany*K.meany));K.rmsz=Math.sqrt(Math.abs(k/p-K.meanz*K.meanz))}K.integral=p;if(z.fEntries>1){K.entries=z.fEntries}return K};g.prototype.FillStatistic=function(m,n,s){if(this.IgnoreStatsFill()){return false}var l=this.CountStat(),p=n%10,q=Math.floor(n/10)%10,o=Math.floor(n/100)%10,r=Math.floor(n/1000)%10,i=Math.floor(n/10000)%10,j=Math.floor(n/100000)%10,k=Math.floor(n/1000000)%10;m.ClearPave();if(p>0){m.AddText(l.name)}if(q>0){m.AddText("Entries = "+m.Format(l.entries,"entries"))}if(o>0){m.AddText("Mean x = "+m.Format(l.meanx));m.AddText("Mean y = "+m.Format(l.meany));m.AddText("Mean z = "+m.Format(l.meanz))}if(r>0){m.AddText("Std Dev x = "+m.Format(l.rmsx));m.AddText("Std Dev y = "+m.Format(l.rmsy));m.AddText("Std Dev z = "+m.Format(l.rmsz))}if(k>0){m.AddText("Integral = "+m.Format(l.integral,"entries"))}if(s){m.FillFunctionStat(this.FindFunction("TF1"),s)}return true};g.prototype.GetBinTips=function(l,i,o){var k=[],j=this.frame_painter(),m=this.GetHisto();k.push(this.GetTipName());if(j.x_kind=="labels"){k.push("x = "+j.AxisAsText("x",m.fXaxis.GetBinLowEdge(l+1))+"  xbin="+(l+1))}else{k.push("x = ["+j.AxisAsText("x",m.fXaxis.GetBinLowEdge(l+1))+", "+j.AxisAsText("x",m.fXaxis.GetBinLowEdge(l+2))+")   xbin="+(l+1))}if(j.y_kind=="labels"){k.push("y = "+j.AxisAsText("y",m.fYaxis.GetBinLowEdge(i+1))+"  ybin="+(i+1))}else{k.push("y = ["+j.AxisAsText("y",m.fYaxis.GetBinLowEdge(i+1))+", "+j.AxisAsText("y",m.fYaxis.GetBinLowEdge(i+2))+")  ybin="+(i+1))}if(j.z_kind=="labels"){k.push("z = "+j.AxisAsText("z",m.fZaxis.GetBinLowEdge(o+1))+"  zbin="+(o+1))}else{k.push("z = ["+j.AxisAsText("z",m.fZaxis.GetBinLowEdge(o+1))+", "+j.AxisAsText("z",m.fZaxis.GetBinLowEdge(o+2))+")  zbin="+(o+1))}var n=m.getBinContent(l+1,i+1,o+1);if(n===Math.round(n)){k.push("entries = "+n)}else{k.push("entries = "+c.FFormat(n,c.gStyle.fStatFormat))}return k};g.prototype.Draw3DScatter=function(){var x=this.GetObject(),p=this.frame_painter(),D=this.GetSelectIndex("x","left",0.5),C=this.GetSelectIndex("x","right",0),o=this.GetSelectIndex("y","left",0.5),l=this.GetSelectIndex("y","right",0),u=this.GetSelectIndex("z","left",0.5),s=this.GetSelectIndex("z","right",0),L=this.GetTipName("<br/>"),G,F,E,I;if((C<=D)||(l<=o)||(s<=u)){return true}var r=(this.gmaxbin>1000)?1000/this.gmaxbin:1,H=0,t=0,J=Math.max(0,this.gminbin);for(G=D;G<C;++G){for(F=o;F<l;++F){for(E=u;E<s;++E){I=x.getBinContent(G+1,F+1,E+1);t+=I;if(I<=J){continue}H+=Math.round(I*r)}}}if(H>(p.webgl?100000:30000)){return false}c.seed(t);var z=new c.Painter.PointsCreator(H,p.webgl,p.size_xy3d/200),B=new Int32Array(H),K=0;for(G=D;G<C;++G){for(F=o;F<l;++F){for(E=u;E<s;++E){I=x.getBinContent(G+1,F+1,E+1);if(I<=J){continue}var q=Math.round(I*r);for(var A=0;A<q;++A){var y=x.fXaxis.GetBinCoord(G+c.random()),w=x.fYaxis.GetBinCoord(F+c.random()),v=x.fZaxis.GetBinCoord(E+c.random());B[K++]=x.getBin(G+1,F+1,E+1);z.AddPoint(p.grx(y),p.gry(w),p.grz(v))}}}}var m=z.CreatePoints(this.get_color(x.fMarkerColor));p.toplevel.add(m);m.bins=B;m.painter=this;m.tip_color=(x.fMarkerColor===3)?16711680:65280;m.tooltip=function(j){var n=Math.floor(j.index/this.nvertex);if((n<0)||(n>=this.bins.length)){return null}var N=this.painter,k=N.GetHisto(),i=N.frame_painter(),M=N.Get3DToolTip(this.bins[n]);M.x1=i.grx(k.fXaxis.GetBinLowEdge(M.ix));M.x2=i.grx(k.fXaxis.GetBinLowEdge(M.ix+1));M.y1=i.gry(k.fYaxis.GetBinLowEdge(M.iy));M.y2=i.gry(k.fYaxis.GetBinLowEdge(M.iy+1));M.z1=i.grz(k.fZaxis.GetBinLowEdge(M.iz));M.z2=i.grz(k.fZaxis.GetBinLowEdge(M.iz+1));M.color=this.tip_color;M.opacity=0.3;return M};return true};g.prototype.Draw3DBins=function(){if(!this.draw_content){return}if(!this.options.Box&&!this.options.GLBox&&!this.options.GLColor&&!this.options.Lego){if(this.Draw3DScatter()){return}}var aC=this.GetObject().fFillColor,y=this.get_color(aC),p=this.frame_painter(),ao=0,l=false,ag=false,z=false,M=1,aj=true,N,aD,aF=this.options.Box?this.options.BoxStyle:0,am=0.5;if(!aF&&this.options.Lego){aF=(this.options.Lego===1)?10:this.options.Lego}if((this.options.GLBox===11)||(this.options.GLBox===12)){am=0.4;l=true;if(this.options.GLBox===12){z=true}var x=c.Painter.TestWebGL()?new f.SphereGeometry(0.5,16,12):new f.SphereGeometry(0.5,8,6);x.applyMatrix(new f.Matrix4().makeRotationX(Math.PI/2));ao=x.faces.length*9;N=new Float32Array(ao);aD=new Float32Array(ao);for(var B=0;B<x.faces.length;++B){N[9*B]=x.vertices[x.faces[B].a].x;N[9*B+1]=x.vertices[x.faces[B].a].y;N[9*B+2]=x.vertices[x.faces[B].a].z;N[9*B+3]=x.vertices[x.faces[B].b].x;N[9*B+4]=x.vertices[x.faces[B].b].y;N[9*B+5]=x.vertices[x.faces[B].b].z;N[9*B+6]=x.vertices[x.faces[B].c].x;N[9*B+7]=x.vertices[x.faces[B].c].y;N[9*B+8]=x.vertices[x.faces[B].c].z;aD[9*B]=x.faces[B].vertexNormals[0].x;aD[9*B+1]=x.faces[B].vertexNormals[0].y;aD[9*B+2]=x.faces[B].vertexNormals[0].z;aD[9*B+3]=x.faces[B].vertexNormals[1].x;aD[9*B+4]=x.faces[B].vertexNormals[1].y;aD[9*B+5]=x.faces[B].vertexNormals[1].z;aD[9*B+6]=x.faces[B].vertexNormals[2].x;aD[9*B+7]=x.faces[B].vertexNormals[2].y;aD[9*B+8]=x.faces[B].vertexNormals[2].z}}else{var ai=c.Painter.Box3D.Indexes,Q=c.Painter.Box3D.Normals,m=c.Painter.Box3D.Vertices;ao=ai.length*3;N=new Float32Array(ao);aD=new Float32Array(ao);for(var au=0,aE=-3;au<ai.length;++au){var H=m[ai[au]];N[au*3]=H.x-0.5;N[au*3+1]=H.y-0.5;N[au*3+2]=H.z-0.5;if(au%6===0){aE+=3}aD[au*3]=Q[aE];aD[au*3+1]=Q[aE+1];aD[au*3+2]=Q[aE+2]}ag=true;if(aF===12){z=true}else{if(aF===13){z=true;ag=false}else{if(this.options.GLColor){z=true;M=0.5;aj=false;ag=false;l=true}}}}if(aj){aj=(this.gminbin||this.gmaxbin)?1/Math.max(Math.abs(this.gminbin),Math.abs(this.gmaxbin)):1}var G=this.GetHisto(),w=this.GetSelectIndex("x","left",0.5),v=this.GetSelectIndex("x","right",0),az=this.GetSelectIndex("y","left",0.5),aw=this.GetSelectIndex("y","right",0),X=this.GetSelectIndex("z","left",0.5),W=this.GetSelectIndex("z","right",0),D=this.GetTipName("<br/>");if((v<=w)||(aw<=az)||(W<=X)){return}var L=(p.grx(G.fXaxis.GetBinLowEdge(v+1))-p.grx(G.fXaxis.GetBinLowEdge(w+1)))/(v-w),K=(p.gry(G.fYaxis.GetBinLowEdge(aw+1))-p.gry(G.fYaxis.GetBinLowEdge(az+1)))/(aw-az),I=(p.grz(G.fZaxis.GetBinLowEdge(W+1))-p.grz(G.fZaxis.GetBinLowEdge(X+1)))/(W-X);var at=0,ay,av,au,s,q,af=[],A=0,ac=[];for(ay=w;ay<v;++ay){for(av=az;av<aw;++av){for(au=X;au<W;++au){q=G.getBinContent(ay+1,av+1,au+1);if((q===0)||(q<this.gminbin)){continue}s=aj?Math.pow(Math.abs(q*aj),0.3333):1;if(s<0.001){continue}at++;if(!z){continue}var S=this.getContourColor(q,true);if(S!==null){if(af[S]===undefined){af[S]=0;ac[S]=A++}af[S]+=1}else{console.error("not found color for",q)}}}}if(!z){af.push(at);A=1;ac=[0]}var T=new Array(A),t=new Array(A),al=new Array(A),ak=new Array(A),o=new Array(A),an=new Array(A),u=new Array(A);for(var J=0;J<af.length;++J){if(!af[J]){continue}at=af[J];var ah=ac[J];T[ah]=0;o[ah]=0;if(ag){o[ah]=(at*ao/3>65520)?2:1}t[ah]=new Float32Array(at*ao);al[ah]=new Float32Array(at*ao);ak[ah]=new Int32Array(at);if(o[ah]===1){an[ah]=new Uint16Array(at*c.Painter.Box3D.MeshSegments.length)}if(o[ah]===2){u[ah]=new Float32Array(at*c.Painter.Box3D.Segments.length*3)}}var aB,ab,aA,aa,ax,Z;for(ay=w;ay<v;++ay){aB=G.fXaxis.GetBinCenter(ay+1);ab=p.grx(aB);for(av=az;av<aw;++av){aA=G.fYaxis.GetBinCenter(av+1);aa=p.gry(aA);for(au=X;au<W;++au){q=G.getBinContent(ay+1,av+1,au+1);if((q===0)||(q<this.gminbin)){continue}s=aj?Math.pow(Math.abs(q*aj),0.3333):1;if(s<0.001){continue}var ah=0;if(z){var S=this.getContourColor(q,true);if(S===null){continue}ah=ac[S]}at=T[ah];ax=G.fZaxis.GetBinCenter(au+1);Z=p.grz(ax);ak[ah][at]=G.getBin(ay+1,av+1,au+1);var Y=at*ao,F=t[ah],P=al[ah];for(var O=0;O<ao;O+=3,Y+=3){F[Y]=ab+N[O]*L*s;F[Y+1]=aa+N[O+1]*K*s;F[Y+2]=Z+N[O+2]*I*s;P[Y]=aD[O];P[Y+1]=aD[O+1];P[Y+2]=aD[O+2]}if(o[ah]===1){var ap=c.Painter.Box3D.MeshSegments;Y=at*ap.length;var V=Math.round(at*ao/3),ad=an[ah];for(var aq=0;aq<ap.length;++aq){ad[Y+aq]=V+ap[aq]}}if(o[ah]===2){var ap=c.Painter.Box3D.Segments,U=u[ah];Y=at*ap.length*3;for(var aq=0;aq<ap.length;++aq,Y+=3){var H=c.Painter.Box3D.Vertices[ap[aq]];U[Y]=ab+(H.x-0.5)*L*s;U[Y+1]=aa+(H.y-0.5)*K*s;U[Y+2]=Z+(H.z-0.5)*I*s}}T[ah]=at+1}}}for(var J=0;J<af.length;++J){if(!af[J]){continue}at=af[J];var ah=ac[J];var r=new f.BufferGeometry();r.addAttribute("position",new f.BufferAttribute(t[ah],3));r.addAttribute("normal",new f.BufferAttribute(al[ah],3));if(z){y=this.fPalette.getColor(J)}var ar=l?new f.MeshLambertMaterial({color:y,opacity:M,transparent:(M<1)}):new f.MeshBasicMaterial({color:y,opacity:M});var E=new f.Mesh(r,ar);E.bins=ak[ah];E.bins_faces=ao/3;E.painter=this;E.scalex=am*L;E.scaley=am*K;E.scalez=am*I;E.tip_color=(aC===3)?16711680:65280;E.use_scale=aj;E.tooltip=function(k){var aJ=Math.floor(k.index/this.bins_faces);if((aJ<0)||(aJ>=this.bins.length)){return null}var i=this.painter,aG=i.GetHisto(),n=i.frame_painter(),aL=i.Get3DToolTip(this.bins[aJ]),aK=n.grx(aG.fXaxis.GetBinCoord(aL.ix-0.5)),aI=n.gry(aG.fYaxis.GetBinCoord(aL.iy-0.5)),aH=n.grz(aG.fZaxis.GetBinCoord(aL.iz-0.5)),j=this.use_scale?Math.pow(Math.abs(aL.value*this.use_scale),0.3333):1;aL.x1=aK-this.scalex*j;aL.x2=aK+this.scalex*j;aL.y1=aI-this.scaley*j;aL.y2=aI+this.scaley*j;aL.z1=aH-this.scalez*j;aL.z2=aH+this.scalez*j;aL.color=this.tip_color;return aL};p.toplevel.add(E);if(o[ah]>0){var C=this.get_color(this.GetObject().fLineColor),R=new f.LineBasicMaterial({color:C}),ae=null;if(o[ah]===1){ae=c.Painter.createLineSegments(t[ah],R,an[ah])}else{ae=c.Painter.createLineSegments(u[ah],R)}p.toplevel.add(ae)}}};g.prototype.Redraw=function(k){var i=this.frame_painter(),j=this.GetHisto();if(k){if(i.Resize3D()){i.Render3D()}}else{i.Create3DScene();i.SetAxesRanges(j.fXaxis,this.xmin,this.xmax,j.fYaxis,this.ymin,this.ymax,j.fZaxis,this.zmin,this.zmax);i.Set3DOptions(this.options);i.DrawXYZ(i.toplevel,{zoom:c.gStyle.Zooming,ndim:3});this.Draw3DBins();i.Render3D();this.UpdateStatWebCanvas();i.AddKeysHandler()}this.DrawTitle()};g.prototype.FillToolbar=function(){var i=this.pad_painter();if(!i){return}i.AddButton(c.ToolbarIcons.auto_zoom,"Unzoom all axes","ToggleZoom","Ctrl *");if(this.draw_content){i.AddButton(c.ToolbarIcons.statbox,"Toggle stat box","ToggleStatBox")}i.ShowButtons()};g.prototype.CanZoomIn=function(k,j,i){var l=this.GetHisto();if(l){l=l["f"+k.toUpperCase()+"axis"]}return !l||(l.FindBin(i,0.5)-l.FindBin(j,0)>1)};g.prototype.AutoZoom=function(){var x=this.GetSelectIndex("x","left"),v=this.GetSelectIndex("x","right"),m=this.GetSelectIndex("y","left"),l=this.GetSelectIndex("y","right"),p=this.GetSelectIndex("z","left"),o=this.GetSelectIndex("z","right"),C,A,z,r=this.GetObject();if((x===v)||(m===l)||(p===o)){return}var w=r.getBinContent(x+1,m+1,p+1);for(C=x;C<v;++C){for(A=m;A<l;++A){for(z=p;z<o;++z){w=Math.min(w,r.getBinContent(C+1,A+1,z+1))}}}if(w>0){return}var I=v,B=x,t=l,F=m,n=o,H=p;for(C=x;C<v;++C){for(A=m;A<l;++A){for(z=p;z<o;++z){if(r.getBinContent(C+1,A+1,z+1)>w){if(C<I){I=C}if(C>=B){B=C+1}if(A<t){t=A}if(A>=F){F=A+1}if(z<n){n=z}if(z>=H){H=z+1}}}}}var s,u,y,D,E,G,q=false;if((I===B-1)&&(I>x+1)&&(B<v-1)){I--;B++}if((t===F-1)&&(t>m+1)&&(F<l-1)){t--;F++}if((n===H-1)&&(n>p+1)&&(H<o-1)){n--;H++}if((I>x||B<v)&&(I<B-1)){s=r.fXaxis.GetBinLowEdge(I+1);u=r.fXaxis.GetBinLowEdge(B+1);q=true}if((t>m||F<l)&&(t<F-1)){y=r.fYaxis.GetBinLowEdge(t+1);D=r.fYaxis.GetBinLowEdge(F+1);q=true}if((n>p||H<o)&&(n<H-1)){E=r.fZaxis.GetBinLowEdge(n+1);G=r.fZaxis.GetBinLowEdge(H+1);q=true}if(q){this.frame_painter().Zoom(s,u,y,D,E,G)}};g.prototype.FillHistContextMenu=function(j){var i=c.getDrawSettings("ROOT."+this.GetObject()._typename,"nosame");j.addDrawMenu("Draw with",i.opts,function(k){if(k==="inspect"){return c.draw(this.divid,this.GetObject(),k)}this.DecodeOptions(k);this.Redraw();this.InteractiveRedraw(true,"drawopt")})};c.Painter.drawHistogram3D=function(m,j,l){var i=new c.TH3Painter(j);i.SetDivId(m,4);i.DecodeOptions(l);i.CheckPadRange();i.ScanContent();i.Redraw();var k=i.CreateStat();if(k){c.draw(i.divid,k,"")}i.FillToolbar();return i.DrawingReady()};function e(i){c.TObjectPainter.call(this,i)}e.prototype=Object.create(c.TObjectPainter.prototype);e.prototype.DecodeOptions=function(j){var k=new c.DrawOptions(j);if(!this.options){this.options={}}var i=this.options;i.Color=k.check("COL");i.Line=k.check("LINE");i.Error=k.check("ERR")&&this.MatchObjectType("TGraph2DErrors");i.Circles=k.check("P0");i.Markers=k.check("P");if(!i.Markers&&!i.Error&&!i.Circles&&!i.Line){i.Markers=true}if(!i.Markers){i.Color=false}this.OptionsStore(j)};e.prototype.CreateHistogram=function(){var C=this.GetObject(),w=C.fX[0],B=w,D=C.fY[0],F=D,H=C.fZ[0],J=H;for(var A=0;A<C.fNpoints;++A){var s=C.fX[A],q=C.fY[A],o=C.fZ[A],n=this.options.Error?C.fEX[A]:0,m=this.options.Error?C.fEY[A]:0,l=this.options.Error?C.fEZ[A]:0;w=Math.min(w,s-n);B=Math.max(B,s+n);D=Math.min(D,q-m);F=Math.max(F,q+m);H=Math.min(H,o-l);J=Math.max(J,o+l)}if(w>=B){B=w+1}if(D>=F){F=D+1}if(H>=J){J=H+1}var u=(B-w)*0.02,t=(F-D)*0.02,r=(J-H)*0.02,E=w-u,G=B+u,I=D-t,K=F+t,i=H-r,k=J+r;if((E<0)&&(w>=0)){E=w*0.98}if((G>0)&&(B<=0)){G=0}if((I<0)&&(D>=0)){I=D*0.98}if((K>0)&&(F<=0)){K=0}if((i<0)&&(H>=0)){i=H*0.98}if((k>0)&&(J<=0)){k=0}var j=this.GetObject();if(j.fMinimum!=-1111){i=j.fMinimum}if(j.fMaximum!=-1111){k=j.fMaximum}var v=c.CreateHistogram("TH2I",10,10);v.fName=j.fName+"_h";v.fTitle=j.fTitle;v.fXaxis.fXmin=E;v.fXaxis.fXmax=G;v.fYaxis.fXmin=I;v.fYaxis.fXmax=K;v.fZaxis.fXmin=i;v.fZaxis.fXmax=k;v.fMinimum=i;v.fMaximum=k;v.fBits=v.fBits|c.TH1StatusBits.kNoStats;return v};e.prototype.Graph2DTooltip=function(k){var o=Math.floor(k.index/this.nvertex);if((o<0)||(o>=this.index.length)){return null}o=this.index[o];var j=this.painter,q=j.grx(this.graph.fX[o]),n=j.gry(this.graph.fY[o]),m=j.grz(this.graph.fZ[o]);if(this.check_next&&o+1<this.graph.fX.length){function t(p){return p*p}var r=k.point,i=j.grx(this.graph.fX[o+1]),s=j.gry(this.graph.fY[o+1]),l=j.grz(this.graph.fZ[o+1]);if(t(r.x-i)+t(r.y-s)+t(r.z-l)<t(r.x-q)+t(r.y-n)+t(r.z-m)){q=i;n=s;m=l;o++}}return{x1:q-this.scale0,x2:q+this.scale0,y1:n-this.scale0,y2:n+this.scale0,z1:m-this.scale0,z2:m+this.scale0,color:this.tip_color,lines:[this.tip_name,"pnt: "+o,"x: "+j.AxisAsText("x",this.graph.fX[o]),"y: "+j.AxisAsText("y",this.graph.fY[o]),"z: "+j.AxisAsText("z",this.graph.fZ[o])]}};e.prototype.Redraw=function(){var q=this.main_painter(),u=this.frame_painter(),l=this.GetObject(),r=1;if(!l||!q||!u||!u.mode3d){return}function N(x,T){var z=0;for(var y=0;y<l.fNpoints;++y){if((l.fX[y]<u.scale_xmin)||(l.fX[y]>u.scale_xmax)||(l.fY[y]<u.scale_ymin)||(l.fY[y]>u.scale_ymax)||(l.fZ[y]<x)||(l.fZ[y]>=T)){continue}++z}return z}if((c.gStyle.OptimizeDraw>0)&&!u.webgl){var F=N(u.scale_zmin,u.scale_zmax),G=50000;if(F>G){r=Math.floor(F/G);if(r<=2){r=2}}}var J=new c.TAttMarkerHandler(l),O=null,t=[u.scale_zmin,u.scale_zmax],S=u.size_xy3d/100*J.GetFullSize();if(this.options.Circles){S=0.06*u.size_xy3d}if(u.usesvg){S*=0.3}if(this.options.Color){t=q.GetContour();O=q.GetPalette()}for(var K=0;K<t.length-1;++K){var k=Math.max(t[K],u.scale_zmin),m=Math.min(t[K+1],u.scale_zmax);if(k>=m){continue}var I=Math.floor(N(k,m)/r),H=null,L=0,s=new Int32Array(I),v=0,p=null,C=null,Q=0,o=0;if(this.options.Markers||this.options.Circles){H=new c.Painter.PointsCreator(I,u.webgl,S/3)}if(this.options.Error){p=new Float32Array(I*6*3)}if(this.options.Line){C=new Float32Array((I-1)*6)}for(var M=0;M<l.fNpoints;++M){if((l.fX[M]<u.scale_xmin)||(l.fX[M]>u.scale_xmax)||(l.fY[M]<u.scale_ymin)||(l.fY[M]>u.scale_ymax)||(l.fZ[M]<k)||(l.fZ[M]>=m)){continue}if(r>1){L=(L+1)%r;if(L!==0){continue}}s[v++]=M;var B=u.grx(l.fX[M]),A=u.gry(l.fY[M]),w=u.grz(l.fZ[M]);if(H){H.AddPoint(B,A,w)}if(p){p[Q]=u.grx(l.fX[M]-l.fEX[M]);p[Q+1]=A;p[Q+2]=w;p[Q+3]=u.grx(l.fX[M]+l.fEX[M]);p[Q+4]=A;p[Q+5]=w;Q+=6;p[Q]=B;p[Q+1]=u.gry(l.fY[M]-l.fEY[M]);p[Q+2]=w;p[Q+3]=B;p[Q+4]=u.gry(l.fY[M]+l.fEY[M]);p[Q+5]=w;Q+=6;p[Q]=B;p[Q+1]=A;p[Q+2]=u.grz(l.fZ[M]-l.fEZ[M]);p[Q+3]=B;p[Q+4]=A;p[Q+5]=u.grz(l.fZ[M]+l.fEZ[M]);Q+=6}if(C){if(o>=6){C[o]=C[o-3];C[o+1]=C[o-2];C[o+2]=C[o-1];o+=3}C[o]=B;C[o+1]=A;C[o+2]=w;o+=3}}if(C&&(o>3)&&(C.length==o)){var R=this.get_color(this.GetObject().fLineColor),E=new f.LineBasicMaterial({color:new f.Color(R)});if(!c.browser.isIE){E.linewidth=this.GetObject().fLineWidth}var D=c.Painter.createLineSegments(C,E);u.toplevel.add(D);D.graph=l;D.index=s;D.painter=u;D.scale0=0.7*S;D.tip_name=this.GetTipName();D.tip_color=(l.fMarkerColor===3)?16711680:65280;D.nvertex=2;D.check_next=true;D.tooltip=this.Graph2DTooltip}if(p){var R=this.get_color(this.GetObject().fLineColor),E=new f.LineBasicMaterial({color:new f.Color(R)});if(!c.browser.isIE){E.linewidth=this.GetObject().fLineWidth}var P=c.Painter.createLineSegments(p,E);u.toplevel.add(P);P.graph=l;P.index=s;P.painter=u;P.scale0=0.7*S;P.tip_name=this.GetTipName();P.tip_color=(l.fMarkerColor===3)?16711680:65280;P.nvertex=6;P.tooltip=this.Graph2DTooltip}if(H){var n="blue";if(!this.options.Circles){n=O?O.calcColor(K,t.length):this.get_color(l.fMarkerColor)}var j=H.CreatePoints(n);u.toplevel.add(j);j.graph=l;j.index=s;j.painter=u;j.scale0=0.3*S;j.tip_name=this.GetTipName();j.tip_color=(l.fMarkerColor===3)?16711680:65280;j.tooltip=this.Graph2DTooltip}}u.Render3D(100)};c.Painter.drawGraph2D=function(l,j,k){var i=new c.TGraph2DPainter(j);i.SetDivId(l,-1);i.DecodeOptions(k);if(i.main_painter()){i.SetDivId(l);i.Redraw();return i.DrawingReady()}if(!j.fHistogram){j.fHistogram=i.CreateHistogram()}c.draw(l,j.fHistogram,"lego;axis",function(m){i.ownhisto=true;i.SetDivId(l);i.Redraw();return i.DrawingReady()});return i};c.Painter.drawPolyMarker3D=function(l,k,j){var i=new c.TObjectPainter(k);i.SetDivId(l);i.Redraw=function(){var s=this.frame_painter();if(!s||!s.mode3d){return}var m=1,q=50000,o=0;for(var p=0;p<k.fP.length;p+=3){if((k.fP[p]<s.scale_xmin)||(k.fP[p]>s.scale_xmax)||(k.fP[p+1]<s.scale_ymin)||(k.fP[p+1]>s.scale_ymax)||(k.fP[p+2]<s.scale_zmin)||(k.fP[p+2]>s.scale_zmax)){continue}++o}if((c.gStyle.OptimizeDraw>0)&&(o>q)){m=Math.floor(o/q);if(m<=2){m=2}}var w=Math.floor(o/m),n=new c.Painter.PointsCreator(w,s.webgl,s.size_xy3d/100),r=new Int32Array(w),t=0,u=0;for(var p=0;p<k.fP.length;p+=3){if((k.fP[p]<s.scale_xmin)||(k.fP[p]>s.scale_xmax)||(k.fP[p+1]<s.scale_ymin)||(k.fP[p+1]>s.scale_ymax)||(k.fP[p+2]<s.scale_zmin)||(k.fP[p+2]>s.scale_zmax)){continue}if(m>1){t=(t+1)%m;if(t!==0){continue}}r[u++]=p;n.AddPoint(s.grx(k.fP[p]),s.gry(k.fP[p+1]),s.grz(k.fP[p+2]))}var v=n.CreatePoints(this.get_color(k.fMarkerColor));s.toplevel.add(v);v.tip_color=(k.fMarkerColor===3)?16711680:65280;v.tip_name=k.fName||"Poly3D";v.poly=k;v.painter=s;v.scale0=0.7*n.scale;v.index=r;v.tooltip=function(x){var B=Math.floor(x.index/this.nvertex);if((B<0)||(B>=this.index.length)){return null}B=this.index[B];var C=this.painter,A=C.grx(this.poly.fP[B]),z=C.gry(this.poly.fP[B+1]),y=C.grz(this.poly.fP[B+2]);return{x1:A-this.scale0,x2:A+this.scale0,y1:z-this.scale0,y2:z+this.scale0,z1:y-this.scale0,z2:y+this.scale0,color:this.tip_color,lines:[this.tip_name,"pnt: "+B/3,"x: "+C.AxisAsText("x",this.poly.fP[B]),"y: "+C.AxisAsText("y",this.poly.fP[B+1]),"z: "+C.AxisAsText("z",this.poly.fP[B+2])]}};s.Render3D(100)};i.Redraw();return i.DrawingReady()};c.TH3Painter=g;c.TGraph2DPainter=e;return c}));