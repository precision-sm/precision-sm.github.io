(function(a){if(typeof define==="function"&&define.amd){define(["JSRootPainter","d3","threejs","threejs_all"],a)}else{if(typeof exports==="object"&&typeof module!=="undefined"){var b=require("./JSRootCore.js");a(b,require("./d3.min.js"),require("./three.min.js"),require("./three.extra.min.js"),b.nodejs||(typeof document=="undefined")?b.nodejs_document:document)}else{if(typeof JSROOT=="undefined"){throw new Error("JSROOT is not defined","JSRoot3DPainter.js")}if(typeof d3!="object"){throw new Error("This extension requires d3.js","JSRoot3DPainter.js")}if(typeof THREE=="undefined"){throw new Error("THREE is not defined","JSRoot3DPainter.js")}a(JSROOT,d3,THREE)}}}(function(d,g,h,c,b){d.sources.push("3d");if((typeof b=="undefined")&&(typeof window=="object")){b=window.document}if(typeof d.Painter!="object"){throw new Error("JSROOT.Painter is not defined","JSRoot3DPainter.js")}d.Painter.TestWebGL=function(){if(d.gStyle.NoWebGL||d.nodejs){return false}if("_Detect_WebGL" in this){return this._Detect_WebGL}try{var i=b.createElement("canvas");this._Detect_WebGL=!!(window.WebGLRenderingContext&&(i.getContext("webgl")||i.getContext("experimental-webgl")))}catch(j){this._Detect_WebGL=false}return this._Detect_WebGL};d.Painter.UseSVGFor3D=function(){if(!d.nodejs){return false}if(this._Detect_UseSVGFor3D!==undefined){return this._Detect_UseSVGFor3D}var i=null;try{i=require("canvas")}catch(j){i=null}this._Detect_UseSVGFor3D=!i;return this._Detect_UseSVGFor3D};d.Painter.Create3DRenderer=function(j,p,q,i,l,n){var m={renderer:null,dom:null,usesvg:q,usesvgimg:q&&d.gStyle.ImageSVG};if(!n){n={antialias:true,alpha:true}}if(d.nodejs){m.usewebgl=false}else{if(l!==undefined){m.usewebgl=l}else{m.usewebgl=d.Painter.TestWebGL()}}if(d.BatchMode&&d.browser.isChromeHeadless&&m.usewebgl){n.premultipliedAlpha=false}if(q){var k=null;if(d.nodejs&&m.usesvgimg){try{k=require("canvas")}catch(o){k=null;m.usesvgimg=false;d.gStyle.ImageSVG=false}}if(m.usesvgimg){if(k){n.canvas=new k(j,p);n.canvas.style={}}m.renderer=m.usewebgl?new h.WebGLRenderer(n):new h.CanvasRenderer(n)}else{m.renderer=h.CreateSVGRenderer(false,0,b)}if(m.usesvgimg||(m.renderer.makeOuterHTML!==undefined)){if(!d.svg_workaround){d.svg_workaround=[]}m.renderer.workaround_id=d.svg_workaround.length;d.svg_workaround[m.renderer.workaround_id]="<svg></svg>";m.dom=b.createElementNS("http://www.w3.org/2000/svg","path");m.dom.setAttribute("jsroot_svg_workaround",m.renderer.workaround_id)}}else{m.renderer=m.usewebgl?new h.WebGLRenderer(n):new h.CanvasRenderer(n)}m.renderer.setSize(j,p);if(!m.dom){m.dom=m.renderer.domElement;if(!q&&i){m.dom=m.renderer.svgImage=b.createElementNS("http://www.w3.org/2000/svg","image");g.select(m.dom).attr("width",j).attr("height",p)}}return m};d.Painter.AfterRender3D=function(l){if(l.svgImage){var m=l.domElement.toDataURL("image/png");var k=d.nodejs?"xlink_href_nodejs":"xlink:href";g.select(l.svgImage).attr(k,m)}if(l.workaround_id!==undefined){if(typeof l.makeOuterHTML=="function"){d.svg_workaround[l.workaround_id]=l.makeOuterHTML()}else{var j=l.domElement;var m=j.toDataURL("image/png");var i='<image width="'+j.width+'" height="'+j.height+'" xlink:href="'+m+'"></image>';d.svg_workaround[l.workaround_id]=i}}};d.Painter.ProcessSVGWorkarounds=function(j){if(!d.svg_workaround){return j}for(var i=0;i<d.svg_workaround.length;++i){j=j.replace('<path jsroot_svg_workaround="'+i+'"></path>',d.svg_workaround[i])}d.svg_workaround=undefined;return j};d.Painter.TooltipFor3D=function(j,i){this.tt=null;this.cont=null;this.lastlbl="";this.parent=j?j:b.body;this.canvas=i;this.abspos=!j;this.check_parent=function(k){if(k&&(this.parent!==k)){this.hide();this.parent=k}};this.pos=function(s){if(this.tt===null){return}var q,n;if(this.abspos){n=d.browser.isIE?(s.clientX+b.documentElement.scrollLeft):s.pageX;q=d.browser.isIE?(s.clientY+b.documentElement.scrollTop):s.pageY}else{n=s.offsetX;q=s.offsetY;var o=this.parent.getBoundingClientRect(),m=this.canvas.getBoundingClientRect();if((o.left!==undefined)&&(m.left!==undefined)){n+=(m.left-o.left)}if((o.top!==undefined)&&(m.top!==undefined)){q+=m.top-o.top}if(n+this.tt.offsetWidth+3>=this.parent.offsetWidth){n=this.parent.offsetWidth-this.tt.offsetWidth-3}if(q+this.tt.offsetHeight+15>=this.parent.offsetHeight){q=this.parent.offsetHeight-this.tt.offsetHeight-15}var k=this.parent;while(k){var r=getComputedStyle(k);if(!r||(r.position!=="static")){break}if(!k.parentNode||(k.parentNode.nodeType!=1)){break}k=k.parentNode}if(k&&(k!==this.parent)){var p=k.getBoundingClientRect();n+=(o.left-p.left);q+=(o.top-p.top)}}this.tt.style.top=(q+15)+"px";this.tt.style.left=(n+3)+"px"};this.show=function(k,m,o){if(!k||(k==="")){return this.hide()}if(k&&(typeof k=="object")&&(k.lines||k.line)){if(k.only_status){return this.hide()}if(k.line){k=k.line}else{var l=k.lines[0];for(var p=1;p<k.lines.length;++p){l+="<br/>"+k.lines[p]}k=l}}if(this.tt===null){this.tt=b.createElement("div");this.tt.setAttribute("class","jsroot_tt3d_main");this.cont=b.createElement("div");this.cont.setAttribute("class","jsroot_tt3d_cont");this.tt.appendChild(this.cont);this.parent.appendChild(this.tt)}if(this.lastlbl!==k){this.cont.innerHTML=k;this.lastlbl=k;this.tt.style.width="auto";if(d.browser.isIE){this.tt.style.width=this.tt.offsetWidth}}};this.hide=function(){if(this.tt!==null){this.parent.removeChild(this.tt)}this.tt=null;this.lastlbl=""};return this};d.Painter.CreateOrbitControl=function(p,n,l,o,q){if(d.gStyle.Zooming&&d.gStyle.ZoomWheel){o.domElement.addEventListener("wheel",j)}if(d.gStyle.Zooming&&d.gStyle.ZoomMouse){o.domElement.addEventListener("mousedown",i);o.domElement.addEventListener("mouseup",m)}var k=new h.OrbitControls(n,o.domElement);k.enableDamping=false;k.dampingFactor=1;k.enableZoom=true;if(q){k.target.copy(q);k.target0.copy(q);k.update()}k.tooltip=new d.Painter.TooltipFor3D(p.select_main().node(),o.domElement);k.painter=p;k.camera=n;k.scene=l;k.renderer=o;k.raycaster=new h.Raycaster();k.raycaster.linePrecision=10;k.mouse_zoom_mesh=null;k.block_ctxt=false;k.block_mousemove=false;k.cursor_changed=false;k.control_changed=false;k.control_active=false;k.mouse_ctxt={x:0,y:0,on:false};k.Cleanup=function(){if(d.gStyle.Zooming&&d.gStyle.ZoomWheel){this.domElement.removeEventListener("wheel",j)}if(d.gStyle.Zooming&&d.gStyle.ZoomMouse){this.domElement.removeEventListener("mousedown",i);this.domElement.removeEventListener("mouseup",m)}this.domElement.removeEventListener("dblclick",this.lstn_dblclick);this.domElement.removeEventListener("contextmenu",this.lstn_contextmenu);this.domElement.removeEventListener("mousemove",this.lstn_mousemove);this.domElement.removeEventListener("mouseleave",this.lstn_mouseleave);this.dispose();this.tooltip.hide();delete this.tooltip;delete this.painter;delete this.camera;delete this.scene;delete this.renderer;delete this.raycaster;delete this.mouse_zoom_mesh};k.HideTooltip=function(){this.tooltip.hide()};k.GetMousePos=function(s,r){r.x=("offsetX" in s)?s.offsetX:s.layerX;r.y=("offsetY" in s)?s.offsetY:s.layerY;r.clientX=s.clientX;r.clientY=s.clientY;return r};k.GetIntersects=function(r){var u=(this.renderer instanceof h.WebGLRenderer)?this.renderer.getSize():this.renderer.domElement;var t={x:r.x/u.width*2-1,y:-r.y/u.height*2+1};this.camera.updateMatrix();this.camera.updateMatrixWorld();this.raycaster.setFromCamera(t,this.camera);var s=this.raycaster.intersectObjects(this.scene.children,true);if(typeof this.painter.FilterIntersects=="function"){s=this.painter.FilterIntersects(s)}return s};k.DetectZoomMesh=function(u){var r=this.GetMousePos(u,{});var s=this.GetIntersects(r);if(s){for(var t=0;t<s.length;++t){if(s[t].object.zoom){return s[t]}}}return null};k.ProcessDblClick=function(s){var r=this.DetectZoomMesh(s);if(r&&this.painter){this.painter.Unzoom(r.object.use_y_for_z?"y":r.object.zoom)}else{this.reset()}};k.ChangeEvent=function(){this.mouse_ctxt.on=false;this.painter.Render3D(0);this.control_changed=true};k.StartEvent=function(){this.control_active=true;this.block_ctxt=false;this.mouse_ctxt.on=false;this.tooltip.hide()};k.EndEvent=function(){this.control_active=false;if(this.mouse_ctxt.on){this.mouse_ctxt.on=false;this.ContextMenu(this.mouse_ctxt,this.GetIntersects(this.mouse_ctxt))}else{if(this.control_changed){}}this.control_changed=false};k.MainProcessContextMenu=function(r){r.preventDefault();this.GetMousePos(r,this.mouse_ctxt);if(this.control_active){this.mouse_ctxt.on=true}else{if(this.block_ctxt){this.block_ctxt=false}else{this.ContextMenu(this.mouse_ctxt,this.GetIntersects(this.mouse_ctxt))}}};k.ContextMenu=function(s,r){};k.SwitchTooltip=function(r){this.block_mousemove=!r;if(r===false){this.tooltip.hide();this.RemoveZoomMesh()}};k.RemoveZoomMesh=function(){if(this.mouse_zoom_mesh&&this.mouse_zoom_mesh.object.ShowSelection()){this.painter.Render3D()}this.mouse_zoom_mesh=null};k.MainProcessMouseMove=function(C){if(this.control_active&&C.buttons&&(C.buttons&2)){this.block_ctxt=true}if(this.control_active||this.block_mousemove||!this.ProcessMouseMove){return}if(this.mouse_zoom_mesh){var w=this.DetectZoomMesh(C),s=null;if(w&&(w.object===this.mouse_zoom_mesh.object)){s=w.point}else{s=this.mouse_zoom_mesh.object.GlobalIntersect(this.raycaster)}if(s){this.mouse_zoom_mesh.point2=s}if(s&&this.painter.enable_highlight){if(this.mouse_zoom_mesh.object.ShowSelection(this.mouse_zoom_mesh.point,s)){this.painter.Render3D(0)}}this.tooltip.hide();return}C.preventDefault();var z=this.GetMousePos(C,{}),y=this.GetIntersects(z),B=this.ProcessMouseMove(y),v=this.painter.GetShowStatusFunc();if(B&&v){var r="",A="",x="",u="";if(z){x=z.x.toFixed(0)+","+z.y.toFixed(0)}if(typeof B=="string"){u=B}else{r=B.name;A=B.title;if(B.line){u=B.line}else{if(B.lines){u=B.lines.slice(1).join(" ");r=B.lines[0]}}}v(r,A,u,x)}this.cursor_changed=false;if(B&&this.painter.tooltip_allowed){this.tooltip.check_parent(this.painter.select_main().node());this.tooltip.show(B,z);this.tooltip.pos(C)}else{this.tooltip.hide();if(y){for(var t=0;t<y.length;++t){if(y[t].object.zoom){this.cursor_changed=true}}}}b.body.style.cursor=this.cursor_changed?"pointer":"auto"};k.MainProcessMouseLeave=function(){this.tooltip.hide();if(typeof this.ProcessMouseLeave==="function"){this.ProcessMouseLeave()}if(this.cursor_changed){b.body.style.cursor="auto";this.cursor_changed=false}};function j(v){if(d.Painter.IsRender3DFired(k.painter)||k.mouse_zoom_mesh){v.preventDefault();v.stopPropagation();v.stopImmediatePropagation();return}var s=k.DetectZoomMesh(v);if(!s){return}v.preventDefault();v.stopPropagation();v.stopImmediatePropagation();if(k.painter&&(typeof k.painter.AnalyzeMouseWheelEvent=="function")){var t=s.object.zoom,r=s.point[t],u={name:t,ignore:false};if(t!=="z"){r=(r+k.painter.size_xy3d)/2/k.painter.size_xy3d}else{r=r/2/k.painter.size_z3d}k.painter.AnalyzeMouseWheelEvent(v,u,r,false);if((t==="z")&&s.object.use_y_for_z){t="y"}k.painter.Zoom(t,u.min,u.max)}}function i(r){if(k.mouse_zoom_mesh){r.stopImmediatePropagation();r.stopPropagation();return}if((r.button!==undefined)&&(r.button!==0)){return}if((r.buttons!==undefined)&&(r.buttons!==1)){return}k.mouse_zoom_mesh=k.DetectZoomMesh(r);if(!k.mouse_zoom_mesh){return}r.stopImmediatePropagation();r.stopPropagation()}function m(w){if(k.mouse_zoom_mesh&&k.mouse_zoom_mesh.point2&&k.painter.Get3DZoomCoord){var u=k.mouse_zoom_mesh.object.zoom,t=k.painter.Get3DZoomCoord(k.mouse_zoom_mesh.point,u),s=k.painter.Get3DZoomCoord(k.mouse_zoom_mesh.point2,u);if(t>s){var r=t;t=s;s=r}if((u==="z")&&k.mouse_zoom_mesh.object.use_y_for_z){u="y"}if((u==="z")&&k.mouse_zoom_mesh.object.use_y_for_z){u="y"}if(t<s){if(k.painter.Zoom(u,t,s)){k.mouse_zoom_mesh=null}}}k.RemoveZoomMesh()}k.MainProcessDblClick=function(r){this.ProcessDblClick(r)};k.addEventListener("change",k.ChangeEvent.bind(k));k.addEventListener("start",k.StartEvent.bind(k));k.addEventListener("end",k.EndEvent.bind(k));k.lstn_contextmenu=k.MainProcessContextMenu.bind(k);k.lstn_dblclick=k.MainProcessDblClick.bind(k);k.lstn_mousemove=k.MainProcessMouseMove.bind(k);k.lstn_mouseleave=k.MainProcessMouseLeave.bind(k);o.domElement.addEventListener("dblclick",k.lstn_dblclick);o.domElement.addEventListener("contextmenu",k.lstn_contextmenu);o.domElement.addEventListener("mousemove",k.lstn_mousemove);o.domElement.addEventListener("mouseleave",k.lstn_mouseleave);return k};d.Painter.DisposeThreejsObject=function(k,l){if(!k){return}if(k.children){for(var j=0;j<k.children.length;j++){d.Painter.DisposeThreejsObject(k.children[j])}}if(l){k.children=[];return}k.children=undefined;if(k.geometry){k.geometry.dispose();k.geometry=undefined}if(k.material){if(k.material.map){k.material.map.dispose();k.material.map=undefined}k.material.dispose();k.material=undefined}delete k.painter;delete k.bins_index;delete k.tooltip;delete k.stack;k=undefined};d.Painter.createLineSegments=function(l,o,m,t){var r=new h.BufferGeometry();r.addAttribute("position",l instanceof Float32Array?new h.BufferAttribute(l,3):new h.Float32BufferAttribute(l,3));if(m){r.setIndex(new h.BufferAttribute(m,1))}if(o.isLineDashedMaterial){var u=new h.Vector3(),s=new h.Vector3(),p=0,q=null;if(m){q=new Float32Array(m.length);for(var i=0;i<m.length;i+=2){var k=m[i],j=m[i+1];u.set(l[k],l[k+1],l[k+2]);s.set(l[j],l[j+1],l[j+2]);q[i]=p;p+=s.distanceTo(u);q[i+1]=p}}else{q=new Float32Array(l.length/3);for(var i=0;i<l.length;i+=6){u.set(l[i],l[i+1],l[i+2]);s.set(l[i+3],l[i+4],l[i+5]);q[i/3]=p;p+=s.distanceTo(u);q[i/3+1]=p}}r.addAttribute("lineDistance",new h.BufferAttribute(q,1))}return t?r:new h.LineSegments(r,o)};d.Painter.Box3D={Vertices:[new h.Vector3(1,1,1),new h.Vector3(1,1,0),new h.Vector3(1,0,1),new h.Vector3(1,0,0),new h.Vector3(0,1,0),new h.Vector3(0,1,1),new h.Vector3(0,0,0),new h.Vector3(0,0,1)],Indexes:[0,2,1,2,3,1,4,6,5,6,7,5,4,5,1,5,0,1,7,6,2,6,3,2,5,7,0,7,2,0,1,3,4,3,6,4],Normals:[1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],Segments:[0,2,2,7,7,5,5,0,1,3,3,6,6,4,4,1,1,0,3,2,6,7,4,5]};d.Painter.Box3D.MeshSegments=(function(){var l=d.Painter.Box3D,i=new Int32Array(l.Segments.length);for(var m=0;m<i.length;++m){for(var j=0;j<l.Indexes.length;++j){if(l.Segments[m]===l.Indexes[j]){i[m]=j;break}}}return i})();d.Painter.IsRender3DFired=function(i){if(!i||i.renderer===undefined){return false}return i.render_tmout!==undefined};function f(j,i,k){this.webgl=(i===undefined)?true:i;this.scale=k||1;this.pos=new Float32Array(j*3);this.geom=new h.BufferGeometry();this.geom.addAttribute("position",new h.BufferAttribute(this.pos,3));this.indx=0}f.prototype.AddPoint=function(i,k,j){this.pos[this.indx]=i;this.pos[this.indx+1]=k;this.pos[this.indx+2]=j;this.indx+=3};f.prototype.CreatePoints=function(k){var j=new h.PointsMaterial({size:(this.webgl?3:1)*this.scale,color:k||"black"});var i=new h.Points(this.geom,j);i.nvertex=1;return i};function e(i,m){if(!i||!m){return null}var l=i.get_color(m.fLineColor),k=null,j=m.fLineStyle?d.Painter.root_line_styles[m.fLineStyle]:"",n=j?j.split(","):[];if(n&&n.length>=2){k=new h.LineDashedMaterial({color:l,dashSize:parseInt(n[0]),gapSize:parseInt(n[1])})}else{k=new h.LineBasicMaterial({color:l})}if(m.fLineWidth&&(m.fLineWidth>1)&&!d.browser.isIE){k.linewidth=m.fLineWidth}return k}function a(){var l=this.GetObject(),j=this.frame_painter();if(!j||!j.mode3d||!j.toplevel||!l){return}var o,m,p,i=[];if(l._blob&&(l._blob.length==4)){o=l._blob[1];m=l._blob[2];p=l._blob[3]}else{o=l.fN;m=l.fP;p=l.fOption}for(var q=3;q<3*o;q+=3){i.push(j.grx(m[q-3]),j.gry(m[q-2]),j.grz(m[q-1]),j.grx(m[q]),j.gry(m[q+1]),j.grz(m[q+2]))}var k=d.Painter.createLineSegments(i,e(this,l));j.toplevel.add(k)}d.Painter.PointsCreator=f;d.Painter.drawPolyLine3D=a;d.Painter.Create3DLineMaterial=e;return d}));