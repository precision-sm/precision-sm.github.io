(function(a){if(typeof define==="function"&&define.amd){define(["JSRootCore","threejs","ThreeCSG"],a)}else{if(typeof exports==="object"&&typeof module!=="undefined"){a(require("./JSRootCore.js"),require("./three.min.js"),require("./ThreeCSG.js"))}else{if(typeof JSROOT=="undefined"){throw new Error("JSROOT is not defined","JSRootGeoBase.js")}if(typeof THREE=="undefined"){throw new Error("THREE is not defined","JSRootGeoBase.js")}if(typeof ThreeBSP=="undefined"){throw new Error("ThreeBSP is not defined","JSRootGeoBase.js")}a(JSROOT,THREE,ThreeBSP)}}}(function(a,b,c){a.GEO={GradPerSegm:6,CompressComp:true,CompLimit:20};a.GEO.BITS={kVisOverride:a.BIT(0),kVisNone:a.BIT(1),kVisThis:a.BIT(2),kVisDaughters:a.BIT(3),kVisOneLevel:a.BIT(4),kVisStreamed:a.BIT(5),kVisTouched:a.BIT(6),kVisOnScreen:a.BIT(7),kVisContainers:a.BIT(12),kVisOnly:a.BIT(13),kVisBranch:a.BIT(14),kVisRaytrace:a.BIT(15)};a.GEO.TestBit=function(e,g){var d=e.fGeoAtt;return d===undefined?false:((d&g)!==0)};a.GEO.SetBit=function(d,g,e){if(d.fGeoAtt===undefined){return}d.fGeoAtt=e?(d.fGeoAtt|g):(d.fGeoAtt&~g)};a.GEO.ToggleBit=function(d,e){if(d.fGeoAtt!==undefined){d.fGeoAtt=d.fGeoAtt^(e&16777215)}};a.GEO.InvisibleAll=function(d){if(d===undefined){d=true}a.GEO.SetBit(this,a.GEO.BITS.kVisThis,!d);a.GEO.SetBit(this,a.GEO.BITS.kVisDaughters,!d);a.GEO.SetBit(this,a.GEO.BITS.kVisOneLevel,false);if(this.fNodes){for(var f=0;f<this.fNodes.arr.length;++f){var e=this.fNodes.arr[f].fVolume;a.GEO.SetBit(e,a.GEO.BITS.kVisThis,!d)}}};a.GEO.warn=function(d){if(a.GEO._warn_msgs===undefined){a.GEO._warn_msgs={}}if(a.GEO._warn_msgs[d]!==undefined){return}a.GEO._warn_msgs[d]=true;console.warn(d)};a.GEO.NodeKind=function(d){if((d===undefined)||(d===null)||(typeof d!=="object")){return -1}return("fShape" in d)&&("fTrans" in d)?1:0};a.GEO.getNodeProperties=function(i,h,g){if(i===1){var d={name:a.GEO.ObjectName(h),nname:a.GEO.ObjectName(h),shape:h.fShape,material:null,chlds:null};if(h.fElements!==null){d.chlds=h.fElements.arr}if(g){var l=false,k=1;if(h.fRGBA[3]<1){l=true;k=h.fRGBA[3]}d.fillcolor=new b.Color(h.fRGBA[0],h.fRGBA[1],h.fRGBA[2]);d.material=new b.MeshLambertMaterial({transparent:l,opacity:k,wireframe:false,color:d.fillcolor,side:b.FrontSide,vertexColors:b.NoColors,overdraw:0,depthWrite:!l});d.material.alwaysTransparent=l;d.material.inherentOpacity=k}return d}var j=h.fVolume;var d={name:a.GEO.ObjectName(j),nname:a.GEO.ObjectName(h),volume:h.fVolume,shape:j.fShape,material:null,chlds:null};if(h.fVolume.fNodes!==null){d.chlds=h.fVolume.fNodes.arr}if(g){var l=false,k=1;if((j.fFillColor>1)&&(j.fLineColor==1)){d.fillcolor=a.Painter.root_colors[j.fFillColor]}else{if(j.fLineColor>=0){d.fillcolor=a.Painter.root_colors[j.fLineColor]}}if(j.fMedium&&j.fMedium.fMaterial){var e=j.fMedium.fMaterial.fFillStyle;var f=(e<3000||e>3100)?0:e-3000;if(f>0){l=true;k=(100-f)/100}if(d.fillcolor===undefined){d.fillcolor=a.Painter.root_colors[j.fMedium.fMaterial.fFillColor]}}if(d.fillcolor===undefined){d.fillcolor="lightgrey"}d.material=new b.MeshLambertMaterial({transparent:l,opacity:k,wireframe:false,color:d.fillcolor,side:b.FrontSide,vertexColors:b.NoColors,overdraw:0,depthWrite:!l});d.material.alwaysTransparent=l;d.material.inherentOpacity=k}return d};a.GEO.CountNumShapes=function(d){if(!d){return 0}if(d._typename!=="TGeoCompositeShape"){return 1}return a.GEO.CountNumShapes(d.fNode.fLeft)+a.GEO.CountNumShapes(d.fNode.fRight)};a.GEO.GeometryCreator=function(d){this.nfaces=d;this.indx=0;this.pos=new Float32Array(d*9);this.norm=new Float32Array(d*9);return this};a.GEO.GeometryCreator.prototype.AddFace3=function(f,n,i,e,m,h,d,k,g){var j=this.indx,l=this.pos;l[j]=f;l[j+1]=n;l[j+2]=i;l[j+3]=e;l[j+4]=m;l[j+5]=h;l[j+6]=d;l[j+7]=k;l[j+8]=g;this.last4=false;this.indx=j+9};a.GEO.GeometryCreator.prototype.StartPolygon=function(){};a.GEO.GeometryCreator.prototype.StopPolygon=function(){};a.GEO.GeometryCreator.prototype.AddFace4=function(f,q,j,e,p,i,d,n,h,r,l,g,m){var k=this.indx,o=this.pos;if(m!==1){o[k]=f;o[k+1]=q;o[k+2]=j;o[k+3]=e;o[k+4]=p;o[k+5]=i;o[k+6]=d;o[k+7]=n;o[k+8]=h;k+=9}if(m!==2){o[k]=f;o[k+1]=q;o[k+2]=j;o[k+3]=d;o[k+4]=n;o[k+5]=h;o[k+6]=r;o[k+7]=l;o[k+8]=g;k+=9}this.last4=(k!==this.indx+9);this.indx=k};a.GEO.GeometryCreator.prototype.SetNormal4=function(e,o,i,r,m,h,q,l,g,p,k,f,n){if(this.last4&&n){return console.error("missmatch between AddFace4 and SetNormal4 calls")}var j=this.indx-(this.last4?18:9),d=this.norm;if(n!==1){d[j]=e;d[j+1]=o;d[j+2]=i;d[j+3]=r;d[j+4]=m;d[j+5]=h;d[j+6]=q;d[j+7]=l;d[j+8]=g;j+=9}if(n!==2){d[j]=e;d[j+1]=o;d[j+2]=i;d[j+3]=q;d[j+4]=l;d[j+5]=g;d[j+6]=p;d[j+7]=k;d[j+8]=f}};a.GEO.GeometryCreator.prototype.RecalcZ=function(f){var g=this.pos,e=this.indx,d=e-(this.last4?18:9);while(d<e){g[d+2]=f(g[d],g[d+1],g[d+2]);d+=3}};a.GEO.GetNormal=function(g,p,m,e,o,l,d,n,k){var i=new b.Vector3(g,p,m),h=new b.Vector3(e,o,l),f=new b.Vector3(d,n,k),j=new b.Vector3(),q=new b.Vector3();j.subVectors(f,h);q.subVectors(i,h);j.cross(q);return j};a.GEO.GeometryCreator.prototype.CalcNormal=function(){var e=this.indx,d=this.norm;if(!this.cb){this.pA=new b.Vector3();this.pB=new b.Vector3();this.pC=new b.Vector3();this.cb=new b.Vector3();this.ab=new b.Vector3()}this.pA.fromArray(this.pos,this.indx-9);this.pB.fromArray(this.pos,this.indx-6);this.pC.fromArray(this.pos,this.indx-3);this.cb.subVectors(this.pC,this.pB);this.ab.subVectors(this.pA,this.pB);this.cb.cross(this.ab);this.SetNormal(this.cb.x,this.cb.y,this.cb.z)};a.GEO.GeometryCreator.prototype.SetNormal=function(d,h,g){var f=this.indx-9,e=this.norm;e[f]=e[f+3]=e[f+6]=d;e[f+1]=e[f+4]=e[f+7]=h;e[f+2]=e[f+5]=e[f+8]=g;if(this.last4){f-=9;e[f]=e[f+3]=e[f+6]=d;e[f+1]=e[f+4]=e[f+7]=h;e[f+2]=e[f+5]=e[f+8]=g}};a.GEO.GeometryCreator.prototype.SetNormal_12_34=function(e,g,i,f,j,l,k){if(k===undefined){k=0}var h=this.indx-((k>0)?9:18),d=this.norm;if(k!==1){d[h]=e;d[h+1]=g;d[h+2]=i;d[h+3]=e;d[h+4]=g;d[h+5]=i;d[h+6]=f;d[h+7]=j;d[h+8]=l;h+=9}if(k!==2){d[h]=e;d[h+1]=g;d[h+2]=i;d[h+3]=f;d[h+4]=j;d[h+5]=l;d[h+6]=f;d[h+7]=j;d[h+8]=l;h+=9}};a.GEO.GeometryCreator.prototype.Create=function(){if(this.nfaces!==this.indx/9){console.error("Mismatch with created "+this.nfaces+" and filled "+this.indx/9+" number of faces")}var d=new b.BufferGeometry();d.addAttribute("position",new b.BufferAttribute(this.pos,3));d.addAttribute("normal",new b.BufferAttribute(this.norm,3));return d};a.GEO.PolygonsCreator=function(){this.polygons=[]};a.GEO.PolygonsCreator.prototype.StartPolygon=function(d){this.multi=1;this.mnormal=d};a.GEO.PolygonsCreator.prototype.StopPolygon=function(){if(!this.multi){return}this.multi=0;console.error("Polygon should be already closed at this moment")};a.GEO.PolygonsCreator.prototype.AddFace3=function(f,l,i,e,k,h,d,j,g){this.AddFace4(f,l,i,e,k,h,d,j,g,d,j,g,2)};a.GEO.PolygonsCreator.prototype.AddFace4=function(t,g,o,s,f,l,r,e,k,q,d,j,n){if(n===undefined){n=0}this.v1=new c.Vertex(t,g,o,0,0,0);this.v2=(n===1)?null:new c.Vertex(s,f,l,0,0,0);this.v3=new c.Vertex(r,e,k,0,0,0);this.v4=(n===2)?null:new c.Vertex(q,d,j,0,0,0);this.reduce=n;if(this.multi){if(n!==2){console.error("polygon not supported for not-reduced faces")}var m;if(this.multi++===1){m=new c.Polygon;m.vertices.push(this.mnormal?this.v2:this.v3);this.polygons.push(m)}else{m=this.polygons[this.polygons.length-1];var i=this.mnormal?m.vertices[m.vertices.length-1]:m.vertices[0],u=this.mnormal?this.v2:this.v3;if(u.diff(i)>1e-12){console.error("vertex missmatch when building polygon")}}var h=this.mnormal?m.vertices[0]:m.vertices[m.vertices.length-1],p=this.mnormal?this.v3:this.v2;if(p.diff(h)<1e-12){this.multi=0}else{if(this.mnormal){m.vertices.push(this.v3)}else{m.vertices.unshift(this.v2)}}return}var m=new c.Polygon;switch(n){case 0:m.vertices.push(this.v1,this.v2,this.v3,this.v4);break;case 1:m.vertices.push(this.v1,this.v3,this.v4);break;case 2:m.vertices.push(this.v1,this.v2,this.v3);break}this.polygons.push(m)};a.GEO.PolygonsCreator.prototype.SetNormal4=function(d,m,h,p,k,g,o,j,f,n,i,e,l){this.v1.setnormal(d,m,h);if(this.v2){this.v2.setnormal(p,k,g)}this.v3.setnormal(o,j,f);if(this.v4){this.v4.setnormal(n,i,e)}};a.GEO.PolygonsCreator.prototype.SetNormal_12_34=function(g,e,j,i,f,d,h){this.v1.setnormal(g,e,j);if(this.v2){this.v2.setnormal(g,e,j)}this.v3.setnormal(i,f,d);if(this.v4){this.v4.setnormal(i,f,d)}};a.GEO.PolygonsCreator.prototype.CalcNormal=function(){if(!this.cb){this.pA=new b.Vector3();this.pB=new b.Vector3();this.pC=new b.Vector3();this.cb=new b.Vector3();this.ab=new b.Vector3()}this.pA.set(this.v1.x,this.v1.y,this.v1.z);if(this.reduce!==1){this.pB.set(this.v2.x,this.v2.y,this.v2.z);this.pC.set(this.v3.x,this.v3.y,this.v3.z)}else{this.pB.set(this.v3.x,this.v3.y,this.v3.z);this.pC.set(this.v4.x,this.v4.y,this.v4.z)}this.cb.subVectors(this.pC,this.pB);this.ab.subVectors(this.pA,this.pB);this.cb.cross(this.ab);this.SetNormal(this.cb.x,this.cb.y,this.cb.z)};a.GEO.PolygonsCreator.prototype.SetNormal=function(d,f,e){this.v1.setnormal(d,f,e);if(this.v2){this.v2.setnormal(d,f,e)}this.v3.setnormal(d,f,e);if(this.v4){this.v4.setnormal(d,f,e)}};a.GEO.PolygonsCreator.prototype.RecalcZ=function(d){this.v1.z=d(this.v1.x,this.v1.y,this.v1.z);if(this.v2){this.v2.z=d(this.v2.x,this.v2.y,this.v2.z)}this.v3.z=d(this.v3.x,this.v3.y,this.v3.z);if(this.v4){this.v4.z=d(this.v4.x,this.v4.y,this.v4.z)}};a.GEO.PolygonsCreator.prototype.Create=function(){return{polygons:this.polygons}};a.GEO.createCubeBuffer=function(g,i){if(i<0){return 12}var f=g.fDX,e=g.fDY,d=g.fDZ;var h=i?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(12);h.AddFace4(f,e,d,f,-e,d,f,-e,-d,f,e,-d);h.SetNormal(1,0,0);h.AddFace4(-f,e,-d,-f,-e,-d,-f,-e,d,-f,e,d);h.SetNormal(-1,0,0);h.AddFace4(-f,e,-d,-f,e,d,f,e,d,f,e,-d);h.SetNormal(0,1,0);h.AddFace4(-f,-e,d,-f,-e,-d,f,-e,-d,f,-e,d);h.SetNormal(0,-1,0);h.AddFace4(-f,e,d,-f,-e,d,f,-e,d,f,e,d);h.SetNormal(0,0,1);h.AddFace4(f,e,-d,f,-e,-d,-f,-e,-d,-f,e,-d);h.SetNormal(0,0,-1);return h.Create()};a.GEO.create8edgesBuffer=function(l,k){var i=[4,7,6,5,0,3,7,4,4,5,1,0,6,2,1,5,7,3,2,6,1,2,3,0];var f=(k>0)?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(12);for(var e=0;e<i.length;e+=4){var j=i[e]*3,h=i[e+1]*3,g=i[e+2]*3,d=i[e+3]*3;f.AddFace4(l[j],l[j+1],l[j+2],l[h],l[h+1],l[h+2],l[g],l[g+1],l[g+2],l[d],l[d+1],l[d+2]);if(e===0){f.SetNormal(0,0,1)}else{if(e===20){f.SetNormal(0,0,-1)}else{f.CalcNormal()}}}return f.Create()};a.GEO.createParaBuffer=function(e,i){if(i<0){return 12}var g=e.fTxy,f=e.fTxz,h=e.fTyz;var d=[-e.fZ*f-g*e.fY-e.fX,-e.fY-e.fZ*h,-e.fZ,-e.fZ*f+g*e.fY-e.fX,e.fY-e.fZ*h,-e.fZ,-e.fZ*f+g*e.fY+e.fX,e.fY-e.fZ*h,-e.fZ,-e.fZ*f-g*e.fY+e.fX,-e.fY-e.fZ*h,-e.fZ,e.fZ*f-g*e.fY-e.fX,-e.fY+e.fZ*h,e.fZ,e.fZ*f+g*e.fY-e.fX,e.fY+e.fZ*h,e.fZ,e.fZ*f+g*e.fY+e.fX,e.fY+e.fZ*h,e.fZ,e.fZ*f-g*e.fY+e.fX,-e.fY+e.fZ*h,e.fZ];return a.GEO.create8edgesBuffer(d,i)};a.GEO.createTrapezoidBuffer=function(e,h){if(h<0){return 12}var g,f;if(e._typename=="TGeoTrd1"){g=f=e.fDY}else{g=e.fDy1;f=e.fDy2}var d=[-e.fDx1,g,-e.fDZ,e.fDx1,g,-e.fDZ,e.fDx1,-g,-e.fDZ,-e.fDx1,-g,-e.fDZ,-e.fDx2,f,e.fDZ,e.fDx2,f,e.fDZ,e.fDx2,-f,e.fDZ,-e.fDx2,-f,e.fDZ];return a.GEO.create8edgesBuffer(d,h)};a.GEO.createArb8Buffer=function(g,m){if(m<0){return 12}var l=[g.fXY[0][0],g.fXY[0][1],-g.fDZ,g.fXY[1][0],g.fXY[1][1],-g.fDZ,g.fXY[2][0],g.fXY[2][1],-g.fDZ,g.fXY[3][0],g.fXY[3][1],-g.fDZ,g.fXY[4][0],g.fXY[4][1],g.fDZ,g.fXY[5][0],g.fXY[5][1],g.fDZ,g.fXY[6][0],g.fXY[6][1],g.fDZ,g.fXY[7][0],g.fXY[7][1],g.fDZ],h=[4,7,6,6,5,4,0,3,7,7,4,0,4,5,1,1,0,4,6,2,1,1,5,6,7,3,2,2,6,7,1,2,3,3,0,1];for(var i=0;i<l.length;i+=l.length/2){for(var p=i;p<i+l.length/2-3;p+=3){for(var o=p+3;o<i+l.length/2;o+=3){if((l[p]===l[o])&&(l[p+1]===l[o+1])&&(l[p+2]===l[o+2])){for(var A=0;A<h.length;++A){if(h[A]===o/3){h[A]=p/3}}}}}}var C=[],B=0;for(var A=0;A<h.length;A+=3){var f=h[A]*100+h[A+1]*10+h[A+2],e=h[A+1]*100+h[A+2]*10+h[A],d=h[A+2]*100+h[A]*10+h[A+1];if((h[A]==h[A+1])||(h[A]==h[A+2])||(h[A+1]==h[A+2])||(C.indexOf(f)>=0)||(C.indexOf(e)>=0)||(C.indexOf(d)>=0)){h[A]=h[A+1]=h[A+2]=-1}else{C.push(f,e,d);B++}}var q=m?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(B);for(var x=0;x<h.length;x+=6){var z=h[x]*3,y=h[x+1]*3,w=h[x+2]*3,v=h[x+3]*3,u=h[x+4]*3,t=h[x+5]*3,j=null;if((z>=0)&&(v>=0)&&m){if(x===0){j=new b.Vector3(0,0,1)}else{if(x===30){j=new b.Vector3(0,0,-1)}else{var s=a.GEO.GetNormal(l[z],l[z+1],l[z+2],l[y],l[y+1],l[y+2],l[w],l[w+1],l[w+2]);s.normalize();var r=a.GEO.GetNormal(l[v],l[v+1],l[v+2],l[u],l[u+1],l[u+2],l[t],l[t+1],l[t+2]);r.normalize();if(s.distanceToSquared(r)<1e-12){j=s}}}}if(j!==null){q.AddFace4(l[z],l[z+1],l[z+2],l[y],l[y+1],l[y+2],l[w],l[w+1],l[w+2],l[u],l[u+1],l[u+2]);q.SetNormal(j.x,j.y,j.z)}else{if(z>=0){q.AddFace3(l[z],l[z+1],l[z+2],l[y],l[y+1],l[y+2],l[w],l[w+1],l[w+2]);q.CalcNormal()}if(v>=0){q.AddFace3(l[v],l[v+1],l[v+2],l[u],l[u+1],l[u+2],l[t],l[t+1],l[t+2]);q.CalcNormal()}}}return q.Create()};a.GEO.createSphereBuffer=function(m,v){var D=[m.fRmax,m.fRmin],t=m.fPhi1,P=m.fPhi2-m.fPhi1,L=m.fTheta1,q=m.fTheta2-m.fTheta1,B=m.fNseg,N=m.fNz,G=(D[1]<=0);if(v>0){var f=(G?2:4)*B*N/v;if(f>1){B=Math.max(4,Math.floor(B/Math.sqrt(f)));N=Math.max(4,Math.floor(N/Math.sqrt(f)))}}var u=B*N*2,A=B*2,h=B*2,y=P===360?0:N*(G?2:4),F=1e-10;if(G){h=A=B}if(v<0){return u*(G?1:2)+A+h+y}var O=new Float32Array(B+1),e=new Float32Array(B+1),M=new Float32Array(N+1),d=new Float32Array(N+1);for(var I=0;I<=N;++I){var l=(L+q/N*I)*Math.PI/180;M[I]=Math.sin(l);d[I]=Math.cos(l)}for(var I=0;I<=B;++I){var Q=(t+P/B*I)*Math.PI/180;O[I]=Math.sin(Q);e[I]=Math.cos(Q)}if(Math.abs(M[0])<=F){u-=B;A=0}if(Math.abs(M[N])<=F){u-=B;h=0}var p=u*(G?1:2)+A+h+y;var o=v?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(p);for(var i=0;i<2;++i){if((i===1)&&G){break}var E=D[i],C=(i===0)?1:-1,J=1-i,H=1-J;for(var K=0;K<N;++K){var x=K+J,w=K+H;var j=0;if(Math.abs(M[x])<=F){j=1}else{if(Math.abs(M[w])<=F){j=2}}for(var I=0;I<B;++I){o.AddFace4(E*M[x]*e[I],E*M[x]*O[I],E*d[x],E*M[x]*e[I+1],E*M[x]*O[I+1],E*d[x],E*M[w]*e[I+1],E*M[w]*O[I+1],E*d[w],E*M[w]*e[I],E*M[w]*O[I],E*d[w],j);o.SetNormal4(C*M[x]*e[I],C*M[x]*O[I],C*d[x],C*M[x]*e[I+1],C*M[x]*O[I+1],C*d[x],C*M[w]*e[I+1],C*M[w]*O[I+1],C*d[w],C*M[w]*e[I],C*M[w]*O[I],C*d[w],j)}}}for(var i=0;i<=N;i+=N){if(Math.abs(M[i])>=F){var g=M[i],z=d[i],J=(i===0)?0:1,H=1-J;for(var I=0;I<B;++I){o.AddFace4(D[1]*g*e[I+J],D[1]*g*O[I+J],D[1]*z,D[0]*g*e[I+J],D[0]*g*O[I+J],D[0]*z,D[0]*g*e[I+H],D[0]*g*O[I+H],D[0]*z,D[1]*g*e[I+H],D[1]*g*O[I+H],D[1]*z,G?2:0);o.CalcNormal()}}}if(P<360){for(var i=0;i<=B;i+=B){var g=O[i],z=e[i],J=(i===0)?1:0,H=1-J;for(var K=0;K<N;++K){o.AddFace4(D[1]*M[K+J]*z,D[1]*M[K+J]*g,D[1]*d[K+J],D[0]*M[K+J]*z,D[0]*M[K+J]*g,D[0]*d[K+J],D[0]*M[K+H]*z,D[0]*M[K+H]*g,D[0]*d[K+H],D[1]*M[K+H]*z,D[1]*M[K+H]*g,D[1]*d[K+H],G?2:0);o.CalcNormal()}}}return o.Create()};a.GEO.createTubeBuffer=function(h,p){var e,f;if((h._typename=="TGeoCone")||(h._typename=="TGeoConeSeg")){e=[h.fRmax2,h.fRmax1];f=[h.fRmin2,h.fRmin1]}else{e=[h.fRmax,h.fRmax];f=[h.fRmin,h.fRmin]}var n=(f[0]>0)||(f[1]>0),l=0,s=360;if((h._typename=="TGeoConeSeg")||(h._typename=="TGeoTubeSeg")||(h._typename=="TGeoCtub")){l=h.fPhi1;s=h.fPhi2-h.fPhi1}var t=Math.max(4,Math.round(s/a.GEO.GradPerSegm));var u=t*(((e[0]<=0)||(e[1]<=0))?1:2);if(n){u+=t*(((f[0]<=0)||(f[1]<=0))?1:2)}if(e[0]>0){u+=t*((f[0]>0)?2:1)}if(e[1]>0){u+=t*((f[1]>0)?2:1)}if(s<360){u+=((e[0]>f[0])?2:0)+((e[1]>f[1])?2:0)}if(p<0){return u}var z=l*Math.PI/180,d=s/t*Math.PI/180,k=new Float32Array(t+1),o=new Float32Array(t+1);for(var v=0;v<=t;++v){o[v]=Math.cos(z+v*d);k[v]=Math.sin(z+v*d)}var q=p?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(u);var g;if(h._typename=="TGeoCtub"){g=function(D,F,E){var C=(E<0)?h.fNlow:h.fNhigh;return((E<0)?-h.fDz:h.fDz)-(D*C[0]+F*C[1])/C[2]}}for(var i=0;i<2;++i){if((i===1)&&!n){break}var m=(i===0)?e:f,B=i,A=1-i,j=1,x=0;if(m[0]!==m[1]){var w=Math.atan2((m[1]-m[0]),2*h.fDZ);j=Math.cos(w);x=Math.sin(w)}if(i===1){j*=-1;x*=-1}var r=0;if(m[0]<=0){r=2}else{if(m[1]<=0){r=1}}for(var v=0;v<t;++v){q.AddFace4(m[0]*o[v+B],m[0]*k[v+B],h.fDZ,m[1]*o[v+B],m[1]*k[v+B],-h.fDZ,m[1]*o[v+A],m[1]*k[v+A],-h.fDZ,m[0]*o[v+A],m[0]*k[v+A],h.fDZ,r);if(g){q.RecalcZ(g)}q.SetNormal_12_34(j*o[v+B],j*k[v+B],x,j*o[v+A],j*k[v+A],x,r)}}for(var i=0;i<2;++i){if(e[i]<=0){continue}var B=i,A=1-i,y=(i==0)?1:-1,r=(f[i]<=0)?2:0;if((r==2)&&(s===360)&&!g){q.StartPolygon(i===0)}for(var v=0;v<t;++v){q.AddFace4(f[i]*o[v+B],f[i]*k[v+B],y*h.fDZ,e[i]*o[v+B],e[i]*k[v+B],y*h.fDZ,e[i]*o[v+A],e[i]*k[v+A],y*h.fDZ,f[i]*o[v+A],f[i]*k[v+A],y*h.fDZ,r);if(g){q.RecalcZ(g);q.CalcNormal()}else{q.SetNormal(0,0,y)}}q.StopPolygon()}if(s<360){q.AddFace4(f[1]*o[0],f[1]*k[0],-h.fDZ,e[1]*o[0],e[1]*k[0],-h.fDZ,e[0]*o[0],e[0]*k[0],h.fDZ,f[0]*o[0],f[0]*k[0],h.fDZ,(e[0]===f[0])?2:((f[1]===e[1])?1:0));if(g){q.RecalcZ(g)}q.CalcNormal();q.AddFace4(f[0]*o[t],f[0]*k[t],h.fDZ,e[0]*o[t],e[0]*k[t],h.fDZ,e[1]*o[t],e[1]*k[t],-h.fDZ,f[1]*o[t],f[1]*k[t],-h.fDZ,(e[0]===f[0])?1:((f[1]===e[1])?2:0));if(g){q.RecalcZ(g)}q.CalcNormal()}return q.Create()};a.GEO.createEltuBuffer=function(l,r){var i=Math.max(4,Math.round(360/a.GEO.GradPerSegm));if(r<0){return i*4}var s=new Float32Array(i+1),q=new Float32Array(i+1);for(var j=0;j<=i;++j){var k=j/i*2*Math.PI;s[j]=l.fRmin*Math.cos(k);q[j]=l.fRmax*Math.sin(k)}var h=r?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(i*4),e=1,p=0,t=1,n=0;for(var j=0;j<i;++j){h.AddFace4(s[j],q[j],+l.fDZ,s[j],q[j],-l.fDZ,s[j+1],q[j+1],-l.fDZ,s[j+1],q[j+1],l.fDZ);e=t;p=n;t=s[j+1]*l.fRmax/l.fRmin;n=q[j+1]*l.fRmin/l.fRmax;var o=Math.sqrt(t*t+n*n);t=t/o;n=n/o;h.SetNormal_12_34(e,p,0,t,n,0)}for(var m=0;m<2;++m){var g=(m===0)?1:-1,f=m,d=1-m;for(var j=0;j<i;++j){h.AddFace3(0,0,g*l.fDZ,s[j+f],q[j+f],g*l.fDZ,s[j+d],q[j+d],g*l.fDZ);h.SetNormal(0,0,g)}}return h.Create()};a.GEO.createTorusBuffer=function(h,s){var m=h.fR,j=Math.max(6,Math.round(360/a.GEO.GradPerSegm)),x=Math.max(8,Math.round(h.fDphi/a.GEO.GradPerSegm));var H=(h.fRmin>0?4:2)*j*(x+(h.fDphi!==360?1:0));if(s<0){return H}if((s>0)&&(H>s)){j=Math.floor(j/Math.sqrt(H/s));x=Math.floor(x/Math.sqrt(H/s));H=(h.fRmin>0?4:2)*j*(x+(h.fDphi!==360?1:0))}var K=new Float32Array(j+1),A=new Float32Array(j+1),I=new Float32Array(x+1),z=new Float32Array(x+1);for(var E=0;E<=j;++E){K[E]=Math.sin(E/j*2*Math.PI);A[E]=Math.cos(E/j*2*Math.PI)}for(var C=0;C<=x;++C){var J=(h.fPhi1+h.fDphi*C/x)/180*Math.PI;I[C]=Math.sin(J);z[C]=Math.cos(J)}var v=s?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(H);var g=new b.Vector3(),f=new b.Vector3(),e=new b.Vector3(),d=new b.Vector3(),u=new b.Vector3(),r=new b.Vector3(),q=new b.Vector3(),p=new b.Vector3(),o=new b.Vector3(),l=new b.Vector3();for(var i=0;i<2;++i){if((i>0)&&(h.fRmin<=0)){break}var k=(i>0)?h.fRmin:h.fRmax,N=1-i,L=1-N,M=i>0?-1:1;for(var C=0;C<x;++C){var y=C+N,w=C+L;o.x=m*z[y];o.y=m*I[y];l.x=m*z[w];l.y=m*I[w];for(var E=0;E<j;++E){g.x=(m+k*A[E])*z[y];g.y=(m+k*A[E])*I[y];g.z=k*K[E];f.x=(m+k*A[E+1])*z[y];f.y=(m+k*A[E+1])*I[y];f.z=k*K[E+1];e.x=(m+k*A[E+1])*z[w];e.y=(m+k*A[E+1])*I[w];e.z=k*K[E+1];d.x=(m+k*A[E])*z[w];d.y=(m+k*A[E])*I[w];d.z=k*K[E];v.AddFace4(g.x,g.y,g.z,f.x,f.y,f.z,e.x,e.y,e.z,d.x,d.y,d.z);u.subVectors(g,o).normalize();r.subVectors(f,o).normalize();q.subVectors(e,l).normalize();p.subVectors(d,l).normalize();v.SetNormal4(M*u.x,M*u.y,M*u.z,M*r.x,M*r.y,M*r.z,M*q.x,M*q.y,M*q.z,M*p.x,M*p.y,M*p.z)}}}if(h.fDphi!==360){for(var C=0;C<=x;C+=x){var D=h.fRmax,B=h.fRmin,N=(C>0)?0:1,L=1-N,F=(h.fRmin)>0?0:1,G=C>0?1:-1;for(var E=0;E<j;++E){v.AddFace4((m+D*A[E+N])*z[C],(m+D*A[E+N])*I[C],D*K[E+N],(m+B*A[E+N])*z[C],(m+B*A[E+N])*I[C],B*K[E+N],(m+B*A[E+L])*z[C],(m+B*A[E+L])*I[C],B*K[E+L],(m+D*A[E+L])*z[C],(m+D*A[E+L])*I[C],D*K[E+L],F);v.SetNormal(-G*I[C],G*z[C],0)}}}return v.Create()};a.GEO.createPolygonBuffer=function(t,x){var M=t.fPhi1,w=t.fDphi,L=60;if(t._typename=="TGeoPgon"){L=t.fNedges}else{L=Math.max(5,Math.round(w/a.GEO.GradPerSegm))}var o=new Int16Array(2*t.fNz),O=0,y=false;for(var e=0;e<t.fNz;++e){if(t.fRmin[e]>0){y=true}}if(x<0){return(y?4:2)*L*(t.fNz-1)}var j=(w===360)?null:[];for(var r=0;r<2;++r){var h=(r===0)?"fRmax":"fRmin";for(var e=0;e<t.fNz;++e){var C=t.fZ[e],f=t[h][e];o[e*2+r]=0;if((e>0)&&(e<t.fNz-1)){if(((t.fZ[e-1]===C)&&(t[h][e-1]===f))||((t[h][e+1]===f)&&(t[h][e-1]===f))){continue}}if((e>0)&&((r===0)||y)){o[e*2+r]=1;O++}if(j!==null){if(r===0){j.push(new b.Vector2(f,C))}else{if(f<t.fRmax[e]){j.unshift(new b.Vector2(f,C))}}}}}var v=O*L*2;if(t.fRmin[0]!==t.fRmax[0]){v+=L*(y?2:1)}if(t.fRmin[t.fNz-1]!==t.fRmax[t.fNz-1]){v+=L*(y?2:1)}var K=null;if(j!==null){if(j.length===t.fNz*2){K=[];for(var e=t.fNz-1;e>0;--e){if(t.fZ[e]===t.fZ[e-1]){continue}var E=2*t.fNz-1-e;K.push([E,e-1,e]);K.push([E,E+1,e-1])}}else{K=b.ShapeUtils.triangulateShape(j,[])}v+=K.length*2}var i=M*Math.PI/180,d=w/L*Math.PI/180;var l=new Float32Array(L+1),g=new Float32Array(L+1);for(var z=0;z<=L;++z){g[z]=Math.cos(i+z*d);l[z]=Math.sin(i+z*d)}var u=x?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(v);for(var r=0;r<2;++r){var h=(r===0)?"fRmax":"fRmin",B=t.fZ[0],p=t[h][0],J=1-r,I=r;for(var e=0;e<t.fNz;++e){if(o[e*2+r]===0){continue}var A=t.fZ[e],m=t[h][e],G=1,F=0;if((m!==p)){var s=Math.atan2((m-p),(A-B));G=Math.cos(s);F=Math.sin(s)}if(r>0){G*=-1;F*=-1}for(var z=0;z<L;++z){u.AddFace4(p*g[z+J],p*l[z+J],B,m*g[z+J],m*l[z+J],A,m*g[z+I],m*l[z+I],A,p*g[z+I],p*l[z+I],B);u.SetNormal_12_34(G*g[z+J],G*l[z+J],F,G*g[z+I],G*l[z+I],F)}B=A;p=m}}for(var e=0;e<t.fNz;e+=(t.fNz-1)){var D=t.fRmin[e],k=t.fRmax[e];if(D===k){continue}var C=t.fZ[e],J=(e===0)?1:0,I=1-J,q=(e===0)?-1:1;if(!y&&!K){u.StartPolygon(e>0)}for(var z=0;z<L;++z){u.AddFace4(D*g[z+J],D*l[z+J],C,k*g[z+J],k*l[z+J],C,k*g[z+I],k*l[z+I],C,D*g[z+I],D*l[z+I],C,y?0:2);u.SetNormal(0,0,q)}u.StopPolygon()}if(K){for(var z=0;z<=L;z+=L){var J=(z===0)?1:2,I=3-J;for(var H=0;H<K.length;++H){var Q=j[K[H][0]],P=j[K[H][J]],N=j[K[H][I]];u.AddFace3(Q.x*g[z],Q.x*l[z],Q.y,P.x*g[z],P.x*l[z],P.y,N.x*g[z],N.x*l[z],N.y);u.CalcNormal()}}}return u.Create()};a.GEO.createXtruBuffer=function(d,h){var o=(d.fNz-1)*d.fNvert*2;if(h<0){return o+d.fNvert*3}var p=[];for(var t=0;t<d.fNvert;++t){p.push(new b.Vector2(d.fX[t],d.fY[t]))}var e=b.ShapeUtils.triangulateShape(p,[]);if(e.length<p.length-2){a.GEO.warn("Problem with XTRU shape "+d.fName+" with "+p.length+" vertices");e=[]}else{o+=e.length*2}var k=h?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(o);for(var x=0;x<d.fNz-1;++x){var m=d.fZ[x],s=d.fScale[x],l=d.fZ[x+1],r=d.fScale[x+1];for(var g=0;g<d.fNvert;++g){var f=(g+1)%d.fNvert;k.AddFace4(s*d.fX[g],s*d.fY[g],m,r*d.fX[g],r*d.fY[g],l,r*d.fX[f],r*d.fY[f],l,s*d.fX[f],s*d.fY[f],m);k.CalcNormal()}}for(x=0;x<=d.fNz-1;x+=(d.fNz-1)){var j=d.fZ[x],y=d.fScale[x];for(var q=0;q<e.length;++q){var i=e[q],w=p[i[0]],v=p[i[(x===0)?2:1]],u=p[i[(x===0)?1:2]];k.AddFace3(y*w.x,y*w.y,j,y*v.x,y*v.y,j,y*u.x,y*u.y,j);k.SetNormal(0,0,x===0?-1:1)}}return k.Create()};a.GEO.createParaboloidBuffer=function(f,n){var v=Math.max(4,Math.round(360/a.GEO.GradPerSegm)),p=30;if(n>0){var e=2*v*(p+1)/n;if(e>1){v=Math.max(5,Math.floor(v/Math.sqrt(e)));p=Math.max(5,Math.floor(p/Math.sqrt(e)))}}var B=-f.fDZ,D=f.fDZ,u=f.fRlo,w=f.fRhi;if(f.fA>=0){if(f.fB>B){B=f.fB}}else{if(f.fB<D){D=f.fB}}var q=Math.atan2(B,u),s=Math.atan2(D,w);var y=(p+1)*v*2;if(u===0){y-=v*2}if(w===0){y-=v*2}if(n<0){return y}var h=new Float32Array(v+1),m=new Float32Array(v+1);for(var z=0;z<=v;++z){m[z]=Math.cos(z/v*2*Math.PI);h[z]=Math.sin(z/v*2*Math.PI)}var o=n?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(y);var r=B,x=0,l=0,k=-1;for(var E=0;E<=p+1;++E){var i=0,j=0,g=0,A=-1;if((E===0)&&(u===0)){continue}if((E===p+1)&&(x===0)){break}switch(E){case 0:i=B;j=u;break;case p:i=D;j=w;break;case p+1:i=D;j=0;break;default:var d=Math.tan(q+(s-q)*E/p);var C=d*d-4*f.fA*f.fB;j=0.5*(d+Math.sqrt(C))/f.fA;if(j<0.000001){j=0}i=j*d}g=f.fA*j;A=(f.fA>0)?-1:1;var t=0;if(x===0){t=1}else{if(j===0){t=2}}for(var z=0;z<v;++z){o.AddFace4(j*m[z],j*h[z],i,x*m[z],x*h[z],r,x*m[z+1],x*h[z+1],r,j*m[z+1],j*h[z+1],i,t);if((t===0)||((E===1)&&(u===0))||((E===p+1)&&(w===0))){o.SetNormal4(g*m[z],g*h[z],A,l*m[z],l*h[z],k,l*m[z+1],l*h[z+1],k,g*m[z+1],g*h[z+1],A,t)}else{o.SetNormal(0,0,(E<p)?-1:1)}}r=i;x=j;l=g;k=A}return o.Create()};a.GEO.createHypeBuffer=function(d,h){if((d.fTin===0)&&(d.fTout===0)){return a.GEO.createTubeBuffer(d,h)}var o=Math.max(4,Math.round(360/a.GEO.GradPerSegm)),m=30;var s=o*(m+1)*((d.fRmin>0)?4:2);if(h<0){return s}if((h>0)&&(h>s)){o=Math.max(4,Math.floor(o/Math.sqrt(s/h)));m=Math.max(4,Math.floor(m/Math.sqrt(s/h)));s=o*(m+1)*((d.fRmin>0)?4:2)}var f=new Float32Array(o+1),g=new Float32Array(o+1);for(var t=0;t<=o;++t){g[t]=Math.cos(t/o*2*Math.PI);f[t]=Math.sin(t/o*2*Math.PI)}var j=h?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(s);for(var e=0;e<2;++e){if((e>0)&&(d.fRmin<=0)){break}var r=(e>0)?d.fRmin:d.fRmax,u=(e>0)?d.fTinsq:d.fToutsq,x=1-e,w=1-x;for(var v=0;v<m;++v){var l=-d.fDz+v/m*2*d.fDz,k=-d.fDz+(v+1)/m*2*d.fDz,q=Math.sqrt(r*r+u*l*l),p=Math.sqrt(r*r+u*k*k);for(var t=0;t<o;++t){j.AddFace4(q*g[t+x],q*f[t+x],l,p*g[t+x],p*f[t+x],k,p*g[t+w],p*f[t+w],k,q*g[t+w],q*f[t+w],l);j.CalcNormal()}}}for(var v=0;v<2;++v){var i=(v===0)?d.fDz:-d.fDz,q=Math.sqrt(d.fRmax*d.fRmax+d.fToutsq*i*i),p=(d.fRmin>0)?Math.sqrt(d.fRmin*d.fRmin+d.fTinsq*i*i):0,n=(d.fRmin>0)?0:1,x=1-v,w=1-x;for(var t=0;t<o;++t){j.AddFace4(q*g[t+x],q*f[t+x],i,p*g[t+x],p*f[t+x],i,p*g[t+w],p*f[t+w],i,q*g[t+w],q*f[t+w],i,n);j.SetNormal(0,0,(v===0)?1:-1)}}return j.Create()};a.GEO.createMatrix=function(d){if(!d){return null}var h=null,f=null,g=null;switch(d._typename){case"TGeoTranslation":h=d.fTranslation;break;case"TGeoRotation":f=d.fRotationMatrix;break;case"TGeoScale":g=d.fScale;break;case"TGeoGenTrans":g=d.fScale;case"TGeoCombiTrans":h=d.fTranslation;if(d.fRotation){f=d.fRotation.fRotationMatrix}break;case"TGeoHMatrix":h=d.fTranslation;f=d.fRotationMatrix;g=d.fScale;break;case"TGeoIdentity":break;default:console.warn("unsupported matrix "+d._typename)}if(!h&&!f&&!g){return null}var e=new b.Matrix4();if(f){e.set(f[0],f[1],f[2],0,f[3],f[4],f[5],0,f[6],f[7],f[8],0,0,0,0,1)}if(h){e.setPosition(new b.Vector3(h[0],h[1],h[2]))}if(g){e.scale(new b.Vector3(g[0],g[1],g[2]))}return e};a.GEO.getNodeMatrix=function(f,e){var j=null;if(f===1){j=new b.Matrix4();if(e.fTrans!==null){j.set(e.fTrans[0],e.fTrans[4],e.fTrans[8],0,e.fTrans[1],e.fTrans[5],e.fTrans[9],0,e.fTrans[2],e.fTrans[6],e.fTrans[10],0,0,0,0,1);j.setPosition({x:e.fTrans[12],y:e.fTrans[13],z:e.fTrans[14]})}}else{if(("fMatrix" in e)&&(e.fMatrix!==null)){j=a.GEO.createMatrix(e.fMatrix)}else{if((e._typename=="TGeoNodeOffset")&&(e.fFinder!==null)){var i=a.BIT(14);if((e.fFinder.fBits&i)!==0){a.GEO.warn("Unsupported reflected pattern "+e.fFinder._typename)}switch(e.fFinder._typename){case"TGeoPatternX":case"TGeoPatternY":case"TGeoPatternZ":case"TGeoPatternParaX":case"TGeoPatternParaY":case"TGeoPatternParaZ":var g=e.fFinder.fStart+(e.fIndex+0.5)*e.fFinder.fStep;j=new b.Matrix4();switch(e.fFinder._typename.charAt[e.fFinder._typename.length-1]){case"X":j.setPosition(new b.Vector3(g,0,0));break;case"Y":j.setPosition(new b.Vector3(0,g,0));break;case"Z":j.setPosition(new b.Vector3(0,0,g));break}break;case"TGeoPatternCylPhi":var h=(Math.PI/180)*(e.fFinder.fStart+(e.fIndex+0.5)*e.fFinder.fStep),d=Math.cos(h),l=Math.sin(h);j=new b.Matrix4();j.set(d,-l,0,0,l,d,0,0,0,0,1,0,0,0,0,1);break;case"TGeoPatternCylR":j=new b.Matrix4();break;case"TGeoPatternTrapZ":var k=e.fFinder.fStart+(e.fIndex+0.5)*e.fFinder.fStep;j=new b.Matrix4();j.setPosition(new b.Vector3(e.fFinder.fTxz*k,e.fFinder.fTyz*k,k));break;default:a.GEO.warn("Unsupported pattern type "+e.fFinder._typename);break}}}}return j};a.GEO.createComposite=function(j,l){if(l<0){return a.GEO.createGeometry(j.fNode.fLeft,-10)+a.GEO.createGeometry(j.fNode.fRight,-10)}var m,k,g,f,e=false,d=a.GEO.createMatrix(j.fNode.fLeftMat),n=a.GEO.createMatrix(j.fNode.fRightMat);if(l===0){l=(a.browser&&a.browser.isIE)?2000:4000}else{e=true}if(d&&(d.determinant()<-0.9)){a.GEO.warn("Axis reflection in left composite shape - not supported")}if(n&&(n.determinant()<-0.9)){a.GEO.warn("Axis reflections in right composite shape - not supported")}m=a.GEO.createGeometry(j.fNode.fLeft,l);if(!m){return null}var i=a.GEO.numGeometryFaces(m),h=0;if(m._exceed_limit){i+=l}if(i<l){k=a.GEO.createGeometry(j.fNode.fRight,l);h=a.GEO.numGeometryFaces(k)}if((i+h>=l)||!k){if(m.polygons){m=c.CreateBufferGeometry(m.polygons);i=a.GEO.numGeometryFaces(m)}if(d){m.applyMatrix(d)}m._exceed_limit=true;return m}g=new c.Geometry(m,d,a.GEO.CompressComp?0:undefined);f=new c.Geometry(k,n,g.maxid);g.maxid=f.maxid;switch(j.fNode._typename){case"TGeoIntersection":g.direct_intersect(f);break;case"TGeoUnion":g.direct_union(f);break;case"TGeoSubtraction":g.direct_subtract(f);break;default:a.GEO.warn("unsupported bool operation "+j.fNode._typename+", use first geom")}if(a.GEO.numGeometryFaces(g)===0){a.GEO.warn("Zero faces in comp shape left: "+j.fNode.fLeft._typename+" "+a.GEO.numGeometryFaces(m)+" faces right: "+j.fNode.fRight._typename+" "+a.GEO.numGeometryFaces(k)+" faces  use first");g=new c.Geometry(m,d)}return e?{polygons:g.toPolygons()}:g.toBufferGeometry()};a.GEO.projectGeometry=function(l,m,i,h,d){if(!l.boundingBox){l.computeBoundingBox()}var g=l.boundingBox.clone();g.applyMatrix4(m);if(!h){h=0}if(((g.min[i]>=h)&&(g.max[i]>=h))||((g.min[i]<=h)&&(g.max[i]<=h))){return null}var f=new c.Geometry(l,m,0,d),n=2*Math.max(Math.abs(g.min.x),Math.abs(g.max.x)),k=2*Math.max(Math.abs(g.min.y),Math.abs(g.max.y)),j=2*Math.max(Math.abs(g.min.z),Math.abs(g.max.z)),o=10000;switch(i){case"x":o=Math.max(k,j);break;case"y":o=Math.max(n,j);break;case"z":o=Math.max(n,k);break}var e=c.CreateNormal(i,h,o);f.cut_from_plane(e);return e.toBufferGeometry()};a.GEO.createGeometry=function(g,f){if(f===undefined){f=0}try{switch(g._typename){case"TGeoBBox":return a.GEO.createCubeBuffer(g,f);case"TGeoPara":return a.GEO.createParaBuffer(g,f);case"TGeoTrd1":case"TGeoTrd2":return a.GEO.createTrapezoidBuffer(g,f);case"TGeoArb8":case"TGeoTrap":case"TGeoGtra":return a.GEO.createArb8Buffer(g,f);case"TGeoSphere":return a.GEO.createSphereBuffer(g,f);case"TGeoCone":case"TGeoConeSeg":case"TGeoTube":case"TGeoTubeSeg":case"TGeoCtub":return a.GEO.createTubeBuffer(g,f);case"TGeoEltu":return a.GEO.createEltuBuffer(g,f);case"TGeoTorus":return a.GEO.createTorusBuffer(g,f);case"TGeoPcon":case"TGeoPgon":return a.GEO.createPolygonBuffer(g,f);case"TGeoXtru":return a.GEO.createXtruBuffer(g,f);case"TGeoParaboloid":return a.GEO.createParaboloidBuffer(g,f);case"TGeoHype":return a.GEO.createHypeBuffer(g,f);case"TGeoCompositeShape":return a.GEO.createComposite(g,f);case"TGeoShapeAssembly":break;case"TGeoScaledShape":var h=a.GEO.createGeometry(g.fShape,f);if(g.fScale&&(f>=0)&&(typeof h==="object")&&(typeof h.scale==="function")){h.scale(g.fScale.fScale[0],g.fScale.fScale[1],g.fScale.fScale[2])}return h;default:a.GEO.warn("unsupported shape type "+g._typename)}}catch(i){var d="";if(i.stack!==undefined){d=i.stack.split("\n")[0];if(d.indexOf(i.message)>=0){d=i.stack.split("\n")[1]}else{d=" at: "+d}}a.GEO.warn(g._typename+" err: "+i.message+d)}return f<0?0:null};a.GEO.provideInfo=function(h){var g=[],d=null;if(h.fVolume!==undefined){d=h.fVolume.fShape}else{if(h.fShape!==undefined){d=h.fShape}else{if((h.fShapeBits!==undefined)&&(h.fShapeId!==undefined)){d=h}}}if(!d){g.push(h._typename);return g}var f=Math.max(d.fDX,d.fDY,d.fDZ);var e=(f>10000000)||(f<1e-7);function i(j){if(j===undefined){return"???"}if((j==Math.round(j)&&j<10000000)){return Math.round(j)}return e?j.toExponential(4):j.toPrecision(7)}g.push(d._typename);g.push("DX="+i(d.fDX)+" DY="+i(d.fDY)+" DZ="+i(d.fDZ));switch(d._typename){case"TGeoBBox":break;case"TGeoPara":g.push("Alpha="+d.fAlpha+" Phi="+d.fPhi+" Theta="+d.fTheta);break;case"TGeoTrd2":g.push("Dy1="+i(d.fDy1)+" Dy2="+i(d.fDy1));case"TGeoTrd1":g.push("Dx1="+i(d.fDx1)+" Dx2="+i(d.fDx1));break;case"TGeoArb8":break;case"TGeoTrap":break;case"TGeoGtra":break;case"TGeoSphere":g.push("Rmin="+i(d.fRmin)+" Rmax="+i(d.fRmax));g.push("Phi1="+d.fPhi1+" Phi2="+d.fPhi2);g.push("Theta1="+d.fTheta1+" Theta2="+d.fTheta2);break;case"TGeoConeSeg":g.push("Phi1="+d.fPhi1+" Phi2="+d.fPhi2);case"TGeoCone":g.push("Rmin1="+i(d.fRmin1)+" Rmax1="+i(d.fRmax1));g.push("Rmin2="+i(d.fRmin2)+" Rmax2="+i(d.fRmax2));break;case"TGeoCtub":case"TGeoTubeSeg":g.push("Phi1="+d.fPhi1+" Phi2="+d.fPhi2);case"TGeoEltu":case"TGeoTube":g.push("Rmin="+i(d.fRmin)+" Rmax="+i(d.fRmax));break;case"TGeoTorus":g.push("Rmin="+i(d.fRmin)+" Rmax="+i(d.fRmax));g.push("Phi1="+d.fPhi1+" Dphi="+d.fDphi);break;case"TGeoPcon":case"TGeoPgon":break;case"TGeoXtru":break;case"TGeoParaboloid":g.push("Rlo="+i(d.fRlo)+" Rhi="+i(d.fRhi));g.push("A="+i(d.fA)+" B="+i(d.fB));break;case"TGeoHype":g.push("Rmin="+i(d.fRmin)+" Rmax="+i(d.fRmax));g.push("StIn="+i(d.fStIn)+" StOut="+i(d.fStOut));break;case"TGeoCompositeShape":break;case"TGeoShapeAssembly":break;case"TGeoScaledShape":g=a.GEO.provideInfo(d.fShape);if(d.fScale){g.unshift("Scale X="+d.fScale.fScale[0]+" Y="+d.fScale.fScale[1]+" Z="+d.fScale.fScale[2])}break}return g};a.GEO.CreateProjectionMatrix=function(e){var d=new b.Matrix4();e.updateMatrixWorld();e.matrixWorldInverse.getInverse(e.matrixWorld);d.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse);return d};a.GEO.CreateFrustum=function(e){if(!e){return null}if(e instanceof b.PerspectiveCamera){e=a.GEO.CreateProjectionMatrix(e)}var d=new b.Frustum();d.setFromMatrix(e);d.corners=new Float32Array([1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1,0,0,0]);d.test=new b.Vector3(0,0,0);d.CheckShape=function(j,h){var l=this.test,f=this.corners.length,g=this.corners,k;for(k=0;k<f;k+=3){l.x=g[k]*h.fDX;l.y=g[k+1]*h.fDY;l.z=g[k+2]*h.fDZ;if(this.containsPoint(l.applyMatrix4(j))){return true}}return false};d.CheckBox=function(g){var h=this.test,f=0;h.set(g.min.x,g.min.y,g.min.z);if(this.containsPoint(h)){f++}h.set(g.min.x,g.min.y,g.max.z);if(this.containsPoint(h)){f++}h.set(g.min.x,g.max.y,g.min.z);if(this.containsPoint(h)){f++}h.set(g.min.x,g.max.y,g.max.z);if(this.containsPoint(h)){f++}h.set(g.max.x,g.max.y,g.max.z);if(this.containsPoint(h)){f++}h.set(g.max.x,g.min.y,g.max.z);if(this.containsPoint(h)){f++}h.set(g.max.x,g.max.y,g.min.z);if(this.containsPoint(h)){f++}h.set(g.max.x,g.max.y,g.max.z);if(this.containsPoint(h)){f++}return f>5};return d};a.GEO.VisibleByCamera=function(j,g,f){var k=new b.Frustum();var d=new b.Matrix4();j.updateMatrixWorld();j.matrixWorldInverse.getInverse(j.matrixWorld);d.multiplyMatrices(j.projectionMatrix,j.matrixWorldInverse);k.setFromMatrix(d);var e=[new b.Vector3(f.fDX/2,f.fDY/2,f.fDZ/2),new b.Vector3(f.fDX/2,f.fDY/2,-f.fDZ/2),new b.Vector3(f.fDX/2,-f.fDY/2,f.fDZ/2),new b.Vector3(f.fDX/2,-f.fDY/2,-f.fDZ/2),new b.Vector3(-f.fDX/2,f.fDY/2,f.fDZ/2),new b.Vector3(-f.fDX/2,f.fDY/2,-f.fDZ/2),new b.Vector3(-f.fDX/2,-f.fDY/2,f.fDZ/2),new b.Vector3(-f.fDX/2,-f.fDY/2,-f.fDZ/2)];for(var h=0;h<e.length;h++){if(k.containsPoint(e[h].applyMatrix4(g))){return true}}return false};a.GEO.numGeometryFaces=function(e){if(!e){return 0}if(e instanceof c.Geometry){return e.tree.numPolygons()}if(e.type=="BufferGeometry"){var d=e.getAttribute("position");return d?d.count/3:0}if(e&&e.polygons){return e.polygons.length}return e.faces.length};a.GEO.numGeometryVertices=function(e){if(!e){return 0}if(e instanceof c.Geometry){return e.tree.numPolygons()*3}if(e.type=="BufferGeometry"){var d=e.getAttribute("position");return d?d.count:0}if(e&&e.polygons){return e.polygons.length*4}return e.vertices.length};a.GEO.ClonedNodes=function(e,d){this.toplevel=true;this.name_prefix="";this.maxdepth=1;if(e){if(e.$geoh){this.toplevel=false}this.CreateClones(e)}else{if(d){this.nodes=d}}};a.GEO.ClonedNodes.prototype.GetNodeShape=function(d){if(!this.origin||!this.nodes){return null}var e=this.origin[d],f=this.nodes[d];if(!e||!f){return null}if(f.kind===0){if(e.fVolume){return e.fVolume.fShape}}else{return e.fShape}return null};a.GEO.ClonedNodes.prototype.Cleanup=function(d,e){if(d){for(var f=0;f<d.length;++f){delete d[f].stack;d[f]=undefined}}if(e){for(var f=0;f<e.length;++f){delete e[f].geom;e[f]=undefined}}if(this.nodes){for(var f=0;f<this.nodes.length;++f){delete this.nodes[f].chlds}}delete this.nodes;delete this.origin;delete this.sortmap};a.GEO.ClonedNodes.prototype.CreateClones=function(j,d,g){if(!d){this.origin=[];d=1;g=a.GEO.NodeKind(j)}if((g<0)||!j||("_refid" in j)){return}j._refid=this.origin.length;this.origin.push(j);if(d>this.maxdepth){this.maxdepth=d}var s=null;if(g===0){s=(j.fVolume&&j.fVolume.fNodes)?j.fVolume.fNodes.arr:null}else{s=j.fElements?j.fElements.arr:null}if(s!==null){a.GEO.CheckDuplicates(j,s);for(var l=0;l<s.length;++l){this.CreateClones(s[l],d+1,g)}}if(d>1){return}this.nodes=[];var r=[];for(var e=0;e<this.origin.length;++e){var j=this.origin[e];var f={id:e,kind:g,vol:0,nfaces:0,numvischld:1,idshift:0};this.nodes.push(f);r.push(f)}for(var e=0;e<this.origin.length;++e){var j=this.origin[e],p=this.nodes[e];var s=null,m=null;if(g===1){m=j.fShape;if(j.fElements){s=j.fElements.arr}}else{if(j.fVolume){m=j.fVolume.fShape;if(j.fVolume.fNodes){s=j.fVolume.fNodes.arr}}}var q=a.GEO.getNodeMatrix(g,j);if(q){p.matrix=q.elements;if(p.matrix[0]===1){var o=true;for(var h=1;(h<p.matrix.length)&&o;++h){o=(p.matrix[h]===((h===5)||(h===10)||(h===15)?1:0))}if(o){delete p.matrix}}}if(m){p.fDX=m.fDX;p.fDY=m.fDY;p.fDZ=m.fDZ;p.vol=m.fDX*m.fDY*m.fDZ;if(m.$nfaces===undefined){m.$nfaces=a.GEO.createGeometry(m,-1)}p.nfaces=m.$nfaces;if(p.nfaces<=0){p.vol=0}}if(!s){continue}p.chlds=new Int32Array(s.length);for(var h=0;h<s.length;++h){p.chlds[h]=s[h]._refid}}for(var e=0;e<this.origin.length;++e){delete this.origin[e]._refid}r.sort(function(k,i){return i.vol-k.vol});this.sortmap=new Int32Array(this.nodes.length);for(var e=0;e<this.nodes.length;++e){this.sortmap[e]=r[e].id}};a.GEO.ClonedNodes.prototype.MarkVisisble=function(k,f,h){if(!this.nodes){return 0}var d=0,e=h&&(h.length===this.nodes.length);if(!e&&!this.origin){return 0}for(var j=0;j<this.nodes.length;++j){var i=this.nodes[j];i.vis=false;i.numvischld=1;i.idshift=0;delete i.depth;if(e){i.vis=h[j].vis;if(h[j].depth!==undefined){i.depth=h[j].depth}if(i.vis){d++}continue}var g=this.origin[j];if(i.kind===0){if(g.fVolume){if(k){i.vis=a.GEO.TestBit(g.fVolume,a.GEO.BITS.kVisOnScreen);if(f){a.GEO.SetBit(g.fVolume,a.GEO.BITS.kVisNone,false);a.GEO.SetBit(g.fVolume,a.GEO.BITS.kVisThis,i.vis);a.GEO.SetBit(g.fVolume,a.GEO.BITS.kVisDaughters,true)}}else{i.vis=!a.GEO.TestBit(g.fVolume,a.GEO.BITS.kVisNone)&&a.GEO.TestBit(g.fVolume,a.GEO.BITS.kVisThis);if(!a.GEO.TestBit(g.fVolume,a.GEO.BITS.kVisDaughters)){i.depth=a.GEO.TestBit(g.fVolume,a.GEO.BITS.kVisOneLevel)?1:0}}}}else{i.vis=g.fRnrSelf;if((j===0)&&(this.nodes.length===1)){i.vis=true}}if((i.vol<=0)||(i.nfaces<=0)){i.vis=false}if(i.vis){d++}}return d};a.GEO.ClonedNodes.prototype.GetVisibleFlags=function(){var d=[];for(var f=0;f<this.nodes.length;++f){var e={vis:this.nodes[f].vis};if("depth" in this.nodes[f]){e.depth=this.nodes[f].depth}d.push(e)}return d};a.GEO.ClonedNodes.prototype.ScanVisible=function(d,l){if(!this.nodes){return 0}if(l===undefined){l=99999;if(!d){d={}}d.stack=new Array(100);d.nodeid=0;d.counter=0;d.last=0;d.CopyStack=function(i){var m={nodeid:this.nodeid,seqid:this.counter,stack:(this.last>10)?new Int32Array(this.last):new Array(this.last)};if(i){m.factor=i}for(var o=0;o<this.last;++o){m.stack[o]=this.stack[o+1]}return m};if(d.domatrix){d.matrices=[];d.mpool=[new b.Matrix4()];d.getmatrix=function(){return this.matrices[this.last]}}}var h=0,k=this.nodes[d.nodeid];if(d.domatrix){if(!d.mpool[d.last+1]){d.mpool[d.last+1]=new b.Matrix4()}var g=(d.last>0)?d.matrices[d.last-1]:new b.Matrix4();if(k.matrix){d.matrices[d.last]=d.mpool[d.last].fromArray(g.elements);d.matrices[d.last].multiply(d.mpool[d.last+1].fromArray(k.matrix))}else{d.matrices[d.last]=g}}if(k.vis&&(l>=0)){if(!d.func||d.func(k)){h++}}d.counter++;if((k.depth!==undefined)&&(l>k.depth)){l=k.depth}if(k.chlds&&(k.numvischld>0)){var f=d.counter,j=0;d.last++;for(var e=0;e<k.chlds.length;++e){d.nodeid=k.chlds[e];d.stack[d.last]=e;j+=this.ScanVisible(d,l-1)}d.last--;h+=j;if(j===0){k.numvischld=0;k.idshift=d.counter-f}}else{d.counter+=k.idshift}if(d.last===0){delete d.last;delete d.stack;delete d.CopyStack;delete d.counter;delete d.matrices;delete d.mpool;delete d.getmatrix}return h};a.GEO.ClonedNodes.prototype.ResolveStack=function(d,f){var g={id:0,obj:null,node:this.nodes[0],name:this.name_prefix};if(f){g.matrix=new b.Matrix4();if(g.node.matrix){g.matrix.fromArray(g.node.matrix)}}if(this.origin){g.obj=this.origin[0]}if(d){for(var e=0;e<d.length;++e){g.id=g.node.chlds[d[e]];g.node=this.nodes[g.id];if(this.origin){g.obj=this.origin[g.id];if(g.obj.fName){if(g.name.length>0){g.name+="/"}g.name+=a.GEO.ObjectName(g.obj)}}if(f&&g.node.matrix){g.matrix.multiply(new b.Matrix4().fromArray(g.node.matrix))}}}return g};a.GEO.ClonedNodes.prototype.FindStackByName=function(o){if(!this.origin){return null}var j=o.split("/"),h=0,m=[],l=this.origin[0];if(!l||(a.GEO.ObjectName(l)!==j[0])){return null}for(var e=1;e<j.length;++e){var f=this.nodes[h];if(!f.chlds){return null}for(var g=0;g<f.chlds.length;++g){var d=f.chlds[g],i=this.origin[d];if(i&&(a.GEO.ObjectName(i)===j[e])){m.push(g);h=d;break}}if(m.length===e-1){return null}}return m};a.GEO.ClonedNodes.prototype.CreateObject3D=function(m,o,s){var g=this.nodes[0],q=o,f=0,d=(typeof s=="object")||(s==="force");for(var l=0;l<=m.length;++l){var h=(l>0)?m[l-1]:0;if(l>0){g=this.nodes[g.chlds[h]]}var k=undefined;if(q.children){for(var j=0;j<q.children.length;++j){if(q.children[j].nchld===h){k=q.children[j];break}}}if(k){q=k;if(k.$jsroot_drawable){f++}continue}if(!d){return null}k=new b.Object3D();if(g.matrix){k.matrix.fromArray(g.matrix);k.matrix.decompose(k.position,k.quaternion,k.scale)}k.nchld=h;q.add(k);if((l==0)&&(typeof s=="object")&&s.scale){if((s.scale.x<0)||(s.scale.y<0)||(s.scale.z<0)){k.scale.copy(s.scale);k.updateMatrix()}}k.updateMatrixWorld();q=k}if((s==="mesh")||(s==="delete_mesh")){var r=null;if(q){for(var e=0;(e<q.children.length)&&!r;++e){var p=q.children[e];if((p.type==="Mesh")&&(p.nchld===undefined)){r=p}}}if((s==="mesh")||!r){return r}while(r&&(r!==o)){q=r.parent;q.remove(r);r=(q.children.length==0)?q:null}return null}if(q){q.$jsroot_drawable=true;q.$jsroot_depth=f}return q};a.GEO.ClonedNodes.prototype.GetVolumeBoundary=function(h,l,k){if(!this.sortmap){console.error("sorting map do not exist");return{min:0,max:1}}var d,j,g=0,i=0;for(var f=0;(f<this.sortmap.length)&&(g<k)&&(i<l);++f){var e=this.sortmap[f];if(h[e]===0){continue}j=this.nodes[e];if(!d){d=j}g+=h[e];i+=h[e]*j.nfaces}if(!j){console.error("no volumes selected");return{min:0,max:1}}return{min:j.vol,max:d.vol}};a.GEO.ClonedNodes.prototype.CollectVisibles=function(l,m,j){if(!j){j=l/100}var p={facecnt:0,viscnt:new Int32Array(this.nodes.length),func:function(n){this.facecnt+=n.nfaces;this.viscnt[n.id]++;return true}};for(var g=0;g<p.viscnt.length;++g){p.viscnt[g]=0}var k=this.ScanVisible(p),q=0,d=0,o=-1,i=10;if(p.facecnt>l){var h=l*(m?0.8:1),f=j*(m?0.8:1);var e=this.GetVolumeBoundary(p.viscnt,h,f);q=e.min;d=e.max;if(m){p.domatrix=true;p.frustum=m;p.totalcam=0;p.func=function(n){if(n.vol<=q){if(this.frustum.CheckShape(this.getmatrix(),n)){this.viscnt[n.id]++;this.totalcam+=n.nfaces}}return true};for(var g=0;g<p.viscnt.length;++g){p.viscnt[g]=0}this.ScanVisible(p);if(p.totalcam>l*0.2){o=this.GetVolumeBoundary(p.viscnt,l*0.2,j*0.2).min}else{o=0}i=d/((o>0)?(o>0):q)}}p.items=[];p.func=function(n){if(n.vol>q){this.items.push(this.CopyStack())}else{if((o>=0)&&(n.vol>o)){if(this.frustum.CheckShape(this.getmatrix(),n)){this.items.push(this.CopyStack(i))}}}return true};this.ScanVisible(p);return{lst:p.items,complete:q===0}};a.GEO.ClonedNodes.prototype.MergeVisibles=function(h,g){var e=0,d=[];for(var f=0;(f<h.length)&&(e<g.length);++f){while((e<g.length)&&(g[e].seqid<h[f].seqid)){d.push(g[e++])}if((e<g.length)&&(g[e].seqid===h[f].seqid)){if(g[e].done){h[f].done=true}e++}}while(e<g.length){d.push(g[e++])}return d};a.GEO.ClonedNodes.prototype.CollectShapes=function(d){var e=[];for(var g=0;g<d.length;++g){var j=d[g];var f=this.GetNodeShape(j.nodeid);if(!f){continue}if(f._id===undefined){f._id=e.length;e.push({id:f._id,shape:f,vol:this.nodes[j.nodeid].vol,refcnt:1,factor:1,ready:false})}else{e[f._id].refcnt++}j.shape=e[f._id];if(j.factor&&(j.factor>j.shape.factor)){j.shape.factor=j.factor}}e.sort(function(l,i){return i.vol*i.factor-l.vol*l.factor});for(var k=0;k<e.length;++k){var h=e[k];h.id=k;delete h.shape._id}for(var g=0;g<d.length;++g){var j=d[g];j.shapeid=j.shape.id;delete j.shape}return e};a.GEO.ClonedNodes.prototype.MergeShapesLists=function(e,f){if(!e){return f}for(var g=0;g<e.length;++g){var d=e[g];d.shape._geom=d.geom;delete d.geom;if(d.geomZ!==undefined){d.shape._geomZ=d.geomZ;delete d.geomZ}}for(var g=0;g<f.length;++g){var d=f[g];if(d.shape._geom!==undefined){d.geom=d.shape._geom;delete d.shape._geom}if(d.shape._geomZ!==undefined){d.geomZ=d.shape._geomZ;delete d.shape._geomZ}}for(var g=0;g<e.length;++g){var d=e[g];delete d.shape._geom;delete d.shape._geomZ}return f};a.GEO.ClonedNodes.prototype.BuildShapes=function(i,h,k){var g=0,e=new Date().getTime(),j={done:false,shapes:0,faces:0,notusedshapes:0};for(var f=0;f<i.length;++f){var l=i[f];if(j.done){l.ready=true;continue}if(!l.ready){if(l.geom===undefined){l.geom=a.GEO.createGeometry(l.shape);if(l.geom){g++}}l.nfaces=a.GEO.numGeometryFaces(l.geom);l.ready=true}j.shapes++;if(!l.used){j.notusedshapes++}j.faces+=l.nfaces*l.refcnt;if(j.faces>=h){j.done=true}else{if((g>0.01*i.length)&&(k!==undefined)){var d=new Date().getTime();if(d-e>k){return j}}}}j.done=true;return j};a.GEO.ObjectName=function(d){if(!d||!d.fName){return""}return d.fName+(d.$geo_suffix?d.$geo_suffix:"")};a.GEO.CheckDuplicates=function(j,m){if(j){if(j.$geo_checked){return}j.$geo_checked=true}var h=[],i=[],f=null;for(var e=0;e<m.length;++e){var l=m[e];if(!l||!l.fName){continue}if(!l.$geo_suffix){var g=h.indexOf(l.fName);if(g>=0){var d=i[g]||1;while(h.indexOf(l.fName+"#"+d)>=0){++d}l.$geo_suffix="#"+d;i[g]=d+1}}h.push(a.GEO.ObjectName(l))}};a.GEO.createFlippedMesh=function(r,l,k){var i=new b.Vector3(1,1,-1);if(l.geomZ===undefined){if(l.geom.type=="BufferGeometry"){var q=l.geom.getAttribute("position").array,e=l.geom.getAttribute("normal").array,j=q.length,g,f=0,p=new Float32Array(j),h=new Float32Array(j);for(g=0;g<j;g+=3){p[g]=q[g+f];p[g+1]=q[g+1+f];p[g+2]=-q[g+2+f];h[g]=e[g+f];h[g+1]=e[g+1+f];h[g+2]=-e[g+2+f];f+=3;if(f===6){f=-3}}l.geomZ=new b.BufferGeometry();l.geomZ.addAttribute("position",new b.BufferAttribute(p,3));l.geomZ.addAttribute("normal",new b.BufferAttribute(h,3))}else{l.geomZ=l.geom.clone();l.geomZ.scale(i.x,i.y,i.z);var o,m;for(var g=0;g<l.geomZ.faces.length;++g){o=geom.faces[g];m=o.b;o.b=o.c;o.c=m}}}var s=new b.Mesh(l.geomZ,k);s.scale.copy(i);s.updateMatrix();s._flippedMesh=true;return s};a.GEO.produceRenderOrder=function(j,k,d,i){var f=new b.Raycaster();function l(m){if(!m){return}m.traverse(function(n){n.renderOrder=0;if(n.material){n.material.depthWrite=true}})}function h(q,o,m){if(!q.children){return}for(var n=0;n<q.children.length;++n){var p=q.children[n];if(p.$jsroot_order===o){if(p.material){if(p.material.transparent){p.material.depthWrite=false;m.push(p)}else{l(p)}}}else{if((q.$jsroot_depth===undefined)||(q.$jsroot_depth<o)){h(p,o,m)}}}}function g(n,v,y){if(n.length>300){for(var C=0;C<n.length;++C){n[C].renderOrder=(v+y)/2}return false}for(var C=0;C<n.length;++C){var m=n[C],B=m.$jsroot_box3;if(!B){m.$jsroot_box3=B=a.GEO.getBoundingBox(m)}if(d==="size"){m.$jsroot_distance=B.getSize();continue}if(d==="pnt"){m.$jsroot_distance=k.distanceTo(B.getCenter());continue}var x=Math.min(x,k.distanceTo(B.min),k.distanceTo(B.max));var F=new b.Vector3(B.min.x,B.min.y,B.max.z);x=Math.min(x,k.distanceTo(F));F.set(B.min.x,B.max.y,B.min.z);x=Math.min(x,k.distanceTo(F));F.set(B.max.x,B.min.y,B.min.z);x=Math.min(x,k.distanceTo(F));F.set(B.max.x,B.max.y,B.min.z);x=Math.min(x,k.distanceTo(F));F.set(B.max.x,B.min.y,B.max.z);x=Math.min(x,k.distanceTo(F));F.set(B.min.x,B.max.y,B.max.z);x=Math.min(x,k.distanceTo(F));m.$jsroot_distance=x}n.sort(function(H,G){return H.$jsroot_distance-G.$jsroot_distance});var q=new Array(n.length);for(var C=0;C<n.length;++C){n[C].$jsroot_index=C;q[C]=n[C]}if(d==="ray"){for(var C=n.length-1;C>=0;--C){var m=n[C],B=m.$jsroot_box3,E=B.getCenter();for(var D=0;D<2;++D){E.sub(k).normalize();f.set(k,E);var o=f.intersectObjects(n,false);var p=[];for(var u=0;u<o.length;++u){if(p.indexOf(o[u].object)<0){p.push(o[u].object)}}o=p;if((o.indexOf(m)<0)&&(D>0)){console.log("MISS",i?i.ResolveStack(m.stack).name:"???")}if((o.indexOf(m)>=0)||(D>0)){break}var t=m.geometry.attributes.position.array;E=new b.Vector3((t[0]+t[3]+t[6])/3,(t[1]+t[4]+t[7])/3,(t[2]+t[5]+t[8])/3);E.applyMatrix4(m.matrixWorld)}for(var u=0;u<o.length-1;++u){var s=o[u],r=o[u+1],A=s.$jsroot_index,z=r.$jsroot_index;if(A<z){continue}for(var w=z;w<A;++w){q[w]=q[w+1];q[w].$jsroot_index=w}q[A]=r;r.$jsroot_index=A}}}for(var C=0;C<q.length;++C){q[C].renderOrder=y-(C+1)/(q.length+1)*(y-v);delete q[C].$jsroot_index;delete q[C].$jsroot_distance}return true}function e(p,v,q,m){var s=[],u=false;h(p,v,s);if(!s.length){return}if(q===m){for(var n=0;n<s.length;++n){s[n].renderOrder=q}}else{u=g(s,q,m);if(!u){q=m=(q+m)/2}}for(var n=0;n<s.length;++n){var r=s[n].parent,o=q,t=m;if(u){t=s[n].renderOrder;o=t-(m-q)/(s.length+2)}e(r,v+1,o,t)}}if(!d||(d==="dflt")){l(j)}else{e(j,0,1,1000000)}};a.GEO.build=function(m,f,p){if(!m){return}if(!f){f={}}if(!f.numfaces){f.numfaces=100000}if(!f.numnodes){f.numnodes=1000}f.res_mesh=f.res_faces=0;var g=null;if(("fShapeBits" in m)&&("fShapeId" in m)){g=m;m=null}else{if((m._typename==="TGeoVolumeAssembly")||(m._typename==="TGeoVolume")){g=m.fShape}else{if((m._typename==="TEveGeoShapeExtract")||(m._typename==="ROOT::Experimental::TEveGeoShapeExtract")){g=m.fShape}else{if(m._typename==="TGeoManager"){m=m.fMasterVolume;a.GEO.SetBit(m,a.GEO.BITS.kVisThis,false);g=m.fShape}else{if("fVolume" in m){if(m.fVolume){g=m.fVolume.fShape}}else{m=null}}}}}if(f.composite&&g&&(g._typename=="TGeoCompositeShape")&&g.fNode){m=a.GEO.buildCompositeVolume(g)}if(!m&&g){m=a.extend(a.Create("TEveGeoShapeExtract"),{fTrans:null,fShape:g,fRGBA:[0,1,0,1],fElements:null,fRnrSelf:true})}if(!m){return null}if(m._typename.indexOf("TGeoVolume")===0){m={_typename:"TGeoNode",fVolume:m,fName:m.fName,$geoh:m.$geoh,_proxy:true}}var e=new a.GEO.ClonedNodes(m);var q=e.MarkVisisble(true);if(q<=0){q=e.MarkVisisble(false)}else{q=e.MarkVisisble(true,true)}var l=e.MarkVisisble();var k=null;var w=e.CollectVisibles(f.numfaces,k,f.numnodes);var t=w.lst;var r=e.CollectShapes(t);e.BuildShapes(r,f.numfaces);var o=new b.Object3D();for(var s=0;s<t.length;++s){var h=t[s];if(h.done){continue}var g=r[h.shapeid];if(!g.ready){console.warn("shape marked as not ready when should");break}h.done=true;g.used=true;if(!g.geom||(g.nfaces===0)){e.CreateObject3D(h.stack,o,"delete_mesh");continue}var j=e.origin[h.nodeid];var u=e.nodes[h.nodeid];var i=a.GEO.getNodeProperties(u.kind,j,true);f.res_mesh++;f.res_faces+=g.nfaces;var v=e.CreateObject3D(h.stack,o,f);i.material.wireframe=f.wireframe;i.material.side=f.doubleside?b.DoubleSide:b.FrontSide;var d=null;if(v.matrixWorld.determinant()>-0.9){d=new b.Mesh(g.geom,i.material)}else{d=a.GEO.createFlippedMesh(v,g,i.material)}v.add(d)}a.CallBack(p,o);return o};a.GEO.getBoundingBox=function(j,d){if(!j||!j.geometry){return d}if(!d){d=new b.Box3();d.makeEmpty()}j.updateMatrixWorld();var m=new b.Vector3(),k=j.geometry;if(k.isGeometry){var f=k.vertices;for(var g=0,e=f.length;g<e;g++){m.copy(f[g]);m.applyMatrix4(j.matrixWorld);d.expandByPoint(m)}}else{if(k.isBufferGeometry){var h=k.attributes.position;if(h!==undefined){for(var g=0,e=h.count;g<e;g++){m.fromBufferAttribute(h,g).applyMatrix4(j.matrixWorld);d.expandByPoint(m)}}}}return d};return a}));