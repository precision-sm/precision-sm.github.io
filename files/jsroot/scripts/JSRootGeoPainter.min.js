(function(e){if("function"===typeof define&&define.amd)define("JSRootPainter d3 threejs JSRoot3DPainter JSRootGeoBase dat.gui".split(" "),e);else if("object"===typeof exports&&"undefined"!==typeof module){var v=require("./JSRootCore.js");e(v,require("d3"),require("three"),require("./JSRoot3DPainter.js"),require("./JSRootGeoBase.js"),void 0,v.nodejs||"undefined"==typeof document?v.nodejs_document:document)}else{if("undefined"==typeof JSROOT)throw Error("JSROOT is not defined","JSRootGeoPainter.js");
if("object"!=typeof JSROOT.Painter)throw Error("JSROOT.Painter is not defined","JSRootGeoPainter.js");if("undefined"==typeof d3)throw Error("d3 is not defined","JSRootGeoPainter.js");if("undefined"==typeof THREE)throw Error("THREE is not defined","JSRootGeoPainter.js");e(JSROOT,d3,THREE)}})(function(e,v,h,C,D,B,y){function z(a,b,c){this.bright=c;void 0!==a&&"function"==typeof a.append&&(this.element=a.append("div").attr("class","jsroot"),this.addButtons(b))}function f(a){a&&"TGeoManager"===a._typename&&
(this.geo_manager=a,a=a.fMasterVolume);a&&0===a._typename.indexOf("TGeoVolume")&&(a={_typename:"TGeoNode",fVolume:a,fName:a.fName,$geoh:a.$geoh,_proxy:!0});e.TObjectPainter.call(this,a);this.mode3d=this.no_default_title=!0;this.drawing_stage=0;this.ctrl={clipIntersect:!0,clip:[{name:"x",enabled:!1,value:0,min:-100,max:100},{name:"y",enabled:!1,value:0,min:-100,max:100},{name:"z",enabled:!1,value:0,min:-100,max:100}],ssao:{enabled:!1,output:h.SSAOPass.OUTPUT.Default,kernelRadius:0,minDistance:.001,
maxDistance:.1},info:{num_meshes:0,num_faces:0,num_shapes:0},highlight:!1,highlight_scene:!1,depthTest:!0,depthMethod:"dflt",select_in_view:!1,update_browser:!0,light:{kind:"points",top:!1,bottom:!1,left:!1,right:!1,front:!1,specular:!0,power:1},trans_radial:0,trans_z:0};this.ctrl.depthMethodItems=[{name:"Default",value:"dflt"},{name:"Raytraicing",value:"ray"},{name:"Boundary box",value:"box"},{name:"Mesh size",value:"size"},{name:"Central point",value:"pnt"}];this.ctrl.ssao.outputItems=[{name:"Default",
value:h.SSAOPass.OUTPUT.Default},{name:"SSAO Only",value:h.SSAOPass.OUTPUT.SSAO},{name:"SSAO Only + Blur",value:h.SSAOPass.OUTPUT.Blur},{name:"Beauty",value:h.SSAOPass.OUTPUT.Beauty},{name:"Depth",value:h.SSAOPass.OUTPUT.Depth},{name:"Normal",value:h.SSAOPass.OUTPUT.Normal}];this.Cleanup(!0)}function A(a){e.Painter.InteractiveControl.call(this);this.mesh=a&&a.material?a:null}e.sources.push("geom");"undefined"==typeof y&&"object"==typeof window&&(y=window.document);"function"===typeof define&&define.amd&&
e.loadScript("$$$style/JSRootGeoPainter.css");"object"!==typeof e.GEO&&console.error("JSROOT.GEO namespace is not defined");z.prototype.addButtons=function(a){var b=this;this.buttonsNames=[];a.forEach(function(a){var c=b.element.append("div").attr("class","toolbar-group");a.forEach(function(a){var d=a.name;if(!d)throw Error("must provide button 'name' in button config");if(-1!==b.buttonsNames.indexOf(d))throw Error("button name '"+d+"' is taken");b.buttonsNames.push(d);b.createButton(c,a)})})};z.prototype.createButton=
function(a,b){var c=b.title;void 0===c&&(c=b.name);if("function"!==typeof b.click)throw Error("must provide button 'click' function in button config");a=a.append("a").attr("class",this.bright?"toolbar-btn-bright":"toolbar-btn").attr("rel","tooltip").attr("data-title",c).on("click",b.click);this.createIcon(a,b.icon||e.ToolbarIcons.question)};z.prototype.changeBrightness=function(a){this.bright=a;this.element&&this.element.selectAll(a?".toolbar-btn":".toolbar-btn-bright").attr("class",a?"toolbar-btn-bright":
"toolbar-btn")};z.prototype.createIcon=function(a,b){var c=b.size?b.size.split(" "):[512,512],d=c[0],l=c[1]||c[0];c=b.scale||1;a=a.append("svg:svg").attr("height","1em").attr("width","1em").attr("viewBox",[0,0,d,l].join(" "));if("recs"in b)for(c={},d=0;d<b.recs.length;++d)e.extend(c,b.recs[d]),a.append("rect").attr("x",c.x).attr("y",c.y).attr("width",c.w).attr("height",c.h).attr("fill",c.f);else b=a.append("svg:path").attr("d",b.path),1!==c&&b.attr("transform","scale("+c+" "+c+")")};z.prototype.Cleanup=
function(){this.element&&(this.element.remove(),delete this.element)};f.prototype=Object.create(e.TObjectPainter.prototype);f.prototype.CreateToolbar=function(a){if(!(this._toolbar||this._usesvg||this._usesvgimg||this.ctrl.notoolbar)){var b=this;a=[{name:"toImage",title:"Save as PNG",icon:e.ToolbarIcons.camera,click:function(){b.createSnapshot()}},{name:"control",title:"Toggle control UI",icon:e.ToolbarIcons.rect,click:function(){b.showControlOptions("toggle")}},{name:"enlarge",title:"Enlarge geometry drawing",
icon:e.ToolbarIcons.circle,click:function(){b.toggleEnlarge()}}];navigator.getVRDisplays&&(a.push({name:"entervr",title:"Enter VR (It requires a VR Headset connected)",icon:e.ToolbarIcons.vrgoggles,click:function(){b.toggleVRMode()}}),this.InitVRMode());e.gStyle.ContextMenu&&a.push({name:"menu",title:"Show context menu",icon:e.ToolbarIcons.question,click:function(){v.event.preventDefault();v.event.stopPropagation();e.Painter.closeMenu()||e.Painter.createMenu(b,function(a){a.painter.FillContextMenu(a);
a.show()},v.event)}});var c=new h.Color(this.ctrl.background);this._toolbar=new z(this.select_main(),[a],1>c.r+c.g+c.b)}};f.prototype.InitVRMode=function(){var a=this;this._dolly=new h.Group;this._scene.add(this._dolly);this._standingMatrix=new h.Matrix4;this._raycasterEnd=new h.Vector3;this._raycasterOrigin=new h.Vector3;navigator.getVRDisplays().then(function(b){if(b=b[0])a._renderer.vr.setDevice(b),a._vrDisplay=b,b.stageParameters&&a._standingMatrix.fromArray(b.stageParameters.sittingToStandingTransform),
a.InitVRControllersGeometry()})};f.prototype.InitVRControllersGeometry=function(){var a=new h.SphereGeometry(.025,18,36),b=new h.MeshBasicMaterial({color:"grey"}),c=new h.MeshBasicMaterial({color:"fuchsia"}),d=new h.BoxBufferGeometry(.001,.001,2),l=new h.Mesh(d,c);c=new h.Mesh(d,c);d=new h.Mesh(a,b);a=new h.Mesh(a,b);this._controllersMeshes=[];this._controllersMeshes.push(d);this._controllersMeshes.push(a);--l.position.z;--c.position.z;d.add(l);a.add(c);this._dolly.add(d);this._dolly.add(a);d.visible=
!1;a.visible=!1};f.prototype.UpdateVRControllersList=function(){var a=navigator.getGamepads&&navigator.getGamepads();if(!this.vrControllers||a.length!==this.vrControllers.length){this._controllersMeshes.forEach(function(a){a.visible=!1});this._vrControllers=[];for(var b=0;b<a.length;++b)a[b]&&a[b].pose&&(this._vrControllers.push({gamepad:a[b],mesh:this._controllersMeshes[b]}),this._controllersMeshes[b].visible=!0)}};f.prototype.ProcessVRControllerIntersections=function(){for(var a=[],b=0;b<this._vrControllers.length;++b){var c=
this._vrControllers[b].mesh,d=c.localToWorld(this._raycasterEnd.set(0,0,-1));c=c.localToWorld(this._raycasterOrigin.set(0,0,0));d.sub(c).normalize();a=a.concat(this._controls.GetOriginDirectionIntersects(c,d))}a=a.filter(function(b,c){return a.indexOf(b)===c});this._controls.ProcessMouseMove(a)};f.prototype.UpdateVRControllers=function(){this.UpdateVRControllersList();for(var a=0;a<this._vrControllers.length;++a){var b=this._vrControllers[a],c=b.gamepad.pose.orientation,d=b.gamepad.pose.position;
b=b.mesh;c&&b.quaternion.fromArray(c);d&&b.position.fromArray(d);b.updateMatrix();b.applyMatrix(this._standingMatrix);b.matrixWorldNeedsUpdate=!0}this.ProcessVRControllerIntersections()};f.prototype.toggleVRMode=function(){if(this._vrDisplay)if(this._vrDisplay.isPresenting)this.ExitVRMode();else{var a=this;this._previousCameraPosition=this._camera.position.clone();this._previousCameraRotation=this._camera.rotation.clone();this._vrDisplay.requestPresent([{source:this._renderer.domElement}]).then(function(){a._previousCameraNear=
a._camera.near;a._dolly.position.set(a._camera.position.x/4,-a._camera.position.y/8,-a._camera.position.z/4);a._camera.position.set(0,0,0);a._dolly.add(a._camera);a._camera.near=.1;a._camera.updateProjectionMatrix();a._renderer.vr.enabled=!0;a._renderer.setAnimationLoop(function(){a.UpdateVRControllers();a.Render3D(0)})});this._renderer.vr.enabled=!0;window.addEventListener("keydown",function(b){27===b.keyCode&&a.ExitVRMode()})}};f.prototype.ExitVRMode=function(){this._vrDisplay.isPresenting&&(this._renderer.vr.enabled=
!1,this._dolly.remove(this._camera),this._scene.add(this._camera),this._camera.position.copy(this._previousCameraPosition),this._previousCameraPosition=void 0,this._camera.rotation.copy(this._previousCameraRotation),this._previousCameraRotation=void 0,this._camera.near=this._previousCameraNear,this._camera.updateProjectionMatrix(),this._vrDisplay.exitPresent())};f.prototype.GetGeometry=function(){return this.GetObject()};f.prototype.ModifyVisisbility=function(a,b){if(0===e.GEO.NodeKind(this.GetGeometry())){if(""==
a)return e.GEO.SetBit(this.GetGeometry().fVolume,e.GEO.BITS.kVisThis,"+"===b);var c=!1;0>a.indexOf("*")?(a=new RegExp("^"+a+"$"),c=!0):(a=new RegExp("^"+a.split("*").join(".*")+"$"),c=!1);this.FindNodeWithVolume(a,function(a){e.GEO.InvisibleAll.call(a.node.fVolume,"+"!==b);return c?a:null})}};f.prototype.decodeOptions=function(a){"string"!=typeof a&&(a="");var b={_grid:!1,_bound:!1,_debug:!1,_full:!1,_axis:0,_count:!1,wireframe:!1,scale:new h.Vector3(1,1,1),zoom:1,rotatey:0,rotatez:0,more:1,maxlimit:1E5,
vislevel:void 0,maxnodes:void 0,dflt_colors:!1,use_worker:!1,show_controls:!1,highlight:!1,highlight_scene:!1,no_screen:!1,project:"",is_main:!1,tracks:!1,showtop:!1,can_rotate:!0,ortho_camera:!1,clipx:!1,clipy:!1,clipz:!1,usessao:!1,outline:!1,script_name:"",transparency:0,rotate:!1,background:"#FFFFFF",depthMethod:"dflt",mouse_tmout:50,trans_radial:0,trans_z:0},c=e.GetUrlOption("_grid");null!==c&&"true"==c&&(b._grid=!0);c=e.GetUrlOption("_debug");null!==c&&"true"==c&&(b._debug=!0,b._grid=!0);null!==
c&&"bound"==c&&(b._debug=!0,b._grid=!0,b._bound=!0);null!==c&&"full"==c&&(b._debug=!0,b._grid=!0,b._full=!0,b._bound=!0);c=a.indexOf("macro:");if(0<=c){var d=a.indexOf(";",c+6);0>d&&(d=a.length);b.script_name=a.substr(c+6,d-c-6);a=a.substr(0,c)+a.substr(d+1);console.log("script",b.script_name,"rest",a)}for(;;){var l=a.indexOf("+"),g=a.indexOf("-");if(0>l&&0>g)break;c=l;d="+";if(0>c||0<=g&&g<l)c=g,d="-";l=c+1;for(g=/[,; .]/;l<a.length&&!g.test(a[l])&&"+"!=a[l]&&"-"!=a[l];)l++;g=a.substring(c+1,l);
a=a.substr(0,c)+a.substr(l);this.ModifyVisisbility(g,d)}a=new e.DrawOptions(a);a.check("MAIN")&&(b.is_main=!0);a.check("TRACKS")&&(b.tracks=!0);a.check("SHOWTOP")&&(b.showtop=!0);a.check("NO_SCREEN")&&(b.no_screen=!0);a.check("ORTHO_CAMERA_ROTATE")&&(b.ortho_camera=!0,b.can_rotate=!0);a.check("ORTHO_CAMERA")&&(b.ortho_camera=!0,b.can_rotate=!1);a.check("MOUSE_CLICK")&&(b.mouse_click=!0);if(a.check("DEPTHRAY")||a.check("DRAY"))b.depthMethod="ray";if(a.check("DEPTHBOX")||a.check("DBOX"))b.depthMethod=
"box";if(a.check("DEPTHPNT")||a.check("DPNT"))b.depthMethod="pnt";if(a.check("DEPTHSIZE")||a.check("DSIZE"))b.depthMethod="size";if(a.check("DEPTHDFLT")||a.check("DDFLT"))b.depthMethod="dflt";a.check("ZOOM",!0)&&(b.zoom=a.partAsFloat(0,100)/100);a.check("ROTY",!0)&&(b.rotatey=a.partAsFloat());a.check("ROTZ",!0)&&(b.rotatez=a.partAsFloat());a.check("VISLVL",!0)&&(b.vislevel=a.partAsInt());a.check("BLACK")&&(b.background="#000000");a.check("WHITE")&&(b.background="#FFFFFF");if(a.check("BKGR_",!0)){c=
null;if(0<a.partAsInt(1))c=e.Painter.root_colors[a.partAsInt()];else for(d=0;8>d;++d)e.Painter.root_colors[d].toUpperCase()===a.part&&(c=e.Painter.root_colors[d]);c&&(b.background="#"+(new h.Color(c)).getHexString())}a.check("MORE3")&&(b.more=3);a.check("MORE")&&(b.more=2);a.check("ALL")&&(b.more=10,b.vislevel=9);if(a.check("CONTROLS")||a.check("CTRL"))b.show_controls=!0;a.check("CLIPXYZ")&&(b.clipx=b.clipy=b.clipz=!0);a.check("CLIPX")&&(b.clipx=!0);a.check("CLIPY")&&(b.clipy=!0);a.check("CLIPZ")&&
(b.clipz=!0);a.check("CLIP")&&(b.clipx=b.clipy=b.clipz=!0);a.check("PROJX",!0)&&(b.project="x",0<a.partAsInt(1)&&(b.projectPos=a.partAsInt()),b.can_rotate=!1);a.check("PROJY",!0)&&(b.project="y",0<a.partAsInt(1)&&(b.projectPos=a.partAsInt()),b.can_rotate=!1);a.check("PROJZ",!0)&&(b.project="z",0<a.partAsInt(1)&&(b.projectPos=a.partAsInt()),b.can_rotate=!1);if(a.check("DFLT_COLORS")||a.check("DFLT"))b.dflt_colors=!0;a.check("SSAO")&&(b.usessao=!0);a.check("OUTLINE")&&(b.outline=!0);a.check("NOWORKER")&&
(b.use_worker=-1);a.check("WORKER")&&(b.use_worker=1);if(a.check("NOHIGHLIGHT")||a.check("NOHIGH"))b.highlight_scene=b.highlight=0;a.check("HIGHLIGHT")&&(b.highlight_scene=b.highlight=!0);a.check("HSCENEONLY")&&(b.highlight_scene=!0,b.highlight=0);a.check("NOHSCENE")&&(b.highlight_scene=0);a.check("HSCENE")&&(b.highlight_scene=!0);if(a.check("WIREFRAME")||a.check("WIRE"))b.wireframe=!0;a.check("ROTATE")&&(b.rotate=!0);if(a.check("INVX")||a.check("INVERTX"))b.scale.x=-1;if(a.check("INVY")||a.check("INVERTY"))b.scale.y=
-1;if(a.check("INVZ")||a.check("INVERTZ"))b.scale.z=-1;a.check("COUNT")&&(b._count=!0);a.check("TRANSP",!0)&&(b.transparency=a.partAsInt(0,100)/100);a.check("OPACITY",!0)&&(b.transparency=1-a.partAsInt(0,100)/100);if(a.check("AXISCENTER")||a.check("AC"))b._axis=2;a.check("TRR",!0)&&(b.trans_radial=a.partAsInt()/100);a.check("TRZ",!0)&&(b.trans_z=a.partAsInt()/100);if(a.check("AXIS")||a.check("A"))b._axis=!0;a.check("D")&&(b._debug=!0);a.check("G")&&(b._grid=!0);a.check("B")&&(b._bound=!0);a.check("W")&&
(b.wireframe=!0);a.check("F")&&(b._full=!0);a.check("Y")&&(b._yup=!0);a.check("Z")&&(b._yup=!1);void 0===b._yup&&(b._yup=this.svg_canvas().empty());return b};f.prototype.ActivateInBrowser=function(a,b){"string"==typeof a&&(a=[a]);this._hpainter&&(this._hpainter.activate(a,b),this.ctrl.update_browser||setTimeout(this._hpainter.activate.bind(this._hpainter,[]),2E3))};f.prototype.TestMatrixes=function(){var a=this,b=0,c=0,d=0;tm1=(new Date).getTime();this._clones.ScanVisible({domatrix:!0,func:function(l){l=
this.getmatrix();var e=this.CopyStack(),n=a._clones.CreateObject3D(e.stack,a._toplevel,"mesh");if(!n)return!0;c++;n=n.matrixWorld;if(n.equals(l))return!0;if(0<n.determinant()&&-.9>l.determinant()){var k=h.Vector3(1,1,-1);l=l.clone().scale(k);if(n.equals(l))return!0}for(var f=k=0;16>f;++f)k=Math.max(k,Math.abs(n.elements[f]-l.elements[f]));d=Math.max(k,d);if(1E-4>k)return!0;console.log(a._clones.ResolveStack(e.stack).name,"maxdiff",k,"determ",n.determinant(),l.determinant());b++;return!1}});tm2=(new Date).getTime();
console.log("Compare matrixes total",c,"errors",b,"takes",tm2-tm1,"maxdiff",d)};f.prototype.FillContextMenu=function(a){a.add("header: Draw options");a.addchk(this.ctrl.update_browser,"Browser update",function(){this.ctrl.update_browser=!this.ctrl.update_browser;this.ctrl.update_browser||this.ActivateInBrowser([])});a.addchk(this.ctrl.show_controls,"Show Controls",function(){this.showControlOptions("toggle")});a.addchk(this.ctrl._axis,"Show axes",function(){this.setAxesDraw("toggle")});this.geo_manager&&
a.addchk(this.ctrl.showtop,"Show top volume",function(){this.setShowTop(!this.ctrl.showtop)});a.addchk(this.ctrl.wireframe,"Wire frame",function(){this.toggleWireFrame()});a.addchk(this.ctrl.highlight,"Highlight volumes",function(){this.ctrl.highlight=!this.ctrl.highlight});a.addchk(this.ctrl.highlight_scene,"Highlight scene",function(){this.ctrl.highlight_scene=!this.ctrl.highlight_scene});a.add("Reset camera position",function(){this.focusCamera()});this._geom_viewer||a.add("Get camera position",
function(){alert("Position (as url): &opt="+this.produceCameraUrl())});this.ctrl.project||a.addchk(this.ctrl.rotate,"Autorotate",function(){this.setAutoRotate(!this.ctrl.rotate)});a.addchk(this.ctrl.select_in_view,"Select in view",function(){this.ctrl.select_in_view=!this.ctrl.select_in_view;this.ctrl.select_in_view&&this.startDrawGeometry()})};f.prototype.changedGlobalTransparency=function(a,b){var c="function"==typeof a?a:null;if(c||void 0===a)a=this.ctrl.transparency;this._toplevel.traverse(function(b){if(b&&
b.material&&void 0!==b.material.inherentOpacity){var d=c?c(b):void 0;b.material.opacity=void 0!==d?1-d:Math.min(1-(a||0),b.material.inherentOpacity);b.material.transparent=1>b.material.opacity}});b||this.Render3D(-1)};f.prototype.resetTransformation=function(){this.changedTransformation("reset")};f.prototype.changedTransformation=function(a){if(this._toplevel){var b=this.ctrl,c=new h.Matrix4,d=new h.Vector3;"reset"==a&&(b.trans_z=b.trans_radial=0);this._toplevel.traverse(function(l){if(void 0!==l.stack){var g=
l.parent;if("reset"==a)g.matrix0&&(g.matrix.copy(g.matrix0),g.matrix.decompose(g.position,g.quaternion,g.scale),g.matrixWorldNeedsUpdate=!0),delete g.matrix0,delete g.vect0,delete g.vect1,delete g.minvert;else{if(void 0===g.vect0){g.matrix0=g.matrix.clone();g.minvert=(new h.Matrix4).getInverse(g.matrixWorld);var n=e.GEO.getBoundingBox(l,null,!0);g.vect0=(new h.Vector3((n.max.x+n.min.x)/2,(n.max.y+n.min.y)/2,(l._flippedMesh?-1:1)*(n.max.z+n.min.z)/2)).applyMatrix4(g.matrixWorld);g.vect1=(new h.Vector3(0,
0,0)).applyMatrix4(g.minvert)}d.set(b.trans_radial*g.vect0.x,b.trans_radial*g.vect0.y,b.trans_z*g.vect0.z).applyMatrix4(g.minvert).sub(g.vect1);g.matrix.multiplyMatrices(g.matrix0,c.makeTranslation(d.x,d.y,d.z));g.matrix.decompose(g.position,g.quaternion,g.scale);g.matrixWorldNeedsUpdate=!0}}});this._toplevel.updateMatrixWorld();"norender"!=a&&this.drawSimpleAxis()}};f.prototype.changedAutoRotate=function(){this.autorotate(2.5)};f.prototype.changedAxes=function(){"string"==typeof this.ctrl._axis&&
(this.ctrl._axis=parseInt(this.ctrl._axis));this.drawSimpleAxis()};f.prototype.changedBackground=function(a){void 0!==a&&(this.ctrl.background=a);this._renderer.setClearColor(this.ctrl.background,1);this.Render3D(0);this._toolbar&&(a=new h.Color(this.ctrl.background),this._toolbar.changeBrightness(1>a.r+a.g+a.b))};f.prototype.changedSSAO=function(){this.ctrl.ssao.enabled?(this.createSSAO(),this._ssaoPass.output=parseInt(this.ctrl.ssao.output),this._ssaoPass.kernelRadius=this.ctrl.ssao.kernelRadius,
this._ssaoPass.minDistance=this.ctrl.ssao.minDistance,this._ssaoPass.maxDistance=this.ctrl.ssao.maxDistance):this.removeSSAO();this.updateClipping()};f.prototype.showControlOptions=function(a){var b=B;b||"object"!=typeof dat||(b=dat);if("load"===a){if("undefined"==typeof b)throw Error("dat.gui is not defined","JSRootGeoPainter.js");a=!0}else"toggle"===a?a=!this._datgui:void 0===a&&(a=this.ctrl.show_controls);this.ctrl.show_controls=a;if(this._datgui)a||(v.select(this._datgui.domElement).remove(),
this._datgui.destroy(),delete this._datgui);else if(a){if("undefined"==typeof b)return e.AssertPrerequisites("datgui",this.showControlOptions.bind(this,"load"));var c=this;this._datgui=new b.GUI({autoPlace:!1,width:Math.min(650,c._renderer.domElement.width/2)});a=this.select_main();"static"==a.style("position")&&a.style("position","relative");v.select(this._datgui.domElement).style("position","absolute").style("top",0).style("right",0);a.node().appendChild(this._datgui.domElement);this._datgui.painter=
this;if(this.ctrl.project)a=this.getGeomBoundingBox(this.getProjectionSource(),.01),b=this.ctrl.project,void 0===this.ctrl.projectPos&&(this.ctrl.projectPos=(a.min[b]+a.max[b])/2),this._datgui.add(this.ctrl,"projectPos",a.min[b],a.max[b]).name(b.toUpperCase()+" projection").onChange(function(a){c.startDrawGeometry()});else{a=this._datgui.addFolder("Clipping");b=this.changedClipping.bind(this,-1);for(var d=0;3>d;++d){var l=this.ctrl.clip[d],g=l.name.toUpperCase();a.add(l,"enabled").name("Enable "+
g).listen().onChange(b);a.add(l,"value",l.min,l.max).name(g+" position").onChange(this.changedClipping.bind(this,d))}a.add(this.ctrl,"clipIntersect").name("Clip intersection").listen().onChange(b)}a=this._datgui.addFolder("Appearance");a.add(this.ctrl,"highlight").name("Highlight Selection").listen().onChange(this.changedHighlight.bind(this));a.add(this.ctrl,"transparency",0,1,.001).listen().onChange(this.changedGlobalTransparency.bind(this));a.addColor(this.ctrl,"background").name("Background").onChange(this.changedBackground.bind(this));
a.add(this.ctrl,"wireframe").name("Wireframe").listen().onChange(this.changedWireFrame.bind(this));this.ctrl._axis_cfg=0;a.add(this.ctrl,"_axis",{none:0,show:1,center:2}).name("Axes").onChange(this.changedAxes.bind(this));if(!this.ctrl.project)a.add(this.ctrl,"rotate").name("Autorotate").listen().onChange(this.changedAutoRotate.bind(this));a.add(this,"focusCamera").name("Reset camera position");if(this._webgl){a=this._datgui.addFolder("Advanced");var n={};this.ctrl.depthMethodItems.forEach(function(a){n[a.name]=
a.value});a.add(this.ctrl,"depthTest").name("Depth test").listen().onChange(this.changedDepthTest.bind(this));a.add(this.ctrl,"depthMethod",n).name("Rendering order").onChange(this.changedDepthMethod.bind(this));a.add(this,"resetAdvanced").name("Reset")}this.ctrl.project||(a=this._datgui.addFolder("Transform"),a.add(this.ctrl,"trans_z",0,3,.01).name("Z axis").listen().onChange(this.changedTransformation.bind(this)),a.add(this.ctrl,"trans_radial",0,3,.01).name("Radial").listen().onChange(this.changedTransformation.bind(this)),
a.add(this,"resetTransformation").name("Reset"),(this.ctrl.trans_z||this.ctrl.trans_radial)&&a.open());if(!this.ctrl.outline){a=this._datgui.addFolder("Smooth Lighting (SSAO)");b=this.changedSSAO.bind(this);var k={};this.ctrl.ssao.outputItems.forEach(function(a){k[a.name]=a.value});a.add(this.ctrl.ssao,"enabled").name("Enable SSAO").listen().onChange(b);a.add(this.ctrl.ssao,"output",k).listen().onChange(b);a.add(this.ctrl.ssao,"kernelRadius",0,32).listen().onChange(b);a.add(this.ctrl.ssao,"minDistance",
.001,.02).listen().onChange(b);a.add(this.ctrl.ssao,"maxDistance",.01,.3).listen().onChange(b)}}};f.prototype.removeSSAO=function(){delete this._ssaoPass;delete this._effectComposer};f.prototype.createSSAO=function(){this._webgl&&!this._ssaoPass&&(this._effectComposer||(this._effectComposer=new h.EffectComposer(this._renderer),this._effectComposer.addPass(new h.RenderPass(this._scene,this._camera))),this._ssaoPass=new h.SSAOPass(this._scene,this._camera,this._scene_width,this._scene_height),this._ssaoPass.kernelRadius=
16,this._ssaoPass.renderToScreen=!0,this._effectComposer.addPass(this._ssaoPass))};f.prototype.OrbitContext=function(a,b){e.Painter.createMenu(this,function(a){var c=0,l=0,g=0;if(b)for(var n=0;n<b.length;++n)b[n].object.stack&&l++,b[n].object.geo_name&&c++;if(0===l+c)a.painter.FillContextMenu(a);else for((l=1<l+c)&&a.add("header:"+(0<c?"Items":"Nodes")),n=0;n<b.length;++n){c=b[n].object;var k;if(c.geo_name){var f=c.geo_name;0==f.indexOf("<prnt>")&&(f=(a.painter.GetItemName()||"top")+f.substr(6));
(k=f.substr(f.lastIndexOf("/")+1))||(k=f);var h=k}else if(c.stack)k=a.painter._clones.ResolveStack(c.stack).name,f=a.painter.GetStackFullName(c.stack),h=a.painter.GetItemName(),0===k.indexOf("Nodes/")?h=k.substr(6):0<k.length?h=k:h||(h="header");else continue;a.add((l?"sub:":"header:")+h,f,function(a){this.ActivateInBrowser([a],!0)});a.add("Browse",f,function(a){this.ActivateInBrowser([a],!0)});a.painter._hpainter&&a.add("Inspect",f,function(a){this._hpainter.display(a,"inspect")});c.geo_name?a.add("Hide",
n,function(c){c=b[c].object;c.visible=!1;c.geo_object&&(c.geo_object.$hidden_via_menu=!0);a.painter.Render3D()}):(c=a.painter.accessObjectWireFrame(c),void 0!==c&&a.addchk(c,"Wireframe",n,function(a){a=b[a].object.material;a.wireframe=!a.wireframe;this.Render3D()}),1<++g&&a.add("Manifest",n,function(a){this._last_manifest&&(this._last_manifest.wireframe=!this._last_manifest.wireframe);this._last_hidden&&this._last_hidden.forEach(function(a){a.visible=!0});this._last_hidden=[];for(var c=0;c<a;++c)this._last_hidden.push(b[c].object);
this._last_hidden.forEach(function(a){a.visible=!1});this._last_manifest=b[a].object.material;this._last_manifest.wireframe=!this._last_manifest.wireframe;this.Render3D()}),a.add("Focus",n,function(a){this.focusCamera(b[a].object)}),a.painter._geom_viewer||a.add("Hide",n,function(c){c=a.painter._clones.ResolveStack(b[c].object.stack);c.obj&&0===c.node.kind&&c.obj.fVolume?(e.GEO.SetBit(c.obj.fVolume,e.GEO.BITS.kVisThis,!1),e.GEO.updateBrowserIcons(c.obj.fVolume,this._hpainter)):c.obj&&1===c.node.kind&&
(c.obj.fRnrSelf=!1,e.GEO.updateBrowserIcons(c.obj,this._hpainter));this.testGeomChanges()}));l&&a.add("endsub:")}a.show()},a)};f.prototype.FilterIntersects=function(a){if(!a.length)return a;for(var b=0;b<a.length;++b)a[b].object.geo_highlight&&(a[b].object=a[b].object.geo_highlight);for(b=a.length-1;0<=b;--b){var c=a[b].object,d=void 0!==c.stack||void 0!==c.geo_name;d&&c.material&&void 0!==c.material.opacity&&(d=.1<=c.material.opacity);c.jsroot_special&&(d=!1);for(var e=0;e<b&&d;++e)a[e].object===
c&&(d=!1);d||a.splice(b,1)}b=this.ctrl.clip;if(b[0].enabled||b[1].enabled||b[2].enabled){c=[];for(d=0;d<a.length;++d){e=a[d].point;var g="Points"==a[d].object.type,n=!0,k;if(k=b[0].enabled)k=(k=this._clipPlanes[0].normal.dot(e)>this._clipPlanes[0].constant)&&!g||!k&&g;k&&(n=!1);if(k=b[1].enabled)k=(k=this._clipPlanes[1].normal.dot(e)>this._clipPlanes[1].constant)&&!g||!k&&g;k&&(n=!1);b[2].enabled&&this._clipPlanes[2].normal.dot(e)>this._clipPlanes[2].constant&&(n=!1);n||c.push(a[d])}a=c}return a};
f.prototype.testCameraPositionChange=function(){if(this.ctrl.select_in_view&&!this._draw_all_nodes){var a=e.GEO.CreateProjectionMatrix(this._camera);e.GEO.CreateFrustum(a).CheckBox(this.getGeomBoundingBox(this._toplevel))||this.startDrawGeometry()}};f.prototype.ResolveStack=function(a){return this._clones&&a?this._clones.ResolveStack(a):null};f.prototype.GetStackFullName=function(a){var b=this.GetItemName();return(a=this.ResolveStack(a))&&a.name?b?b+"/"+a.name:a.name:b};f.prototype.AddHighlightHandler=
function(a){a&&"function"==typeof a.HighlightMesh&&(this._highlight_handlers||(this._highlight_handlers=[]),this._highlight_handlers.push(a))};A.prototype=Object.create(e.Painter.InteractiveControl.prototype);A.prototype.setHighlight=function(a,b){return this.drawSpecial(a,b)};A.prototype.drawSpecial=function(a,b){if((b=this.mesh)&&b.material){if(a)return b.origin||(b.origin={color:b.material.color,opacity:b.material.opacity,width:b.material.linewidth,size:b.material.size}),b.material.color=new h.Color(a),
b.material.opacity=1,b.hightlightWidthScale&&!e.browser.isWin&&(b.material.linewidth=b.origin.width*b.hightlightWidthScale),b.highlightScale&&(b.material.size=b.origin.size*b.highlightScale),!0;if(b.origin)return b.material.color=b.origin.color,b.material.opacity=b.origin.opacity,b.hightlightWidthScale&&(b.material.linewidth=b.origin.width),b.highlightScale&&(b.material.size=b.origin.size),!0}};f.prototype.HighlightMesh=function(a,b,c,d,l,g){function n(a){return a.get_ctrl?a.get_ctrl():new A(a)}if(c){a=
a?[a]:[];var k=this.getExtrasContainer();k&&k.traverse(function(b){b.geo_object===c&&0>a.indexOf(b)&&a.push(b)})}else l&&this._toplevel?(a=[],this._toplevel.traverse(function(b){b instanceof h.Mesh&&e.GEO.IsSameStack(b.stack,l)&&a.push(b)})):a=a?[a]:[];a.length||(a=null);a&&(a[0].geo_object?this.ctrl.highlight_scene||(a=null):this.ctrl.highlight||(a=null));if(!g)for(a&&(c||(c=a[0].geo_object),l||(l=a[0].stack)),k=this._highlight_handlers||(this._main_painter?this._main_painter._slave_painters.concat([this._main_painter]):
this._slave_painters),g=0;g<k.length;++g)k[g]!==this&&k[g].HighlightMesh(null,b,c,d,l,!0);k=this._selected_mesh;if(!k&&!a)return!1;var f=!1;if(k&&a&&k.length==a.length)for(f=!0,g=0;g<k.length&&f;++g)if(k[g]!==a[g]||n(k[g]).checkHighlightIndex(d))f=!1;if(f)return!!k;if(k)for(g=0;g<k.length;++g)n(k[g]).setHighlight();if(this._selected_mesh=a)for(g=0;g<a.length;++g)n(a[g]).setHighlight(b||16755251,d);this.Render3D(0);return!!a};f.prototype.ProcessMouseClick=function(a,b,c){b.length&&(a=b[0].object,a.get_ctrl&&
(a=a.get_ctrl(),b=a.extractIndex(b[0]),a.evnt=c,a.setSelected("blue",b)&&this.Render3D(),a.evnt=null))};f.prototype.setMouseTmout=function(a){this.ctrl&&(this.ctrl.mouse_tmout=a);this._controls&&(this._controls.mouse_tmout=a)};f.prototype.setDepthMethod=function(a){this.ctrl&&(this.ctrl.depthMethod=a)};f.prototype.addOrbitControls=function(){if(!(this._controls||this._usesvg||e.BatchMode)){var a=this;this.SetTooltipAllowed(0<e.gStyle.Tooltip);this._controls=e.Painter.CreateOrbitControl(this,this._camera,
this._scene,this._renderer,this._lookat);this._controls.mouse_tmout=this.ctrl.mouse_tmout;this.ctrl.can_rotate||(this._controls.enableRotate=!1);this._controls.ContextMenu=this.OrbitContext.bind(this);this._controls.ProcessMouseMove=function(b){for(var c=null,d=null,l=null,g=[],n,k,f=0;f<b.length;++f){var h=b[f].object,u=null;h&&(h.geo_object?u=h.geo_name:h.stack&&(u=a.GetStackFullName(h.stack)),u&&(0==u.indexOf("<prnt>")&&(u=a.GetItemName()+u.substr(6)),g.push(u),c||(c=h,d=u,n=h.geo_object,h.get_ctrl&&
(k=h.get_ctrl().extractIndex(b[f]),void 0!==k&&"string"==typeof d&&(d+=" indx:"+JSON.stringify(k))),c.stack&&(l=a.ResolveStack(c.stack)))))}a.HighlightMesh(c,void 0,n,k);a.ctrl.update_browser&&(a.ctrl.highlight&&d&&(g=[d]),a.ActivateInBrowser(g));if(!l||!l.obj)return d;b=e.GEO.provideInfo(l.obj);b.unshift(d);return{name:l.obj.fName,title:l.obj.fTitle||l.obj._typename,lines:b}};this._controls.ProcessMouseLeave=function(){this.ProcessMouseMove([])};this._controls.ProcessDblClick=function(){a._last_manifest?
(a._last_manifest.wireframe=!a._last_manifest.wireframe,a._last_hidden&&a._last_hidden.forEach(function(a){a.visible=!0}),delete a._last_hidden,delete a._last_manifest,a.Render3D()):a.adjustCameraPosition()}}};f.prototype.addTransformControl=function(){if(!this._tcontrols&&(this.ctrl._debug||this.ctrl._grid)){this._tcontrols=new h.TransformControls(this._camera,this._renderer.domElement);this._scene.add(this._tcontrols);this._tcontrols.attach(this._toplevel);var a=this;window.addEventListener("keydown",
function(b){switch(b.keyCode){case 81:a._tcontrols.setSpace("local"===a._tcontrols.space?"world":"local");break;case 17:a._tcontrols.setTranslationSnap(Math.ceil(a._overall_size)/50);a._tcontrols.setRotationSnap(h.Math.degToRad(15));break;case 84:a._tcontrols.setMode("translate");break;case 82:a._tcontrols.setMode("rotate");break;case 83:a._tcontrols.setMode("scale");break;case 187:case 107:a._tcontrols.setSize(a._tcontrols.size+.1);break;case 189:case 109:a._tcontrols.setSize(Math.max(a._tcontrols.size-
.1,.1))}});window.addEventListener("keyup",function(b){switch(b.keyCode){case 17:a._tcontrols.setTranslationSnap(null),a._tcontrols.setRotationSnap(null)}});this._tcontrols.addEventListener("change",function(){a.Render3D(0)})}};f.prototype.nextDrawAction=function(){if(!this._clones||0==this.drawing_stage)return!1;if(1==this.drawing_stage){if(this._geom_viewer)return this._draw_all_nodes=!1,this.drawing_stage=3,!0;if(0<this.ctrl.use_worker){if(!this._worker)return this.startWorker(),1;if(!this._worker_ready)return 1}var a=
this._clones.CountVisibles()||this._clones.MarkVisibles(),b=null,c=null;this.ctrl.select_in_view&&!this._first_drawing&&(b=e.GEO.CreateProjectionMatrix(this._camera),c=e.GEO.CreateFrustum(b),c.CheckBox(this.getGeomBoundingBox(this._toplevel))&&(c=b=null));this._current_face_limit=this.ctrl.maxlimit;b&&(this._current_face_limit*=1.25);(a=!e.BatchMode&&(1E4<a||b&&1E5<this._clones.ScanVisible()))&&0==e.source_dir.indexOf("file://")&&(console.log("disable worker for jsroot from file system"),a=!1);a&&
!this._worker&&0<=this.ctrl.use_worker&&this.startWorker();if(!a||!this._worker_ready)return b=this._clones.CollectVisibles(this._current_face_limit,c),this._new_draw_nodes=b.lst,this._draw_all_nodes=b.complete,this.drawing_stage=3,!0;c={collect:this._current_face_limit,flags:this._clones.GetVisibleFlags(),matrix:b?b.elements:null};this.submitToWorker(c);this.drawing_stage=2;this.drawing_log="Worker select visibles";return 2}if(2==this.drawing_stage)return this.drawing_log="Worker select visibles",
2;if(3==this.drawing_stage){this.drawing_log="Analyse visibles";if(this._new_append_nodes)this._new_draw_nodes=this._draw_nodes.concat(this._new_append_nodes),delete this._new_append_nodes;else if(this._draw_nodes){c=this._geom_viewer?this._draw_nodes:this._clones.MergeVisibles(this._new_draw_nodes,this._draw_nodes);for(b=0;b<c.length;++b)this._clones.CreateObject3D(c[b].stack,this._toplevel,"delete_mesh");0<c.length&&(this.drawing_log="Delete "+c.length+" nodes")}this._draw_nodes=this._new_draw_nodes;
delete this._new_draw_nodes;this.drawing_stage=4;return!0}if(4===this.drawing_stage)return this.drawing_log="Collect shapes",b=this._clones.CollectShapes(this._draw_nodes),this._build_shapes=this._clones.MergeShapesLists(this._build_shapes,b),this.drawing_stage=5,!0;if(5===this.drawing_stage){if(this.canSubmitToWorker()){c={limit:this._current_face_limit,shapes:[]};for(b=a=0;b<this._build_shapes.length;++b){var d=this._build_shapes[b];d.ready||d.geom?d={id:d.id,ready:!0,nfaces:e.GEO.numGeometryFaces(d.geom),
refcnt:d.refcnt}:(d=e.clone(d,null,!0),a++);c.shapes.push(d)}if(0<a)return this.submitToWorker(c),this.drawing_log="Worker build shapes",this.drawing_stage=6,2}this.drawing_stage=7}if(6===this.drawing_stage)return 2;if(7===this.drawing_stage||8===this.drawing_stage){if(7===this.drawing_stage)if(b=this._clones.BuildShapes(this._build_shapes,this._current_face_limit,500),b.done)this.ctrl.info.num_shapes=this._build_shapes.length,this.drawing_stage=8;else if(this.ctrl.info.num_shapes=b.shapes,this.drawing_log=
"Creating: "+b.shapes+" / "+this._build_shapes.length+" shapes,  "+b.faces+" faces",30>b.notusedshapes)return!0;c=(new Date).getTime();a=!0;d=this.ctrl.project?this._full_geom:this._toplevel;for(b=0;b<this._draw_nodes.length;++b){var l=this._draw_nodes[b];if(!l.done){var g=l.server_shape||this._build_shapes[l.shapeid];if(g.ready){if(l.done=!0,g.used=!0,this.createEntryMesh(l,g,d)&&(this.ctrl.info.num_meshes++,this.ctrl.info.num_faces+=g.nfaces),500<(new Date).getTime()-c){a=!1;break}}else 8===this.drawing_stage&&
console.warn("shape marked as not ready when should"),a=!1}}if(a){if(this.ctrl.project)return this.drawing_log="Build projection",this.drawing_stage=10,!0;this.drawing_log="Building done";this.drawing_stage=0;return!1}7<this.drawing_stage&&(this.drawing_log="Building meshes "+this.ctrl.info.num_meshes+" / "+this.ctrl.info.num_faces);return!0}if(9===this.drawing_stage){if(!this._main_painter)return console.warn("MAIN PAINTER DISAPPER"),this.drawing_stage=0,!1;if(!this._main_painter._drawing_ready)return 1;
this.drawing_stage=10}if(10===this.drawing_stage)return this.doProjection(),this.drawing_log="Building done",this.drawing_stage=0,!1;console.error("never come here stage = "+this.drawing_stage);return!1};f.prototype.createEntryMesh=function(a,b,c){if(!b.geom||0===b.nfaces)return this._clones.CreateObject3D(a.stack,c,"delete_mesh"),!1;this._splitColors&&a.stack&&(0===a.stack[0]?a.custom_color="green":1===a.stack[0]&&(a.custom_color="blue"));var d=this._clones.getDrawEntryProperties(a);c=this._clones.CreateObject3D(a.stack,
c,this.ctrl);d.material.wireframe=this.ctrl.wireframe;d.material.side=this.ctrl.bothSides?h.DoubleSide:h.FrontSide;b=-.9<c.matrixWorld.determinant()?new h.Mesh(b.geom,d.material):e.GEO.createFlippedMesh(c,b,d.material);c.add(b);b.stack=a.stack;b.renderOrder=this._clones.maxdepth-a.stack.length;b.$jsroot_order=c.$jsroot_depth;if(this.ctrl._debug||this.ctrl._full)a=new h.WireframeGeometry(b.geometry),d=new h.LineBasicMaterial({color:d.fillcolor,linewidth:d.linewidth||1}),d=new h.LineSegments(a,d),c.add(d);
if(this.ctrl._bound||this.ctrl._full)d=new h.BoxHelper(b),c.add(d);return!0};f.prototype.appendMoreNodes=function(a,b){if(this.drawing_stage&&!b)this._provided_more_nodes=a;else{if(this._more_nodes)for(var c=0;c<this._more_nodes.length;++c){var d=this._more_nodes[c],l=this._clones.CreateObject3D(d.stack,this._toplevel,"delete_mesh");e.Painter.DisposeThreejsObject(l);e.GEO.cleanupShape(d.server_shape);delete d.server_shape}delete this._more_nodes;if(a){c=[];for(l=0;l<a.length;++l){d=a[l];var g=d.server_shape;
g&&g.ready&&(d.done=!0,g.used=!0,this.createEntryMesh(d,g,this._toplevel)&&c.push(d))}c&&(this._more_nodes=c);b||this.Render3D()}}};f.prototype.getProjectionSource=function(){return this._clones_owner?this._full_geom:this._main_painter?this._main_painter._drawing_ready?this._main_painter._toplevel:(console.warn("MAIN PAINTER NOT READY WHEN DO PROJECTION"),null):(console.warn("MAIN PAINTER DISAPPER"),null)};f.prototype.getGeomBoundingBox=function(a,b){var c=new h.Box3,d=!this._clones;if(!a)return c.min.x=
c.min.y=c.min.z=-1,c.max.x=c.max.y=c.max.z=1,c;c.makeEmpty();a.traverse(function(a){(d||a.stack&&a instanceof h.Mesh||a.main_track&&a instanceof h.LineSegments)&&e.GEO.getBoundingBox(a,c)});void 0!==b&&c.expandByVector(c.getSize(new h.Vector3).multiplyScalar(b));return c};f.prototype.doProjection=function(){var a=this.getProjectionSource(),b=this;if(!a)return!1;e.Painter.DisposeThreejsObject(this._toplevel,!0);if(void 0===this.ctrl.projectPos){var c=this.getGeomBoundingBox(a),d=c.min[this.ctrl.project];
c=c.max[this.ctrl.project];var l=(d+c)/2;0>d&&0<c&&Math.abs(l)<.2*Math.max(-d,c)&&(l=0);this.ctrl.projectPos=l}a.traverse(function(a){if(a instanceof h.Mesh&&a.stack){var c=e.GEO.projectGeometry(a.geometry,a.parent.matrixWorld,b.ctrl.project,b.ctrl.projectPos,a._flippedMesh);c&&(c=new h.Mesh(c,a.material.clone()),b._toplevel.add(c),c.stack=a.stack)}});return!0};f.prototype.SameMaterial=function(a,b){if(null===a||null===b)return a===b;if(0<=a.fVolume.fLineColor)return a.fVolume.fLineColor===b.fVolume.fLineColor;
a=null!==a.fVolume.fMedium?a.fVolume.fMedium.fMaterial:null;b=null!==b.fVolume.fMedium?b.fVolume.fMedium.fMaterial:null;return a===b?!0:null===a||null===b?!1:a.fFillStyle===b.fFillStyle&&a.fFillColor===b.fFillColor};f.prototype.changedLight=function(a){if(this._camera){var b=!a;a||(a=this.getGeomBoundingBox(this._toplevel));var c=a.max.x-a.min.x,d=a.max.y-a.min.y;a=a.max.z-a.min.z;var l=[],g=this.ctrl.light.power;void 0===g&&(g=1);if(this._camera._lights!=this.ctrl.light.kind)switch(e.Painter.DisposeThreejsObject(this._camera,
!0),this._camera._lights=this.ctrl.light.kind,this._camera._lights){case "ambient":this._camera.add(new h.AmbientLight(15724527,g));break;case "hemisphere":this._camera.add(new h.HemisphereLight(16777147,526368,g));break;default:for(var n=0;6>n;++n)this._camera.add(new h.PointLight(15724527,g))}for(n=0;n<this._camera.children.length;++n){var f=this._camera.children[n],p=!1;if(f.isAmbientLight||f.isHemisphereLight)f.intensity=g;else if(f.isPointLight){switch(n){case 0:f.position.set(c/5,d/5,a/5);p=
this.ctrl.light.specular;break;case 1:f.position.set(0,0,a/2);p=this.ctrl.light.front;break;case 2:f.position.set(0,2*d,0);p=this.ctrl.light.top;break;case 3:f.position.set(0,-2*d,0);p=this.ctrl.light.bottom;break;case 4:f.position.set(-2*c,0,0);p=this.ctrl.light.left;break;case 5:f.position.set(2*c,0,0),p=this.ctrl.light.right}f.power=p?g*Math.PI*4:0;p&&l.push(f)}}l.forEach(function(a){a.power=4*g*Math.PI/l.length});b&&this.Render3D()}};f.prototype.createScene=function(a,b){this._scene=new h.Scene;
this._scene.fog=new h.Fog(16777215,1,1E4);this._scene.overrideMaterial=new h.MeshLambertMaterial({color:7340287,transparent:!0,opacity:.2,depthTest:!1});this._scene_width=a;this._scene_height=b;this.ctrl.ortho_camera?this._camera=new h.OrthographicCamera(-600,600,-600,600,1,1E4):(this._camera=new h.PerspectiveCamera(25,a/b,1,1E4),this._camera.up=this.ctrl._yup?new h.Vector3(0,1,0):new h.Vector3(0,0,1));this._scene.add(this._camera);this._selected_mesh=null;this._overall_size=10;this._toplevel=new h.Object3D;
this._scene.add(this._toplevel);var c=e.Painter.Create3DRenderer(a,b,this._usesvg,this._usesvgimg,this._webgl,{antialias:!0,logarithmicDepthBuffer:!1,preserveDrawingBuffer:!0});this._webgl=c.usewebgl;this._renderer=c.renderer;this._renderer.setPixelRatio&&!e.nodejs&&this._renderer.setPixelRatio(window.devicePixelRatio);this._renderer.setSize(a,b,!this._fit_main_area);this._renderer.localClippingEnabled=!0;this._renderer.setClearColor(this.ctrl.background,1);if(this._fit_main_area&&!this._usesvg){this._renderer.domElement.style.width=
"100%";this._renderer.domElement.style.height="100%";var d=this.select_main();"static"==d.style("position")&&d.style("position","relative")}this._animating=!1;this.ctrl.bothSides=!1;this._clipPlanes=[new h.Plane(new h.Vector3(1,0,0),0),new h.Plane(new h.Vector3(0,this.ctrl._yup?-1:1,0),0),new h.Plane(new h.Vector3(0,0,this.ctrl._yup?1:-1),0)];d=new h.PointLight(15724527,1);d.position.set(10,10,10);this._camera.add(d);this._webgl&&(this.ctrl.ssao.enabled||this.ctrl.outline)&&(this.ctrl.outline&&"function"==
typeof this.createOutline?(this._effectComposer=new h.EffectComposer(this._renderer),this._effectComposer.addPass(new h.RenderPass(this._scene,this._camera)),this.createOutline(a,b)):this.ctrl.ssao.enabled&&this.createSSAO());return this._fit_main_area&&(this._usesvg||this._usesvgimg)?(a=y.createElementNS("http://www.w3.org/2000/svg","svg"),a.appendChild(c.dom),a):c.dom};f.prototype.startDrawGeometry=function(a){a||0===this.drawing_stage?(this._clones_owner&&this._clones&&this._clones.SetDefaultColors(this.ctrl.dflt_colors),
this._last_render_tm=this._startm=(new Date).getTime(),this._last_render_meshes=0,this.drawing_stage=1,this._drawing_ready=!1,this.drawing_log="collect visible",this.ctrl.info.num_meshes=0,this.ctrl.info.num_faces=0,this.ctrl.info.num_shapes=0,this._selected_mesh=null,this.ctrl.project&&(this._clones_owner?this._full_geom?(this.drawing_stage=10,this.drawing_log="build projection"):this._full_geom=new h.Object3D:(this.drawing_stage=9,this.drawing_log="wait for main painter")),delete this._last_manifest,
delete this._last_hidden,delete this._draw_nodes_again,this.continueDraw()):this._draw_nodes_again=!0};f.prototype.resetAdvanced=function(){this.ctrl.ssao.kernelRadius=16;this.ctrl.ssao.output=h.SSAOPass.OUTPUT.Default;this.ctrl.depthTest=!0;this.ctrl.clipIntersect=!0;this.ctrl.depthMethod="ray";this.changedDepthMethod("norender");this.changedDepthTest()};f.prototype.getGeomBox=function(){var a=this.getExtrasContainer("collect"),b=this.getGeomBoundingBox(this._toplevel);if(a)for(var c=0;c<a.length;++c)this._toplevel.add(a[c]);
return b};f.prototype.getOverallSize=function(a){if(!this._overall_size||a){a=this.getGeomBoundingBox(this._toplevel);if(isNaN(a.min.x))return 1E3;this._overall_size=2*Math.max(a.max.x-a.min.x,a.max.y-a.min.y,a.max.z-a.min.z)}return this._overall_size};f.prototype.createSnapshot=function(a){if(this._renderer){this.Render3D(0);var b=this._renderer.domElement.toDataURL("image/png");if("asis"===a)return b;b.replace("image/png","image/octet-stream");var c=y.createElement("a");"string"===typeof c.download&&
(y.body.appendChild(c),c.download=a||"geometry.png",c.href=b,c.click(),y.body.removeChild(c))}};f.prototype.produceCameraUrl=function(a){if(this._lookat&&this._camera0pos&&this._camera&&this.ctrl){var b=(new h.Vector3).add(this._camera0pos).sub(this._lookat),c=(new h.Vector3).add(this._camera.position).sub(this._lookat),d=b.length(),e=c.length();d=this.ctrl.zoom*e/d*100;1>d?d=1:1E4<d&&(d=1E4);b.normalize();c.normalize();e=new h.Quaternion;e.setFromUnitVectors(b,c);b=new h.Euler;b.setFromQuaternion(e,
"YZX");c=b.y/Math.PI*180;b=b.z/Math.PI*180;0>c&&(c+=360);0>b&&(b+=360);return"roty"+c.toFixed(a||0)+",rotz"+b.toFixed(a||0)+",zoom"+d.toFixed(a||0)}};f.prototype.calculateZoom=function(){if(this._camera0pos&&this._camera&&this._lookat){var a=(new h.Vector3).add(this._camera0pos).sub(this._lookat);return(new h.Vector3).add(this._camera.position).sub(this._lookat).length()/a.length()}return 0};f.prototype.adjustCameraPosition=function(a,b){if(this._toplevel){var c=this.getGeomBoundingBox(this._toplevel);
if(!isNaN(c.min.x)){var d=c.max.x-c.min.x,e=c.max.y-c.min.y,g=c.max.z-c.min.z,f=(c.max.x+c.min.x)/2,k=(c.max.y+c.min.y)/2,p=(c.max.z+c.min.z)/2;this._overall_size=2*Math.max(d,e,g);this._camera.near=this._overall_size/350;this._camera.far=12*this._overall_size;this._scene.fog.near=2*this._overall_size;this._scene.fog.far=12*this._overall_size;if(a)for(a=0;3>a;++a){var q=this.ctrl.clip[a];q.min=c.min[q.name];q.max=c.max[q.name];var u=q.max-q.min;q.max+=.01*u;q.min-=.01*u;q.value?q.value<q.min?q.value=
q.min:q.value>q.max&&(q.value=q.max):q.value=(q.min+q.max)/2}this.ctrl.ortho_camera&&(this._camera.left=c.min.x,this._camera.right=c.max.x,this._camera.top=c.max.y,this._camera.bottom=c.min.y);this._camera.updateProjectionMatrix();a=2*this.ctrl.zoom;q=Math.max(d,e,g);if((this.ctrl.rotatey||this.ctrl.rotatez)&&this.ctrl.can_rotate)d=this.calculateZoom(),b&&d&&(a=2*d),e=new h.Euler(0,this.ctrl.rotatey/180*Math.PI,this.ctrl.rotatez/180*Math.PI,"YZX"),this._camera.position.set(-a*q,0,0),this._camera.position.applyEuler(e),
this._camera.position.add(new h.Vector3(f,k,p)),b&&d&&(b=this.calculateZoom(),this._camera.position.set(-(d/b*a)*q,0,0),this._camera.position.applyEuler(e),this._camera.position.add(new h.Vector3(f,k,p)));else if(this.ctrl.ortho_camera)this._camera.position.set(f,k,Math.max(d,e));else if(this.ctrl.project)switch(this.ctrl.project){case "x":this._camera.position.set(1.5*a*Math.max(e,g),0,0);break;case "y":this._camera.position.set(0,1.5*a*Math.max(d,g),0);break;case "z":this._camera.position.set(0,
0,1.5*a*Math.max(d,e))}else this.ctrl._yup?this._camera.position.set(f-a*Math.max(d,g),k+a*e,p-a*Math.max(d,g)):this._camera.position.set(f-a*Math.max(d,e),k-a*Math.max(d,e),p+a*g);this._lookat=new h.Vector3(f,k,p);this._camera0pos=new h.Vector3(-2*q,0,0);this._camera.lookAt(this._lookat);this.changedLight(c);this._controls&&(this._controls.target.copy(this._lookat),this._controls.update());this.ctrl.select_in_view&&this.startDrawGeometry()}}};f.prototype.setCameraPosition=function(a,b,c){this.ctrl&&
(this.ctrl.rotatey=a||0,this.ctrl.rotatez=b||0,a=!1,c&&!isNaN(c)?this.ctrl.zoom=c:a=!0,this.adjustCameraPosition(!1,a))};f.prototype.focusOnItem=function(a){a&&this._clones&&(a=this._clones.FindStackByName(a))&&(a=this._clones.ResolveStack(a,!0),this.focusCamera(a,!1))};f.prototype.focusCamera=function(a,b){function c(){if(void 0!==x._animating){x._animating?requestAnimationFrame(c):x._geom_viewer||x.startDrawGeometry();var a=-Math.cos(2*Math.PI*u/q)+1;x._camera.position.add(r.clone().multiplyScalar(a));
p.add(v.clone().multiplyScalar(a));x._lookat=p;x._camera.lookAt(x._lookat);x._camera.updateProjectionMatrix();var d=(new Date).getTime();if(b){for(var e=0;3>e;++e)x.ctrl.clip[e].value+=x.ctrl.clip[e].inc*a;x.updateClipping()}else x.Render3D(0);a=(new Date).getTime();0==u&&200<a-d&&(q=20);u++;x._animating=u<q}}if(this.ctrl.project||this.ctrl.ortho_camera)return this.adjustCameraPosition();var d=new h.Box3;if(void 0===a)d=this.getGeomBoundingBox(this._toplevel);else if(a instanceof h.Mesh)d.setFromObject(a);
else{var e=(new h.Vector3).setFromMatrixPosition(a.matrix);a=a.node;a=(new h.Vector3(a.fDX,a.fDY,a.fDZ)).multiplyScalar(.5);d.min=e.clone().sub(a);d.max=e.clone().add(a)}var g=d.max.x-d.min.x,f=d.max.y-d.min.y,k=d.max.z-d.min.z;e=(d.max.x+d.min.x)/2;a=(d.max.y+d.min.y)/2;d=(d.max.z+d.min.z)/2;g=this.ctrl._yup?new h.Vector3(e-2*Math.max(g,k),a+2*f,d-2*Math.max(g,k)):new h.Vector3(e-2*Math.max(g,f),a-2*Math.max(g,f),d+2*k);d=new h.Vector3(e,a,d);this._camera.position.distanceTo(d);var p=this._controls.target,
q=50,u=0,r=g.sub(this._camera.position).divideScalar(q),v=d.sub(p).divideScalar(q);if(b=b&&this._webgl){for(d=0;3>d;++d)e=this.ctrl.clip[d],e.enabled||(e.value=e.min,e.enabled=!0),e.inc=((e.min+e.max)/2-e.value)/q;this.updateClipping()}var x=this;this._animating=!0;c()};f.prototype.autorotate=function(a){function b(){if(d._renderer&&d.ctrl){var a=new Date;d.ctrl.rotate&&requestAnimationFrame(b);d._controls&&(d._controls.autoRotate=d.ctrl.rotate,d._controls.autoRotateSpeed=c*(a.getTime()-e.getTime())/
16.6666,d._controls.update());e=new Date;d.Render3D(0)}}var c=void 0===a?2:a,d=this,e=new Date;this._webgl&&b()};f.prototype.completeScene=function(){if(this.ctrl._debug||this.ctrl._grid){if(this.ctrl._full){var a=new h.BoxHelper(this._toplevel);this._scene.add(a)}this._scene.add(new h.AxesHelper(2*this._overall_size));this._scene.add(new h.GridHelper(Math.ceil(this._overall_size),Math.ceil(this._overall_size)/50));this.helpText("<font face='verdana' size='1' color='red'><center>Transform Controls<br>'T' translate | 'R' rotate | 'S' scale<br>'+' increase size | '-' decrease size<br>'W' toggle wireframe/solid display<br>keep 'Ctrl' down to snap to grid</center></font>")}};
f.prototype.drawCount=function(a,b){a="Unique nodes: "+this._clones.nodes.length+"<br/>Unique visible: "+a+"<br/>Time to clone: "+b+"ms <br/>";this._clones.ScanVisible();var c=this,d=0,l={cnt:[],func:function(a){void 0===this.cnt[this.last]?this.cnt[this.last]=1:this.cnt[this.last]++;d+=e.GEO.CountNumShapes(c._clones.GetNodeShape(a.id));return!0}},g=(new Date).getTime(),f=this._clones.ScanVisible(l),h=(new Date).getTime();a=a+("Total visible nodes: "+f+"<br/>Total shapes: ")+(d+"<br/>");for(b=0;b<
l.cnt.length;++b)void 0!==l.cnt[b]&&(a+="  lvl"+b+": "+l.cnt[b]+"<br/>");a+="Time to scan: "+(h-g)+"ms <br/><br/><br/>Check timing for matrix calculations ...<br/>";var p=this.select_main().style("overflow","auto").html(a);setTimeout(function(){l.domatrix=!0;g=(new Date).getTime();f=c._clones.ScanVisible(l);h=(new Date).getTime();p.append("p").text("Time to scan with matrix: "+(h-g)+"ms");c.DrawingReady()},100);return this};f.prototype.PerformDrop=function(a,b,c,d,l){if(a&&"TTree"===a.$kind){b="extract_geo_tracks";
d&&0<d.indexOf("$")&&(b=d.substr(0,d.indexOf("$")),d=d.substr(d.indexOf("$")+1));b=e.findFunction(b);if(!b)return e.CallBack(l);var g=this;return b(a,d,function(a){a&&(g.drawExtras(a,"",!1),g.updateClipping(!0),g.Render3D(100));e.CallBack(l)})}this.drawExtras(a,b)&&c&&(c._painter=this);e.CallBack(l)};f.prototype.MouseOverHierarchy=function(a,b,c){this.ctrl&&(c=c._obj,this.ctrl._debug&&console.log("Mouse over",a,b,c?c._typename:"---"),!c||"TEveTrack"!==c._typename&&"TEvePointSet"!==c._typename&&"TPolyMarker3D"!==
c._typename||this.HighlightMesh(null,65280,a?c:null))};f.prototype.clearExtras=function(){this.getExtrasContainer("delete");delete this._extraObjects;this.Render3D()};f.prototype.addExtra=function(a,b){void 0===this._extraObjects&&(this._extraObjects=e.Create("TList"));if(0<=this._extraObjects.arr.indexOf(a))return!1;this._extraObjects.Add(a,b);delete a.$hidden_via_menu;return!0};f.prototype.ExtraObjectVisible=function(a,b,c){if(this._extraObjects){a=a.itemFullName(b);var d=this._extraObjects.opt.indexOf(a);
0>d&&b._obj&&(d=this._extraObjects.arr.indexOf(b._obj),0<=d&&(this._extraObjects.opt[d]=a));if(!(0>d)){var e=this._extraObjects.arr[d];b=e.$hidden_via_menu?!1:!0;if(c){e.$hidden_via_menu=b;b=!b;var g=null;this._toplevel.traverse(function(a){a.geo_object===e&&(g=a)});g?g.visible=b:b&&(this.drawExtras(e,"",!1),this.updateClipping(!0));(g||b)&&this.Render3D()}return b}}};f.prototype.drawExtras=function(a,b,c){if(!a||!a._typename||!c&&a.$hidden_via_menu)return!1;var d=!1,e=!1;void 0===c&&(e=c=!0);if("TList"===
a._typename||"TObjArray"===a._typename){if(!a.arr)return!1;for(var g=0;g<a.arr.length;++g){var f=a.arr[g],h=a.opt?a.opt[g]:"";h||(h=(b||"<prnt>")+"/["+g+"]");this.drawExtras(f,h,c)&&(d=!0)}}else if("THREE.Mesh"===a._typename)this.getExtrasContainer().add(a),d=!0;else if("TGeoTrack"===a._typename){if(c&&!this.addExtra(a,b))return!1;d=this.drawGeoTrack(a,b)}else if("TEveTrack"===a._typename||"ROOT::Experimental::TEveTrack"===a._typename){if(c&&!this.addExtra(a,b))return!1;d=this.drawEveTrack(a,b)}else if("TEvePointSet"===
a._typename||"ROOT::Experimental::TEvePointSet"===a._typename||"TPolyMarker3D"===a._typename){if(c&&!this.addExtra(a,b))return!1;d=this.drawHit(a,b)}else if("TEveGeoShapeExtract"===a._typename||"ROOT::Experimental::REveGeoShapeExtract"===a._typename){if(c&&!this.addExtra(a,b))return!1;d=this.drawExtraShape(a,b)}d&&e&&(this.updateClipping(!0),this.Render3D(100));return d};f.prototype.getExtrasContainer=function(a,b){if(!this._toplevel)return null;b||(b="tracks");for(var c=null,d=[],l=0;l<this._toplevel.children.length;++l){var g=
this._toplevel.children[l];if(g._extras)if("collect"===a)d.push(g);else if(g._extras===b){c=g;break}}if("collect"===a){for(a=0;a<d.length;++a)this._toplevel.remove(d[a]);return d}if("delete"===a)return c&&this._toplevel.remove(c),e.Painter.DisposeThreejsObject(c),null;"get"===a||c||(c=new h.Object3D,c._extras=b,this._toplevel.add(c));return c};f.prototype.drawGeoTrack=function(a,b){if(!a||!a.fNpoints)return!1;var c=a.fLineWidth||1,d=e.Painter.root_colors[a.fLineColor]||"rgb(255,0,255)";e.browser.isWin&&
(c=1);for(var l=Math.round(a.fNpoints/4),g=new Float32Array(6*(l-1)),f=0,k=this.ctrl.projectPos,p="x"===this.ctrl.project,q="y"===this.ctrl.project,u="z"===this.ctrl.project,r=0;r<l-1;++r)g[f]=p?k:a.fPoints[4*r],g[f+1]=q?k:a.fPoints[4*r+1],g[f+2]=u?k:a.fPoints[4*r+2],g[f+3]=p?k:a.fPoints[4*r+4],g[f+4]=q?k:a.fPoints[4*r+5],g[f+5]=u?k:a.fPoints[4*r+6],f+=6;c=new h.LineBasicMaterial({color:d,linewidth:c});g=e.Painter.createLineSegments(g,c);g.renderOrder=1E6;g.geo_name=b;g.geo_object=a;g.hightlightWidthScale=
2;b&&0==b.indexOf("<prnt>/Tracks")&&(g.main_track=!0);this.getExtrasContainer().add(g);return!0};f.prototype.drawEveTrack=function(a,b){if(!a||0>=a.fN)return!1;var c=a.fLineWidth||1,d=e.Painter.root_colors[a.fLineColor]||"rgb(255,0,255)";e.browser.isWin&&(c=1);for(var l=new Float32Array(6*(a.fN-1)),g=0,f=this.ctrl.projectPos,k="x"===this.ctrl.project,p="y"===this.ctrl.project,q="z"===this.ctrl.project,u=0;u<a.fN-1;++u)l[g]=k?f:a.fP[3*u],l[g+1]=p?f:a.fP[3*u+1],l[g+2]=q?f:a.fP[3*u+2],l[g+3]=k?f:a.fP[3*
u+3],l[g+4]=p?f:a.fP[3*u+4],l[g+5]=q?f:a.fP[3*u+5],g+=6;c=new h.LineBasicMaterial({color:d,linewidth:c});l=e.Painter.createLineSegments(l,c);l.renderOrder=1E6;l.geo_name=b;l.geo_object=a;l.hightlightWidthScale=2;this.getExtrasContainer().add(l);return!0};f.prototype.drawHit=function(a,b){if(!a||!a.fN||0>a.fN)return!1;var c=a.fMarkerSize*this.getOverallSize()*.005;0>=c&&(c=1);var d=a.fN,f=this.ctrl.projectPos,g="x"===this.ctrl.project,h="y"===this.ctrl.project,k="z"===this.ctrl.project;c=new e.Painter.PointsCreator(d,
this._webgl,c);for(var p=0;p<d;p++)c.AddPoint(g?f:a.fP[3*p],h?f:a.fP[3*p+1],k?f:a.fP[3*p+2]);d=c.CreatePoints({color:e.Painter.root_colors[a.fMarkerColor]||"rgb(0,0,255)",style:a.fMarkerStyle,callback:function(a){a&&this.Render3D(100)}.bind(this)});d.renderOrder=1E6;d.highlightScale=2;d.geo_name=b;d.geo_object=a;this.getExtrasContainer().add(d);return!0};f.prototype.drawExtraShape=function(a,b){var c=e.GEO.build(a);if(!c)return!1;c.geo_name=b;c.geo_object=a;this.getExtrasContainer().add(c);return!0};
f.prototype.FindNodeWithVolume=function(a,b,c,d,f){var g=!1,l=null;if(c)0<d.length&&(d+="/"),d+=c.fName;else{c=this.GetGeometry();if(!c&&0!==e.GEO.NodeKind(c))return null;d=this.geo_manager?c.fName:"";g=!0;f=[]}if(!c.fVolume||c.fVolume._searched)return null;if(a.test(c.fVolume.fName)&&(l=b({node:c,item:d})))return l;c.fVolume._searched=!0;f.push(c.fVolume);if(c.fVolume.fNodes)for(var h=0;h<c.fVolume.fNodes.arr.length&&!(l=this.FindNodeWithVolume(a,b,c.fVolume.fNodes.arr[h],d,f));++h);if(g)for(h=0,
a=f.length;h<a;++h)delete f[h]._searched;return l};f.prototype.checkScript=function(a,b){var c=this,d=this.GetGeometry(),f="";this.geo_manager&&(f=d.fName);if(!a||3>a.length||0!==e.GEO.NodeKind(d))return e.CallBack(b,d,f);var g={GetVolume:function(a){var b=c.FindNodeWithVolume(new RegExp("^"+a+"$"),function(a){return a});b||console.log("Did not found "+a+" volume");return{found:b,fVolume:b?b.node.fVolume:null,InvisibleAll:function(a){e.GEO.InvisibleAll.call(this.fVolume,a)},Draw:function(){this.found&&
this.fVolume&&(d=this.found.node,f=this.found.item,console.log("Select volume for drawing",this.fVolume.fName,f))},SetTransparency:function(a){this.fVolume&&this.fVolume.fMedium&&this.fVolume.fMedium.fMaterial&&(this.fVolume.fMedium.fMaterial.fFillStyle=3E3+a)},SetLineColor:function(a){this.fVolume&&(this.fVolume.fLineColor=a)}}},DefaultColors:function(){c.ctrl.dflt_colors=!0},SetMaxVisNodes:function(a){c.ctrl.maxnodes||(c.ctrl.maxnodes=pasrseInt(a)||0)},SetVisLevel:function(a){c.ctrl.vislevel||(c.ctrl.vislevel=
parseInt(a)||0)}};e.progress("Loading macro "+a);e.NewHttpRequest(a,"text",function(a){function c(a){for(var h=(new Date).getTime();a<l.length;){var k=l[a++].trim();if(!(0==k.indexOf("//")||0>k.indexOf("gGeoManager")||(k=k.replace("->GetVolume",".GetVolume"),k=k.replace("->InvisibleAll",".InvisibleAll"),k=k.replace("->SetMaxVisNodes",".SetMaxVisNodes"),k=k.replace("->DefaultColors",".DefaultColors"),k=k.replace("->Draw",".Draw"),k=k.replace("->SetTransparency",".SetTransparency"),k=k.replace("->SetLineColor",
".SetLineColor"),k=k.replace("->SetVisLevel",".SetVisLevel"),0<=k.indexOf("->")))){try{(new Function("gGeoManager",k))(g)}catch(E){console.error("Problem by processing "+k)}if(300<(new Date).getTime()-h)return e.progress("exec "+k),setTimeout(c.bind(this,a),1)}}e.CallBack(b,d,f)}if(!a||0==a.length)return e.CallBack(b,d,f);var l=a.split("\n");c(0)}).send()};f.prototype.assignClones=function(a){this._clones_owner=!0;this._clones=a};f.prototype.prepareObjectDraw=function(a,b){if(!this.did_cleanup){if("__geom_viewer_append__"==
b)this._new_append_nodes=a,this.ctrl.use_worker=0,this._geom_viewer=!0;else if("__geom_viewer_selection__"==b&&this._clones)this._new_draw_nodes=a,this.ctrl.use_worker=0,this._geom_viewer=!0;else if(this._main_painter)this._clones_owner=!1,this._clones=this._main_painter._clones,console.log("Reuse clones",this._clones.nodes.length,"from main painter");else if(a){this._start_drawing_time=(new Date).getTime();this._clones_owner=!0;this._clones=new e.GEO.ClonedNodes(a);a=this.ctrl.vislevel;var c=this.ctrl.maxnodes;
this.geo_manager&&(!a&&this.geo_manager.fVisLevel&&(a=this.geo_manager.fVisLevel),c||(c=this.geo_manager.fMaxVisNodes));this._clones.SetVisLevel(a);this._clones.SetMaxVisNodes(c);this._clones.name_prefix=b;a=!!this.geo_manager&&!this.ctrl.showtop;b=this.ctrl.no_screen?0:this._clones.MarkVisibles(!0,!1,a);b=0>=b?this._clones.MarkVisibles(!1,!1,a):this._clones.MarkVisibles(!0,!0,a);this._clones.ProduceIdShits();a=(new Date).getTime()-this._start_drawing_time;this._scene||console.log("Creating clones",
this._clones.nodes.length,"takes",a,"uniquevis",b);if(this.options._count)return this.drawCount(b,a)}else this._clones_owner=!1,this._clones=null;this._scene||(this.ctrl.maxlimit=(this._webgl?2E5:1E5)*this.ctrl.more,this._first_drawing=!0,0<this.ctrl.use_worker&&this.startWorker(),b=this.size_for_3d(this._usesvg?3:void 0),this._fit_main_area=-1===b.can3d,a=this.createScene(b.width,b.height),this.add_3d_canvas(b,a),this.AccessTopPainter(!0));this.CreateToolbar();this._clones?(this.showDrawInfo("Drawing geometry"),
this.startDrawGeometry(!0)):this.completeDraw()}};f.prototype.showDrawInfo=function(a){if(this._first_drawing&&this._start_drawing_time){var b=this._renderer.domElement.parentNode,c=v.select(b).select(".geo_info");if(a){var d=.001*((new Date).getTime()-this._start_drawing_time);c.empty()&&(c=v.select(b).append("p").attr("class","geo_info"));c.html(a+", "+d.toFixed(1)+"s")}else c.remove()}};f.prototype.continueDraw=function(){if(0!==this.drawing_stage){for(var a=(new Date).getTime(),b=this._first_drawing?
1E3:200,c=a;;){var d=this.nextDrawAction();if(!d)break;c=(new Date).getTime();if(1E5<c-this._startm){this.drawing_stage=0;break}if(!(!0===d&&c-a<b)&&(c-a>b||1===d||2===d)){e.progress(this.drawing_log);this.showDrawInfo(this.drawing_log);this._first_drawing&&this._webgl&&100<this._num_meshes-this._last_render_meshes&&c-this._last_render_tm>2.5*b&&(this.adjustCameraPosition(),this.Render3D(-1),this._last_render_meshes=this.ctrl.info.num_meshes);2!==d&&setTimeout(this.continueDraw.bind(this),1===d?100:
1);return}}a=c-this._startm;this._first_drawing&&e.console("Create tm = "+a+" meshes "+this.ctrl.info.num_meshes+" faces "+this.ctrl.info.num_faces);if(300<a)return e.progress("Rendering geometry"),this.showDrawInfo("Rendering"),setTimeout(this.completeDraw.bind(this,!0),10);this.completeDraw(!0)}};f.prototype.TestCameraPosition=function(a){this._camera.updateMatrixWorld();var b=this._camera.position.clone();!a&&this._last_camera_position&&this._last_camera_position.distanceTo(b)<1E-4*(this._overall_size||
1E3)||(this._last_camera_position=b,!this.ctrl.project&&this._webgl&&e.GEO.produceRenderOrder(this._toplevel,b,this.ctrl.depthMethod,this._clones))};f.prototype.Render3D=function(a,b){if(this._renderer){void 0===a&&(a=5);if(0>=a||this._usesvg){if("render_tmout"in this)clearTimeout(this.render_tmout);else if(-2222===a)return;var c=new Date;this.TestCameraPosition(-1===a);this._webgl&&this._effectComposer&&0<this._effectComposer.passes.length?this._effectComposer.render():this._renderer.render(this._scene,
this._camera);a=new Date;this.last_render_tm=a.getTime();delete this.render_tmout;0===this.first_render_tm&&b&&(this.first_render_tm=a.getTime()-c.getTime(),e.console("First render tm = "+this.first_render_tm));return e.Painter.AfterRender3D(this._renderer)}this.render_tmout||(this.render_tmout=setTimeout(this.Render3D.bind(this,0,b),a))}else console.warn("renderer object not exists - check code")};f.prototype.startWorker=function(){if(!this._worker){this._worker_ready=!1;this._worker_jobs=0;var a=
this;this._worker=new Worker(e.source_dir+"scripts/JSRootGeoWorker.js");this._worker.onmessage=function(b){if("object"===typeof b.data){if("log"in b.data)return e.console("geo: "+b.data.log);if("progress"in b.data)return e.progress(b.data.progress);b.data.tm3=(new Date).getTime();if("init"in b.data)return a._worker_ready=!0,e.console("Worker ready: "+(b.data.tm3-b.data.tm0));a.processWorkerReply(b.data)}};this._worker.postMessage({init:!0,browser:e.browser,tm0:(new Date).getTime(),vislevel:this._clones.GetVisLevel(),
maxvisnodes:this._clones.GetMaxVisNodes(),clones:this._clones.nodes,sortmap:this._clones.sortmap})}};f.prototype.canSubmitToWorker=function(a){return this._worker?this._worker_ready&&(0==this._worker_jobs||a):!1};f.prototype.submitToWorker=function(a){if(!this._worker)return!1;this._worker_jobs++;a.tm0=(new Date).getTime();this._worker.postMessage(a)};f.prototype.processWorkerReply=function(a){this._worker_jobs--;if("collect"in a)return this._new_draw_nodes=a.new_nodes,this._draw_all_nodes=a.complete,
this.drawing_stage=3,this.continueDraw();if("shapes"in a){for(var b=0;b<a.shapes.length;++b){var c=a.shapes[b],d=this._build_shapes[b];c.buf_pos&&c.buf_norm&&(0===c.buf_pos.length?d.geom=null:c.buf_pos.length!==c.buf_norm.length?(console.error("item.buf_pos",c.buf_pos.length,"item.buf_norm",c.buf_norm.length),d.geom=null):(d.geom=new h.BufferGeometry,d.geom.addAttribute("position",new h.BufferAttribute(c.buf_pos,3)),d.geom.addAttribute("normal",new h.BufferAttribute(c.buf_norm,3))),d.ready=!0,d.nfaces=
c.nfaces)}a.tm4=(new Date).getTime();this.drawing_stage=7;return this.continueDraw()}};f.prototype.testGeomChanges=function(){if(this._main_painter)return console.warn("Get testGeomChanges call for slave painter"),this._main_painter.testGeomChanges();this.startDrawGeometry();for(var a=0;a<this._slave_painters.length;++a)this._slave_painters[a].startDrawGeometry()};f.prototype.drawSimpleAxis=function(a){this.getExtrasContainer("delete","axis");if(!this.ctrl._axis)return a?null:this.Render3D();var b=
this.getGeomBoundingBox(this._toplevel),c=this.getExtrasContainer("create","axis"),d=.02*Math.max(b.max.x-b.min.x,b.max.y-b.min.y,b.max.z-b.min.z),f=[0,0,0],g=["x","y","z"],n=["X","Y","Z"],k=["red","green","blue"],p=this.ctrl.ortho_camera,q=[this.ctrl._yup,this.ctrl._yup,this.ctrl._yup],u=3;if(2==this.ctrl._axis)for(var r=0;3>r;++r){var v=g[r];0>=b.min[v]&&0<=b.max[v]||(f[r]=(b.min[v]+b.max[v])/2)}this.ctrl.ortho_camera&&(u=2,n[0]=n[2],k[0]=k[2],q[0]=q[2],p=!0);for(r=0;r<u;++r){var x=function(a){return 2>
b.max[v]-b.min[v]?a.toFixed(3):1E5<Math.abs(a)?a.toExponential(3):Math.round(a).toString()},w=new Float32Array(6),y=k[r];v=g[r];var t=x(b.max[v]);w[0]=b.min.x;w[1]=b.min.y;w[2]=b.min.z;w[3]=b.min.x;w[4]=b.min.y;w[5]=b.min.z;switch(r){case 0:w[3]=b.max.x;t=q[0]&&!p?n[0]+" "+t:t+(" "+n[0]);break;case 1:w[4]=b.max.y;t=q[1]?t+(" "+n[1]):n[1]+" "+t;break;case 2:w[5]=b.max.z,t+=" "+n[2]}if(2==this.ctrl._axis)for(var m=0;6>m;++m)m%3!==r&&(w[m]=f[m%3]);m=new h.LineBasicMaterial({color:y});m=e.Painter.createLineSegments(w,
m);c.add(m);y=new h.MeshBasicMaterial({color:y});0===f[r]&&f[r]>=b.min[v]&&f[r]<=b.max[v]&&(2!=this.ctrl._axis||0===r)&&(m=p?new h.CircleBufferGeometry(.25*d):new h.SphereBufferGeometry(.25*d),m=new h.Mesh(m,y),m.translateX(0===r?f[0]:w[0]),m.translateY(1===r?f[1]:w[1]),m.translateZ(2===r?f[2]:w[2]),c.add(m));t=new h.TextGeometry(t,{font:e.threejs_font_helvetiker_regular,size:d,height:0,curveSegments:5});m=new h.Mesh(t,y);t=(new h.Box3).setFromObject(m);m.translateX(w[3]);m.translateY(w[4]);m.translateZ(w[5]);
if(q[r])switch(r){case 0:p?m.translateX(.5*d):(m.rotateY(Math.PI),m.translateX(-t.max.x-.5*d));m.translateY(-t.max.y/2);break;case 1:p?m.rotateZ(Math.PI/2):(m.rotateX(-Math.PI/2),m.rotateY(-Math.PI/2));m.translateX(.5*d);m.translateY(-t.max.y/2);break;case 2:m.rotateY(-Math.PI/2),m.translateX(.5*d),m.translateY(-t.max.y/2)}else switch(r){case 0:m.rotateX(Math.PI/2);m.translateY(-t.max.y/2);m.translateX(.5*d);break;case 1:m.rotateX(Math.PI/2);m.rotateY(-Math.PI/2);m.translateX(-t.max.x-.5*d);m.translateY(-t.max.y/
2);break;case 2:m.rotateX(Math.PI/2),m.rotateZ(Math.PI/2),m.translateX(.5*d),m.translateY(-t.max.y/2)}c.add(m);t=new h.TextGeometry(x(b.min[v]),{font:e.threejs_font_helvetiker_regular,size:d,height:0,curveSegments:5});m=new h.Mesh(t,y);t=(new h.Box3).setFromObject(m);m.translateX(w[0]);m.translateY(w[1]);m.translateZ(w[2]);if(q[r])switch(r){case 0:p?m.translateX(-t.max.x-.5*d):(m.rotateY(Math.PI),m.translateX(.5*d));m.translateY(-t.max.y/2);break;case 1:p?m.rotateZ(Math.PI/2):(m.rotateX(-Math.PI/
2),m.rotateY(-Math.PI/2));m.translateY(-t.max.y/2);m.translateX(-t.max.x-.5*d);break;case 2:m.rotateY(-Math.PI/2),m.translateX(-t.max.x-.5*d),m.translateY(-t.max.y/2)}else switch(r){case 0:m.rotateX(Math.PI/2);m.translateX(-t.max.x-.5*d);m.translateY(-t.max.y/2);break;case 1:m.rotateX(Math.PI/2);m.rotateY(-Math.PI/2);m.translateY(-t.max.y/2);m.translateX(.5*d);break;case 2:m.rotateX(Math.PI/2),m.rotateZ(Math.PI/2),m.translateX(-t.max.x-.5*d),m.translateY(-t.max.y/2)}c.add(m)}this.changedDepthMethod(a?
"norender":void 0)};f.prototype.toggleAxesDraw=function(){this.setAxesDraw("toggle")};f.prototype.setAxesDraw=function(a){this.ctrl._axis="toggle"===a?this.ctrl._axis?0:1:"number"==typeof a?a:a?1:0;this.drawSimpleAxis()};f.prototype.setAutoRotate=function(a){this.ctrl.project||(void 0!==a&&(this.ctrl.rotate=a),this.autorotate(2.5))};f.prototype.toggleWireFrame=function(){this.ctrl.wireframe=!this.ctrl.wireframe;this.changedWireFrame()};f.prototype.setWireFrame=function(a){this.ctrl.wireframe=a?!0:
!1;this.changedWireFrame()};f.prototype.setShowTop=function(a){this.ctrl.showtop=a?!0:!1;this.RedrawObject("same")};f.prototype.changedClipping=function(a){var b=this.ctrl.clip;if(!(void 0!==a&&0<=a)||b[a].enabled){if(b[0].enabled||b[1].enabled||b[2].enabled)this.ctrl.ssao.enabled=!1,this.removeSSAO();this.updateClipping(!1,!0)}};f.prototype.changedDepthTest=function(){if(this._toplevel){var a=this.ctrl.depthTest;this._toplevel.traverse(function(b){b instanceof h.Mesh&&(b.material.depthTest=a)});
this.Render3D(0)}};f.prototype.changedDepthMethod=function(a){delete this._last_camera_position;"norender"!==a&&this.Render3D()};f.prototype.changedHighlight=function(){this.ctrl.highlight||this.HighlightMesh(null)};f.prototype.updateClipping=function(a,b){if(this._webgl){for(var c=this.ctrl.clip,d=[],e=!1,f=[c[0].value,-1*c[1].value,(this.ctrl._yup?-1:1)*c[2].value],n=this.ctrl.clipIntersect?16:0,k=0;3>k;++k)c[k].enabled&&(n+=2<<k),this._clipPlanes[k].constant!=f[k]&&(e=!0,this._clipPlanes[k].constant=
f[k]);this.ctrl.ssao.enabled||(c[0].enabled&&d.push(this._clipPlanes[0]),c[1].enabled&&d.push(this._clipPlanes[1]),c[2].enabled&&d.push(this._clipPlanes[2]),n+=1E3*d.length);0==d.length&&(d=null);this._clipCfg!==n&&(e=!0);this._clipCfg=n;c=!!d;var p=this.ctrl.clipIntersect,q=c?h.DoubleSide:h.FrontSide;(b||e)&&this._scene.traverse(function(a){a.hasOwnProperty("material")&&a.material&&void 0!==a.material.clippingPlanes&&(a.material.clippingPlanes!==d&&(a.material.clipIntersection=p,a.material.clippingPlanes=
d,a.material.needsUpdate=!0),void 0!==a.material.emissive&&a.material.side!=q&&(a.material.side=q,a.material.needsUpdate=!0))});this.ctrl.bothSides=c;a||this.Render3D(0);return e}};f.prototype.setCompleteHandler=function(a){this._complete_handler=a};f.prototype.completeDraw=function(a){var b=!1,c=!1,d=!0;if(this.ctrl){if(this._clones)(this._first_drawing||this._full_redrawing)&&this.ctrl.tracks&&this.geo_manager&&this.drawExtras(this.geo_manager.fTracks,"<prnt>/Tracks");else{d=!1;this.getExtrasContainer("delete");
var f=(this._main_painter?this._main_painter._extraObjects:null)||this._extraObjects;this.drawExtras(f,"",!1)}this._full_redrawing&&(this._full_redrawing=!1,c=!0,this.changedDepthMethod("norender"));this._first_drawing&&(this.adjustCameraPosition(!0),this.showDrawInfo(),this._first_drawing=!1,c=b=!0);0!==this.ctrl.transparency&&this.changedGlobalTransparency(this.ctrl.transparency,!0);b&&this.completeScene();c&&(this.ctrl.trans_radial||this.ctrl.trans_z)&&this.changedTransformation("norender");c&&
this.ctrl._axis&&this.drawSimpleAxis(!0);this._scene.overrideMaterial=null;void 0!==this._provided_more_nodes&&(this.appendMoreNodes(this._provided_more_nodes,!0),delete this._provided_more_nodes);d&&(this.getExtrasContainer("delete"),f=(this._main_painter?this._main_painter._extraObjects:null)||this._extraObjects,this.drawExtras(f,"",!1));this.updateClipping(!0);this.Render3D(0,!0);a&&e.progress();this.addOrbitControls();this.addTransformControl();b&&(!1===this.ctrl.highlight&&(this.ctrl.highlight=
1E3>this.first_render_tm),!1===this.ctrl.highlight_scene&&(this.ctrl.highlight_scene=this.ctrl.highlight),this._webgl&&this.ctrl.rotate&&!this.ctrl.project&&this.autorotate(2.5),this._usesvg||!this.ctrl.show_controls||e.BatchMode||this.showControlOptions(!0));this.DrawingReady();"function"==typeof this._complete_handler&&this._complete_handler(this);if(this._draw_nodes_again)return this.startDrawGeometry();this._drawing_ready=!0}else console.warn("ctrl object does not exist in completeDraw - something went wrong")};
f.prototype.isDrawingReady=function(){return this._drawing_ready||!1};f.prototype.RemoveDrawnNode=function(a){if(this._draw_nodes){for(var b=[],c=0;c<this._draw_nodes.length;++c){var d=this._draw_nodes[c];d.nodeid===a||this._clones.IsNodeInStack(a,d.stack)?this._clones.CreateObject3D(d.stack,this._toplevel,"delete_mesh"):b.push(d)}b.length<this._draw_nodes.length&&(this._draw_nodes=b,this.Render3D())}};f.prototype.Cleanup=function(a){if(!a){this.removeSSAO();this.AccessTopPainter(!1);a=this.clear_3d_canvas();
this._toolbar&&this._toolbar.Cleanup();this.helpText();e.Painter.DisposeThreejsObject(this._scene);e.Painter.DisposeThreejsObject(this._full_geom);this._tcontrols&&this._tcontrols.dispose();this._controls&&this._controls.Cleanup();this._context_menu&&this._renderer.domElement.removeEventListener("contextmenu",this._context_menu,!1);this._datgui&&this._datgui.destroy();this._worker&&this._worker.terminate();delete this._animating;var b=this.GetGeometry();b&&this.ctrl.is_main&&(b.$geo_painter===this?
delete b.$geo_painter:b.fVolume&&b.fVolume.$geo_painter===this&&delete b.fVolume.$geo_painter);this._main_painter&&(b=this._main_painter._slave_painters.indexOf(this),0<=b&&this._main_painter._slave_painters.splice(b,1));for(b=0;b<this._slave_painters.length;++b){var c=this._slave_painters[b];c&&c._main_painter===this&&(c._main_painter=null)}delete this.geo_manager;delete this._highlight_handlers;e.TObjectPainter.prototype.Cleanup.call(this);delete this.ctrl;delete this.options;this.did_cleanup=!0;
0>a&&this.select_main().html("")}if(this._slave_painters)for(b in this._slave_painters)c=this._slave_painters[b],c._main_painter=null,c._clones===this._clones&&(c._clones=null);this._main_painter=null;this._slave_painters=[];this._renderer&&(this._renderer.dispose&&this._renderer.dispose(),this._renderer.context&&delete this._renderer.context);delete this._scene;this._scene_height=this._scene_width=0;this._toplevel=this._renderer=null;delete this._full_geom;delete this._camera;delete this._camera0pos;
delete this._lookat;delete this._selected_mesh;this._clones&&this._clones_owner&&this._clones.Cleanup(this._draw_nodes,this._build_shapes);delete this._clones;delete this._clones_owner;delete this._draw_nodes;delete this._drawing_ready;delete this._build_shapes;delete this._new_draw_nodes;delete this._new_append_nodes;delete this._last_camera_position;this.drawing_stage=this.last_render_tm=this.first_render_tm=0;delete this.drawing_log;delete this._datgui;delete this._controls;delete this._context_menu;
delete this._tcontrols;delete this._toolbar;delete this._worker};f.prototype.helpText=function(a){e.progress(a)};f.prototype.CheckResize=function(a){var b=this.canv_painter();if(b&&!b.CheckCanvasResize(a))return!1;a=this.size_for_3d();if(this._scene_width===a.width&&this._scene_height===a.height||10>a.width||10>a.height)return!1;this._scene_width=a.width;this._scene_height=a.height;this._camera&&this._renderer&&("PerspectiveCamera"==this._camera.type&&(this._camera.aspect=this._scene_width/this._scene_height),
this._camera.updateProjectionMatrix(),this._renderer.setSize(this._scene_width,this._scene_height,!this._fit_main_area),this._effectComposer&&this._effectComposer.setSize(this._scene_width,this._scene_height),this.drawing_stage||this.Render3D());return!0};f.prototype.toggleEnlarge=function(){v.event&&(v.event.preventDefault(),v.event.stopPropagation());this.enlarge_main("toggle")&&this.CheckResize()};f.prototype.ownedByTransformControls=function(a){for(a=a.parent;a&&!(a instanceof h.TransformControls);)a=
a.parent;return a&&a instanceof h.TransformControls};f.prototype.accessObjectWireFrame=function(a,b){if(a.hasOwnProperty("material")&&!(a instanceof h.GridHelper)&&!this.ownedByTransformControls(a))return void 0!==b&&a.stack&&(a.material.wireframe=b),a.material.wireframe};f.prototype.changedWireFrame=function(){if(this._scene){var a=this,b=this.ctrl.wireframe;this._scene.traverse(function(c){a.accessObjectWireFrame(c,b)});this.Render3D()}};f.prototype.UpdateObject=function(a){if("same"===a)return!0;
if(!a||!a._typename)return!1;if(a===this.GetObject())return!0;if(this.geo_manager&&"TGeoManager"==a._typename)return this.geo_manager=a,this.AssignObject({_typename:"TGeoNode",fVolume:a.fMasterVolume,fName:a.fMasterVolume.fName,$geoh:a.fMasterVolume.$geoh,_proxy:!0}),!0;if(!this.MatchObjectType(a._typename))return!1;this.AssignObject(a);return!0};f.prototype.ClearDrawings=function(){this._clones&&this._clones_owner&&this._clones.Cleanup(this._draw_nodes,this._build_shapes);delete this._clones;delete this._clones_owner;
delete this._draw_nodes;delete this._drawing_ready;delete this._build_shapes;delete this._extraObjects;delete this._clipCfg;e.Painter.DisposeThreejsObject(this._toplevel,!0);this._full_redrawing=!0};f.prototype.RedrawObject=function(a){if(!this.UpdateObject(a))return!1;this.ClearDrawings();a=this.GetGeometry();var b="";this.geo_manager&&(b=a.fName);this.prepareObjectDraw(a,b);return!0};e.Painter.CreateGeoPainter=function(a,b,c){e.GEO.GradPerSegm=e.gStyle.GeoGradPerSegm;e.GEO.CompressComp=e.gStyle.GeoCompressComp;
b=new f(b);b.SetDivId(a,5);b._usesvg=e.Painter.UseSVGFor3D();b._usesvgimg=!b._usesvg&&e.BatchMode;b._webgl=!b._usesvg&&e.Painter.TestWebGL();b.options=b.decodeOptions(c);e.extend(b.ctrl,b.options);b.ctrl.ssao.enabled=b.options.usessao;b.ctrl.clip[0].enabled=b.options.clipx;b.ctrl.clip[1].enabled=b.options.clipy;b.ctrl.clip[2].enabled=b.options.clipz;return b};e.Painter.drawGeoObject=function(a,b,c){if(!b)return null;var d=null,f=null,g="",h=!1;"fShapeBits"in b&&"fShapeId"in b?(d=b,b=null):"TGeoVolumeAssembly"===
b._typename||"TGeoVolume"===b._typename?d=b.fShape:"TEveGeoShapeExtract"===b._typename||"ROOT::Experimental::REveGeoShapeExtract"===b._typename?(d=b.fShape,h=!0):"TGeoManager"===b._typename?d=b.fMasterVolume.fShape:"TGeoOverlap"===b._typename?(f=b.fMarker,g="<prnt>/Marker",b=e.GEO.buildOverlapVolume(b),c||(c="wire")):"fVolume"in b?b.fVolume&&(d=b.fVolume.fShape):b=null;"string"==typeof c&&0==c.indexOf("comp")&&d&&"TGeoCompositeShape"==d._typename&&d.fNode&&(b=1,c=c.substr(4),"x"==c[0]&&(b=999,c=c.substr(1)+
"_vislvl999"),b=e.GEO.buildCompositeVolume(d,b));!b&&d&&(b=e.extend(e.Create("TEveGeoShapeExtract"),{fTrans:null,fShape:d,fRGBA:[0,1,0,1],fElements:null,fRnrSelf:!0}));if(!b)return null;a=e.Painter.CreateGeoPainter(a,b,c);a.ctrl.is_main&&!b.$geo_painter&&(b.$geo_painter=a);!a.ctrl.is_main&&a.ctrl.project&&b.$geo_painter&&(a._main_painter=b.$geo_painter,a._main_painter._slave_painters.push(a));if(h&&!a.ctrl.vislevel||9>a.ctrl.vislevel)a.ctrl.vislevel=9;f&&(a._splitColors=!0,a.addExtra(f,g));a.checkScript(a.ctrl.script_name,
a.prepareObjectDraw.bind(a));return a};e.Painter.drawGeometry=e.Painter.drawGeoObject;e.GEO.buildCompositeVolume=function(a,b,c){void 0===b&&(b=1);c||(this.$comp_col_cnt=0,c="");var d=e.Create("TGeoVolume");e.GEO.SetBit(d,e.GEO.BITS.kVisThis,!0);e.GEO.SetBit(d,e.GEO.BITS.kVisDaughters,!0);if(c&&"TGeoCompositeShape"!==a._typename||0>=b)return d.fName=c,d.fLineColor=this.$comp_col_cnt++%8+2,d.fShape=a,d;c&&(c+="/");d.$geoh=!0;d.fName="";var f=e.Create("TGeoNodeMatrix");e.GEO.SetBit(f,e.GEO.BITS.kVisThis,
!0);e.GEO.SetBit(f,e.GEO.BITS.kVisDaughters,!0);f.fName="Left";f.fMatrix=a.fNode.fLeftMat;f.fVolume=e.GEO.buildCompositeVolume(a.fNode.fLeft,b-1,c+"Left");var g=e.Create("TGeoNodeMatrix");e.GEO.SetBit(g,e.GEO.BITS.kVisThis,!0);e.GEO.SetBit(g,e.GEO.BITS.kVisDaughters,!0);g.fName="Right";g.fMatrix=a.fNode.fRightMat;g.fVolume=e.GEO.buildCompositeVolume(a.fNode.fRight,b-1,c+"Right");d.fNodes=e.Create("TList");d.fNodes.Add(f);d.fNodes.Add(g);c||delete this.$comp_col_cnt;return d};e.GEO.buildOverlapVolume=
function(a){var b=e.Create("TGeoVolume");e.GEO.SetBit(b,e.GEO.BITS.kVisDaughters,!0);b.$geoh=!0;b.fName="";var c=e.Create("TGeoNodeMatrix");c.fName=a.fVolume1.fName||"Overlap1";c.fMatrix=a.fMatrix1;c.fVolume=a.fVolume1;var d=e.Create("TGeoNodeMatrix");d.fName=a.fVolume2.fName||"Overlap2";d.fMatrix=a.fMatrix2;d.fVolume=a.fVolume2;b.fNodes=e.Create("TList");b.fNodes.Add(c);b.fNodes.Add(d);return b};e.GEO.provideVisStyle=function(a){if("TEveGeoShapeExtract"===a._typename||"ROOT::Experimental::REveGeoShapeExtract"===
a._typename)return a.fRnrSelf?" geovis_this":"";var b=!e.GEO.TestBit(a,e.GEO.BITS.kVisNone)&&e.GEO.TestBit(a,e.GEO.BITS.kVisThis),c=e.GEO.TestBit(a,e.GEO.BITS.kVisDaughters);!c||a.fNodes&&0!==a.fNodes.arr.length||(c=!1);return b&&c?" geovis_all":b?" geovis_this":c?" geovis_daughters":""};e.GEO.getBrowserItem=function(a,b,c){a._geoobj&&(a._geoobj.$geoh=!0);e.CallBack(c,a,a._geoobj)};e.GEO.createItem=function(a,b,c){c={_kind:"ROOT."+b._typename,_name:c?c:e.GEO.ObjectName(b),_title:b.fTitle,_parent:a,
_geoobj:b,_get:e.GEO.getBrowserItem};var d=!1;if("TGeoMaterial"==b._typename)c._icon="img_geomaterial";else if("TGeoMedium"==b._typename)c._icon="img_geomedium";else if("TGeoMixture"==b._typename)c._icon="img_geomixture";else if(0===b._typename.indexOf("TGeoNode")&&b.fVolume){c._title="node:"+b._typename;0<b.fTitle.length&&(c._title+=" "+b.fTitle);var f=b.fVolume}else if(0===b._typename.indexOf("TGeoVolume"))f=b;else if("TEveGeoShapeExtract"==b._typename||"ROOT::Experimental::REveGeoShapeExtract"==
b._typename){d=!0;var g=b.fShape;var h=b.fElements?b.fElements.arr:null}else void 0!==b.fShapeBits&&void 0!==b.fShapeId&&(g=b);f&&(g=f.fShape,h=f.fNodes?f.fNodes.arr:null);if(f||g||h)f&&(c._volume=f),h?(c._more=!0,c._expand=e.GEO.expandObject):g&&"TGeoCompositeShape"===g._typename&&g.fNode&&(c._more=!0,c._shape=g,c._expand=function(a,b){e.GEO.createItem(a,a._shape.fNode.fLeft,"Left");e.GEO.createItem(a,a._shape.fNode.fRight,"Right");return!0}),c._title||"TGeoVolume"==b._typename||(c._title=b._typename),
g?(""==c._title&&(c._title=g._typename),c._icon=e.GEO.getShapeIcon(g)):c._icon=c._more?"img_geocombi":"img_geobbox",f?c._icon+=e.GEO.provideVisStyle(f):d&&(c._icon+=e.GEO.provideVisStyle(b)),c._menu=e.GEO.provideMenu,c._icon_click=e.GEO.browserIconClick;a._childs||(a._childs=[]);c._name||("string"===typeof a._name?(c._name=a._name,c._name.lastIndexOf("s")===c._name.length-1&&(c._name=c._name.substr(0,c._name.length-1)),c._name+="_"+a._childs.length):c._name="item_"+a._childs.length);a._childs.push(c);
return c};e.GEO.createList=function(a,b,c,d){b&&"arr"in b&&0!=b.arr.length&&(b={_name:c,_kind:"ROOT.TList",_title:d,_more:!0,_geoobj:b,_parent:a,_get:function(a,b,c){if("_geoobj"in a)return e.CallBack(c,a,a._geoobj);e.CallBack(c,a,null)},_expand:function(a,b){"fVolume"in b&&(b=b.fVolume.fNodes);if(!("arr"in b))return!1;a._childs=[];e.GEO.CheckDuplicates(null,b.arr);for(var c in b.arr)e.GEO.createItem(a,b.arr[c]);return!0}},a._childs||(a._childs=[]),a._childs.push(b))};e.GEO.provideMenu=function(a,
b,c){function d(a,b,c){b||(b={visible:0,hidden:0});c||(void 0!==b.assign?a.fRnrSelf=b.assign:a.fRnrSelf?b.vis++:b.hidden++);if(a.fElements)for(c=0;c<a.fElements.arr.length;++c)d(a.fElements.arr[c],b,!1);return b}function f(a){"self"===a?(h.fRnrSelf=!h.fRnrSelf,b._icon=b._icon.split(" ")[0]+e.GEO.provideVisStyle(h),c.UpdateTreeNode(b)):(d(h,{assign:"true"===a},!0),c.ForEach(function(a){a._geoobj&&a._icon&&(a._icon=b._icon.split(" ")[0]+e.GEO.provideVisStyle(a._geoobj),c.UpdateTreeNode(a))},b));e.GEO.findItemWithPainter(b,
"testGeomChanges")}function g(a){e.GEO.ToggleBit(k,a);var d=b._icon.split(" ")[0]+e.GEO.provideVisStyle(k);c.ForEach(function(a){b._volume===a._volume&&(a._icon=d,c.UpdateTreeNode(a))});c.UpdateTreeNode(b);e.GEO.findItemWithPainter(b,"testGeomChanges")}if(!b._geoobj)return!1;var h=b._geoobj,k=b._volume,p="TEveGeoShapeExtract"===h._typename||"ROOT::Experimental::REveGeoShapeExtract"===h._typename;if(!k&&!p)return!1;a.add("separator");0===b._geoobj._typename.indexOf("TGeoNode")&&e.GEO.findItemWithPainter(b)&&
a.add("Focus",function(){var a=e.GEO.findItemWithPainter(b);if(a){var d=c.itemFullName(b,a);a._painter&&"function"==typeof a._painter.focusOnItem&&a._painter.focusOnItem(d)}});p?(a.addchk(h.fRnrSelf,"Visible","self",f),p=d(h,void 0,!0),0<p.hidden+p.visible&&a.addchk(0==p.hidden,"Daughters",0!=p.hidden?"true":"false",f)):(a.addchk(e.GEO.TestBit(k,e.GEO.BITS.kVisNone),"Invisible",e.GEO.BITS.kVisNone,g),a.addchk(e.GEO.TestBit(k,e.GEO.BITS.kVisThis),"Visible",e.GEO.BITS.kVisThis,g),a.addchk(e.GEO.TestBit(k,
e.GEO.BITS.kVisDaughters),"Daughters",e.GEO.BITS.kVisDaughters,g));return!0};e.GEO.findItemWithPainter=function(a,b){for(;a;){if(a._painter&&a._painter._camera){if(b&&"function"==typeof a._painter[b])a._painter[b]();return a}a=a._parent}return null};e.GEO.updateBrowserIcons=function(a,b){a&&b&&b.ForEach(function(c){if(a===c._volume||a===c._geoobj)c._icon=c._icon.split(" ")[0]+e.GEO.provideVisStyle(a),b.UpdateTreeNode(c)})};e.GEO.browserIconClick=function(a,b){if(a._volume)return a._more&&a._volume.fNodes&&
0<a._volume.fNodes.arr.length?e.GEO.ToggleBit(a._volume,e.GEO.BITS.kVisDaughters):e.GEO.ToggleBit(a._volume,e.GEO.BITS.kVisThis),e.GEO.updateBrowserIcons(a._volume,b),e.GEO.findItemWithPainter(a,"testGeomChanges"),!1;if(a._geoobj&&("TEveGeoShapeExtract"==a._geoobj._typename||"ROOT::Experimental::REveGeoShapeExtract"==a._geoobj._typename))return a._geoobj.fRnrSelf=!a._geoobj.fRnrSelf,e.GEO.updateBrowserIcons(a._geoobj,b),e.GEO.findItemWithPainter(a,"testGeomChanges"),!1;var c=e.GEO.findItemWithPainter(a);
return c?void 0!==c._painter.ExtraObjectVisible(b,a,!0)?!0:!1:!1};e.GEO.getShapeIcon=function(a){switch(a._typename){case "TGeoArb8":return"img_geoarb8";case "TGeoCone":return"img_geocone";case "TGeoConeSeg":return"img_geoconeseg";case "TGeoCompositeShape":return"img_geocomposite";case "TGeoTubeSeg":return"img_geotubeseg";case "TGeoPara":return"img_geopara";case "TGeoParaboloid":return"img_geoparab";case "TGeoPcon":return"img_geopcon";case "TGeoPgon":return"img_geopgon";case "TGeoShapeAssembly":return"img_geoassembly";
case "TGeoSphere":return"img_geosphere";case "TGeoTorus":return"img_geotorus";case "TGeoTrd1":return"img_geotrd1";case "TGeoTrd2":return"img_geotrd2";case "TGeoXtru":return"img_geoxtru";case "TGeoTrap":return"img_geotrap";case "TGeoGtra":return"img_geogtra";case "TGeoEltu":return"img_geoeltu";case "TGeoHype":return"img_geohype";case "TGeoCtub":return"img_geoctub"}return"img_geotube"};e.GEO.getBrowserIcon=function(a,b){var c="";"ROOT.TEveTrack"==a._kind?c="img_evetrack":"ROOT.TEvePointSet"==a._kind?
c="img_evepoints":"ROOT.TPolyMarker3D"==a._kind&&(c="img_evepoints");if(0<c.length){var d=e.GEO.findItemWithPainter(a);d&&d._painter.ExtraObjectVisible(b,a)&&(c+=" geovis_this")}return c};e.GEO.expandObject=function(a,b){if(!a||!b)return!1;var c=0===b._typename.indexOf("TGeoNode"),d=0===b._typename.indexOf("TGeoVolume"),f="TGeoManager"===b._typename,g="TEveGeoShapeExtract"===b._typename||"ROOT::Experimental::REveGeoShapeExtract"===b._typename,h="TGeoOverlap"===b._typename;if(!(c||d||f||g||h))return!1;
if(a._childs)return!0;if(f)return e.GEO.createList(a,b.fMaterials,"Materials","list of materials"),e.GEO.createList(a,b.fMedia,"Media","list of media"),e.GEO.createList(a,b.fTracks,"Tracks","list of tracks"),e.GEO.createList(a,b.fOverlaps,"Overlaps","list of detected overlaps"),e.GEO.createItem(a,b.fMasterVolume),!0;if(h)return e.GEO.createItem(a,b.fVolume1),e.GEO.createItem(a,b.fVolume2),e.GEO.createItem(a,b.fMarker,"Marker"),!0;g?(c=b.fElements?b.fElements.arr:null,d=b.fShape):(c=(d=c?b.fVolume:
b)&&d.fNodes?d.fNodes.arr:null,d=d?d.fShape:null);if(!c&&d&&"TGeoCompositeShape"===d._typename&&d.fNode)return a._childs||(e.GEO.createItem(a,d.fNode.fLeft,"Left"),e.GEO.createItem(a,d.fNode.fRight,"Right")),!0;if(!c)return!1;e.GEO.CheckDuplicates(b,c);for(b=0;b<c.length;++b)e.GEO.createItem(a,c[b]);return!0};e.addDrawFunc({name:"TGeoVolumeAssembly",icon:"img_geoassembly",func:e.Painter.drawGeoObject,expand:e.GEO.expandObject,opt:";more;all;count"});e.addDrawFunc({name:"TEvePointSet",icon_get:e.GEO.getBrowserIcon,
icon_click:e.GEO.browserIconClick});e.addDrawFunc({name:"TEveTrack",icon_get:e.GEO.getBrowserIcon,icon_click:e.GEO.browserIconClick});e.TGeoPainter=f;e.Painter.GeoDrawingControl=A;return e.Painter});
