(function(g){if("function"===typeof define&&define.amd)define(["JSRootCore","threejs","ThreeCSG"],g);else if("object"===typeof exports&&"undefined"!==typeof module)g(require("./JSRootCore.js"),require("three"),require("./ThreeCSG.js"));else{if("undefined"==typeof JSROOT)throw Error("JSROOT is not defined","JSRootGeoBase.js");if("undefined"==typeof THREE)throw Error("THREE is not defined","JSRootGeoBase.js");if("undefined"==typeof ThreeBSP)throw Error("ThreeBSP is not defined","JSRootGeoBase.js");
g(JSROOT,THREE,ThreeBSP)}})(function(g,q,A){g.GEO={GradPerSegm:6,CompressComp:!0,CompLimit:20};g.GEO.BITS={kVisOverride:g.BIT(0),kVisNone:g.BIT(1),kVisThis:g.BIT(2),kVisDaughters:g.BIT(3),kVisOneLevel:g.BIT(4),kVisStreamed:g.BIT(5),kVisTouched:g.BIT(6),kVisOnScreen:g.BIT(7),kVisContainers:g.BIT(12),kVisOnly:g.BIT(13),kVisBranch:g.BIT(14),kVisRaytrace:g.BIT(15)};g.GEO.TestBit=function(a,c){a=a.fGeoAtt;return void 0===a?!1:0!==(a&c)};g.GEO.SetBit=function(a,c,b){void 0!==a.fGeoAtt&&(a.fGeoAtt=b?a.fGeoAtt|
c:a.fGeoAtt&~c)};g.GEO.ToggleBit=function(a,c){void 0!==a.fGeoAtt&&(a.fGeoAtt^=c&16777215)};g.GEO.InvisibleAll=function(a){void 0===a&&(a=!0);g.GEO.SetBit(this,g.GEO.BITS.kVisThis,!a);if(this.fNodes)for(var c=0;c<this.fNodes.arr.length;++c)g.GEO.SetBit(this.fNodes.arr[c].fVolume,g.GEO.BITS.kVisThis,!a)};g.GEO.warn=function(a){void 0===g.GEO._warn_msgs&&(g.GEO._warn_msgs={});void 0===g.GEO._warn_msgs[a]&&(g.GEO._warn_msgs[a]=!0,console.warn(a))};g.GEO.NodeKind=function(a){return void 0===a||null===
a||"object"!==typeof a?-1:"fShape"in a&&"fTrans"in a?1:0};g.GEO.CountNumShapes=function(a){return a?"TGeoCompositeShape"!==a._typename?1:g.GEO.CountNumShapes(a.fNode.fLeft)+g.GEO.CountNumShapes(a.fNode.fRight):0};g.GEO.GeometryCreator=function(a){this.nfaces=a;this.indx=0;this.pos=new Float32Array(9*a);this.norm=new Float32Array(9*a);return this};g.GEO.GeometryCreator.prototype.AddFace3=function(a,c,b,d,e,f,g,h,l){var k=this.indx,p=this.pos;p[k]=a;p[k+1]=c;p[k+2]=b;p[k+3]=d;p[k+4]=e;p[k+5]=f;p[k+
6]=g;p[k+7]=h;p[k+8]=l;this.last4=!1;this.indx=k+9};g.GEO.GeometryCreator.prototype.StartPolygon=function(){};g.GEO.GeometryCreator.prototype.StopPolygon=function(){};g.GEO.GeometryCreator.prototype.AddFace4=function(a,c,b,d,e,f,k,h,g,n,p,m,t){var l=this.indx,r=this.pos;1!==t&&(r[l]=a,r[l+1]=c,r[l+2]=b,r[l+3]=d,r[l+4]=e,r[l+5]=f,r[l+6]=k,r[l+7]=h,r[l+8]=g,l+=9);2!==t&&(r[l]=a,r[l+1]=c,r[l+2]=b,r[l+3]=k,r[l+4]=h,r[l+5]=g,r[l+6]=n,r[l+7]=p,r[l+8]=m,l+=9);this.last4=l!==this.indx+9;this.indx=l};g.GEO.GeometryCreator.prototype.SetNormal4=
function(a,c,b,d,e,f,k,h,g,n,p,m,t){if(this.last4&&t)return console.error("missmatch between AddFace4 and SetNormal4 calls");var l=this.indx-(this.last4?18:9),r=this.norm;1!==t&&(r[l]=a,r[l+1]=c,r[l+2]=b,r[l+3]=d,r[l+4]=e,r[l+5]=f,r[l+6]=k,r[l+7]=h,r[l+8]=g,l+=9);2!==t&&(r[l]=a,r[l+1]=c,r[l+2]=b,r[l+3]=k,r[l+4]=h,r[l+5]=g,r[l+6]=n,r[l+7]=p,r[l+8]=m)};g.GEO.GeometryCreator.prototype.RecalcZ=function(a){for(var c=this.pos,b=this.indx,d=b-(this.last4?18:9);d<b;)c[d+2]=a(c[d],c[d+1],c[d+2]),d+=3};g.GEO.GetNormal=
function(a,c,b,d,e,f,g,h,l){a=new q.Vector3(a,c,b);d=new q.Vector3(d,e,f);g=new q.Vector3(g,h,l);h=new q.Vector3;l=new q.Vector3;h.subVectors(g,d);l.subVectors(a,d);h.cross(l);return h};g.GEO.GeometryCreator.prototype.CalcNormal=function(){this.cb||(this.pA=new q.Vector3,this.pB=new q.Vector3,this.pC=new q.Vector3,this.cb=new q.Vector3,this.ab=new q.Vector3);this.pA.fromArray(this.pos,this.indx-9);this.pB.fromArray(this.pos,this.indx-6);this.pC.fromArray(this.pos,this.indx-3);this.cb.subVectors(this.pC,
this.pB);this.ab.subVectors(this.pA,this.pB);this.cb.cross(this.ab);this.SetNormal(this.cb.x,this.cb.y,this.cb.z)};g.GEO.GeometryCreator.prototype.SetNormal=function(a,c,b){var d=this.indx-9,e=this.norm;e[d]=e[d+3]=e[d+6]=a;e[d+1]=e[d+4]=e[d+7]=c;e[d+2]=e[d+5]=e[d+8]=b;this.last4&&(d-=9,e[d]=e[d+3]=e[d+6]=a,e[d+1]=e[d+4]=e[d+7]=c,e[d+2]=e[d+5]=e[d+8]=b)};g.GEO.GeometryCreator.prototype.SetNormal_12_34=function(a,c,b,d,e,f,g){void 0===g&&(g=0);var h=this.indx-(0<g?9:18),k=this.norm;1!==g&&(k[h]=a,
k[h+1]=c,k[h+2]=b,k[h+3]=a,k[h+4]=c,k[h+5]=b,k[h+6]=d,k[h+7]=e,k[h+8]=f,h+=9);2!==g&&(k[h]=a,k[h+1]=c,k[h+2]=b,k[h+3]=d,k[h+4]=e,k[h+5]=f,k[h+6]=d,k[h+7]=e,k[h+8]=f)};g.GEO.GeometryCreator.prototype.Create=function(){this.nfaces!==this.indx/9&&console.error("Mismatch with created "+this.nfaces+" and filled "+this.indx/9+" number of faces");var a=new q.BufferGeometry;a.addAttribute("position",new q.BufferAttribute(this.pos,3));a.addAttribute("normal",new q.BufferAttribute(this.norm,3));return a};g.GEO.PolygonsCreator=
function(){this.polygons=[]};g.GEO.PolygonsCreator.prototype.StartPolygon=function(a){this.multi=1;this.mnormal=a};g.GEO.PolygonsCreator.prototype.StopPolygon=function(){this.multi&&(this.multi=0,console.error("Polygon should be already closed at this moment"))};g.GEO.PolygonsCreator.prototype.AddFace3=function(a,c,b,d,e,f,g,h,l){this.AddFace4(a,c,b,d,e,f,g,h,l,g,h,l,2)};g.GEO.PolygonsCreator.prototype.AddFace4=function(a,c,b,d,e,f,g,h,l,n,p,m,t){void 0===t&&(t=0);this.v1=new A.Vertex(a,c,b,0,0,0);
this.v2=1===t?null:new A.Vertex(d,e,f,0,0,0);this.v3=new A.Vertex(g,h,l,0,0,0);this.v4=2===t?null:new A.Vertex(n,p,m,0,0,0);this.reduce=t;if(this.multi)2!==t&&console.error("polygon not supported for not-reduced faces"),1===this.multi++?(a=new A.Polygon,a.vertices.push(this.mnormal?this.v2:this.v3),this.polygons.push(a)):(a=this.polygons[this.polygons.length-1],1E-12<(this.mnormal?this.v2:this.v3).diff(this.mnormal?a.vertices[a.vertices.length-1]:a.vertices[0])&&console.error("vertex missmatch when building polygon")),
1E-12>(this.mnormal?this.v3:this.v2).diff(this.mnormal?a.vertices[0]:a.vertices[a.vertices.length-1])?this.multi=0:this.mnormal?a.vertices.push(this.v3):a.vertices.unshift(this.v2);else{a=new A.Polygon;switch(t){case 0:a.vertices.push(this.v1,this.v2,this.v3,this.v4);break;case 1:a.vertices.push(this.v1,this.v3,this.v4);break;case 2:a.vertices.push(this.v1,this.v2,this.v3)}this.polygons.push(a)}};g.GEO.PolygonsCreator.prototype.SetNormal4=function(a,c,b,d,e,f,g,h,l,n,p,m,t){this.v1.setnormal(a,c,
b);this.v2&&this.v2.setnormal(d,e,f);this.v3.setnormal(g,h,l);this.v4&&this.v4.setnormal(n,p,m)};g.GEO.PolygonsCreator.prototype.SetNormal_12_34=function(a,c,b,d,e,f,g){this.v1.setnormal(a,c,b);this.v2&&this.v2.setnormal(a,c,b);this.v3.setnormal(d,e,f);this.v4&&this.v4.setnormal(d,e,f)};g.GEO.PolygonsCreator.prototype.CalcNormal=function(){this.cb||(this.pA=new q.Vector3,this.pB=new q.Vector3,this.pC=new q.Vector3,this.cb=new q.Vector3,this.ab=new q.Vector3);this.pA.set(this.v1.x,this.v1.y,this.v1.z);
1!==this.reduce?(this.pB.set(this.v2.x,this.v2.y,this.v2.z),this.pC.set(this.v3.x,this.v3.y,this.v3.z)):(this.pB.set(this.v3.x,this.v3.y,this.v3.z),this.pC.set(this.v4.x,this.v4.y,this.v4.z));this.cb.subVectors(this.pC,this.pB);this.ab.subVectors(this.pA,this.pB);this.cb.cross(this.ab);this.SetNormal(this.cb.x,this.cb.y,this.cb.z)};g.GEO.PolygonsCreator.prototype.SetNormal=function(a,c,b){this.v1.setnormal(a,c,b);this.v2&&this.v2.setnormal(a,c,b);this.v3.setnormal(a,c,b);this.v4&&this.v4.setnormal(a,
c,b)};g.GEO.PolygonsCreator.prototype.RecalcZ=function(a){this.v1.z=a(this.v1.x,this.v1.y,this.v1.z);this.v2&&(this.v2.z=a(this.v2.x,this.v2.y,this.v2.z));this.v3.z=a(this.v3.x,this.v3.y,this.v3.z);this.v4&&(this.v4.z=a(this.v4.x,this.v4.y,this.v4.z))};g.GEO.PolygonsCreator.prototype.Create=function(){return{polygons:this.polygons}};g.GEO.createCubeBuffer=function(a,c){if(0>c)return 12;var b=a.fDX,d=a.fDY;a=a.fDZ;c=c?new g.GEO.PolygonsCreator:new g.GEO.GeometryCreator(12);c.AddFace4(b,d,a,b,-d,a,
b,-d,-a,b,d,-a);c.SetNormal(1,0,0);c.AddFace4(-b,d,-a,-b,-d,-a,-b,-d,a,-b,d,a);c.SetNormal(-1,0,0);c.AddFace4(-b,d,-a,-b,d,a,b,d,a,b,d,-a);c.SetNormal(0,1,0);c.AddFace4(-b,-d,a,-b,-d,-a,b,-d,-a,b,-d,a);c.SetNormal(0,-1,0);c.AddFace4(-b,d,a,-b,-d,a,b,-d,a,b,d,a);c.SetNormal(0,0,1);c.AddFace4(b,d,-a,b,-d,-a,-b,-d,-a,-b,d,-a);c.SetNormal(0,0,-1);return c.Create()};g.GEO.create8edgesBuffer=function(a,c){var b=[4,7,6,5,0,3,7,4,4,5,1,0,6,2,1,5,7,3,2,6,1,2,3,0];c=0<c?new g.GEO.PolygonsCreator:new g.GEO.GeometryCreator(12);
for(var d=0;d<b.length;d+=4){var e=3*b[d],f=3*b[d+1],k=3*b[d+2],h=3*b[d+3];c.AddFace4(a[e],a[e+1],a[e+2],a[f],a[f+1],a[f+2],a[k],a[k+1],a[k+2],a[h],a[h+1],a[h+2]);0===d?c.SetNormal(0,0,1):20===d?c.SetNormal(0,0,-1):c.CalcNormal()}return c.Create()};g.GEO.createParaBuffer=function(a,c){if(0>c)return 12;var b=a.fTxy,d=a.fTxz,e=a.fTyz;return g.GEO.create8edgesBuffer([-a.fZ*d-b*a.fY-a.fX,-a.fY-a.fZ*e,-a.fZ,-a.fZ*d+b*a.fY-a.fX,a.fY-a.fZ*e,-a.fZ,-a.fZ*d+b*a.fY+a.fX,a.fY-a.fZ*e,-a.fZ,-a.fZ*d-b*a.fY+a.fX,
-a.fY-a.fZ*e,-a.fZ,a.fZ*d-b*a.fY-a.fX,-a.fY+a.fZ*e,a.fZ,a.fZ*d+b*a.fY-a.fX,a.fY+a.fZ*e,a.fZ,a.fZ*d+b*a.fY+a.fX,a.fY+a.fZ*e,a.fZ,a.fZ*d-b*a.fY+a.fX,-a.fY+a.fZ*e,a.fZ],c)};g.GEO.createTrapezoidBuffer=function(a,c){if(0>c)return 12;var b;if("TGeoTrd1"==a._typename)var d=b=a.fDY;else d=a.fDy1,b=a.fDy2;return g.GEO.create8edgesBuffer([-a.fDx1,d,-a.fDZ,a.fDx1,d,-a.fDZ,a.fDx1,-d,-a.fDZ,-a.fDx1,-d,-a.fDZ,-a.fDx2,b,a.fDZ,a.fDx2,b,a.fDZ,a.fDx2,-b,a.fDZ,-a.fDx2,-b,a.fDZ],c)};g.GEO.createArb8Buffer=function(a,
c){if(0>c)return 12;a=[a.fXY[0][0],a.fXY[0][1],-a.fDZ,a.fXY[1][0],a.fXY[1][1],-a.fDZ,a.fXY[2][0],a.fXY[2][1],-a.fDZ,a.fXY[3][0],a.fXY[3][1],-a.fDZ,a.fXY[4][0],a.fXY[4][1],a.fDZ,a.fXY[5][0],a.fXY[5][1],a.fDZ,a.fXY[6][0],a.fXY[6][1],a.fDZ,a.fXY[7][0],a.fXY[7][1],a.fDZ];for(var b=[4,7,6,6,5,4,3,7,4,4,0,3,5,1,0,0,4,5,6,2,1,1,5,6,7,3,2,2,6,7,1,2,3,3,0,1],d=0;d<a.length;d+=a.length/2)for(var e=d;e<d+a.length/2-3;e+=3)for(var f=e+3;f<d+a.length/2;f+=3)if(a[e]===a[f]&&a[e+1]===a[f+1]&&a[e+2]===a[f+2])for(var k=
0;k<b.length;++k)b[k]===f/3&&(b[k]=e/3);d=[];for(k=e=0;k<b.length;k+=3){f=100*b[k]+10*b[k+1]+b[k+2];var h=100*b[k+1]+10*b[k+2]+b[k],l=100*b[k+2]+10*b[k]+b[k+1];b[k]==b[k+1]||b[k]==b[k+2]||b[k+1]==b[k+2]||0<=d.indexOf(f)||0<=d.indexOf(h)||0<=d.indexOf(l)?b[k]=b[k+1]=b[k+2]=-1:(d.push(f,h,l),e++)}k=c?new g.GEO.PolygonsCreator:new g.GEO.GeometryCreator(e);for(d=0;d<b.length;d+=6){e=3*b[d];f=3*b[d+1];h=3*b[d+2];l=3*b[d+3];var n=3*b[d+4],p=3*b[d+5],m=null;if(0<=e&&0<=l&&c)if(0===d)m=new q.Vector3(0,0,
1);else if(30===d)m=new q.Vector3(0,0,-1);else{var t=g.GEO.GetNormal(a[e],a[e+1],a[e+2],a[f],a[f+1],a[f+2],a[h],a[h+1],a[h+2]);t.normalize();var w=g.GEO.GetNormal(a[l],a[l+1],a[l+2],a[n],a[n+1],a[n+2],a[p],a[p+1],a[p+2]);w.normalize();1E-12>t.distanceToSquared(w)&&(m=t)}null!==m?(k.AddFace4(a[e],a[e+1],a[e+2],a[f],a[f+1],a[f+2],a[h],a[h+1],a[h+2],a[n],a[n+1],a[n+2]),k.SetNormal(m.x,m.y,m.z)):(0<=e&&(k.AddFace3(a[e],a[e+1],a[e+2],a[f],a[f+1],a[f+2],a[h],a[h+1],a[h+2]),k.CalcNormal()),0<=l&&(k.AddFace3(a[l],
a[l+1],a[l+2],a[n],a[n+1],a[n+2],a[p],a[p+1],a[p+2]),k.CalcNormal()))}return k.Create()};g.GEO.createSphereBuffer=function(a,c){var b=[a.fRmax,a.fRmin],d=a.fPhi1,e=a.fPhi2-a.fPhi1,f=a.fTheta1,k=a.fTheta2-a.fTheta1,h=a.fNseg;a=a.fNz;var l=0>=b[1];if(0<c){var n=(l?2:4)*h*a/c;1<n&&(h=Math.max(4,Math.floor(h/Math.sqrt(n))),a=Math.max(4,Math.floor(a/Math.sqrt(n))))}var p=h*a*2,m=2*h,t=2*h,w=360===e?0:a*(l?2:4);l&&(t=m=h);if(0>c)return p*(l?1:2)+m+t+w;n=new Float32Array(h+1);for(var r=new Float32Array(h+
1),v=new Float32Array(a+1),q=new Float32Array(a+1),u=0;u<=a;++u){var x=(f+k/a*u)*Math.PI/180;v[u]=Math.sin(x);q[u]=Math.cos(x)}for(u=0;u<=h;++u)f=(d+e/h*u)*Math.PI/180,n[u]=Math.sin(f),r[u]=Math.cos(f);1E-10>=Math.abs(v[0])&&(p-=h,m=0);1E-10>=Math.abs(v[a])&&(p-=h,t=0);u=p*(l?1:2)+m+t+w;c=c?new g.GEO.PolygonsCreator:new g.GEO.GeometryCreator(u);for(d=0;2>d&&(1!==d||!l);++d)for(m=b[d],t=0===d?1:-1,f=1-d,k=1-f,p=0;p<a;++p){w=p+f;x=p+k;var y=0;1E-10>=Math.abs(v[w])?y=1:1E-10>=Math.abs(v[x])&&(y=2);for(u=
0;u<h;++u)c.AddFace4(m*v[w]*r[u],m*v[w]*n[u],m*q[w],m*v[w]*r[u+1],m*v[w]*n[u+1],m*q[w],m*v[x]*r[u+1],m*v[x]*n[u+1],m*q[x],m*v[x]*r[u],m*v[x]*n[u],m*q[x],y),c.SetNormal4(t*v[w]*r[u],t*v[w]*n[u],t*q[w],t*v[w]*r[u+1],t*v[w]*n[u+1],t*q[w],t*v[x]*r[u+1],t*v[x]*n[u+1],t*q[x],t*v[x]*r[u],t*v[x]*n[u],t*q[x],y)}for(d=0;d<=a;d+=a)if(1E-10<=Math.abs(v[d]))for(m=v[d],t=q[d],f=0===d?0:1,k=1-f,u=0;u<h;++u)c.AddFace4(b[1]*m*r[u+f],b[1]*m*n[u+f],b[1]*t,b[0]*m*r[u+f],b[0]*m*n[u+f],b[0]*t,b[0]*m*r[u+k],b[0]*m*n[u+
k],b[0]*t,b[1]*m*r[u+k],b[1]*m*n[u+k],b[1]*t,l?2:0),c.CalcNormal();if(360>e)for(d=0;d<=h;d+=h)for(m=n[d],t=r[d],f=0===d?1:0,k=1-f,p=0;p<a;++p)c.AddFace4(b[1]*v[p+f]*t,b[1]*v[p+f]*m,b[1]*q[p+f],b[0]*v[p+f]*t,b[0]*v[p+f]*m,b[0]*q[p+f],b[0]*v[p+k]*t,b[0]*v[p+k]*m,b[0]*q[p+k],b[1]*v[p+k]*t,b[1]*v[p+k]*m,b[1]*q[p+k],l?2:0),c.CalcNormal();return c.Create()};g.GEO.createTubeBuffer=function(a,c){if("TGeoCone"==a._typename||"TGeoConeSeg"==a._typename){var b=[a.fRmax2,a.fRmax1];var d=[a.fRmin2,a.fRmin1]}else b=
[a.fRmax,a.fRmax],d=[a.fRmin,a.fRmin];var e=0<d[0]||0<d[1],f=0,k=360;if("TGeoConeSeg"==a._typename||"TGeoTubeSeg"==a._typename||"TGeoCtub"==a._typename)f=a.fPhi1,k=a.fPhi2-a.fPhi1;var h=Math.max(4,Math.round(k/g.GEO.GradPerSegm)),l=h*(0>=b[0]||0>=b[1]?1:2);e&&(l+=h*(0>=d[0]||0>=d[1]?1:2));0<b[0]&&(l+=h*(0<d[0]?2:1));0<b[1]&&(l+=h*(0<d[1]?2:1));360>k&&(l+=(b[0]>d[0]?2:0)+(b[1]>d[1]?2:0));if(0>c)return l;var n=f*Math.PI/180,p=k/h*Math.PI/180;f=new Float32Array(h+1);for(var m=new Float32Array(h+1),t=
0;t<=h;++t)m[t]=Math.cos(n+t*p),f[t]=Math.sin(n+t*p);c=c?new g.GEO.PolygonsCreator:new g.GEO.GeometryCreator(l);var w;"TGeoCtub"==a._typename&&(w=function(b,d,c){var e=0>c?a.fNlow:a.fNhigh;return(0>c?-a.fDz:a.fDz)-(b*e[0]+d*e[1])/e[2]});for(l=0;2>l&&(1!==l||e);++l){var r=0===l?b:d;n=l;p=1-l;var v=1,q=0;r[0]!==r[1]&&(t=Math.atan2(r[1]-r[0],2*a.fDZ),v=Math.cos(t),q=Math.sin(t));1===l&&(v*=-1,q*=-1);var u=0;0>=r[0]?u=2:0>=r[1]&&(u=1);for(t=0;t<h;++t)c.AddFace4(r[0]*m[t+n],r[0]*f[t+n],a.fDZ,r[1]*m[t+
n],r[1]*f[t+n],-a.fDZ,r[1]*m[t+p],r[1]*f[t+p],-a.fDZ,r[0]*m[t+p],r[0]*f[t+p],a.fDZ,u),w&&c.RecalcZ(w),c.SetNormal_12_34(v*m[t+n],v*f[t+n],q,v*m[t+p],v*f[t+p],q,u)}for(l=0;2>l;++l)if(!(0>=b[l])){n=l;p=1-l;e=0==l?1:-1;u=0>=d[l]?2:0;2!=u||360!==k||w||c.StartPolygon(0===l);for(t=0;t<h;++t)c.AddFace4(d[l]*m[t+n],d[l]*f[t+n],e*a.fDZ,b[l]*m[t+n],b[l]*f[t+n],e*a.fDZ,b[l]*m[t+p],b[l]*f[t+p],e*a.fDZ,d[l]*m[t+p],d[l]*f[t+p],e*a.fDZ,u),w?(c.RecalcZ(w),c.CalcNormal()):c.SetNormal(0,0,e);c.StopPolygon()}360>k&&
(c.AddFace4(d[1]*m[0],d[1]*f[0],-a.fDZ,b[1]*m[0],b[1]*f[0],-a.fDZ,b[0]*m[0],b[0]*f[0],a.fDZ,d[0]*m[0],d[0]*f[0],a.fDZ,b[0]===d[0]?2:d[1]===b[1]?1:0),w&&c.RecalcZ(w),c.CalcNormal(),c.AddFace4(d[0]*m[h],d[0]*f[h],a.fDZ,b[0]*m[h],b[0]*f[h],a.fDZ,b[1]*m[h],b[1]*f[h],-a.fDZ,d[1]*m[h],d[1]*f[h],-a.fDZ,b[0]===d[0]?1:d[1]===b[1]?2:0),w&&c.RecalcZ(w),c.CalcNormal());return c.Create()};g.GEO.createEltuBuffer=function(a,c){var b=Math.max(4,Math.round(360/g.GEO.GradPerSegm));if(0>c)return 4*b;for(var d=new Float32Array(b+
1),e=new Float32Array(b+1),f=0;f<=b;++f){var k=f/b*2*Math.PI;d[f]=a.fRmin*Math.cos(k);e[f]=a.fRmax*Math.sin(k)}c=c?new g.GEO.PolygonsCreator:new g.GEO.GeometryCreator(4*b);var h=1,l=0;for(f=0;f<b;++f){c.AddFace4(d[f],e[f],+a.fDZ,d[f],e[f],-a.fDZ,d[f+1],e[f+1],-a.fDZ,d[f+1],e[f+1],a.fDZ);k=h;var n=l;h=d[f+1]*a.fRmax/a.fRmin;l=e[f+1]*a.fRmin/a.fRmax;var p=Math.sqrt(h*h+l*l);h/=p;l/=p;c.SetNormal_12_34(k,n,0,h,l,0)}for(k=0;2>k;++k)for(n=0===k?1:-1,h=k,l=1-k,f=0;f<b;++f)c.AddFace3(0,0,n*a.fDZ,d[f+h],
e[f+h],n*a.fDZ,d[f+l],e[f+l],n*a.fDZ),c.SetNormal(0,0,n);return c.Create()};g.GEO.createTorusBuffer=function(a,c){var b=a.fR,d=Math.max(6,Math.round(360/g.GEO.GradPerSegm)),e=Math.max(8,Math.round(a.fDphi/g.GEO.GradPerSegm)),f=(0<a.fRmin?4:2)*d*(e+(360!==a.fDphi?1:0));if(0>c)return f;0<c&&f>c&&(d=Math.floor(d/Math.sqrt(f/c)),e=Math.floor(e/Math.sqrt(f/c)),f=(0<a.fRmin?4:2)*d*(e+(360!==a.fDphi?1:0)));for(var k=new Float32Array(d+1),h=new Float32Array(d+1),l=new Float32Array(e+1),n=new Float32Array(e+
1),p=0;p<=d;++p)k[p]=Math.sin(p/d*2*Math.PI),h[p]=Math.cos(p/d*2*Math.PI);for(var m=0;m<=e;++m)p=(a.fPhi1+a.fDphi*m/e)/180*Math.PI,l[m]=Math.sin(p),n[m]=Math.cos(p);c=c?new g.GEO.PolygonsCreator:new g.GEO.GeometryCreator(f);for(var t=new q.Vector3,w=new q.Vector3,r=new q.Vector3,v=new q.Vector3,z=new q.Vector3,u=new q.Vector3,x=new q.Vector3,y=new q.Vector3,I=new q.Vector3,A=new q.Vector3,B=0;2>B&&!(0<B&&0>=a.fRmin);++B){var C=0<B?a.fRmin:a.fRmax;f=1-B;var F=1-f,D=0<B?-1:1;for(m=0;m<e;++m){var G=
m+f,H=m+F;I.x=b*n[G];I.y=b*l[G];A.x=b*n[H];A.y=b*l[H];for(p=0;p<d;++p)t.x=(b+C*h[p])*n[G],t.y=(b+C*h[p])*l[G],t.z=C*k[p],w.x=(b+C*h[p+1])*n[G],w.y=(b+C*h[p+1])*l[G],w.z=C*k[p+1],r.x=(b+C*h[p+1])*n[H],r.y=(b+C*h[p+1])*l[H],r.z=C*k[p+1],v.x=(b+C*h[p])*n[H],v.y=(b+C*h[p])*l[H],v.z=C*k[p],c.AddFace4(t.x,t.y,t.z,w.x,w.y,w.z,r.x,r.y,r.z,v.x,v.y,v.z),z.subVectors(t,I).normalize(),u.subVectors(w,I).normalize(),x.subVectors(r,A).normalize(),y.subVectors(v,A).normalize(),c.SetNormal4(D*z.x,D*z.y,D*z.z,D*u.x,
D*u.y,D*u.z,D*x.x,D*x.y,D*x.z,D*y.x,D*y.y,D*y.z)}}if(360!==a.fDphi)for(m=0;m<=e;m+=e)for(t=a.fRmax,w=a.fRmin,f=0<m?0:1,F=1-f,r=0<a.fRmin?0:1,v=0<m?1:-1,p=0;p<d;++p)c.AddFace4((b+t*h[p+f])*n[m],(b+t*h[p+f])*l[m],t*k[p+f],(b+w*h[p+f])*n[m],(b+w*h[p+f])*l[m],w*k[p+f],(b+w*h[p+F])*n[m],(b+w*h[p+F])*l[m],w*k[p+F],(b+t*h[p+F])*n[m],(b+t*h[p+F])*l[m],t*k[p+F],r),c.SetNormal(-v*l[m],v*n[m],0);return c.Create()};g.GEO.createPolygonBuffer=function(a,c){var b=a.fPhi1,d=a.fDphi,e=1;if("TGeoPgon"==a._typename){var f=
a.fNedges;e=1/Math.cos(Math.PI/180*d/f/2)}else f=Math.max(5,Math.round(d/g.GEO.GradPerSegm));for(var k=new Int16Array(2*a.fNz),h=0,l=!1,n=0;n<a.fNz;++n)0<a.fRmin[n]&&(l=!0);if(0>c)return(l?4:2)*f*(a.fNz-1);for(var p=360===d?null:[],m=0;2>m;++m){var t=0===m?"fRmax":"fRmin";for(n=0;n<a.fNz;++n){var w=a.fZ[n],r=a[t][n];k[2*n+m]=0;0<n&&n<a.fNz-1&&(a.fZ[n-1]===w&&a[t][n-1]===r||a[t][n+1]===r&&a[t][n-1]===r)||(0<n&&(0===m||l)&&(k[2*n+m]=1,h++),null!==p&&(0===m?p.push(new q.Vector2(e*r,w)):r<a.fRmax[n]&&
p.unshift(new q.Vector2(e*r,w))))}}var v=h*f*2;a.fRmin[0]!==a.fRmax[0]&&(v+=f*(l?2:1));a.fRmin[a.fNz-1]!==a.fRmax[a.fNz-1]&&(v+=f*(l?2:1));h=null;if(null!==p){if(p.length===2*a.fNz)for(h=[],n=a.fNz-1;0<n;--n)a.fZ[n]!==a.fZ[n-1]&&(r=2*a.fNz-1-n,h.push([r,n-1,n]),h.push([r,r+1,n-1]));else h=q.ShapeUtils.triangulateShape(p,[]);v+=2*h.length}n=b*Math.PI/180;var z=d/f*Math.PI/180;d=new Float32Array(f+1);b=new Float32Array(f+1);for(r=0;r<=f;++r)b[r]=Math.cos(n+r*z),d[r]=Math.sin(n+r*z);c=c?new g.GEO.PolygonsCreator:
new g.GEO.GeometryCreator(v);for(m=0;2>m;++m){t=0===m?"fRmax":"fRmin";w=a.fZ[0];var u=e*a[t][0];v=1-m;z=m;for(n=0;n<a.fNz;++n)if(0!==k[2*n+m]){var x=a.fZ[n],y=e*a[t][n],A=1,E=0;y!==u&&(r=Math.atan2(y-u,x-w),A=Math.cos(r),E=Math.sin(r));0<m&&(A*=-1,E*=-1);for(r=0;r<f;++r)c.AddFace4(u*b[r+v],u*d[r+v],w,y*b[r+v],y*d[r+v],x,y*b[r+z],y*d[r+z],x,u*b[r+z],u*d[r+z],w),c.SetNormal_12_34(A*b[r+v],A*d[r+v],E,A*b[r+z],A*d[r+z],E);w=x;u=y}}for(n=0;n<a.fNz;n+=a.fNz-1)if(k=e*a.fRmin[n],m=e*a.fRmax[n],k!==m){w=a.fZ[n];
v=0===n?1:0;z=1-v;t=0===n?-1:1;l||h||c.StartPolygon(0<n);for(r=0;r<f;++r)c.AddFace4(k*b[r+v],k*d[r+v],w,m*b[r+v],m*d[r+v],w,m*b[r+z],m*d[r+z],w,k*b[r+z],k*d[r+z],w,l?0:2),c.SetNormal(0,0,t);c.StopPolygon()}if(h)for(r=0;r<=f;r+=f)for(v=0===r?1:2,z=3-v,a=0;a<h.length;++a)e=p[h[a][0]],l=p[h[a][v]],n=p[h[a][z]],c.AddFace3(e.x*b[r],e.x*d[r],e.y,l.x*b[r],l.x*d[r],l.y,n.x*b[r],n.x*d[r],n.y),c.CalcNormal();return c.Create()};g.GEO.createXtruBuffer=function(a,c){var b=(a.fNz-1)*a.fNvert*2;if(0>c)return b+
3*a.fNvert;for(var d=[],e=0;e<a.fNvert;++e)d.push(new q.Vector2(a.fX[e],a.fY[e]));e=q.ShapeUtils.triangulateShape(d,[]);e.length<d.length-2?(g.GEO.warn("Problem with XTRU shape "+a.fName+" with "+d.length+" vertices"),e=[]):b+=2*e.length;c=c?new g.GEO.PolygonsCreator:new g.GEO.GeometryCreator(b);for(b=0;b<a.fNz-1;++b)for(var f=a.fZ[b],k=a.fScale[b],h=a.fZ[b+1],l=a.fScale[b+1],n=a.fX0[b],p=a.fX0[b+1],m=a.fY0[b],t=a.fY0[b+1],w=0;w<a.fNvert;++w){var r=(w+1)%a.fNvert;c.AddFace4(k*a.fX[w]+n,k*a.fY[w]+
m,f,l*a.fX[w]+p,l*a.fY[w]+t,h,l*a.fX[r]+p,l*a.fY[r]+t,h,k*a.fX[r]+n,k*a.fY[r]+m,f);c.CalcNormal()}for(b=0;b<=a.fNz-1;b+=a.fNz-1)for(f=a.fZ[b],k=a.fScale[b],h=a.fX0[b],l=a.fY0[b],n=0;n<e.length;++n)t=e[n],p=d[t[0]],m=d[t[0===b?2:1]],t=d[t[0===b?1:2]],c.AddFace3(k*p.x+h,k*p.y+l,f,k*m.x+h,k*m.y+l,f,k*t.x+h,k*t.y+l,f),c.SetNormal(0,0,0===b?-1:1);return c.Create()};g.GEO.createParaboloidBuffer=function(a,c){var b=Math.max(4,Math.round(360/g.GEO.GradPerSegm)),d=30;if(0<c){var e=2*b*(d+1)/c;1<e&&(b=Math.max(5,
Math.floor(b/Math.sqrt(e))),d=Math.max(5,Math.floor(d/Math.sqrt(e))))}e=-a.fDZ;var f=a.fDZ,k=a.fRlo,h=a.fRhi;0<=a.fA?a.fB>e&&(e=a.fB):a.fB<f&&(f=a.fB);var l=Math.atan2(e,k),n=Math.atan2(f,h),p=(d+1)*b*2;0===k&&(p-=2*b);0===h&&(p-=2*b);if(0>c)return p;for(var m=new Float32Array(b+1),t=new Float32Array(b+1),q=0;q<=b;++q)t[q]=Math.cos(q/b*2*Math.PI),m[q]=Math.sin(q/b*2*Math.PI);c=c?new g.GEO.PolygonsCreator:new g.GEO.GeometryCreator(p);p=e;for(var r=0,v=0,z=-1,u=0;u<=d+1;++u)if(0!==u||0!==k){if(u===
d+1&&0===r)break;switch(u){case 0:var x=e;var y=k;break;case d:x=f;y=h;break;case d+1:x=f;y=0;break;default:q=Math.tan(l+(n-l)*u/d),y=.5*(q+Math.sqrt(q*q-4*a.fA*a.fB))/a.fA,1E-6>y&&(y=0),x=y*q}var A=a.fA*y;var E=0<a.fA?-1:1;var B=0;0===r?B=1:0===y&&(B=2);for(q=0;q<b;++q)c.AddFace4(y*t[q],y*m[q],x,r*t[q],r*m[q],p,r*t[q+1],r*m[q+1],p,y*t[q+1],y*m[q+1],x,B),0===B||1===u&&0===k||u===d+1&&0===h?c.SetNormal4(A*t[q],A*m[q],E,v*t[q],v*m[q],z,v*t[q+1],v*m[q+1],z,A*t[q+1],A*m[q+1],E,B):c.SetNormal(0,0,u<d?
-1:1);p=x;r=y;v=A;z=E}return c.Create()};g.GEO.createHypeBuffer=function(a,c){if(0===a.fTin&&0===a.fTout)return g.GEO.createTubeBuffer(a,c);var b=Math.max(4,Math.round(360/g.GEO.GradPerSegm)),d=30,e=b*(d+1)*(0<a.fRmin?4:2);if(0>c)return e;0<c&&c>e&&(b=Math.max(4,Math.floor(b/Math.sqrt(e/c))),d=Math.max(4,Math.floor(d/Math.sqrt(e/c))),e=b*(d+1)*(0<a.fRmin?4:2));for(var f=new Float32Array(b+1),k=new Float32Array(b+1),h=0;h<=b;++h)k[h]=Math.cos(h/b*2*Math.PI),f[h]=Math.sin(h/b*2*Math.PI);c=c?new g.GEO.PolygonsCreator:
new g.GEO.GeometryCreator(e);for(var l=0;2>l&&!(0<l&&0>=a.fRmin);++l){var n=0<l?a.fRmin:a.fRmax,p=0<l?a.fTinsq:a.fToutsq;e=1-l;for(var m=1-e,t=0;t<d;++t){var q=-a.fDz+t/d*2*a.fDz,r=-a.fDz+(t+1)/d*2*a.fDz,v=Math.sqrt(n*n+p*q*q),z=Math.sqrt(n*n+p*r*r);for(h=0;h<b;++h)c.AddFace4(v*k[h+e],v*f[h+e],q,z*k[h+e],z*f[h+e],r,z*k[h+m],z*f[h+m],r,v*k[h+m],v*f[h+m],q),c.CalcNormal()}}for(t=0;2>t;++t)for(d=0===t?a.fDz:-a.fDz,v=Math.sqrt(a.fRmax*a.fRmax+a.fToutsq*d*d),z=0<a.fRmin?Math.sqrt(a.fRmin*a.fRmin+a.fTinsq*
d*d):0,l=0<a.fRmin?0:1,e=1-t,m=1-e,h=0;h<b;++h)c.AddFace4(v*k[h+e],v*f[h+e],d,z*k[h+e],z*f[h+e],d,z*k[h+m],z*f[h+m],d,v*k[h+m],v*f[h+m],d,l),c.SetNormal(0,0,0===t?1:-1);return c.Create()};g.GEO.createTessellatedBuffer=function(a,c){for(var b=0,d=0;d<a.fFacets.length;++d){var e=a.fFacets[d];b=4==e.fNvert?b+2:b+1}if(0>c)return b;c=c?new g.GEO.PolygonsCreator:new g.GEO.GeometryCreator(b);for(d=0;d<a.fFacets.length;++d){e=a.fFacets[d];b=a.fVertices[e.fIvert[0]].fVec;var f=a.fVertices[e.fIvert[1]].fVec,
k=a.fVertices[e.fIvert[2]].fVec;4==e.fNvert?(e=a.fVertices[e.fIvert[3]].fVec,c.AddFace4(b[0],b[1],b[2],f[0],f[1],f[2],k[0],k[1],k[2],e[0],e[1],e[2])):c.AddFace3(b[0],b[1],b[2],f[0],f[1],f[2],k[0],k[1],k[2]);c.CalcNormal()}return c.Create()};g.GEO.createMatrix=function(a){if(!a)return null;var c=null,b=null,d=null;switch(a._typename){case "TGeoTranslation":c=a.fTranslation;break;case "TGeoRotation":b=a.fRotationMatrix;break;case "TGeoScale":d=a.fScale;break;case "TGeoGenTrans":d=a.fScale;case "TGeoCombiTrans":c=
a.fTranslation;a.fRotation&&(b=a.fRotation.fRotationMatrix);break;case "TGeoHMatrix":c=a.fTranslation;b=a.fRotationMatrix;d=a.fScale;break;case "TGeoIdentity":break;default:console.warn("unsupported matrix "+a._typename)}if(!c&&!b&&!d)return null;a=new q.Matrix4;b&&a.set(b[0],b[1],b[2],0,b[3],b[4],b[5],0,b[6],b[7],b[8],0,0,0,0,1);c&&a.setPosition(new q.Vector3(c[0],c[1],c[2]));d&&a.scale(new q.Vector3(d[0],d[1],d[2]));return a};g.GEO.getNodeMatrix=function(a,c){var b=null;if(1===a)b=new q.Matrix4,
c.fTrans&&(b.set(c.fTrans[0],c.fTrans[4],c.fTrans[8],0,c.fTrans[1],c.fTrans[5],c.fTrans[9],0,c.fTrans[2],c.fTrans[6],c.fTrans[10],0,0,0,0,1),b.setPosition({x:c.fTrans[12],y:c.fTrans[13],z:c.fTrans[14]}));else if(c.fMatrix)b=g.GEO.createMatrix(c.fMatrix);else if("TGeoNodeOffset"==c._typename&&c.fFinder)switch(a=g.BIT(14),0!==(c.fFinder.fBits&a)&&g.GEO.warn("Unsupported reflected pattern "+c.fFinder._typename),c.fFinder._typename){case "TGeoPatternX":case "TGeoPatternY":case "TGeoPatternZ":case "TGeoPatternParaX":case "TGeoPatternParaY":case "TGeoPatternParaZ":a=
c.fFinder.fStart+(c.fIndex+.5)*c.fFinder.fStep;b=new q.Matrix4;switch(c.fFinder._typename[c.fFinder._typename.length-1]){case "X":b.setPosition(new q.Vector3(a,0,0));break;case "Y":b.setPosition(new q.Vector3(0,a,0));break;case "Z":b.setPosition(new q.Vector3(0,0,a))}break;case "TGeoPatternCylPhi":b=Math.PI/180*(c.fFinder.fStart+(c.fIndex+.5)*c.fFinder.fStep);c=Math.cos(b);a=Math.sin(b);b=new q.Matrix4;b.set(c,-a,0,0,a,c,0,0,0,0,1,0,0,0,0,1);break;case "TGeoPatternCylR":b=new q.Matrix4;break;case "TGeoPatternTrapZ":a=
c.fFinder.fStart+(c.fIndex+.5)*c.fFinder.fStep;b=new q.Matrix4;b.setPosition(new q.Vector3(c.fFinder.fTxz*a,c.fFinder.fTyz*a,a));break;default:g.GEO.warn("Unsupported pattern type "+c.fFinder._typename)}return b};g.GEO.createComposite=function(a,c){if(0>c)return g.GEO.createGeometry(a.fNode.fLeft,-10)+g.GEO.createGeometry(a.fNode.fRight,-10);var b=!1,d=g.GEO.createMatrix(a.fNode.fLeftMat);var e=g.GEO.createMatrix(a.fNode.fRightMat);0===c?c=g.browser&&g.browser.isIE?2E3:4E3:b=!0;d&&-.9>d.determinant()&&
g.GEO.warn("Axis reflection in left composite shape - not supported");e&&-.9>e.determinant()&&g.GEO.warn("Axis reflections in right composite shape - not supported");var f="TGeoHalfSpace"==a.fNode.fLeft._typename?g.GEO.createHalfSpace(a.fNode.fLeft):g.GEO.createGeometry(a.fNode.fLeft,c);if(!f)return null;var k=g.GEO.numGeometryFaces(f),h=0;f._exceed_limit&&(k+=c);if(k<c){var l="TGeoHalfSpace"==a.fNode.fRight._typename?g.GEO.createHalfSpace(a.fNode.fRight,f):g.GEO.createGeometry(a.fNode.fRight,c);
h=g.GEO.numGeometryFaces(l)}if(k+h>=c||!l)return f.polygons&&(f=A.CreateBufferGeometry(f.polygons),g.GEO.numGeometryFaces(f)),d&&f.applyMatrix(d),f._exceed_limit=!0,f;c=new A.Geometry(f,d,g.GEO.CompressComp?0:void 0);e=new A.Geometry(l,e,c.maxid);c.maxid=e.maxid;switch(a.fNode._typename){case "TGeoIntersection":c.direct_intersect(e);break;case "TGeoUnion":c.direct_union(e);break;case "TGeoSubtraction":c.direct_subtract(e);break;default:g.GEO.warn("unsupported bool operation "+a.fNode._typename+", use first geom")}0===
g.GEO.numGeometryFaces(c)&&(g.GEO.warn("Zero faces in comp shape left: "+a.fNode.fLeft._typename+" "+g.GEO.numGeometryFaces(f)+" faces right: "+a.fNode.fRight._typename+" "+g.GEO.numGeometryFaces(l)+" faces  use first"),c=new A.Geometry(f,d));return b?{polygons:c.toPolygons()}:c.toBufferGeometry()};g.GEO.projectGeometry=function(a,c,b,d,e){a.boundingBox||a.computeBoundingBox();var f=a.boundingBox.clone();f.applyMatrix4(c);d||(d=0);if(f.min[b]>=d&&f.max[b]>=d||f.min[b]<=d&&f.max[b]<=d)return null;
a=new A.Geometry(a,c,0,e);c=2*Math.max(Math.abs(f.min.x),Math.abs(f.max.x));e=2*Math.max(Math.abs(f.min.y),Math.abs(f.max.y));f=2*Math.max(Math.abs(f.min.z),Math.abs(f.max.z));var g=1E4;switch(b){case "x":g=Math.max(e,f);break;case "y":g=Math.max(c,f);break;case "z":g=Math.max(c,e)}b=A.CreateNormal(b,d,g);a.cut_from_plane(b);return b.toBufferGeometry()};g.GEO.createGeometry=function(a,c){void 0===c&&(c=0);try{switch(a._typename){case "TGeoBBox":return g.GEO.createCubeBuffer(a,c);case "TGeoPara":return g.GEO.createParaBuffer(a,
c);case "TGeoTrd1":case "TGeoTrd2":return g.GEO.createTrapezoidBuffer(a,c);case "TGeoArb8":case "TGeoTrap":case "TGeoGtra":return g.GEO.createArb8Buffer(a,c);case "TGeoSphere":return g.GEO.createSphereBuffer(a,c);case "TGeoCone":case "TGeoConeSeg":case "TGeoTube":case "TGeoTubeSeg":case "TGeoCtub":return g.GEO.createTubeBuffer(a,c);case "TGeoEltu":return g.GEO.createEltuBuffer(a,c);case "TGeoTorus":return g.GEO.createTorusBuffer(a,c);case "TGeoPcon":case "TGeoPgon":return g.GEO.createPolygonBuffer(a,
c);case "TGeoXtru":return g.GEO.createXtruBuffer(a,c);case "TGeoParaboloid":return g.GEO.createParaboloidBuffer(a,c);case "TGeoHype":return g.GEO.createHypeBuffer(a,c);case "TGeoTessellated":return g.GEO.createTessellatedBuffer(a,c);case "TGeoCompositeShape":return g.GEO.createComposite(a,c);case "TGeoShapeAssembly":break;case "TGeoScaledShape":var b=g.GEO.createGeometry(a.fShape,c);a.fScale&&0<=c&&"object"===typeof b&&"function"===typeof b.scale&&b.scale(a.fScale.fScale[0],a.fScale.fScale[1],a.fScale.fScale[2]);
return b;case "TGeoHalfSpace":if(0>c)return 1;default:g.GEO.warn("unsupported shape type "+a._typename)}}catch(d){b="",void 0!==d.stack&&(b=d.stack.split("\n")[0],b=0<=b.indexOf(d.message)?d.stack.split("\n")[1]:" at: "+b),g.GEO.warn(a._typename+" err: "+d.message+b)}return 0>c?0:null};g.GEO.createHalfSpace=function(a,c){if(!a||!a.fN||!a.fP)return null;var b=new q.Vector3(a.fP[0],a.fP[1],a.fP[2]);a=new q.Vector3(a.fN[0],a.fN[1],a.fN[2]);a.normalize();var d=1E10;c&&(c=g.GEO.geomBoundingBox(c))&&(d=
1E3*c.getSize(new q.Vector3).length());c=new q.Vector3(-d,-d/2,0);var e=new q.Vector3(0,d,0),f=new q.Vector3(d,-d/2,0);d=new q.Vector3(0,0,-d);var k=new q.Geometry;k.vertices.push(c,e,f,d);k.faces.push(new q.Face3(0,2,1));k.faces.push(new q.Face3(0,1,3));k.faces.push(new q.Face3(1,2,3));k.faces.push(new q.Face3(2,0,3));k.lookAt(a);k.computeFaceNormals();c.add(b);e.add(b);f.add(b);d.add(b);return k};g.GEO.provideInfo=function(a){function c(a){return void 0===a?"???":a==Math.round(a)&&1E7>a?Math.round(a):
e?a.toExponential(4):a.toPrecision(7)}var b=[],d=null;void 0!==a.fVolume?d=a.fVolume.fShape:void 0!==a.fShape?d=a.fShape:void 0!==a.fShapeBits&&void 0!==a.fShapeId&&(d=a);if(!d)return b.push(a._typename),b;a=Math.max(d.fDX,d.fDY,d.fDZ);var e=1E7<a||1E-7>a;b.push(d._typename);b.push("DX="+c(d.fDX)+" DY="+c(d.fDY)+" DZ="+c(d.fDZ));switch(d._typename){case "TGeoPara":b.push("Alpha="+d.fAlpha+" Phi="+d.fPhi+" Theta="+d.fTheta);break;case "TGeoTrd2":b.push("Dy1="+c(d.fDy1)+" Dy2="+c(d.fDy1));case "TGeoTrd1":b.push("Dx1="+
c(d.fDx1)+" Dx2="+c(d.fDx1));break;case "TGeoSphere":b.push("Rmin="+c(d.fRmin)+" Rmax="+c(d.fRmax));b.push("Phi1="+d.fPhi1+" Phi2="+d.fPhi2);b.push("Theta1="+d.fTheta1+" Theta2="+d.fTheta2);break;case "TGeoConeSeg":b.push("Phi1="+d.fPhi1+" Phi2="+d.fPhi2);case "TGeoCone":b.push("Rmin1="+c(d.fRmin1)+" Rmax1="+c(d.fRmax1));b.push("Rmin2="+c(d.fRmin2)+" Rmax2="+c(d.fRmax2));break;case "TGeoCtub":case "TGeoTubeSeg":b.push("Phi1="+d.fPhi1+" Phi2="+d.fPhi2);case "TGeoEltu":case "TGeoTube":b.push("Rmin="+
c(d.fRmin)+" Rmax="+c(d.fRmax));break;case "TGeoTorus":b.push("Rmin="+c(d.fRmin)+" Rmax="+c(d.fRmax));b.push("Phi1="+d.fPhi1+" Dphi="+d.fDphi);break;case "TGeoParaboloid":b.push("Rlo="+c(d.fRlo)+" Rhi="+c(d.fRhi));b.push("A="+c(d.fA)+" B="+c(d.fB));break;case "TGeoHype":b.push("Rmin="+c(d.fRmin)+" Rmax="+c(d.fRmax));b.push("StIn="+c(d.fStIn)+" StOut="+c(d.fStOut));break;case "TGeoScaledShape":b=g.GEO.provideInfo(d.fShape),d.fScale&&b.unshift("Scale X="+d.fScale.fScale[0]+" Y="+d.fScale.fScale[1]+
" Z="+d.fScale.fScale[2])}return b};g.GEO.CreateProjectionMatrix=function(a){var c=new q.Matrix4;a.updateMatrixWorld();a.matrixWorldInverse.getInverse(a.matrixWorld);c.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse);return c};g.GEO.CreateFrustum=function(a){if(!a)return null;a instanceof q.PerspectiveCamera&&(a=g.GEO.CreateProjectionMatrix(a));var c=new q.Frustum;c.setFromMatrix(a);c.corners=new Float32Array([1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1,0,0,0]);c.test=new q.Vector3(0,
0,0);c.CheckShape=function(a,d){var b=this.test,c=this.corners.length,g=this.corners,h;for(h=0;h<c;h+=3)if(b.x=g[h]*d.fDX,b.y=g[h+1]*d.fDY,b.z=g[h+2]*d.fDZ,this.containsPoint(b.applyMatrix4(a)))return!0;return!1};c.CheckBox=function(a){var b=this.test,c=0;b.set(a.min.x,a.min.y,a.min.z);this.containsPoint(b)&&c++;b.set(a.min.x,a.min.y,a.max.z);this.containsPoint(b)&&c++;b.set(a.min.x,a.max.y,a.min.z);this.containsPoint(b)&&c++;b.set(a.min.x,a.max.y,a.max.z);this.containsPoint(b)&&c++;b.set(a.max.x,
a.max.y,a.max.z);this.containsPoint(b)&&c++;b.set(a.max.x,a.min.y,a.max.z);this.containsPoint(b)&&c++;b.set(a.max.x,a.max.y,a.min.z);this.containsPoint(b)&&c++;b.set(a.max.x,a.max.y,a.max.z);this.containsPoint(b)&&c++;return 5<c};return c};g.GEO.VisibleByCamera=function(a,c,b){var d=new q.Frustum,e=new q.Matrix4;a.updateMatrixWorld();a.matrixWorldInverse.getInverse(a.matrixWorld);e.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse);d.setFromMatrix(e);a=[new q.Vector3(b.fDX/2,b.fDY/2,b.fDZ/
2),new q.Vector3(b.fDX/2,b.fDY/2,-b.fDZ/2),new q.Vector3(b.fDX/2,-b.fDY/2,b.fDZ/2),new q.Vector3(b.fDX/2,-b.fDY/2,-b.fDZ/2),new q.Vector3(-b.fDX/2,b.fDY/2,b.fDZ/2),new q.Vector3(-b.fDX/2,b.fDY/2,-b.fDZ/2),new q.Vector3(-b.fDX/2,-b.fDY/2,b.fDZ/2),new q.Vector3(-b.fDX/2,-b.fDY/2,-b.fDZ/2)];for(b=0;b<a.length;b++)if(d.containsPoint(a[b].applyMatrix4(c)))return!0;return!1};g.GEO.numGeometryFaces=function(a){return a?a instanceof A.Geometry?a.tree.numPolygons():"BufferGeometry"==a.type?(a=a.getAttribute("position"))&&
a.count?Math.round(a.count/3):0:a.polygons?a.polygons.length:a.faces.length:0};g.GEO.numGeometryVertices=function(a){return a?a instanceof A.Geometry?3*a.tree.numPolygons():"BufferGeometry"==a.type?(a=a.getAttribute("position"))?a.count:0:a.polygons?4*a.polygons.length:a.vertices.length:0};g.GEO.geomBoundingBox=function(a){if(!a)return null;var c=null;a instanceof A.Geometry?c=a.tree.collectPolygons([]):a.polygons&&(c=a.polygons);if(null!==c){a=new q.Box3;for(var b=0;b<c.length;++b)for(var d=c[b],
e=d.vertices.length,f=0;f<e;++f)a.expandByPoint(d.vertices[f]);return a}a.boundingBox||a.computeBoundingBox();return a.boundingBox.clone()};g.GEO.CompareStacks=function(a,c){if(!a||!c)return 0;if(a===c)return a.length;for(var b=Math.min(a.length,c.length),d=0;d<b;++d)if(a[d]!==c[d])return d;return b};g.GEO.IsSameStack=function(a,c){if(!a||!c)return!1;if(a===c)return!0;if(a.length!==c.length)return!1;for(var b=0;b<a.length;++b)if(a[b]!==c[b])return!1;return!0};g.GEO.ClonedNodes=function(a,c){this.toplevel=
!0;this.name_prefix="";this.maxdepth=1;this.vislevel=4;this.maxnodes=1E4;a?(a.$geoh&&(this.toplevel=!1),this.CreateClones(a)):c&&(this.nodes=c)};g.GEO.ClonedNodes.prototype.SetVisLevel=function(a){this.vislevel=a&&!isNaN(a)?a:4};g.GEO.ClonedNodes.prototype.GetVisLevel=function(){return this.vislevel};g.GEO.ClonedNodes.prototype.SetMaxVisNodes=function(a){this.maxnodes=isNaN(a)?1E4:a};g.GEO.ClonedNodes.prototype.GetMaxVisNodes=function(){return this.maxnodes};g.GEO.ClonedNodes.prototype.updateNode=
function(a){a&&!isNaN(a.id)&&a.id<this.nodes.length&&(this.nodes[a.id]=a)};g.GEO.ClonedNodes.prototype.GetNodeShape=function(a){if(!this.origin||!this.nodes)return null;var c=this.origin[a];a=this.nodes[a];if(!c||!a)return null;if(0===a.kind){if(c.fVolume)return c.fVolume.fShape}else return c.fShape;return null};g.GEO.ClonedNodes.prototype.Cleanup=function(a,c){if(a)for(var b=0;b<a.length;++b)delete a[b].stack,a[b]=void 0;if(c)for(b=0;b<c.length;++b)delete c[b].geom,c[b]=void 0;if(this.nodes)for(b=
0;b<this.nodes.length;++b)this.nodes[b]&&delete this.nodes[b].chlds;delete this.nodes;delete this.origin;delete this.sortmap};g.GEO.ClonedNodes.prototype.CreateClones=function(a,c,b){if(!c){if(a&&"$$Shape$$"==a._typename)return this.CreateClonesForShape(a);this.origin=[];c=1;b=g.GEO.NodeKind(a)}if(!(0>b||!a||"_refid"in a)){a._refid=this.origin.length;this.origin.push(a);c>this.maxdepth&&(this.maxdepth=c);var d=null;d=0===b?a.fVolume&&a.fVolume.fNodes?a.fVolume.fNodes.arr:null:a.fElements?a.fElements.arr:
null;if(null!==d){g.GEO.CheckDuplicates(a,d);for(var e=0;e<d.length;++e)this.CreateClones(d[e],c+1,b)}if(!(1<c)){this.nodes=[];c=[];for(e=0;e<this.origin.length;++e)a=this.origin[e],d={id:e,kind:b,vol:0,nfaces:0},this.nodes.push(d),c.push(d);for(e=0;e<this.origin.length;++e){a=this.origin[e];var f=this.nodes[e],k=d=null;1===b?(k=a.fShape,a.fElements&&(d=a.fElements.arr)):a.fVolume&&(k=a.fVolume.fShape,a.fVolume.fNodes&&(d=a.fVolume.fNodes.arr));if(a=g.GEO.getNodeMatrix(b,a))if(f.matrix=a.elements,
1===f.matrix[0]){a=!0;for(var h=1;h<f.matrix.length&&a;++h)a=f.matrix[h]===(5===h||10===h||15===h?1:0);a&&delete f.matrix}k&&(f.fDX=k.fDX,f.fDY=k.fDY,f.fDZ=k.fDZ,f.vol=k.fDX*k.fDY*k.fDZ,void 0===k.$nfaces&&(k.$nfaces=g.GEO.createGeometry(k,-1)),f.nfaces=k.$nfaces,0>=f.nfaces&&(f.vol=0));if(d)for(f.chlds=Array(d.length),h=0;h<d.length;++h)f.chlds[h]=d[h]._refid}for(e=0;e<this.origin.length;++e)delete this.origin[e]._refid;c.sort(function(a,b){return b.vol-a.vol});this.sortmap=Array(this.nodes.length);
for(e=0;e<this.nodes.length;++e)this.sortmap[e]=c[e].id,c[e].sortid=e}}};g.GEO.ClonedNodes.prototype.CreateClonesForShape=function(a){this.origin=[];this.plain_shape=a;this.nodes=[{id:0,sortid:0,kind:2,name:"Shape",nfaces:a.nfaces,fDX:1,fDY:1,fDZ:1,vol:1,vis:!0}]};g.GEO.ClonedNodes.prototype.CountVisibles=function(){var a=0;if(this.nodes)for(var c=0;c<this.nodes.length;++c)this.nodes[c].vis&&a++;return a};g.GEO.ClonedNodes.prototype.MarkVisibles=function(a,c,b){if(this.plain_shape)return 1;if(!this.origin||
!this.nodes)return 0;for(var d=0,e=0;e<this.nodes.length;++e){var f=this.nodes[e],k=this.origin[e];f.vis=0;delete f.nochlds;0===f.kind?k.fVolume&&(a?(f.vis=g.GEO.TestBit(k.fVolume,g.GEO.BITS.kVisOnScreen)?99:0,0==e&&f.vis&&b&&(f.vis=0),c&&(g.GEO.SetBit(k.fVolume,g.GEO.BITS.kVisNone,!1),g.GEO.SetBit(k.fVolume,g.GEO.BITS.kVisThis,0<f.vis),g.GEO.SetBit(k.fVolume,g.GEO.BITS.kVisDaughters,!0))):(f.vis=!g.GEO.TestBit(k.fVolume,g.GEO.BITS.kVisNone)&&g.GEO.TestBit(k.fVolume,g.GEO.BITS.kVisThis)?99:0,g.GEO.TestBit(k,
g.GEO.BITS.kVisDaughters)&&g.GEO.TestBit(k.fVolume,g.GEO.BITS.kVisDaughters)||(f.nochlds=!0),0<f.vis&&f.chlds&&!f.nochlds&&(f.vis=1),0==e&&(b&&(f.vis=0),delete f.nochlds))):(f.vis=k.fRnrSelf?99:0,0===e&&1===this.nodes.length&&(f.vis=99),this.vislevel=9999);if(0>=f.vol||0>=f.nfaces)f.vis=0;f.vis&&d++}return d};g.GEO.ClonedNodes.prototype.ProduceIdShits=function(){function a(b,c){if(0>c.idshift&&(c.idshift=0,c.chlds))for(var d=0;d<c.chlds.length;++d)c.idshift+=a(b,b[c.chlds[d]]);return c.idshift+1}
for(var c=0;c<this.nodes.length;++c)this.nodes[c].idshift=-1;a(this.nodes,this.nodes[0])};g.GEO.ClonedNodes.prototype.GetVisibleFlags=function(){for(var a=Array(this.nodes.length),c=0;c<this.nodes.length;++c)a[c]={vis:this.nodes[c].vis,nochlds:this.nodes[c].nochlds};return a};g.GEO.ClonedNodes.prototype.SetVisibleFlags=function(a){if(!this.nodes||!a||!a.length!=this.nodes.length)return 0;for(var c=0,b=0;b<this.nodes.length;++b){var d=this.nodes[b];d.vis=a[b].vis;d.nochlds=a[b].nochlds;d.vis&&c++}return c};
g.GEO.ClonedNodes.prototype.ScanVisible=function(a,c){if(!this.nodes)return 0;void 0===c&&(a||(a={}),c=a.vislvl||this.vislevel||4,88<c&&(c=88),a.stack=Array(100),a.nodeid=0,a.counter=0,a.last=0,a.CopyStack=function(a){var b={nodeid:this.nodeid,seqid:this.counter,stack:Array(this.last)};a&&(b.factor=a);for(a=0;a<this.last;++a)b.stack[a]=this.stack[a+1];return b},a.domatrix&&(a.matrices=[],a.mpool=[new q.Matrix4],a.getmatrix=function(){return this.matrices[this.last]}));var b=0,d=this.nodes[a.nodeid];
if(a.domatrix){a.mpool[a.last+1]||(a.mpool[a.last+1]=new q.Matrix4);var e=0<a.last?a.matrices[a.last-1]:new q.Matrix4;d.matrix?(a.matrices[a.last]=a.mpool[a.last].fromArray(e.elements),a.matrices[a.last].multiply(a.mpool[a.last+1].fromArray(d.matrix))):a.matrices[a.last]=e}d.nochlds&&(c=0);d.vis>c&&(!a.func||a.func(d))&&b++;a.counter++;if(0<c&&d.chlds){a.last++;for(e=0;e<d.chlds.length;++e)a.nodeid=d.chlds[e],a.stack[a.last]=e,b+=this.ScanVisible(a,c-1);a.last--}else a.counter+=d.idshift||0;0===a.last&&
(delete a.last,delete a.stack,delete a.CopyStack,delete a.counter,delete a.matrices,delete a.mpool,delete a.getmatrix);return b};g.GEO.ClonedNodes.prototype.GetNodeName=function(a){return this.origin?(a=this.origin[a])?g.GEO.ObjectName(a):"":(a=this.nodes[a])?a.name:""};g.GEO.ClonedNodes.prototype.ResolveStack=function(a,c){var b={id:0,obj:null,node:this.nodes[0],name:this.name_prefix};c&&(b.matrix=new q.Matrix4,b.node.matrix&&b.matrix.fromArray(b.node.matrix));this.origin&&(b.obj=this.origin[0]);
if(a)for(var d=0;d<a.length;++d){b.id=b.node.chlds[a[d]];b.node=this.nodes[b.id];this.origin&&(b.obj=this.origin[b.id]);var e=this.GetNodeName(b.id);e&&(b.name&&(b.name+="/"),b.name+=e);c&&b.node.matrix&&b.matrix.multiply((new q.Matrix4).fromArray(b.node.matrix))}return b};g.GEO.ClonedNodes.prototype.MakeStackByIds=function(a){if(!a)return null;if(0!==a[0])return console.error("wrong ids - first should be 0"),null;for(var c=this.nodes[0],b=[],d=1;d<a.length;++d){var e=a[d];if(!c)return null;c=c.chlds.indexOf(e);
if(0>c)return console.error("wrong nodes ids "+a[d]+" is not child of "+a[d-1]),null;b.push(c);c=this.nodes[e]}return b};g.GEO.ClonedNodes.prototype.MakeIdsByStack=function(a){if(!a)return null;for(var c=this.nodes[0],b=[0],d=0;d<a.length;++d)c=c.chlds[a[d]],b.push(c),c=this.nodes[c];return b};g.GEO.ClonedNodes.prototype.IsNodeInStack=function(a,c){if(!a)return!0;for(var b=this.nodes[0],d=0;d<c.length;++d){b=b.chlds[c[d]];if(b==a)return!0;b=this.nodes[b]}return!1};g.GEO.ClonedNodes.prototype.FindStackByName=
function(a){a=a.split("/");var c=0,b=[];if(this.GetNodeName(c)!==a[0])return null;for(var d=1;d<a.length;++d){var e=this.nodes[c];if(!e.chlds)return null;for(var f=0;f<e.chlds.length;++f){var g=e.chlds[f];if(this.GetNodeName(g)===a[d]){b.push(f);c=g;break}}if(b.length===d-1)return null}return b};g.GEO.ClonedNodes.prototype.SetDefaultColors=function(a){if((this.use_dflt_colors=a)&&!this.dflt_table){a=[];for(var c=0;110>c;c++)a.push(920);a[3]=390;a[4]=a[5]=406;a[6]=a[7]=593;a[8]=a[9]=613;a[10]=a[11]=
622;a[12]=921;a[13]=590;a[14]=807;a[16]=401;a[20]=390;a[24]=a[25]=a[26]=592;a[29]=809;a[79]=798;this.dflt_table=a}};g.GEO.ClonedNodes.prototype.getDrawEntryProperties=function(a){var c=this.nodes[a.nodeid];if(2===c.kind){c={name:c.name,nname:c.name,shape:null,material:null,chlds:null};var b=a.opacity||1;c.fillcolor=new q.Color(a.color?"rgb("+a.color+")":"blue");c.material=new q.MeshLambertMaterial({transparent:1>b,opacity:b,wireframe:!1,color:c.fillcolor,side:q.FrontSide,vertexColors:q.NoColors,depthWrite:1==
b});c.material.inherentOpacity=b;return c}if(!this.origin)return console.error("origin not there - kind",c.kind,a.nodeid,c),null;var d=this.origin[a.nodeid];if(1===c.kind)return c={name:g.GEO.ObjectName(d),nname:g.GEO.ObjectName(d),shape:d.fShape,material:null,chlds:null},null!==d.fElements&&(c.chlds=d.fElements.arr),b=Math.min(1,d.fRGBA[3]),c.fillcolor=new q.Color(d.fRGBA[0],d.fRGBA[1],d.fRGBA[2]),c.material=new q.MeshLambertMaterial({transparent:1>b,opacity:b,wireframe:!1,color:c.fillcolor,side:q.FrontSide,
vertexColors:q.NoColors,depthWrite:1==b}),c.material.inherentOpacity=b,c;var e=d.fVolume;c={name:g.GEO.ObjectName(e),nname:g.GEO.ObjectName(d),volume:d.fVolume,shape:e.fShape,material:null,chlds:null};null!==d.fVolume.fNodes&&(c.chlds=d.fVolume.fNodes.arr);e&&(c.linewidth=e.fLineWidth);b=1;a.custom_color?c.fillcolor=a.custom_color:1<e.fFillColor&&1==e.fLineColor?c.fillcolor=g.Painter.root_colors[e.fFillColor]:0<=e.fLineColor&&(c.fillcolor=g.Painter.root_colors[e.fLineColor]);e.fMedium&&e.fMedium.fMaterial&&
(a=e.fMedium.fMaterial,d=a.fFillStyle,d=3E3>d||3100<d?0:d-3E3,this.use_dflt_colors&&(c.fillcolor=g.Painter.root_colors[this.dflt_table[Math.round(a.fZ)]],.1>a.fDensity&&(d=60)),0<d&&(b=(100-d)/100),void 0===c.fillcolor&&(c.fillcolor=g.Painter.root_colors[a.fFillColor]));void 0===c.fillcolor&&(c.fillcolor="lightgrey");c.material=new q.MeshLambertMaterial({transparent:1>b,opacity:b,wireframe:!1,color:c.fillcolor,side:q.FrontSide,vertexColors:q.NoColors,depthWrite:1==b});c.material.inherentOpacity=b;
return c};g.GEO.ClonedNodes.prototype.CreateObject3D=function(a,c,b){for(var d=this.nodes[0],e=c,f=0,g="object"==typeof b||"force"===b,h=0;h<=a.length;++h){var l=0<h?a[h-1]:0;0<h&&(d=this.nodes[d.chlds[l]]);var n=void 0;if(e.children)for(var p=0;p<e.children.length;++p)if(e.children[p].nchld===l){n=e.children[p];break}if(n)e=n,n.$jsroot_drawable&&f++;else{if(!g)return null;n=new q.Object3D;d.matrix&&(n.matrix.fromArray(d.matrix),n.matrix.decompose(n.position,n.quaternion,n.scale));n.nchld=l;e.add(n);
0==h&&"object"==typeof b&&b.scale&&(0>b.scale.x||0>b.scale.y||0>b.scale.z)&&(n.scale.copy(b.scale),n.updateMatrix());n.updateMatrixWorld();e=n}}if("mesh"===b||"delete_mesh"===b){a=null;if(e)for(d=0;d<e.children.length&&!a;++d)f=e.children[d],"Mesh"===f.type&&void 0===f.nchld&&(a=f);if("mesh"===b||!a)return a;for(b=e;a&&a!==c;)e=a.parent,e.remove(a),a=0==e.children.length?e:null;return b}e&&(e.$jsroot_drawable=!0,e.$jsroot_depth=f);return e};g.GEO.ClonedNodes.prototype.GetVolumeBoundary=function(a,
c,b){var d={min:0,max:1,sortidcut:0};if(!this.sortmap)return console.error("sorting map do not exist"),d;for(var e,f,g=0,h=0,l=0;l<this.sortmap.length&&g<b&&h<c;++l){var n=this.sortmap[l];0!==a[n]&&(f=this.nodes[n],e||(e=f),g+=a[n],h+=a[n]*f.nfaces)}if(!f)return console.error("no volumes selected"),d;d.max=e.vol;d.min=f.vol;d.sortidcut=f.sortid;return d};g.GEO.ClonedNodes.prototype.CollectVisibles=function(a,c){if(this.plain_shape)return{lst:[{nodeid:0,seqid:0,stack:[],factor:1,shapeid:0,server_shape:this.plain_shape}],
complete:!0};var b={facecnt:0,viscnt:Array(this.nodes.length),vislvl:this.GetVisLevel(),reset:function(){for(var a=this.facecnt=this.total=0;a<this.viscnt.length;++a)this.viscnt[a]=0},func:function(a){this.total++;this.facecnt+=a.nfaces;this.viscnt[a.id]++;return!0}};b.reset();var d=this.ScanVisible(b),e=this.GetMaxVisNodes();if(0<e)for(;d>e&&1<b.vislvl;)b.vislvl--,b.reset(),d=this.ScanVisible(b);this.actual_level=b.vislvl;var f=0,g=0,h=-1,l=10,n=this.nodes.length+1;console.log("Total visible nodes "+
d+" numfaces "+b.facecnt);if(b.facecnt>a&&(d=this.GetVolumeBoundary(b.viscnt,a*(c?.8:1),e*(c?.8:1)),f=d.min,g=d.max,n=d.sortidcut,c)){b.domatrix=!0;b.frustum=c;b.totalcam=0;b.func=function(a){a.vol<=f&&this.frustum.CheckShape(this.getmatrix(),a)&&(this.viscnt[a.id]++,this.totalcam+=a.nfaces);return!0};for(c=0;c<b.viscnt.length;++c)b.viscnt[c]=0;this.ScanVisible(b);h=b.totalcam>.2*a?this.GetVolumeBoundary(b.viscnt,.2*a,.2*e).min:0;l=g/(0<h?0<h:f)}b.items=[];b.func=function(a){a.sortid<n?this.items.push(this.CopyStack()):
0<=h&&a.vol>h&&this.frustum.CheckShape(this.getmatrix(),a)&&this.items.push(this.CopyStack(l));return!0};this.ScanVisible(b);return{lst:b.items,complete:0===f}};g.GEO.ClonedNodes.prototype.MergeVisibles=function(a,c){for(var b=0,d=[],e=0;e<a.length&&b<c.length;++e){for(;b<c.length&&c[b].seqid<a[e].seqid;)d.push(c[b++]);b<c.length&&c[b].seqid===a[e].seqid&&(c[b].done&&(a[e].done=!0),b++)}for(;b<c.length;)d.push(c[b++]);return d};g.GEO.ClonedNodes.prototype.CollectShapes=function(a){if(this.plain_shape)return[this.plain_shape];
for(var c=[],b=0;b<a.length;++b){var d=a[b],e=this.GetNodeShape(d.nodeid);e&&(void 0===e._id?(e._id=c.length,c.push({id:e._id,shape:e,vol:this.nodes[d.nodeid].vol,refcnt:1,factor:1,ready:!1})):c[e._id].refcnt++,d.shape=c[e._id],d.factor&&d.factor>d.shape.factor&&(d.shape.factor=d.factor))}c.sort(function(a,b){return b.vol*b.factor-a.vol*a.factor});for(b=0;b<c.length;++b)d=c[b],d.id=b,delete d.shape._id;for(b=0;b<a.length;++b)d=a[b],d.shape&&(d.shapeid=d.shape.id,delete d.shape);return c};g.GEO.ClonedNodes.prototype.MergeShapesLists=
function(a,c){if(!a)return c;for(var b=0;b<a.length;++b){var d=a[b];d.shape._geom=d.geom;delete d.geom;void 0!==d.geomZ&&(d.shape._geomZ=d.geomZ,delete d.geomZ)}for(b=0;b<c.length;++b)d=c[b],void 0!==d.shape._geom&&(d.geom=d.shape._geom,delete d.shape._geom),void 0!==d.shape._geomZ&&(d.geomZ=d.shape._geomZ,delete d.shape._geomZ);for(b=0;b<a.length;++b)d=a[b],delete d.shape._geom,delete d.shape._geomZ;return c};g.GEO.ClonedNodes.prototype.BuildShapes=function(a,c,b){for(var d=0,e=(new Date).getTime(),
f={done:!1,shapes:0,faces:0,notusedshapes:0},k=0;k<a.length;++k){var h=a[k];if(f.done)h.ready=!0;else if(h.ready||(h._typename="$$Shape$$",h.ready=!0,void 0===h.geom&&(h.geom=g.GEO.createGeometry(h.shape),h.geom&&d++),h.nfaces=g.GEO.numGeometryFaces(h.geom)),f.shapes++,h.used||f.notusedshapes++,f.faces+=h.nfaces*h.refcnt,f.faces>=c)f.done=!0;else if(d>.01*a.length&&void 0!==b&&(new Date).getTime()-e>b)return f}f.done=!0;return f};g.GEO.ObjectName=function(a){return a&&a.fName?a.fName+(a.$geo_suffix?
a.$geo_suffix:""):""};g.GEO.CheckDuplicates=function(a,c){if(a){if(a.$geo_checked)return;a.$geo_checked=!0}a=[];for(var b=[],d=0;d<c.length;++d){var e=c[d];if(e&&e.fName){if(!e.$geo_suffix){var f=a.indexOf(e.fName);if(0<=f){for(var k=b[f]||1;0<=a.indexOf(e.fName+"#"+k);)++k;e.$geo_suffix="#"+k;b[f]=k+1}}a.push(g.GEO.ObjectName(e))}}};g.GEO.createFlippedMesh=function(a,c,b){a=new q.Vector3(1,1,-1);if(void 0===c.geomZ)if("BufferGeometry"==c.geom.type){var d=c.geom.getAttribute("position").array,e=c.geom.getAttribute("normal").array,
f=c.geom.getIndex();if(f){f=f.array;var g=c.geom.drawRange.start,h=c.geom.drawRange.count;g+h>f.length&&(h=f.length-g);for(var l=new Float32Array(3*h),n=new Float32Array(3*h),p=0;p<h;++p){var m=f[g+p];(0>m||3*m>=d.length)&&console.log("strange index",3*m,d.length);l[3*p]=d[3*m];l[3*p+1]=d[3*m+1];l[3*p+2]=d[3*m+2];n[3*p]=e[3*m];n[3*p+1]=e[3*m+1];n[3*p+2]=e[3*m+2]}d=l;e=n}g=d.length;h=0;l=new Float32Array(g);n=new Float32Array(g);for(f=0;f<g;f+=3)l[f]=d[f+h],l[f+1]=d[f+1+h],l[f+2]=-d[f+2+h],n[f]=e[f+
h],n[f+1]=e[f+1+h],n[f+2]=-e[f+2+h],h+=3,6===h&&(h=-3);c.geomZ=new q.BufferGeometry;c.geomZ.addAttribute("position",new q.BufferAttribute(l,3));c.geomZ.addAttribute("normal",new q.BufferAttribute(n,3))}else for(c.geomZ=c.geom.clone(),c.geomZ.scale(a.x,a.y,a.z),f=0;f<c.geomZ.faces.length;)d=geom.faces[f++],e=d.b,d.b=d.c,d.c=e;c=new q.Mesh(c.geomZ,b);c.scale.copy(a);c.updateMatrix();c._flippedMesh=!0;return c};g.GEO.cleanupShape=function(a){a&&(a.geom&&"funciton"==typeof a.geom.dispose&&a.geom.dispose(),
a.geomZ&&"funciton"==typeof a.geomZ.dispose&&a.geomZ.dispose(),delete a.geom,delete a.geomZ)};g.GEO.produceRenderOrder=function(a,c,b,d){function e(a){a&&a.traverse(function(a){a.renderOrder=0;a.material&&(a.material.depthWrite=!0)})}function f(a,b,c){if(a.children)for(var d=0;d<a.children.length;++d){var g=a.children[d];g.$jsroot_order===b?g.material&&(g.material.transparent?(g.material.depthWrite=!1,c.push(g)):e(g)):(void 0===a.$jsroot_depth||a.$jsroot_depth<b)&&f(g,b,c)}}function k(a,e,f){if(300<
a.length){for(var h=0;h<a.length;++h)a[h].renderOrder=(e+f)/2;return!1}var k=new q.Vector3;for(h=0;h<a.length;++h){var n=a[h],m=n.$jsroot_box3;m||(n.$jsroot_box3=m=g.GEO.getBoundingBox(n));if("size"===b)n.$jsroot_distance=m.getSize(new q.Vector3);else if("pnt"===b)n.$jsroot_distance=c.distanceTo(m.getCenter(k));else{var p=Math.min(c.distanceTo(m.min),c.distanceTo(m.max)),u=new q.Vector3(m.min.x,m.min.y,m.max.z);p=Math.min(p,c.distanceTo(u));u.set(m.min.x,m.max.y,m.min.z);p=Math.min(p,c.distanceTo(u));
u.set(m.max.x,m.min.y,m.min.z);p=Math.min(p,c.distanceTo(u));u.set(m.max.x,m.max.y,m.min.z);p=Math.min(p,c.distanceTo(u));u.set(m.max.x,m.min.y,m.max.z);p=Math.min(p,c.distanceTo(u));u.set(m.min.x,m.max.y,m.max.z);p=Math.min(p,c.distanceTo(u));n.$jsroot_distance=p}}a.sort(function(a,b){return a.$jsroot_distance-b.$jsroot_distance});p=Array(a.length);for(h=0;h<a.length;++h)a[h].$jsroot_index=h,p[h]=a[h];if("ray"===b)for(h=a.length-1;0<=h;--h){n=a[h];m=n.$jsroot_box3;m=m.getCenter(k);for(u=0;2>u;++u){m.sub(c).normalize();
l.set(c,m);var x=l.intersectObjects(a,!1),y=[];for(m=0;m<x.length;++m)0>y.indexOf(x[m].object)&&y.push(x[m].object);x=y;0>x.indexOf(n)&&0<u&&console.log("MISS",d?d.ResolveStack(n.stack).name:"???");if(0<=x.indexOf(n)||0<u)break;m=n.geometry.attributes.position.array;m=new q.Vector3((m[0]+m[3]+m[6])/3,(m[1]+m[4]+m[7])/3,(m[2]+m[5]+m[8])/3);m.applyMatrix4(n.matrixWorld)}for(m=0;m<x.length-1;++m)if(n=x[m+1],u=x[m].$jsroot_index,y=n.$jsroot_index,!(u<y)){for(;y<u;++y)p[y]=p[y+1],p[y].$jsroot_index=y;
p[u]=n;n.$jsroot_index=u}}for(h=0;h<p.length;++h)p[h].renderOrder=f-(h+1)/(p.length+1)*(f-e),delete p[h].$jsroot_index,delete p[h].$jsroot_distance;return!0}function h(a,b,c,d){var e=[],g=!1;f(a,b,e);if(e.length){if(c===d)for(a=0;a<e.length;++a)e[a].renderOrder=c;else(g=k(e,c,d))||(c=d=(c+d)/2);for(a=0;a<e.length;++a){var l=e[a].parent,m=c,n=d;g&&(n=e[a].renderOrder,m=n-(d-c)/(e.length+2));h(l,b+1,m,n)}}}var l=new q.Raycaster;b&&"dflt"!==b?h(a,0,1,1E6):e(a)};g.GEO.build=function(a,c,b){if(a){c||(c=
{});c.numfaces||(c.numfaces=1E5);c.numnodes||(c.numnodes=1E3);c.frustum||(c.frustum=null);c.res_mesh=c.res_faces=0;var d=null,e=!1;"fShapeBits"in a&&"fShapeId"in a?(d=a,a=null):"TGeoVolumeAssembly"===a._typename||"TGeoVolume"===a._typename?d=a.fShape:"TEveGeoShapeExtract"===a._typename||"ROOT::Experimental::REveGeoShapeExtract"===a._typename?d=a.fShape:"TGeoManager"===a._typename?(a=a.fMasterVolume,e=!c.showtop,d=a.fShape):a.fVolume?d=a.fVolume.fShape:a=null;c.composite&&d&&"TGeoCompositeShape"==
d._typename&&d.fNode&&(a=g.GEO.buildCompositeVolume(d));!a&&d&&(a=g.extend(g.Create("TEveGeoShapeExtract"),{fTrans:null,fShape:d,fRGBA:[0,1,0,1],fElements:null,fRnrSelf:!0}));if(!a)return null;0===a._typename.indexOf("TGeoVolume")&&(a={_typename:"TGeoNode",fVolume:a,fName:a.fName,$geoh:a.$geoh,_proxy:!0});a=new g.GEO.ClonedNodes(a);a.SetVisLevel(c.vislevel);a.SetMaxVisNodes(c.numnodes);c.dflt_colors&&a.SetDefaultColors(!0);0>=(c.no_screen?0:a.MarkVisibles(!0))?a.MarkVisibles(!1,!1,e):a.MarkVisibles(!0,
!0,e);a.ProduceIdShits();e=a.CollectVisibles(c.numfaces,c.frustum).lst;var f=a.CollectShapes(e);a.BuildShapes(f,c.numfaces);for(var k=new q.Object3D,h=0;h<e.length;++h){var l=e[h];if(!l.done){d=f[l.shapeid];if(!d.ready){console.warn("shape marked as not ready when should");break}l.done=!0;d.used=!0;if(d.geom&&0!==d.nfaces){var n=a.getDrawEntryProperties(l);c.res_mesh++;c.res_faces+=d.nfaces;l=a.CreateObject3D(l.stack,k,c);n.material.wireframe=c.wireframe;n.material.side=c.doubleside?q.DoubleSide:
q.FrontSide;d=-.9<l.matrixWorld.determinant()?new q.Mesh(d.geom,n.material):g.GEO.createFlippedMesh(l,d,n.material);l.add(d)}else a.CreateObject3D(l.stack,k,"delete_mesh")}}g.CallBack(b,k);return k}};g.GEO.getBoundingBox=function(a,c,b){if(!a||!a.geometry)return c;c||(c=new q.Box3,c.makeEmpty());b||a.updateMatrixWorld();var d=new q.Vector3,e=a.geometry;if(e.isGeometry){var f=e.vertices;e=0;for(var g=f.length;e<g;e++)d.copy(f[e]),b||d.applyMatrix4(a.matrixWorld),c.expandByPoint(d)}else if(e.isBufferGeometry&&
(f=e.attributes.position,void 0!==f))for(e=0,g=f.count;e<g;e++)d.fromBufferAttribute(f,e),b||d.applyMatrix4(a.matrixWorld),c.expandByPoint(d);return c};return g});
