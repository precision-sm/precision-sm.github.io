var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(e,K,M){e!=Array.prototype&&e!=Object.prototype&&(e[K]=M.value)};$jscomp.getGlobal=function(e){return"undefined"!=typeof window&&window===e?e:"undefined"!=typeof global&&null!=global?global:e};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(e,K,M,h){if(K){M=$jscomp.global;e=e.split(".");for(h=0;h<e.length-1;h++){var fa=e[h];fa in M||(M[fa]={});M=M[fa]}e=e[e.length-1];h=M[e];K=K(h);K!=h&&null!=K&&$jscomp.defineProperty(M,e,{configurable:!0,writable:!0,value:K})}};$jscomp.arrayIteratorImpl=function(e){var K=0;return function(){return K<e.length?{done:!1,value:e[K++]}:{done:!0}}};$jscomp.arrayIterator=function(e){return{next:$jscomp.arrayIteratorImpl(e)}};$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(e,K){this.$jscomp$symbol$id_=e;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:K})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function e(M){if(this instanceof e)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(M||"")+"_"+K++,M)}var K=0;return e}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var e=$jscomp.global.Symbol.iterator;e||(e=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[e]&&$jscomp.defineProperty(Array.prototype,e,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var e=$jscomp.global.Symbol.asyncIterator;e||(e=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(e){$jscomp.initSymbolIterator();e={next:e};e[$jscomp.global.Symbol.iterator]=function(){return this};return e};
$jscomp.iteratorFromArray=function(e,K){$jscomp.initSymbolIterator();e instanceof String&&(e+="");var M=0,h={next:function(){if(M<e.length){var fa=M++;return{value:K(fa,e[fa]),done:!1}}h.next=function(){return{done:!0,value:void 0}};return h.next()}};h[Symbol.iterator]=function(){return h};return h};$jscomp.polyfill("Array.prototype.entries",function(e){return e?e:function(){return $jscomp.iteratorFromArray(this,function(e,M){return[e,M]})}},"es6","es3");
(function(e){if("function"===typeof define&&define.amd)define(["JSRootCore","d3","JSRootPainter.hist","threejs","threejs_all"],e);else if("object"===typeof exports&&"undefined"!==typeof module){var K=require("./JSRootCore.js");e(K,require("d3"),require("./JSRootPainter.hist.js"),require("three"),require("./three.extra.min.js"),K.nodejs||"undefined"==typeof document?K.nodejs_document:document)}else{if("undefined"==typeof JSROOT)throw Error("JSROOT is not defined","JSRootPainter.hist3d.js");if("object"!=
typeof d3)throw Error("This extension requires d3.js","JSRootPainter.hist3d.js");if("undefined"==typeof THREE)throw Error("THREE is not defined","JSRootPainter.hist3d.js");e(JSROOT,d3,JSROOT,THREE,THREE)}})(function(e,K,M,h,fa,ja){function Q(a){e.THistPainter.call(this,a);this.mode3d=!0}function X(a){e.TObjectPainter.call(this,a)}e.sources.push("hist3d");"undefined"==typeof ja&&"object"==typeof window&&(ja=window.document);if("undefined"===typeof e.THistPainter)throw Error("JSROOT.THistPainter is not defined",
"JSRootPainter.hist3d.js");e.TFramePainter.prototype.SetCameraPosition=function(a,b){var c=Math.max(.75*this.size_xy3d,this.size_z3d);a&&this.camera.position.set(-1.6*c,-3.5*c,1.4*this.size_z3d);if(!(!b||!a&&this.zoom_changed_interactive||isNaN(b.fTheta)||isNaN(b.fPhi)||b.fTheta===this.camera_Theta&&b.fPhi===this.camera_Phi)){c=3*Math.max(this.size_xy3d,this.size_z3d);a=(-b.fPhi-90)/180*Math.PI;var d=b.fTheta/180*Math.PI;this.camera_Phi=b.fPhi;this.camera_Theta=b.fTheta;this.camera.position.set(c*
Math.cos(a)*Math.cos(d),c*Math.sin(a)*Math.cos(d),this.size_z3d+c*Math.sin(d));a=!0}a&&this.camera.lookAt(this.lookat)};e.TFramePainter.prototype.Create3DScene=function(a){if(void 0!==a&&0>a)this.mode3d&&(this.TestAxisVisibility(null,this.toplevel),this.clear_3d_canvas(),e.Painter.DisposeThreejsObject(this.scene),this.control&&this.control.Cleanup(),this.renderer&&(this.renderer.dispose&&this.renderer.dispose(),this.renderer.context&&delete this.renderer.context),delete this.size_xy3d,delete this.size_z3d,
delete this.tooltip_mesh,delete this.scene,delete this.toplevel,delete this.camera,delete this.pointLight,delete this.renderer,delete this.control,"render_tmout"in this&&(clearTimeout(this.render_tmout),delete this.render_tmout),this.mode3d=!1);else if(this.mode3d=!0,"toplevel"in this)this.scene.remove(this.toplevel),e.Painter.DisposeThreejsObject(this.toplevel),delete this.tooltip_mesh,delete this.toplevel,this.control&&this.control.HideTooltip(),a=new h.Object3D,this.scene.add(a),this.toplevel=
a,this.Resize3D(),this.SetCameraPosition(!1,this.root_pad());else{this.usesvg=e.Painter.UseSVGFor3D();a=this.size_for_3d(this.usesvg?3:void 0);this.size_z3d=100;this.size_xy3d=10<a.height&&10<a.width?Math.round(a.width/a.height*this.size_z3d):this.size_z3d;this.scene=new h.Scene;this.toplevel=new h.Object3D;this.scene.add(this.toplevel);this.scene_width=a.width;this.scene_height=a.height;this.camera=new h.PerspectiveCamera(45,this.scene_width/this.scene_height,1,40*this.size_z3d);this.camera_Theta=
this.camera_Phi=30;this.pointLight=new h.PointLight(16777215,1);this.camera.add(this.pointLight);this.pointLight.position.set(this.size_xy3d/2,this.size_xy3d/2,this.size_z3d/2);this.lookat=new h.Vector3(0,0,.8*this.size_z3d);this.camera.up=new h.Vector3(0,0,1);this.scene.add(this.camera);this.SetCameraPosition(!0,this.root_pad());var b=e.Painter.Create3DRenderer(this.scene_width,this.scene_height,this.usesvg,4==a.can3d);this.renderer=b.renderer;this.webgl=b.usewebgl;this.add_3d_canvas(a,b.dom);this.first_render_tm=
0;this.enable_highlight=!1;if(!e.BatchMode){this.control=e.Painter.CreateOrbitControl(this,this.camera,this.scene,this.renderer,this.lookat);var c=this,d=this.main_painter();this.control.ProcessMouseMove=function(a){for(var b=null,d=null,f=null,e=0;e<a.length;++e)if(a[e].object.tooltip){if(b=a[e].object.tooltip(a[e])){d=a[e].object;break}}else a[e].object.zoom&&!f&&(f=a[e].object);b&&!b.use_itself&&(a=1E-4*c.size_xy3d,e=1E-4*c.size_z3d,(b.x1>b.x2||b.y1>b.y2||b.z1>b.z2)&&console.warn("check 3D hints coordinates"),
b.x1-=a,b.x2+=a,b.y1-=a,b.y2+=a,b.z1-=e,b.z2+=e);c.BinHighlight3D(b,d);return!b&&f&&c.Get3DZoomCoord?(d=f.GlobalIntersect(this.raycaster),b=f.zoom,d=c.Get3DZoomCoord(d,b),"z"===b&&f.use_y_for_z&&(b="y"),f=c.GetAxis(b),a={name:b,title:"TAxis",line:"any info",only_status:!0},f&&(a.name=f.fName,a.title=f.fTitle||"histogram TAxis object"),a.line=b+" : "+c.AxisAsText(b,d),a):b&&b.lines?b:""};this.control.ProcessMouseLeave=function(){c.BinHighlight3D(null)};this.control.ContextMenu=function(a,b){var c=
"hist",f=d;if(b)for(var e=0;e<b.length;++e){var m=b[e].object;if(m.zoom){c=m.zoom;f=d.frame_painter();break}if(m.painter&&"function"===typeof m.painter.ShowContextMenu){f=m.painter;break}}"function"==typeof f.ShowContextMenu&&f.ShowContextMenu(c,a)}}}};e.TFramePainter.prototype.SetActive=function(a){this.control&&(this.control.enableKeys=a&&e.key_handling)};e.TFramePainter.prototype.Render3D=function(a){if(-1111===a){a=h.CreateSVGRenderer(!1,0,ja);a.setSize(this.scene_width,this.scene_height);a.render(this.scene,
this.camera);if(a.makeOuterHTML){var b=ja.createElement("div");b.innerHTML=a.makeOuterHTML();return b.childNodes[0]}return a.domElement}void 0===a&&(a=5);if(0>=a||this.usesvg||e.BatchMode){if("render_tmout"in this)clearTimeout(this.render_tmout);else if(-2222===a)return;void 0!==this.renderer&&(a=new Date,this.opt3d||(this.opt3d={FrontBox:!0,BackBox:!0}),this.TestAxisVisibility(this.camera,this.toplevel,this.opt3d.FrontBox,this.opt3d.BackBox),this.renderer.render(this.scene,this.camera),0===this.first_render_tm&&
this.renderer instanceof h.SoftwareRenderer&&this.renderer.render(this.scene,this.camera),e.Painter.AfterRender3D(this.renderer),b=new Date,delete this.render_tmout,0===this.first_render_tm&&(this.first_render_tm=b.getTime()-a.getTime(),this.enable_highlight=1200>this.first_render_tm&&this.IsTooltipAllowed(),console.log("First render tm = "+this.first_render_tm)))}else"render_tmout"in this||(this.render_tmout=setTimeout(this.Render3D.bind(this,0),a))};e.TFramePainter.prototype.Resize3D=function(){var a=
this.size_for_3d(this.access_3d_kind());this.apply_3d_size(a);if(this.scene_width===a.width&&this.scene_height===a.height||10>a.width||10>a.height)return!1;this.scene_width=a.width;this.scene_height=a.height;this.camera.aspect=this.scene_width/this.scene_height;this.camera.updateProjectionMatrix();this.renderer.setSize(this.scene_width,this.scene_height);return!0};e.TFramePainter.prototype.BinHighlight3D=function(a,b){var c=!1,d=null,z=!0,w=!a||void 0===a.x1||!this.enable_highlight,q=this.main_painter();
q&&!q.IsUserTooltipCallback()&&(q=null);this.tooltip_selfmesh&&(z=this.tooltip_selfmesh!==b,this.tooltip_selfmesh.material.color=this.tooltip_selfmesh.save_color,delete this.tooltip_selfmesh,c=!0);this.tooltip_mesh&&(d=this.tooltip_mesh,this.toplevel.remove(this.tooltip_mesh),delete this.tooltip_mesh,c=!0);if(w)c&&this.Render3D(),q&&c&&q.ProvideUserTooltip(null);else{if(a.use_itself)b.save_color=b.material.color,b.material.color=new h.Color(a.color),this.tooltip_selfmesh=b,c=z;else{c=!0;b=e.Painter.Box3D.Indexes;
z=e.Painter.Box3D.Normals;w=e.Painter.Box3D.Vertices;var f=new h.Color(a.color?a.color:16711680),u=a.opacity||1;if(d){var m=d.geometry.attributes.position.array;d.geometry.attributes.position.needsUpdate=!0;d.material.color=f;d.material.opacity=u}else{m=new Float32Array(3*b.length);var g=new Float32Array(3*b.length);d=new h.BufferGeometry;d.addAttribute("position",new h.BufferAttribute(m,3));d.addAttribute("normal",new h.BufferAttribute(g,3));f=new h.MeshBasicMaterial({color:f,opacity:u,flatShading:!0});
d=new h.Mesh(d,f)}a.x1===a.x2&&console.warn("same tip X",a.x1,a.x2);a.y1===a.y2&&console.warn("same tip Y",a.y1,a.y2);a.z1===a.z2&&(a.z2=a.z1+1E-4);f=0;for(u=-3;f<b.length;++f){var t=w[b[f]];m[3*f]=a.x1+t.x*(a.x2-a.x1);m[3*f+1]=a.y1+t.y*(a.y2-a.y1);m[3*f+2]=a.z1+t.z*(a.z2-a.z1);g&&(0===f%6&&(u+=3),g[3*f]=z[u],g[3*f+1]=z[u+1],g[3*f+2]=z[u+2])}this.tooltip_mesh=d;this.toplevel.add(d)}c&&this.Render3D();c&&a.$painter&&"function"==typeof a.$painter.RedrawProjection&&a.$painter.RedrawProjection(a.ix-1,
a.ix,a.iy-1,a.iy);c&&q&&q.GetObject()&&q.ProvideUserTooltip({obj:q.GetObject(),name:q.GetObject().fName,bin:a.bin,cont:a.value,binx:a.ix,biny:a.iy,binz:a.iz,grx:(a.x1+a.x2)/2,gry:(a.y1+a.y2)/2,grz:(a.z1+a.z2)/2})}};e.TFramePainter.prototype.TestAxisVisibility=function(a,b,c,d){function e(a,b){a<=f&&(a+=4);return a>f&&a<f+b}if(b&&b.children)for(var h=0;h<b.children.length;++h){var q=b.children[h];if(q.axis_draw)break;q=void 0}if(q)if(a){c=c?!0:!1;d=d?!0:!1;var f=1;h=a.position;0>h.x&&0<=h.y&&(f=2);
0<=h.x&&0<=h.y&&(f=3);0<=h.x&&0>h.y&&(f=4);for(h=0;h<q.children.length;++h)if(a=q.children[h],a.grid)a.visible=d&&e(a.grid,3);else if(a.zid)a.visible=e(a.zid,2);else if(a.xyid)a.visible=e(a.xyid,3);else if(a.xyboxid){b=5;var u=0;d&&!c?(b=3,u=-2):c&&!d?b=3:c||d||(b=a.bottom?3:0);a.visible=e(a.xyboxid+u,b);!a.visible&&a.bottom&&d&&(a.visible=e(a.xyboxid,3))}else a.zboxid&&(b=2,u=0,c&&d?b=5:d&&!c?b=4:!d&&c&&(u=-2,b=4),a.visible=e(a.zboxid+u,b))}else b.remove(q)};e.TFramePainter.prototype.Set3DOptions=
function(a){this.opt3d=a};e.TFramePainter.prototype.DrawXYZ=function(a,b){function c(a,b,d){var c=new h.Geometry;"z"===a?c.vertices.push(new h.Vector3(0,0,0),new h.Vector3(4*A,0,0),new h.Vector3(4*A,0,2*b),new h.Vector3(0,0,2*b)):c.vertices.push(new h.Vector3(-b,0,0),new h.Vector3(b,0,0),new h.Vector3(b,4*-A,0),new h.Vector3(-b,4*-A,0));c.faces.push(new h.Face3(0,2,1));c.faces.push(new h.Face3(0,3,2));c.computeFaceNormals();var f=new h.MeshBasicMaterial({transparent:!0,vertexColors:h.NoColors,side:h.DoubleSide,
opacity:0});c=new h.Mesh(c,f);c.zoom=a;c.size_3d=b;c.use_y_for_z=d;"y"==a&&c.rotateZ(Math.PI/2).rotateX(Math.PI);c.GlobalIntersect=function(a){var b=new h.Plane,c=this.geometry;if(c&&c.vertices&&(b.setFromCoplanarPoints(c.vertices[0],c.vertices[1],c.vertices[2]),b.applyMatrix4(this.matrixWorld),c=a.ray.origin.clone(),a=c.clone().addScaledVector(a.ray.direction,1E10),b=b.intersectLine(new h.Line3(c,a),new h.Vector3)))return a=-this.size_3d,c=this.size_3d,"z"===this.zoom&&(a=0,c=2*this.size_3d),b[this.zoom]<
a?b[this.zoom]=a:b[this.zoom]>c&&(b[this.zoom]=c),b};c.ShowSelection=function(a,b){var c=this.children?this.children[0]:null,d=this.zoom;if(!a||!b)return c&&(this.remove(c),e.Painter.DisposeThreejsObject(c)),c;if(c)var f=c.geometry;else f=this.geometry.clone(),"z"===d?f.vertices[1].x=f.vertices[2].x=A:f.vertices[2].y=f.vertices[3].y=-A,c=new h.Mesh(f,new h.MeshBasicMaterial({color:65280,side:h.DoubleSide})),this.add(c);"z"==d?(f.vertices[0].z=f.vertices[1].z=a[d],f.vertices[2].z=f.vertices[3].z=b[d]):
(f.vertices[0].x=f.vertices[3].x=a[d],f.vertices[1].x=f.vertices[2].x=b[d]);f.computeFaceNormals();f.verticesNeedUpdate=!0;return f.normalsNeedUpdate=!0};return c}b||(b={});var d=-this.size_xy3d,z=this.size_xy3d,w=-this.size_xy3d,q=this.size_xy3d,f=0,u=2*this.size_z3d,m=Math.round(.05*this.size_z3d),g=this.root_pad(),t=this.xmin,y=this.xmax,l=this.ymin,p=this.ymax,k=this.zmin,n=this.zmax,v=!1,r=!1;this.size_z3d||(d=this.xmin,z=this.xmax,w=this.ymin,q=this.ymax,f=this.zmin,u=this.zmax,m=.05*(u-f));
"zoom_xmin"in this&&"zoom_xmax"in this&&this.zoom_xmin!==this.zoom_xmax&&(t=this.zoom_xmin,y=this.zoom_xmax);"zoom_ymin"in this&&"zoom_ymax"in this&&this.zoom_ymin!==this.zoom_ymax&&(l=this.zoom_ymin,p=this.zoom_ymax,v=!0);"zoom_zmin"in this&&"zoom_zmax"in this&&this.zoom_zmin!==this.zoom_zmax&&(k=this.zoom_zmin,n=this.zoom_zmax,r=!0);b.use_y_for_z&&(this.zmin=this.ymin,this.zmax=this.ymax,k=l,n=p,r=v,l=0,p=1);this.lego_zmin=k;this.lego_zmax=n;void 0===b.zmult||r||(n*=b.zmult);if(g&&g.fLogx){0>=y&&
(y=1);if(0>=t&&this.xaxis)for(v=0;v<this.xaxis.fNbins&&!(t=Math.max(t,this.xaxis.GetBinLowEdge(v+1)),0<t);++v);0>=t&&(t=1E-4*y);this.grx=K.scaleLog();this.x_kind="log"}else this.grx=K.scaleLinear(),this.x_kind=this.xaxis&&this.xaxis.fLabels?"labels":"normal";this.logx="log"===this.x_kind;this.grx.domain([t,y]).range([d,z]);this.x_handle=new e.TAxisPainter(this.xaxis);this.x_handle.SetAxisConfig("xaxis",this.x_kind,this.grx,this.xmin,this.xmax,t,y);this.x_handle.CreateFormatFuncs();this.scale_xmin=
t;this.scale_xmax=y;if(g&&g.fLogy&&!b.use_y_for_z){0>=p&&(p=1);if(0>=l&&this.yaxis)for(v=0;v<this.yaxis.fNbins&&!(l=Math.max(l,this.yaxis.GetBinLowEdge(v+1)),0<l);++v);0>=l&&(l=1E-4*p);this.gry=K.scaleLog();this.y_kind="log"}else this.gry=K.scaleLinear(),this.y_kind=this.yaxis&&this.yaxis.fLabels?"labels":"normal";this.logy="log"===this.y_kind;this.gry.domain([l,p]).range([w,q]);this.y_handle=new e.TAxisPainter(this.yaxis);this.y_handle.SetAxisConfig("yaxis",this.y_kind,this.gry,this.ymin,this.ymax,
l,p);this.y_handle.CreateFormatFuncs();this.scale_ymin=l;this.scale_ymax=p;g&&g.fLogz?(0>=n&&(n=1),0>=k&&(k=1E-4*n),this.grz=K.scaleLog(),this.z_kind="log"):(this.grz=K.scaleLinear(),this.z_kind="normal",this.zaxis&&this.zaxis.fLabels&&3===b.ndim&&(this.z_kind="labels"));this.logz="log"===this.z_kind;this.grz.domain([k,n]).range([f,u]);this.SetRootPadRange(g,!0);this.z_handle=new e.TAxisPainter(this.zaxis);this.z_handle.SetAxisConfig("zaxis",this.z_kind,this.grz,this.zmin,this.zmax,k,n);this.z_handle.CreateFormatFuncs();
this.scale_zmin=k;this.scale_zmax=n;this.x_handle.debug=!0;var D=new h.MeshBasicMaterial({color:0});g=new h.LineBasicMaterial({color:0});var A=.5*m;y=[];var B=1;r=this.x_handle.CreateTicks(!1,!0);v=this.y_handle.CreateTicks(!1,!0);l=this.z_handle.CreateTicks(!1,!0);t=new h.Object3D;t.axis_draw=!0;a.add(t);a=[];for(var O=0,J=this.xaxis;r.next();){var H=r.grpos;k=1===r.kind;p=this.x_handle.format(r.tick,!0,!0);r.last_major()?J&&J.fTitle||(p="x"):null===p&&(k=!1,p="");if(k&&p&&0<p.length){p=new h.TextGeometry(p,
{font:e.threejs_font_helvetiker_regular,size:m,height:0,curveSegments:5});p.computeBoundingBox();n=p.boundingBox.max.x-p.boundingBox.min.x;var G=p.boundingBox.max.y-p.boundingBox.min.y;p.center=!0;O=Math.max(O,G);p.grx=H;y.push(p);r.last_major()||(G=r.next_major_grpos()-H,0<n&&(B=Math.min(B,.9*G/n)),this.x_handle.IsCenterLabels()&&(p.grx+=G/2))}a.push(H,0,0,H,k?-A:.6*-A,0)}J&&J.fTitle&&(p=new h.TextGeometry(J.fTitle,{font:e.threejs_font_helvetiker_regular,size:m,height:0,curveSegments:5}),p.computeBoundingBox(),
p.center=J.TestBit(e.EAxisBits.kCenterTitle),p.gry=2,p.grx=(d+z)/2,y.push(p));this.Get3DZoomCoord=function(a,b){a=a[b];var c=this["scale_"+b+"min"],d=this["scale_"+b+"max"];a="z"===b?a/2/this.size_z3d:(a+this.size_xy3d)/2/this.size_xy3d;return a=this["log"+b]?Math.exp(Math.log(c)+a*(Math.log(d)-Math.log(c))):c+a*(d-c)};var E=new h.Object3D;E.position.set(0,w,f);E.rotation.x=.25*Math.PI;E.xyid=2;a=e.Painter.createLineSegments(a,g);E.add(a);y.forEach(function(a){var b=a.boundingBox.max.x-a.boundingBox.min.x,
c=a.center?a.grx-b/2:z-b;b=new h.Matrix4;b.set(B,0,0,c,0,B,0,(-O*B-1.5*A)*(a.gry||1),0,0,1,0,0,0,0,1);a=new h.Mesh(a,D);a.applyMatrix(b);E.add(a)});b.zoom&&E.add(c("x",this.size_xy3d));t.add(E);E=new h.Object3D;E.position.set(0,q,f);E.rotation.x=.75*Math.PI;E.add(new h.LineSegments(a.geometry,g));y.forEach(function(a){var b=a.boundingBox.max.x-a.boundingBox.min.x,c=a.center?a.grx+b/2:z;b=new h.Matrix4;b.set(-B,0,0,c,0,B,0,(-O*B-1.5*A)*(a.gry||1),0,0,-1,0,0,0,0,1);a=new h.Mesh(a,D);a.applyMatrix(b);
E.add(a)});E.xyid=4;b.zoom&&E.add(c("x",this.size_xy3d));t.add(E);y=[];B=1;O=0;a=[];for(r=this.yaxis;v.next();)J=v.grpos,k=1===v.kind,p=this.y_handle.format(v.tick,!0,!0),v.last_major()?r&&r.fTitle||(p="y"):null===p&&(k=!1,p=""),k&&(p=new h.TextGeometry(p,{font:e.threejs_font_helvetiker_regular,size:m,height:0,curveSegments:5}),p.computeBoundingBox(),n=p.boundingBox.max.x-p.boundingBox.min.x,G=p.boundingBox.max.y-p.boundingBox.min.y,p.center=!0,O=Math.max(O,G),p.gry=J,y.push(p),v.last_major()||(G=
v.next_major_grpos()-J,0<n&&(B=Math.min(B,.9*G/n)),this.y_handle.IsCenterLabels()&&(p.gry+=G/2))),a.push(0,J,0,k?-A:.6*-A,J,0);r&&r.fTitle&&(p=new h.TextGeometry(r.fTitle,{font:e.threejs_font_helvetiker_regular,size:m,height:0,curveSegments:5}),p.computeBoundingBox(),p.center=r.TestBit(e.EAxisBits.kCenterTitle),p.grx=2,p.gry=(w+q)/2,y.push(p));if(!b.use_y_for_z){a=e.Painter.createLineSegments(a,g);var F=new h.Object3D;F.position.set(d,0,f);F.rotation.y=-.25*Math.PI;F.add(a);y.forEach(function(a){var b=
a.boundingBox.max.x-a.boundingBox.min.x,c=a.center?a.gry+b/2:q;b=new h.Matrix4;b.set(0,B,0,(-O*B-1.5*A)*(a.grx||1),-B,0,0,c,0,0,1,0,0,0,0,1);a=new h.Mesh(a,D);a.applyMatrix(b);F.add(a)});F.xyid=3;b.zoom&&F.add(c("y",this.size_xy3d));t.add(F);F=new h.Object3D;F.position.set(z,0,f);F.rotation.y=-.75*Math.PI;F.add(new h.LineSegments(a.geometry,g));y.forEach(function(a){var b=a.boundingBox.max.x-a.boundingBox.min.x,c=a.center?a.gry-b/2:q-b;b=new h.Matrix4;b.set(0,B,0,(-O*B-1.5*A)*(a.grx||1),B,0,0,c,0,
0,-1,0,0,0,0,1);a=new h.Mesh(a,D);a.applyMatrix(b);F.add(a)});F.xyid=1;b.zoom&&F.add(c("y",this.size_xy3d));t.add(F)}y=[];B=1;a=[];var L=J=H=null;v=this.zaxis;r=0;this.size_z3d&&(H=[],J=[]);for(;l.next();){var I=l.grpos;k=1==l.kind;p=this.z_handle.format(l.tick,!0,!0);null===p&&(k=!1,p="");k&&p&&(p=new h.TextGeometry(p,{font:e.threejs_font_helvetiker_regular,size:m,height:0,curveSegments:5}),p.computeBoundingBox(),n=p.boundingBox.max.x-p.boundingBox.min.x,G=p.boundingBox.max.y-p.boundingBox.min.y,
p.translate(-n,-G/2,0),p.grz=I,y.push(p),null!==L&&0<G&&(B=Math.min(B,.9*(I-L)/G)),r=Math.max(r,n),L=I);H&&k&&H.push(d,0,I,z,0,I);J&&k&&J.push(0,w,I,0,q,I);a.push(0,0,I,k?A:.6*A,0,I)}H&&0<H.length&&(l=new h.LineDashedMaterial({color:0,dashSize:2,gapSize:2}),p=e.Painter.createLineSegments(H,l),p.position.set(0,q,0),p.grid=2,p.visible=!1,t.add(p),l=new h.LineSegments(p.geometry,l),l.position.set(0,w,0),l.grid=4,l.visible=!1,t.add(l));J&&0<J.length&&(l=new h.LineDashedMaterial({color:0,dashSize:2,gapSize:2}),
p=e.Painter.createLineSegments(J,l),p.position.set(z,0,0),p.grid=3,p.visible=!1,t.add(p),l=new h.LineSegments(p.geometry,l),l.position.set(d,0,0),l.grid=1,l.visible=!1,t.add(l));var C=[];l=e.Painter.createLineSegments(a,g);for(var x=0;4>x;++x)C.push(new h.Object3D),y.forEach(function(a){var b=new h.Matrix4;b.set(-B,0,0,2*A,0,0,1,0,0,B,0,a.grz);a=new h.Mesh(a,D);a.applyMatrix(b);C[x].add(a)}),v&&v.fTitle&&(p=new h.TextGeometry(v.fTitle,{font:e.threejs_font_helvetiker_regular,size:m,height:0,curveSegments:5}),
p.computeBoundingBox(),n=p.boundingBox.max.x-p.boundingBox.min.x,G=p.boundingBox.max.y-p.boundingBox.min.y,k=v.TestBit(e.EAxisBits.kCenterTitle)?(u+f-n)/2:u-n,p.rotateZ(Math.PI/2),a=new h.Matrix4,a.set(-B,0,0,3*A+r,0,0,1,0,0,B,0,k),p=new h.Mesh(p,D),p.applyMatrix(a),C[x].add(p)),C[x].add(0==x?l:new h.LineSegments(l.geometry,g)),b.zoom&&C[x].add(c("z",this.size_z3d,b.use_y_for_z)),C[x].zid=x+2,t.add(C[x]);C[0].position.set(d,q,0);C[0].rotation.z=.75*Math.PI;C[1].position.set(z,q,0);C[1].rotation.z=
.25*Math.PI;C[2].position.set(z,w,0);C[2].rotation.z=-.25*Math.PI;C[3].position.set(d,w,0);C[3].rotation.z=-.75*Math.PI;if(0!==this.size_z3d){m=e.Painter.createLineSegments([d,0,0,z,0,0],g,null,!0);for(x=0;2>x;++x)b=new h.LineSegments(m,g),b.position.set(0,w,0===x?f:u),b.xyboxid=2,b.bottom=0==x,t.add(b),b=new h.LineSegments(m,g),b.position.set(0,q,0===x?f:u),b.xyboxid=4,b.bottom=0==x,t.add(b);w=e.Painter.createLineSegments([0,w,0,0,q,0],g,null,!0);for(x=0;2>x;++x)b=new h.LineSegments(w,g),b.position.set(d,
0,0===x?f:u),b.xyboxid=3,b.bottom=0==x,t.add(b),b=new h.LineSegments(w,g),b.position.set(z,0,0===x?f:u),b.xyboxid=1,b.bottom=0==x,t.add(b);d=e.Painter.createLineSegments([0,0,f,0,0,u],g,null,!0);for(x=0;4>x;++x)b=new h.LineSegments(d,g),b.zboxid=C[x].zid,b.position.copy(C[x].position),t.add(b)}};e.THistPainter.prototype.Draw3DBins=function(){function a(a,b,c){r=B.getBinContent(a+1,b+1);v=O?O.getBinContent(a+1,b+1):!1!==A.options.BaseLine?A.options.BaseLine:A.options.Zero?u:0;r<v&&(a=v,v=r,r=a);if(v>=
I||r<L)return!1;D=r===L||v>=r;return!D||0<c?!0:B.$baseh?!1:A.options.Zero||0<u?!0:A._show_empty_bins}if(this.draw_content){if(this.IsTH2Poly()&&this.DrawPolyLego)return this.DrawPolyLego();if(2==this.Dimension()&&this.options.Contour&&this.DrawContour3D)return this.DrawContour3D(!0);if(2==this.Dimension()&&this.options.Surf&&this.DrawSurf)return this.DrawSurf();if(2==this.Dimension()&&this.options.Error&&this.DrawError)return this.DrawError();var b=e.Painter.Box3D.Vertices,c=e.Painter.Box3D.Indexes,
d=e.Painter.Box3D.Normals,z=e.Painter.Box3D.Segments,w=[0,1,1,2,2,3,3,0],q=[new h.Vector3(0,0,0),new h.Vector3(0,1,0),new h.Vector3(1,1,0),new h.Vector3(1,0,0)],f=this.frame_painter(),u=f.grz.domain()[0],m=f.grz.domain()[1],g=this.PrepareColorDraw({rounding:!1,use3d:!0,extra:1}),t=g.i1,y=g.i2,l=g.j1,p=g.j2,k,n,v,r,D,A=this,B=this.GetHisto(),O=B?B.$baseh:null,J=11===this.options.Lego||13===this.options.Lego;if(!(t>=y||l>=p)){var H=65535>B.getBin(y,p),G=[u,m],E=null;if(12===this.options.Lego||14===
this.options.Lego)G=this.CreateContour(B.fContour?B.fContour.length:20,f.lego_zmin,f.lego_zmax),E=this.GetPalette();for(var F=0;F<G.length-1;++F){var L=G[F];var I=G[F+1];E&&F==G.length-2&&I<m&&(I=m);var C=0,x=0,Y=0,M=0,R=f.grz(L),V=f.grz(I);for(k=t;k<y;++k)for(n=l;n<p;++n)if(a(k,n,F)){var N=!D&&0<F;var Q=!D&&r>I&&F<G.length-2;Y+=D?12:c.length;N&&(Y-=6);Q&&(Y-=6);J&&!D&&(Y-=12,M+=12)}var Z=new Float32Array(3*Y),S=new Float32Array(3*Y),U=H?new Uint16Array(Y/3):new Uint32Array(Y/3),P=null,W=null;Y=null;
var ba=0,ca=0,aa;0<M&&(P=new Float32Array(3*M),W=new Float32Array(3*M),Y=H?new Uint16Array(M/3):new Uint32Array(M/3));for(k=t;k<y;++k){var da=g.grx[k]+g.xbar1*(g.grx[k+1]-g.grx[k]);var ha=g.grx[k]+g.xbar2*(g.grx[k+1]-g.grx[k]);for(n=l;n<p;++n)if(a(k,n,F)){N=!D&&0<F;Q=!D&&r>I&&F<G.length-2;var ea=g.gry[n]+g.ybar1*(g.gry[n+1]-g.gry[n]);var ia=g.gry[n]+g.ybar2*(g.gry[n+1]-g.gry[n]);C=v<=L?R:f.grz(v);x=r>I?V:f.grz(r);var T=aa=0;D&&(aa+=12,T+=24);var ka=c.length,la=B.getBin(k+1,n+1);for(N&&(ka-=6);T<ka;)N=
b[c[T]],J&&12>T?(P[ca]=da+N.x*(ha-da),P[ca+1]=ea+N.y*(ia-ea),P[ca+2]=C+N.z*(x-C),W[ca]=d[aa],W[ca+1]=d[aa+1],W[ca+2]=d[aa+2],0===ca%9&&(Y[ca/9]=la),ca+=3):(Z[ba]=da+N.x*(ha-da),Z[ba+1]=ea+N.y*(ia-ea),Z[ba+2]=C+N.z*(x-C),S[ba]=d[aa],S[ba+1]=d[aa+1],S[ba+2]=d[aa+2],0===ba%9&&(U[ba/9]=la),ba+=3),++T,0===T%6&&(aa+=3,Q&&T===c.length-12&&(T+=6,aa+=3))}}n=new h.BufferGeometry;n.addAttribute("position",new h.BufferAttribute(Z,3));n.addAttribute("normal",new h.BufferAttribute(S,3));R=B.fFillColor;V=this.get_color(R);
if(E)V=E.calcColor(F,G.length);else if(1===this.options.Lego||2>R)R=1,V="white";k=new h.MeshBasicMaterial({color:V,flatShading:!0});k=new h.Mesh(n,k);k.face_to_bins_index=U;k.painter=this;k.zmin=u;k.zmax=m;k.baseline=!1!==this.options.BaseLine?this.options.BaseLine:this.options.Zero?u:0;k.tip_color=3===R?16711680:65280;k.handle=g;k.tooltip=function(a){if(isNaN(a.faceIndex))return console.error("faceIndex not provided, check three.js version",h.REVISION,"expected r102"),null;if(0>a.faceIndex||a.faceIndex>=
this.face_to_bins_index.length)return null;var b=this.painter,c=this.handle,d=b.frame_painter(),f=b.GetHisto();a=b.Get3DToolTip(this.face_to_bins_index[a.faceIndex]);a.x1=Math.max(-d.size_xy3d,c.grx[a.ix-1]+c.xbar1*(c.grx[a.ix]-c.grx[a.ix-1]));a.x2=Math.min(d.size_xy3d,c.grx[a.ix-1]+c.xbar2*(c.grx[a.ix]-c.grx[a.ix-1]));a.y1=Math.max(-d.size_xy3d,c.gry[a.iy-1]+c.ybar1*(c.gry[a.iy]-c.gry[a.iy-1]));a.y2=Math.min(d.size_xy3d,c.gry[a.iy-1]+c.ybar2*(c.gry[a.iy]-c.gry[a.iy-1]));c=this.baseline;var g=a.value;
f.$baseh&&(c=f.$baseh.getBinContent(a.ix,a.iy));g<c&&(f=c,c=g,g=f);a.z1=d.grz(Math.max(this.zmin,c));a.z2=d.grz(Math.min(this.zmax,g));a.color=this.tip_color;b.is_projection&&2==b.Dimension()&&(a.$painter=b);return a};f.toplevel.add(k);0<M&&(n=new h.BufferGeometry,n.addAttribute("position",new h.BufferAttribute(P,3)),n.addAttribute("normal",new h.BufferAttribute(W,3)),R=2>R?new h.Color(16711680):new h.Color(K.rgb(V).darker(.5).toString()),R=new h.MeshBasicMaterial({color:R,flatShading:!0}),n=new h.Mesh(n,
R),n.face_to_bins_index=Y,n.painter=this,n.handle=k.handle,n.tooltip=k.tooltip,n.zmin=k.zmin,n.zmax=k.zmax,n.baseline=k.baseline,n.tip_color=k.tip_color,f.toplevel.add(n))}if(!(12<this.options.Lego)){J=d=0;c=!0;H=0;I=m;L=u;for(k=t;k<y;++k)for(n=l;n<p;++n)a(k,n,0)?(d+=D?q.length:b.length,J+=D?w.length:z.length):H++;65520<d&&(c=!1);c||(d=3*J);d=new Float32Array(3*d);J=c?new Uint16Array(J):null;R=f.grz(u);V=f.grz(m);G=H=x=C=0;for(k=t;k<y;++k)for(da=g.grx[k]+g.xbar1*(g.grx[k+1]-g.grx[k]),ha=g.grx[k]+
g.xbar2*(g.grx[k+1]-g.grx[k]),n=l;n<p;++n)if(a(k,n,0))if(ea=g.gry[n]+g.ybar1*(g.gry[n+1]-g.gry[n]),ia=g.gry[n]+g.ybar2*(g.gry[n+1]-g.gry[n]),C=v<=u?R:f.grz(v),x=r>m?V:f.grz(r),t=D?w:z,E=D?q:b,c){for(T=0;T<t.length;++T)J[G++]=H/3+t[T];for(T=0;T<E.length;++T)N=E[T],d[H]=da+N.x*(ha-da),d[H+1]=ea+N.y*(ia-ea),d[H+2]=C+N.z*(x-C),H+=3}else for(T=0;T<t.length;++T)N=E[t[T]],d[H]=da+N.x*(ha-da),d[H+1]=ea+N.y*(ia-ea),d[H+2]=C+N.z*(x-C),H+=3;b=this.get_color(B.fLineColor);k=new h.LineBasicMaterial({color:new h.Color(b)});
e.browser.isIE||(k.linewidth=B.fLineWidth);b=e.Painter.createLineSegments(d,k,c?J:null);f.toplevel.add(b)}}}};e.Painter.drawAxis3D=function(a,b,c){c=new e.TObjectPainter(b);"_main"in b||c.SetDivId(a);c.Draw3DAxis=function(){var a=this.frame_painter();if(!a||!a._toplevel)return console.warn("no geo object found for 3D axis drawing");var b=(new h.Box3).setFromObject(a._toplevel);this.xmin=b.min.x;this.xmax=b.max.x;this.ymin=b.min.y;this.ymax=b.max.y;this.zmin=b.min.z;this.zmax=b.max.z;this.size_xy3d=
this.size_z3d=0;this.DrawXYZ=e.TFramePainter.prototype.DrawXYZ;this.DrawXYZ(a._toplevel);a.adjustCameraPosition();a.Render3D()};c.Draw3DAxis();return c.DrawingReady()};e.TH1Painter.prototype.Draw3D=function(a,b){this.mode3d=!0;var c=this.frame_painter(),d=this.is_main_painter(),h=this.GetHisto();"resize"==b?d&&c.Resize3D()&&c.Render3D():(this.DeleteAtt(),this.ScanContent(!0),d&&(c.Create3DScene(),c.SetAxesRanges(h.fXaxis,this.xmin,this.xmax,h.fYaxis,this.ymin,this.ymax,h.fZaxis,0,0),c.Set3DOptions(this.options),
c.DrawXYZ(c.toplevel,{use_y_for_z:!0,zmult:1.1,zoom:e.gStyle.Zooming,ndim:1})),c.mode3d&&(this.Draw3DBins(),c.Render3D(),this.UpdateStatWebCanvas(),c.AddKeysHandler()));d&&(this.DrawColorPalette(this.options.Zscale&&(12===this.options.Lego||14===this.options.Lego)),this.DrawTitle());e.CallBack(a)};e.TH2Painter.prototype.Draw3D=function(a,b){this.mode3d=!0;var c=this.frame_painter(),d=this.is_main_painter(),h=this.GetHisto();if("resize"==b)d&&c.Resize3D()&&c.Render3D();else{b=this.root_pad();var w=
1.1;this.zmin=b.fLogz?.3*this.gminposbin:this.gminbin;this.zmax=this.gmaxbin;-1111!==this.options.minimum&&(this.zmin=this.options.minimum);-1111!==this.options.maximum&&(this.zmax=this.options.maximum,w=1);b.fLogz&&0>=this.zmin&&(this.zmin=1E-5*this.zmax);this.DeleteAtt();d&&(c.Create3DScene(),c.SetAxesRanges(h.fXaxis,this.xmin,this.xmax,h.fYaxis,this.ymin,this.ymax,h.fZaxis,this.zmin,this.zmax),c.Set3DOptions(this.options),c.DrawXYZ(c.toplevel,{zmult:w,zoom:e.gStyle.Zooming,ndim:2}));c.mode3d&&
(this.Draw3DBins(),c.Render3D(),this.UpdateStatWebCanvas(),c.AddKeysHandler())}d&&(this.DrawColorPalette(this.options.Zscale&&(12===this.options.Lego||14===this.options.Lego||11===this.options.Surf||12===this.options.Surf)),this.DrawTitle());e.CallBack(a)};e.TH2Painter.prototype.DrawContour3D=function(a){var b=this.frame_painter(),c=this.PrepareColorDraw({rounding:!1,use3d:!0,extra:100,middle:0}),d=this.GetHisto(),h=this.GetContour(),w=this.GetPalette(),q=2*b.size_z3d,f=[];this.BuildContour(c,h,w,
function(c,d,g,e,z,l){if(!(3>z-e)){if(a&&(q=b.grz(h[l]),0>q||q>2*b.size_z3d))return;for(c=e;c<z;++c)f.push(d[c],g[c],q),f.push(d[c+1],g[c+1],q)}});c=e.Painter.createLineSegments(f,e.Painter.Create3DLineMaterial(this,d));b.toplevel.add(c)};e.TH2Painter.prototype.DrawSurf=function(){function a(a,b,c,d,f,g){if(k){var e=0>c?-1:c>2*q.size_z3d?1:0,l=0>g?-1:g>2*q.size_z3d?1:0;if(e!==l||0===e){if(!D)return++J;if(0!==e){var h=g-c;c=0>e?0:2*q.size_z3d;a=d-(d-a)/h*(g-c);b=f-(f-b)/h*(g-c)}0!==l&&(h=c-g,g=0>l?
0:2*q.size_z3d,d=a-(a-d)/h*(c-g),f=b-(b-f)/h*(c-g));H[G]=a;H[G+1]=b;H[G+2]=c;G+=3;H[G]=d;H[G+1]=f;H[G+2]=g;G+=3}}}function b(a,b,c,d,f,g,e,k){x>=C.length&&console.log("more than 6 points???");c=(e-c)/(g-c);g=3;0!==K&&Math.abs(c)<Math.abs(K)&&(C[x]=C[x-3],C[x+1]=C[x-2],C[x+2]=C[x-1],x-=3,g=6);C[x]=a+c*(d-a);C[x+1]=b+c*(f-b);C[x+2]=e;k&&F&&(M[R]=C[x],M[R+1]=C[x+1],M[R+2]=C[x+2],R+=3);x+=g;K=c}function c(a,b,c){b=8*((b-f.i1)*(f.j2-f.j1)+(c-f.j1));if(0<=I[b])return console.error("More than 8 vertexes for the bin");
c=b+8+I[b];I[b]--;I[c]=a}function d(a){for(var b=f.i1;b<f.i2;++b)for(var c=f.j1;c<f.j2;++c){var d=8*((b-f.i1)*(f.j2-f.j1)+(c-f.j1));if(-1!==I[d]){var g=0<=I[d]?d:d+9+I[d];d+=8;for(var e=0,k=0,l=0,h=g;h<d;++h){var m=I[h];if(0>m)return console.error("FAILURE in NORMALS RECALCULATIONS");e+=a[m];k+=a[m+1];l+=a[m+2]}e/=d-g;k/=d-g;l/=d-g;for(h=g;h<d;++h)m=I[h],a[m]=e,a[m+1]=k,a[m+2]=l}}}function z(a,d,f,g,e,k,l,h,n,t){for(var q=1;q<p.length;++q){var z=f<p[q-1]?-1:f>p[q]?1:0,r=k<p[q-1]?-1:k>p[q]?1:0,w=n<
p[q-1]?-1:n>p[q]?1:0,y=z+r+w;if(3!==y){if(-3===y)break;if(D){if(x=R=0,0===z&&(C[x]=a,C[x+1]=d,C[x+2]=f,x+=3),z!==r&&(K=0,(0>z||0>r)&&b(a,d,f,g,e,k,p[q-1]),(0<z||0<r)&&b(a,d,f,g,e,k,p[q],!0)),0===r&&(C[x]=g,C[x+1]=e,C[x+2]=k,x+=3),r!==w&&(K=0,(0>r||0>w)&&b(g,e,k,l,h,n,p[q-1]),(0<r||0<w)&&b(g,e,k,l,h,n,p[q],!0)),0===w&&(C[x]=l,C[x+1]=h,C[x+2]=n,x+=3),w!==z&&(K=0,(0>w||0>z)&&b(l,h,n,a,d,f,p[q-1]),(0<w||0<z)&&b(l,h,n,a,d,f,p[q],!0)),0!==x)if(9>x)console.log("found less than 3 points",x/3);else{if(F&&
6===R){for(z=0;6>z;++z)F[L+z]=M[z];L+=6}z=B[q];r=O[q];v&&9===x&&(c(r,u,m),c(r+3,u+1,t?m+1:m),c(r+6,t?u:u+1,m+1));for(w=3;w<x-3;w+=3)z[r]=C[0],z[r+1]=C[1],z[r+2]=C[2],r+=3,z[r]=C[w],z[r+1]=C[w+1],z[r+2]=C[w+2],r+=3,z[r]=C[w+3],z[r+1]=C[w+4],z[r+2]=C[w+5],r+=3;O[q]=r}}else y=Math.abs(r-z)+Math.abs(w-r)+Math.abs(z-w),0===z&&++y,0===r&&++y,0===w&&++y,1!==y&&2!==y||console.error("FOND npnts",y),2<y&&(void 0===A[q]&&(A[q]=0),A[q]+=y-2),!(0<z||0<r||0<w)||z===r&&r===w&&w===z||++E}}}var w=this.GetHisto(),
q=this.frame_painter(),f=this.PrepareColorDraw({rounding:!1,use3d:!0,extra:1,middle:.5}),u,m,g,t,y=q.grz.domain()[0];q.grz.domain();var l=q.logz?function(a){return a<y?-.1:q.grz(a)}:q.grz;if(!(2>f.i2-f.i1||2>f.j2-f.j1)){var p=g=null,k=!0,n=!1,v=!1,r=null;switch(this.options.Surf){case 11:g=this.GetContour();r=this.GetPalette();break;case 12:case 15:case 17:g=this.GetContour();r=this.GetPalette();k=!1;break;case 14:k=!1;v=!0;break;case 16:g=this.GetContour();n=!0;k=!1;break;default:g=q.z_handle.CreateTicks(!0),
n=!0}if(g)for(p=new Float32Array(g.length),t=0;t<g.length;++t)p[t]=l(g[t]);else p=[0,2*q.size_z3d];var D,A=[],B=[],O=[],J=0,H=null,G=0,E=0,F=null,L=0,I=null,C=new Float32Array(18),x=0,K=0,M=new Float32Array(6),R=0;if(v)for(I=new Int32Array((f.i2-f.i1)*(f.j2-f.j1)*8),g=0;g<I.length;++g)I[g]=-1;for(D=0;2>D;++D){if(D){for(g=1;g<p.length;++g)A[g]&&(B[g]=new Float32Array(9*A[g]),O[g]=0);k&&0<J&&(H=new Float32Array(6*J));n&&0<E&&(F=new Float32Array(6*E))}for(u=f.i1;u<f.i2-1;++u){g=f.grx[u];var V=f.grx[u+
1];for(m=f.j1;m<f.j2-1;++m){t=f.gry[m];var N=f.gry[m+1];var Q=l(w.getBinContent(u+1,m+1));var Z=l(w.getBinContent(u+1,m+2));var S=l(w.getBinContent(u+2,m+1));var U=l(w.getBinContent(u+2,m+2));z(g,t,Q,V,N,U,g,N,Z,!0);z(g,t,Q,V,t,S,V,N,U,!1);a(g,N,Z,g,t,Q);a(g,t,Q,V,t,S);u===f.i2-2&&a(V,t,S,V,N,U);m===f.j2-2&&a(g,N,Z,V,N,U)}}}for(g=1;g<p.length;++g)B[g]&&(O[g]!==9*A[g]&&console.error("SURF faces missmatch lvl",g,"faces",A[g],"index",O[g],"check",9*A[g]-O[g]),l=new h.BufferGeometry,l.addAttribute("position",
new h.BufferAttribute(B[g],3)),l.computeVertexNormals(),v&&1===g&&d(l.getAttribute("normal").array),r?n=r.calcColor(g,p.length):(n=1<w.fFillColor?this.get_color(w.fFillColor):"white",14===this.options.Surf&&2>w.fFillColor&&(n=this.get_color(48))),n=14===this.options.Surf?new h.MeshLambertMaterial({color:n,side:h.DoubleSide}):new h.MeshBasicMaterial({color:n,side:h.DoubleSide}),l=new h.Mesh(l,n),q.toplevel.add(l),l.painter=this);H&&(6*J!==G&&console.error("SURF lines mismmatch nsegm",J," lindx",G,
"difference",6*J-G),l=this.get_color(w.fLineColor),n=new h.LineBasicMaterial({color:new h.Color(l)}),e.browser.isIE||(n.linewidth=w.fLineWidth),l=e.Painter.createLineSegments(H,n),l.painter=this,q.toplevel.add(l));F&&(6*E!==L&&console.error("SURF grid draw mismatch ngridsegm",E,"gindx",L,"diff",6*E-L),n=1===this.options.Surf?new h.LineDashedMaterial({color:0,dashSize:2,gapSize:2}):new h.LineBasicMaterial({color:new h.Color(this.get_color(w.fLineColor))}),l=e.Painter.createLineSegments(F,n),l.painter=
this,q.toplevel.add(l));17===this.options.Surf&&this.DrawContour3D();if(13===this.options.Surf){f=this.PrepareColorDraw({rounding:!1,use3d:!0,extra:100,middle:0});p=this.GetContour();r=this.GetPalette();var P=-1,W=2*q.size_z3d;this.BuildContour(f,p,r,function(a,b,c,d,f){b[f]===b[d]&&c[f]===c[d]&&f--;if(!(3>f-d)){for(var g=[],e=d;e<=f;++e)e!==d&&b[e]===b[e-1]&&c[e]===c[e-1]||g.push(new h.Vector2(b[e],c[e]));if(!(3>g.length)&&(d=h.ShapeUtils.triangulateShape(g,[]))&&0!==d.length){if(0>P||P!==a)P=a,
W+=1E-4*q.size_z3d;b=new Float32Array(9*d.length);c=new Float32Array(9*d.length);for(e=f=0;e<d.length;++e)for(var k=d[e],l=0;3>l;++l){var m=g[k[l]];b[f]=m.x;b[f+1]=m.y;b[f+2]=W;c[f]=0;c[f+1]=0;c[f+2]=1;f+=3}g=new h.BufferGeometry;g.addAttribute("position",new h.BufferAttribute(b,3));g.addAttribute("normal",new h.BufferAttribute(c,3));a=r.getColor(a);a=new h.MeshBasicMaterial({color:a,flatShading:!0,side:h.DoubleSide,opacity:.5});a=new h.Mesh(g,a);a.painter=this;q.toplevel.add(a)}}})}}};e.TH2Painter.prototype.DrawError=
function(){for(var a=this.frame_painter(),b=this.GetHisto(),c=this.PrepareColorDraw({rounding:!1,use3d:!0,extra:1}),d=a.grz.domain()[0],z=a.grz.domain()[1],w,q,f,u,m,g,t,y,l,p=0,k=null,n=null,v=0,r=0;2>r;++r){for(w=c.i1;w<c.i2;++w)for(g=c.grx[w],t=c.grx[w+1],q=c.j1;q<c.j2;++q)if(u=b.getBinContent(w+1,q+1),!(u<d||u>z)){if(m=u===d)m=this.options.Zero||0<d?!1:!this._show_empty_bins;m||(0===r?p+=3:(f=b.getBin(w+1,q+1),m=b.getBinError(f),n[v/18]=f,f=c.gry[q],y=c.gry[q+1],l=a.grz(u-m<d?d:u-m),u=a.grz(u+
m>z?z:u+m),k[v]=g,k[v+3]=t,k[v+1]=k[v+4]=(f+y)/2,k[v+2]=k[v+5]=(l+u)/2,v+=6,k[v]=k[v+3]=(g+t)/2,k[v+1]=f,k[v+4]=y,k[v+2]=k[v+5]=(l+u)/2,v+=6,k[v]=k[v+3]=(g+t)/2,k[v+1]=k[v+4]=(f+y)/2,k[v+2]=l,k[v+5]=u,v+=6))}if(0===r){if(0===p)return;k=new Float32Array(6*p);n=new Int32Array(p/3)}}b=this.get_color(this.GetObject().fLineColor);b=new h.LineBasicMaterial({color:new h.Color(b)});k=e.Painter.createLineSegments(k,b);e.browser.isIE||(b.linewidth=this.GetObject().fLineWidth);k.painter=this;k.intersect_index=
n;k.zmin=d;k.zmax=z;k.tip_color=3===this.GetObject().fLineColor?16711680:65280;k.tooltip=function(a){if(isNaN(a.index))return console.error("segment index not provided, check three.js version",h.REVISION,"expected r102"),null;var b=Math.floor(a.index/6);if(0>b||b>=this.intersect_index.length)return null;var c=this.painter;a=c.GetHisto();var d=c.frame_painter();b=c.Get3DToolTip(this.intersect_index[b]);b.x1=Math.max(-d.size_xy3d,d.grx(a.fXaxis.GetBinLowEdge(b.ix)));b.x2=Math.min(d.size_xy3d,d.grx(a.fXaxis.GetBinLowEdge(b.ix+
1)));b.y1=Math.max(-d.size_xy3d,d.gry(a.fYaxis.GetBinLowEdge(b.iy)));b.y2=Math.min(d.size_xy3d,d.gry(a.fYaxis.GetBinLowEdge(b.iy+1)));b.z1=d.grz(b.value-b.error<this.zmin?this.zmin:b.value-b.error);b.z2=d.grz(b.value+b.error>this.zmax?this.zmax:b.value+b.error);b.color=this.tip_color;return b};a.toplevel.add(k)};e.TH2Painter.prototype.DrawPolyLego=function(){var a=this.GetHisto(),b=this.frame_painter(),c=b.grz.domain()[0],d=b.grz.domain()[1],e,w=a.fBins.arr.length,q=0,f=b.grz(c),u=f;this.fContour=
null;this.fCustomContour=!1;this.maxbin=this.gmaxbin;this.minbin=this.gminbin;this.minposbin=this.gminposbin;for(e=0;e<w;++e){var m=a.fBins.arr[e];if(!(m.fContent<c)){var g=this.getContourColor(m.fContent,!0);if(null!==g&&!(m.fXmin>b.scale_xmax||m.fXmax<b.scale_xmin||m.fYmin>b.scale_ymax||m.fYmax<b.scale_ymin)){u=b.grz(m.fContent>d?d:m.fContent);var t=[],y=[],l=1,p=m.fPoly,k=0;"TMultiGraph"==p._typename&&(l=m.fPoly.fGraphs.arr.length,p=null);for(var n=0;n<l;++n){if(!p||0<n)p=m.fPoly.fGraphs.arr[n];
for(var v=p.fNpoints,r=p.fX,D=p.fY;2<v&&r[0]===r[v-1]&&D[0]===D[v-1];)--v;for(var A,B,O=0;2>O;++O){var J=b.size_xy3d*b.size_z3d,H=0<O?0:J/1E6;A=[];B=null;for(var G=0;G<v;++G){var E=b.grx(r[G]);var F=b.gry(D[G]);0<G&&(J=(E-L)*(E-L)+(F-I)*(F-I));if(J>H){A.push(new h.Vector2(E,F));var L=E;var I=F}}try{2<A.length&&(B=h.ShapeUtils.triangulateShape(A,[]))}catch(C){B=null}if(B&&B.length>A.length-3)break}B&&B.length&&A&&(t.push(A),y.push(B),k+=2*B.length,u>f&&(k+=2*A.length))}m=new Float32Array(9*k);for(n=
l=0;n<t.length;++n){A=t[n];B=y[n];for(p=0;2>p;++p)for(k=0;k<B.length;++k)D=B[k],v=A[D[0]],r=A[D[0===p?2:1]],D=A[D[0===p?1:2]],m[l]=v.x,m[l+1]=v.y,m[l+2]=p?u:f,l+=3,m[l]=r.x,m[l+1]=r.y,m[l+2]=p?u:f,l+=3,m[l]=D.x,m[l+1]=D.y,m[l+2]=p?u:f,l+=3;if(u>f)for(k=0;k<A.length;++k)v=A[k],r=A[0<k?k-1:A.length-1],m[l]=v.x,m[l+1]=v.y,m[l+2]=f,l+=3,m[l]=r.x,m[l+1]=r.y,m[l+2]=f,l+=3,m[l]=r.x,m[l+1]=r.y,m[l+2]=u,l+=3,m[l]=v.x,m[l+1]=v.y,m[l+2]=f,l+=3,m[l]=r.x,m[l+1]=r.y,m[l+2]=u,l+=3,m[l]=v.x,m[l+1]=v.y,m[l+2]=u,l+=
3}t=new h.BufferGeometry;t.addAttribute("position",new h.BufferAttribute(m,3));t.computeVertexNormals();g=this.fPalette.getColor(g);g=new h.MeshBasicMaterial({color:g,flatShading:!0});g=new h.Mesh(t,g);b.toplevel.add(g);g.painter=this;g.bins_index=e;g.draw_z0=f;g.draw_z1=u;g.tip_color=65280;g.tooltip=function(a){a=this.painter;var b=a.frame_painter(),c=a.GetObject().fBins.arr[this.bins_index];return{use_itself:!0,x1:b.grx(c.fXmin),x2:b.grx(c.fXmax),y1:b.gry(c.fYmin),y2:b.gry(c.fYmax),z1:this.draw_z0,
z2:this.draw_z1,bin:this.bins_index,value:c.fContent,color:this.tip_color,lines:a.ProvidePolyBinHints(this.bins_index)}};q++}}}};Q.prototype=Object.create(e.THistPainter.prototype);Q.prototype.ScanContent=function(a){if(!(a&&this.nbinsx&&this.nbinsy&&this.nbinsz)){a=this.GetObject();this.nbinsx=a.fXaxis.fNbins;this.nbinsy=a.fYaxis.fNbins;this.nbinsz=a.fZaxis.fNbins;this.xmin=a.fXaxis.fXmin;this.xmax=a.fXaxis.fXmax;this.ymin=a.fYaxis.fXmin;this.ymax=a.fYaxis.fXmax;this.zmin=a.fZaxis.fXmin;this.zmax=
a.fZaxis.fXmax;this.gminbin=this.gmaxbin=a.getBinContent(1,1,1);for(var b=0;b<this.nbinsx;++b)for(var c=0;c<this.nbinsy;++c)for(var d=0;d<this.nbinsz;++d){var e=a.getBinContent(b+1,c+1,d+1);e<this.gminbin?this.gminbin=e:e>this.gmaxbin&&(this.gmaxbin=e)}this.draw_content=0<this.gmaxbin;this.CreateAxisFuncs(!0,!0)}};Q.prototype.CountStat=function(){var a=this.GetHisto(),b=a.fXaxis,c=a.fYaxis,d=a.fZaxis,e=0,h=0,q=0,f=0,u=0,m=0,g=0,t=this.GetSelectIndex("x","left"),y=this.GetSelectIndex("x","right"),
l=this.GetSelectIndex("y","left"),p=this.GetSelectIndex("y","right"),k=this.GetSelectIndex("z","left"),n=this.GetSelectIndex("z","right"),v=this.frame_painter(),r={name:a.fName,entries:0,integral:0,meanx:0,meany:0,meanz:0,rmsx:0,rmsy:0,rmsz:0},D,A,B;for(D=0;D<this.nbinsx+2;++D){var O=b.GetBinCoord(D-.5);var J=D<t?0:D>y?2:1;for(A=0;A<this.nbinsy+2;++A){var H=c.GetBinCoord(A-.5);var G=A<l?0:A>p?2:1;for(B=0;B<this.nbinsz+2;++B){var E=d.GetBinCoord(B-.5);var F=B<k?0:B>n?2:1;var L=a.getBinContent(D,A,
B);r.entries+=L;1==J&&1==G&&1==F&&(e+=L,h+=O*L,q+=H*L,f+=E*L,u+=O*O*L,m+=H*H*L,g+=E*E*L)}}}0<a.fTsumw&&!v.IsAxisZoomed("x")&&!v.IsAxisZoomed("y")&&!v.IsAxisZoomed("z")&&(e=a.fTsumw,h=a.fTsumwx,u=a.fTsumwx2,q=a.fTsumwy,m=a.fTsumwy2,f=a.fTsumwz,g=a.fTsumwz2);0<e&&(r.meanx=h/e,r.meany=q/e,r.meanz=f/e,r.rmsx=Math.sqrt(Math.abs(u/e-r.meanx*r.meanx)),r.rmsy=Math.sqrt(Math.abs(m/e-r.meany*r.meany)),r.rmsz=Math.sqrt(Math.abs(g/e-r.meanz*r.meanz)));r.integral=e;1<a.fEntries&&(r.entries=a.fEntries);return r};
Q.prototype.FillStatistic=function(a,b,c){if(this.IgnoreStatsFill())return!1;var d=this.CountStat(),e=b%10,h=Math.floor(b/10)%10,q=Math.floor(b/100)%10,f=Math.floor(b/1E3)%10;b=Math.floor(b/1E6)%10;a.ClearPave();0<e&&a.AddText(d.name);0<h&&a.AddText("Entries = "+a.Format(d.entries,"entries"));0<q&&(a.AddText("Mean x = "+a.Format(d.meanx)),a.AddText("Mean y = "+a.Format(d.meany)),a.AddText("Mean z = "+a.Format(d.meanz)));0<f&&(a.AddText("Std Dev x = "+a.Format(d.rmsx)),a.AddText("Std Dev y = "+a.Format(d.rmsy)),
a.AddText("Std Dev z = "+a.Format(d.rmsz)));0<b&&a.AddText("Integral = "+a.Format(d.integral,"entries"));c&&a.FillFunctionStat(this.FindFunction("TF1"),c);return!0};Q.prototype.GetBinTips=function(a,b,c){var d=[],h=this.frame_painter(),w=this.GetHisto();d.push(this.GetTipName());"labels"==h.x_kind?d.push("x = "+h.AxisAsText("x",w.fXaxis.GetBinLowEdge(a+1))+"  xbin="+(a+1)):d.push("x = ["+h.AxisAsText("x",w.fXaxis.GetBinLowEdge(a+1))+", "+h.AxisAsText("x",w.fXaxis.GetBinLowEdge(a+2))+")   xbin="+(a+
1));"labels"==h.y_kind?d.push("y = "+h.AxisAsText("y",w.fYaxis.GetBinLowEdge(b+1))+"  ybin="+(b+1)):d.push("y = ["+h.AxisAsText("y",w.fYaxis.GetBinLowEdge(b+1))+", "+h.AxisAsText("y",w.fYaxis.GetBinLowEdge(b+2))+")  ybin="+(b+1));"labels"==h.z_kind?d.push("z = "+h.AxisAsText("z",w.fZaxis.GetBinLowEdge(c+1))+"  zbin="+(c+1)):d.push("z = ["+h.AxisAsText("z",w.fZaxis.GetBinLowEdge(c+1))+", "+h.AxisAsText("z",w.fZaxis.GetBinLowEdge(c+2))+")  zbin="+(c+1));a=w.getBinContent(a+1,b+1,c+1);a===Math.round(a)?
d.push("entries = "+a):d.push("entries = "+e.FFormat(a,e.gStyle.fStatFormat));return d};Q.prototype.Draw3DScatter=function(){var a=this.GetObject(),b=this.frame_painter(),c=this.GetSelectIndex("x","left",.5),d=this.GetSelectIndex("x","right",0),z=this.GetSelectIndex("y","left",.5),w=this.GetSelectIndex("y","right",0),q=this.GetSelectIndex("z","left",.5),f=this.GetSelectIndex("z","right",0);this.GetTipName("<br/>");var u,m,g;if(d<=c||w<=z||f<=q)return!0;var t=1E3<this.gmaxbin?1E3/this.gmaxbin:1,y=
0,l=0,p=Math.max(0,this.gminbin);for(u=c;u<d;++u)for(m=z;m<w;++m)for(g=q;g<f;++g){var k=a.getBinContent(u+1,m+1,g+1);l+=k;k<=p||(y+=Math.round(k*t))}if(y>(b.webgl?1E5:3E4))return!1;e.seed(l);l=new e.Painter.PointsCreator(y,b.webgl,b.size_xy3d/200);y=new Int32Array(y);var n=0;for(u=c;u<d;++u)for(m=z;m<w;++m)for(g=q;g<f;++g)if(k=a.getBinContent(u+1,m+1,g+1),!(k<=p))for(c=Math.round(k*t),k=0;k<c;++k){var v=a.fXaxis.GetBinCoord(u+e.random()),r=a.fYaxis.GetBinCoord(m+e.random()),D=a.fZaxis.GetBinCoord(g+
e.random());y[n++]=a.getBin(u+1,m+1,g+1);l.AddPoint(b.grx(v),b.gry(r),b.grz(D))}d=l.CreatePoints(this.get_color(a.fMarkerColor));b.toplevel.add(d);d.bins=y;d.painter=this;d.tip_color=3===a.fMarkerColor?16711680:65280;d.tooltip=function(a){if(isNaN(a.index))return console.error("intersect.index not provided, check three.js version",h.REVISION,"expected r102"),null;var b=Math.floor(a.index/this.nvertex);if(0>b||b>=this.bins.length)return null;var c=this.painter;a=c.GetHisto();var d=c.frame_painter();
b=c.Get3DToolTip(this.bins[b]);b.x1=d.grx(a.fXaxis.GetBinLowEdge(b.ix));b.x2=d.grx(a.fXaxis.GetBinLowEdge(b.ix+1));b.y1=d.gry(a.fYaxis.GetBinLowEdge(b.iy));b.y2=d.gry(a.fYaxis.GetBinLowEdge(b.iy+1));b.z1=d.grz(a.fZaxis.GetBinLowEdge(b.iz));b.z2=d.grz(a.fZaxis.GetBinLowEdge(b.iz+1));b.color=this.tip_color;b.opacity=.3;return b};return!0};Q.prototype.Draw3DBins=function(){if(this.draw_content&&(this.options.Box||this.options.GLBox||this.options.GLColor||this.options.Lego||!this.Draw3DScatter())){var a=
this.GetObject().fFillColor,b=this.get_color(a),c=this.frame_painter(),d=0,z=!1,w=!1,q=!1,f=1,u=!0,m=this.options.Box?this.options.BoxStyle:0,g=.5;!m&&this.options.Lego&&(m=1===this.options.Lego?10:this.options.Lego);if(11===this.options.GLBox||12===this.options.GLBox){g=.4;z=!0;12===this.options.GLBox&&(q=!0);m=e.Painter.TestWebGL()?new h.SphereGeometry(.5,16,12):new h.SphereGeometry(.5,8,6);m.applyMatrix((new h.Matrix4).makeRotationX(Math.PI/2));d=9*m.faces.length;var t=new Float32Array(d);var y=
new Float32Array(d);for(var l=0;l<m.faces.length;++l)t[9*l]=m.vertices[m.faces[l].a].x,t[9*l+1]=m.vertices[m.faces[l].a].y,t[9*l+2]=m.vertices[m.faces[l].a].z,t[9*l+3]=m.vertices[m.faces[l].b].x,t[9*l+4]=m.vertices[m.faces[l].b].y,t[9*l+5]=m.vertices[m.faces[l].b].z,t[9*l+6]=m.vertices[m.faces[l].c].x,t[9*l+7]=m.vertices[m.faces[l].c].y,t[9*l+8]=m.vertices[m.faces[l].c].z,y[9*l]=m.faces[l].vertexNormals[0].x,y[9*l+1]=m.faces[l].vertexNormals[0].y,y[9*l+2]=m.faces[l].vertexNormals[0].z,y[9*l+3]=m.faces[l].vertexNormals[1].x,
y[9*l+4]=m.faces[l].vertexNormals[1].y,y[9*l+5]=m.faces[l].vertexNormals[1].z,y[9*l+6]=m.faces[l].vertexNormals[2].x,y[9*l+7]=m.faces[l].vertexNormals[2].y,y[9*l+8]=m.faces[l].vertexNormals[2].z}else{l=e.Painter.Box3D.Indexes;var p=e.Painter.Box3D.Normals,k=e.Painter.Box3D.Vertices;d=3*l.length;t=new Float32Array(d);y=new Float32Array(d);for(var n=0,v=-3;n<l.length;++n){var r=k[l[n]];t[3*n]=r.x-.5;t[3*n+1]=r.y-.5;t[3*n+2]=r.z-.5;0===n%6&&(v+=3);y[3*n]=p[v];y[3*n+1]=p[v+1];y[3*n+2]=p[v+2]}w=!0;12===
m?q=!0:13===m?(q=!0,w=!1):this.options.GLColor&&(q=!0,f=.5,w=u=!1,z=!0)}u&&(u=this.gminbin||this.gmaxbin?1/Math.max(Math.abs(this.gminbin),Math.abs(this.gmaxbin)):1);var D=this.GetHisto(),A=this.GetSelectIndex("x","left",.5),B=this.GetSelectIndex("x","right",0),O=this.GetSelectIndex("y","left",.5),J=this.GetSelectIndex("y","right",0),H=this.GetSelectIndex("z","left",.5),G=this.GetSelectIndex("z","right",0);this.GetTipName("<br/>");if(!(B<=A||J<=O||G<=H)){m=(c.grx(D.fXaxis.GetBinLowEdge(B+1))-c.grx(D.fXaxis.GetBinLowEdge(A+
1)))/(B-A);l=(c.gry(D.fYaxis.GetBinLowEdge(J+1))-c.gry(D.fYaxis.GetBinLowEdge(O+1)))/(J-O);p=(c.grz(D.fZaxis.GetBinLowEdge(G+1))-c.grz(D.fZaxis.GetBinLowEdge(H+1)))/(G-H);var E=0,F,L;k=[];var I=0;v=[];for(F=A;F<B;++F)for(L=O;L<J;++L)for(n=H;n<G;++n)if(r=D.getBinContent(F+1,L+1,n+1),this.options.GLColor||!(0===r||r<this.gminbin)){var C=u?Math.pow(Math.abs(r*u),.3333):1;if(!(.001>C)&&(E++,q)){var x=this.getContourColor(r,!0);null!==x?(void 0===k[x]&&(k[x]=0,v[x]=I++),k[x]+=1):console.error("not found color for",
r)}}q||(k.push(E),I=1,v=[0]);var K=Array(I),M=Array(I),R=Array(I),Q=Array(I),N=Array(I),X=Array(I);I=Array(I);for(n=0;n<k.length;++n)k[n]&&(E=k[n],x=v[n],K[x]=0,N[x]=0,w&&(N[x]=65520<E*d/3?2:1),M[x]=new Float32Array(E*d),R[x]=new Float32Array(E*d),Q[x]=new Int32Array(E),1===N[x]&&(X[x]=new Uint16Array(E*e.Painter.Box3D.MeshSegments.length)),2===N[x]&&(I[x]=new Float32Array(E*e.Painter.Box3D.Segments.length*3)));for(F=A;F<B;++F)for(n=D.fXaxis.GetBinCenter(F+1),w=c.grx(n),L=O;L<J;++L)for(n=D.fYaxis.GetBinCenter(L+
1),A=c.gry(n),n=H;n<G;++n)if(r=D.getBinContent(F+1,L+1,n+1),this.options.GLColor||!(0===r||r<this.gminbin))if(C=u?Math.pow(Math.abs(r*u),.3333):1,!(.001>C)){x=0;if(q){x=this.getContourColor(r,!0);if(null===x)continue;x=v[x]}E=K[x];r=D.fZaxis.GetBinCenter(n+1);var Z=c.grz(r);Q[x][E]=D.getBin(F+1,L+1,n+1);var S=E*d;r=M[x];for(var U=R[x],P=0;P<d;P+=3,S+=3)r[S]=w+t[P]*m*C,r[S+1]=A+t[P+1]*l*C,r[S+2]=Z+t[P+2]*p*C,U[S]=y[P],U[S+1]=y[P+1],U[S+2]=y[P+2];if(1===N[x]){U=e.Painter.Box3D.MeshSegments;S=E*U.length;
r=Math.round(E*d/3);var W=X[x];for(P=0;P<U.length;++P)W[S+P]=r+U[P]}if(2===N[x])for(U=e.Painter.Box3D.Segments,W=I[x],S=E*U.length*3,P=0;P<U.length;++P,S+=3)r=e.Painter.Box3D.Vertices[U[P]],W[S]=w+(r.x-.5)*m*C,W[S+1]=A+(r.y-.5)*l*C,W[S+2]=Z+(r.z-.5)*p*C;K[x]=E+1}for(n=0;n<k.length;++n)k[n]&&(E=k[n],x=v[n],t=new h.BufferGeometry,t.addAttribute("position",new h.BufferAttribute(M[x],3)),t.addAttribute("normal",new h.BufferAttribute(R[x],3)),q&&(b=this.fPalette.getColor(n)),y=z?new h.MeshLambertMaterial({color:b,
opacity:f,transparent:1>f}):new h.MeshBasicMaterial({color:b,opacity:f}),t=new h.Mesh(t,y),t.bins=Q[x],t.bins_faces=d/9,t.painter=this,t.scalex=g*m,t.scaley=g*l,t.scalez=g*p,t.tip_color=3===a?16711680:65280,t.use_scale=u,t.tooltip=function(a){if(isNaN(a.faceIndex))return console.error("intersect.faceIndex not provided, check three.js version",h.REVISION,"expected r102"),null;var b=Math.floor(a.faceIndex/this.bins_faces);if(0>b||b>=this.bins.length)return null;var c=this.painter;a=c.GetHisto();var d=
c.frame_painter();b=c.Get3DToolTip(this.bins[b]);c=d.grx(a.fXaxis.GetBinCoord(b.ix-.5));var e=d.gry(a.fYaxis.GetBinCoord(b.iy-.5));a=d.grz(a.fZaxis.GetBinCoord(b.iz-.5));d=this.use_scale?Math.pow(Math.abs(b.value*this.use_scale),.3333):1;b.x1=c-this.scalex*d;b.x2=c+this.scalex*d;b.y1=e-this.scaley*d;b.y2=e+this.scaley*d;b.z1=a-this.scalez*d;b.z2=a+this.scalez*d;b.color=this.tip_color;return b},c.toplevel.add(t),0<N[x]&&(t=this.get_color(this.GetObject().fLineColor),t=new h.LineBasicMaterial({color:t}),
y=null,y=1===N[x]?e.Painter.createLineSegments(M[x],t,X[x]):e.Painter.createLineSegments(I[x],t),c.toplevel.add(y)))}}};Q.prototype.Redraw=function(a){var b=this.frame_painter(),c=this.GetHisto();"resize"==a?b.Resize3D()&&b.Render3D():(b.Create3DScene(),b.SetAxesRanges(c.fXaxis,this.xmin,this.xmax,c.fYaxis,this.ymin,this.ymax,c.fZaxis,this.zmin,this.zmax),b.Set3DOptions(this.options),b.DrawXYZ(b.toplevel,{zoom:e.gStyle.Zooming,ndim:3}),this.Draw3DBins(),b.Render3D(),this.UpdateStatWebCanvas(),b.AddKeysHandler());
this.DrawTitle()};Q.prototype.FillToolbar=function(){var a=this.pad_painter();a&&(a.AddButton(e.ToolbarIcons.auto_zoom,"Unzoom all axes","ToggleZoom","Ctrl *"),this.draw_content&&a.AddButton(e.ToolbarIcons.statbox,"Toggle stat box","ToggleStatBox"),a.ShowButtons())};Q.prototype.CanZoomIn=function(a,b,c){var d=this.GetHisto();d&&(d=d["f"+a.toUpperCase()+"axis"]);return!d||1<d.FindBin(c,.5)-d.FindBin(b,0)};Q.prototype.AutoZoom=function(){var a=this.GetSelectIndex("x","left"),b=this.GetSelectIndex("x",
"right"),c=this.GetSelectIndex("y","left"),d=this.GetSelectIndex("y","right"),e=this.GetSelectIndex("z","left"),h=this.GetSelectIndex("z","right"),q,f,u,m=this.GetObject();if(a!==b&&c!==d&&e!==h){var g=m.getBinContent(a+1,c+1,e+1);for(q=a;q<b;++q)for(f=c;f<d;++f)for(u=e;u<h;++u)g=Math.min(g,m.getBinContent(q+1,f+1,u+1));if(!(0<g)){var t=b,y=a,l=d,p=c,k=h,n=e;for(q=a;q<b;++q)for(f=c;f<d;++f)for(u=e;u<h;++u)m.getBinContent(q+1,f+1,u+1)>g&&(q<t&&(t=q),q>=y&&(y=q+1),f<l&&(l=f),f>=p&&(p=f+1),u<k&&(k=u),
u>=n&&(n=u+1));q=!1;t===y-1&&t>a+1&&y<b-1&&(t--,y++);l===p-1&&l>c+1&&p<d-1&&(l--,p++);k===n-1&&k>e+1&&n<h-1&&(k--,n++);if((t>a||y<b)&&t<y-1){var v=m.fXaxis.GetBinLowEdge(t+1);var r=m.fXaxis.GetBinLowEdge(y+1);q=!0}if((l>c||p<d)&&l<p-1){var D=m.fYaxis.GetBinLowEdge(l+1);var A=m.fYaxis.GetBinLowEdge(p+1);q=!0}if((k>e||n<h)&&k<n-1){var B=m.fZaxis.GetBinLowEdge(k+1);var K=m.fZaxis.GetBinLowEdge(n+1);q=!0}q&&this.frame_painter().Zoom(v,r,D,A,B,K)}}};Q.prototype.FillHistContextMenu=function(a){var b=e.getDrawSettings("ROOT."+
this.GetObject()._typename,"nosame");a.addDrawMenu("Draw with",b.opts,function(a){if("inspect"===a)return this.ShowInspector();this.DecodeOptions(a);this.InteractiveRedraw(!0,"drawopt")})};e.Painter.drawHistogram3D=function(a,b,c){b=new e.TH3Painter(b);b.SetDivId(a,4);b.DecodeOptions(c);b.CheckPadRange();b.ScanContent();b.Redraw();(a=b.CreateStat())&&e.draw(b.divid,a,"");b.FillToolbar();return b.DrawingReady()};X.prototype=Object.create(e.TObjectPainter.prototype);X.prototype.DecodeOptions=function(a){var b=
new e.DrawOptions(a);this.options||(this.options={});var c=this.options;c.Color=b.check("COL");c.Line=b.check("LINE");c.Error=b.check("ERR")&&this.MatchObjectType("TGraph2DErrors");c.Circles=b.check("P0");c.Markers=b.check("P");c.Markers||c.Error||c.Circles||c.Line||(c.Markers=!0);c.Markers||(c.Color=!1);this.OptionsStore(a)};X.prototype.CreateHistogram=function(){for(var a=this.GetObject(),b=a.fX[0],c=b,d=a.fY[0],h=d,w=a.fZ[0],q=w,f=0;f<a.fNpoints;++f){var u=a.fX[f],m=a.fY[f],g=a.fZ[f],t=this.options.Error?
a.fEX[f]:0,y=this.options.Error?a.fEY[f]:0,l=this.options.Error?a.fEZ[f]:0;b=Math.min(b,u-t);c=Math.max(c,u+t);d=Math.min(d,m-y);h=Math.max(h,m+y);w=Math.min(w,g-l);q=Math.max(q,g+l)}b>=c&&(c=b+1);d>=h&&(h=d+1);w>=q&&(q=w+1);f=.02*(c-b);m=.02*(h-d);t=.02*(q-w);a=b-f;f=c+f;u=d-m;m=h+m;g=w-t;t=q+t;0>a&&0<=b&&(a=.98*b);0<f&&0>=c&&(f=0);0>u&&0<=d&&(u=.98*d);0<m&&0>=h&&(m=0);0>g&&0<=w&&(g=.98*w);0<t&&0>=q&&(t=0);b=this.GetObject();-1111!=b.fMinimum&&(g=b.fMinimum);-1111!=b.fMaximum&&(t=b.fMaximum);c=e.CreateHistogram("TH2I",
10,10);c.fName=b.fName+"_h";c.fTitle=b.fTitle;c.fXaxis.fXmin=a;c.fXaxis.fXmax=f;c.fYaxis.fXmin=u;c.fYaxis.fXmax=m;c.fZaxis.fXmin=g;c.fZaxis.fXmax=t;c.fMinimum=g;c.fMaximum=t;c.fBits|=e.TH1StatusBits.kNoStats;return c};X.prototype.Graph2DTooltip=function(a){if(isNaN(a.index))return console.error("intersect.index not provided, check three.js version",h.REVISION,"expected r102"),null;var b=Math.floor(a.index/this.nvertex);if(0>b||b>=this.index.length)return null;b=this.index[b];var c=this.painter,d=
c.grx(this.graph.fX[b]),e=c.gry(this.graph.fY[b]),w=c.grz(this.graph.fZ[b]);if(this.check_next&&b+1<this.graph.fX.length){var q=function(a){return a*a};a=a.point;var f=c.grx(this.graph.fX[b+1]),u=c.gry(this.graph.fY[b+1]),m=c.grz(this.graph.fZ[b+1]);q(a.x-f)+q(a.y-u)+q(a.z-m)<q(a.x-d)+q(a.y-e)+q(a.z-w)&&(d=f,e=u,w=m,b++)}return{x1:d-this.scale0,x2:d+this.scale0,y1:e-this.scale0,y2:e+this.scale0,z1:w-this.scale0,z2:w+this.scale0,color:this.tip_color,lines:[this.tip_name,"pnt: "+b,"x: "+c.AxisAsText("x",
this.graph.fX[b]),"y: "+c.AxisAsText("y",this.graph.fY[b]),"z: "+c.AxisAsText("z",this.graph.fZ[b])]}};X.prototype.PointsCallback=function(a,b){e.extend(b,a);b.tip_name=this.GetTipName();b.tooltip=this.Graph2DTooltip;b.painter.toplevel.add(b);this.points_callback_cnt--;this.CheckCallbacks()};X.prototype.CheckCallbacks=function(){if(!(0<this.points_callback_cnt)){var a=this.frame_painter();a&&a.Render3D(100);this._drawing_ready||(this.DrawingReady(),this._drawing_ready=!0)}};X.prototype.Redraw=function(){function a(a,
b){for(var e=0,f=0;f<d.fNpoints;++f)d.fX[f]<c.scale_xmin||d.fX[f]>c.scale_xmax||d.fY[f]<c.scale_ymin||d.fY[f]>c.scale_ymax||d.fZ[f]<a||d.fZ[f]>=b||++e;return e}var b=this.main_painter(),c=this.frame_painter(),d=this.GetObject(),z=1;if(d&&b&&c&&c.mode3d){if(0<e.gStyle.OptimizeDraw&&!c.webgl){var w=a(c.scale_zmin,c.scale_zmax);5E4<w&&(z=Math.floor(w/5E4),2>=z&&(z=2))}var q=new e.TAttMarkerHandler(d);w=null;var f=[c.scale_zmin,c.scale_zmax];q=c.size_xy3d/100*q.GetFullSize();this.options.Circles&&(q=
.06*c.size_xy3d);c.usesvg&&(q*=.3);this.options.Color&&(f=b.GetContour(),w=b.GetPalette());this.points_callback_cnt=f.length-1;for(b=0;b<f.length-1;++b){var u=Math.max(f[b],c.scale_zmin),m=Math.min(f[b+1],c.scale_zmax);if(u>=m)this.points_callback_cnt--;else{var g=Math.floor(a(u,m)/z),t=null,y=0,l=new Int32Array(g),p=0,k=null,n=null,v=0,r=0;if(this.options.Markers||this.options.Circles)t=new e.Painter.PointsCreator(g,c.webgl,q/3);this.options.Error&&(k=new Float32Array(18*g));this.options.Line&&(n=
new Float32Array(6*(g-1)));for(g=0;g<d.fNpoints;++g)if(!(d.fX[g]<c.scale_xmin||d.fX[g]>c.scale_xmax||d.fY[g]<c.scale_ymin||d.fY[g]>c.scale_ymax||d.fZ[g]<u||d.fZ[g]>=m)){if(1<z&&(y=(y+1)%z,0!==y))continue;l[p++]=g;var D=c.grx(d.fX[g]),A=c.gry(d.fY[g]),B=c.grz(d.fZ[g]);t&&t.AddPoint(D,A,B);k&&(k[v]=c.grx(d.fX[g]-d.fEX[g]),k[v+1]=A,k[v+2]=B,k[v+3]=c.grx(d.fX[g]+d.fEX[g]),k[v+4]=A,k[v+5]=B,v+=6,k[v]=D,k[v+1]=c.gry(d.fY[g]-d.fEY[g]),k[v+2]=B,k[v+3]=D,k[v+4]=c.gry(d.fY[g]+d.fEY[g]),k[v+5]=B,v+=6,k[v]=D,
k[v+1]=A,k[v+2]=c.grz(d.fZ[g]-d.fEZ[g]),k[v+3]=D,k[v+4]=A,k[v+5]=c.grz(d.fZ[g]+d.fEZ[g]),v+=6);n&&(6<=r&&(n[r]=n[r-3],n[r+1]=n[r-2],n[r+2]=n[r-1],r+=3),n[r]=D,n[r+1]=A,n[r+2]=B,r+=3)}n&&3<r&&n.length==r&&(u=this.get_color(this.GetObject().fLineColor),u=new h.LineBasicMaterial({color:new h.Color(u)}),e.browser.isIE||(u.linewidth=this.GetObject().fLineWidth),n=e.Painter.createLineSegments(n,u),c.toplevel.add(n),n.graph=d,n.index=l,n.painter=c,n.scale0=.7*q,n.tip_name=this.GetTipName(),n.tip_color=3===
d.fMarkerColor?16711680:65280,n.nvertex=2,n.check_next=!0,n.tooltip=this.Graph2DTooltip);k&&(u=this.get_color(this.GetObject().fLineColor),u=new h.LineBasicMaterial({color:new h.Color(u)}),e.browser.isIE||(u.linewidth=this.GetObject().fLineWidth),k=e.Painter.createLineSegments(k,u),c.toplevel.add(k),k.graph=d,k.index=l,k.painter=c,k.scale0=.7*q,k.tip_name=this.GetTipName(),k.tip_color=3===d.fMarkerColor?16711680:65280,k.nvertex=6,k.tooltip=this.Graph2DTooltip);t?(k="blue",this.options.Circles||(k=
w?w.calcColor(b,f.length):this.get_color(d.fMarkerColor)),t.AssignCallback(this.PointsCallback.bind(this,{graph:d,index:l,painter:c,scale0:.3*q,tip_color:3===d.fMarkerColor?16711680:65280})),t.CreatePoints({color:k,style:this.options.Circles?4:d.fMarkerStyle})):this.points_callback_cnt--}}this.CheckCallbacks()}};e.Painter.drawGraph2D=function(a,b,c){var d=new e.TGraph2DPainter(b);d.SetDivId(a,-1);d.DecodeOptions(c);if(d.main_painter())return d.SetDivId(a),d.Redraw(),d;b.fHistogram||(b.fHistogram=
d.CreateHistogram());e.draw(a,b.fHistogram,"lego;axis",function(b){d.ownhisto=!0;d.SetDivId(a);d.Redraw()});return d};e.Painter.drawPolyMarker3D=function(a,b,c){var d=new e.TObjectPainter(b);d.SetDivId(a);d.Redraw=function(){var a=this.frame_painter();if(a&&a.mode3d){for(var c=1,q=0,f=0;f<b.fP.length;f+=3)b.fP[f]<a.scale_xmin||b.fP[f]>a.scale_xmax||b.fP[f+1]<a.scale_ymin||b.fP[f+1]>a.scale_ymax||b.fP[f+2]<a.scale_zmin||b.fP[f+2]>a.scale_zmax||++q;0<e.gStyle.OptimizeDraw&&5E4<q&&(c=Math.floor(q/5E4),
2>=c&&(c=2));f=Math.floor(q/c);var u=new e.Painter.PointsCreator(f,a.webgl,a.size_xy3d/100),m=new Int32Array(f),g=q=0;for(f=0;f<b.fP.length;f+=3)if(!(b.fP[f]<a.scale_xmin||b.fP[f]>a.scale_xmax||b.fP[f+1]<a.scale_ymin||b.fP[f+1]>a.scale_ymax||b.fP[f+2]<a.scale_zmin||b.fP[f+2]>a.scale_zmax)){if(1<c&&(q=(q+1)%c,0!==q))continue;m[g++]=f;u.AddPoint(a.grx(b.fP[f]),a.gry(b.fP[f+1]),a.grz(b.fP[f+2]))}u.AssignCallback(function(c){a.toplevel.add(c);c.tip_color=3===b.fMarkerColor?16711680:65280;c.tip_name=b.fName||
"Poly3D";c.poly=b;c.painter=a;c.scale0=.7*u.scale;c.index=m;c.tooltip=function(a){if(isNaN(a.index))return console.error("intersect.index not provided, check three.js version",h.REVISION,"expected r102"),null;a=Math.floor(a.index/this.nvertex);if(0>a||a>=this.index.length)return null;a=this.index[a];var b=this.painter,c=b.grx(this.poly.fP[a]),d=b.gry(this.poly.fP[a+1]),e=b.grz(this.poly.fP[a+2]);return{x1:c-this.scale0,x2:c+this.scale0,y1:d-this.scale0,y2:d+this.scale0,z1:e-this.scale0,z2:e+this.scale0,
color:this.tip_color,lines:[this.tip_name,"pnt: "+a/3,"x: "+b.AxisAsText("x",this.poly.fP[a]),"y: "+b.AxisAsText("y",this.poly.fP[a+1]),"z: "+b.AxisAsText("z",this.poly.fP[a+2])]}};a.Render3D(100);d._did_redraw||d.DrawingReady();d._did_redraw=!0});u.CreatePoints({color:this.get_color(b.fMarkerColor),style:b.fMarkerStyle})}else this._did_redraw||this.DrawingReady(),this._did_redraw=!0};d.Redraw();return d};e.TH3Painter=Q;e.TGraph2DPainter=X;return e});
