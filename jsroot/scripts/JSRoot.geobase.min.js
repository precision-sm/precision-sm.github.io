var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(e,v,y){e!=Array.prototype&&e!=Object.prototype&&(e[v]=y.value)};$jscomp.getGlobal=function(e){return"undefined"!=typeof window&&window===e?e:"undefined"!=typeof global&&null!=global?global:e};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(e,v,y,A){if(v){y=$jscomp.global;e=e.split(".");for(A=0;A<e.length-1;A++){var nb=e[A];nb in y||(y[nb]={});y=y[nb]}e=e[e.length-1];A=y[e];v=v(A);v!=A&&null!=v&&$jscomp.defineProperty(y,e,{configurable:!0,writable:!0,value:v})}};$jscomp.polyfill("Number.isFinite",function(e){return e?e:function(e){return"number"!==typeof e?!1:!isNaN(e)&&Infinity!==e&&-Infinity!==e}},"es6","es3");
$jscomp.polyfill("Number.isInteger",function(e){return e?e:function(e){return Number.isFinite(e)?e===Math.floor(e):!1}},"es6","es3");
JSROOT.define(["three","csg"],function(e,v){function y(a){this.nfaces=a;this.indx=0;this.pos=new Float32Array(9*a);this.norm=new Float32Array(9*a);return this}function A(){this.polygons=[]}function nb(a,b){var d=[4,7,6,5,0,3,7,4,4,5,1,0,6,2,1,5,7,3,2,6,1,2,3,0];b=0<b?new A:new y(12);for(var c=0;c<d.length;c+=4){var f=3*d[c],h=3*d[c+1],n=3*d[c+2],k=3*d[c+3];b.addFace4(a[f],a[f+1],a[f+2],a[h],a[h+1],a[h+2],a[n],a[n+1],a[n+2],a[k],a[k+1],a[k+2]);0===c?b.setNormal(0,0,1):20===c?b.setNormal(0,0,-1):b.calcNormal()}return b.create()}
function Td(a,b){if("TGeoCone"==a._typename||"TGeoConeSeg"==a._typename){var d=[a.fRmax2,a.fRmax1];var c=[a.fRmin2,a.fRmin1]}else d=[a.fRmax,a.fRmax],c=[a.fRmin,a.fRmin];var f=0<c[0]||0<c[1],h=0,n=360;if("TGeoConeSeg"==a._typename||"TGeoTubeSeg"==a._typename||"TGeoCtub"==a._typename)h=a.fPhi1,n=a.fPhi2-a.fPhi1;var k=Math.max(4,Math.round(n/g.GradPerSegm)),e=k*(0>=d[0]||0>=d[1]?1:2);f&&(e+=k*(0>=c[0]||0>=c[1]?1:2));0<d[0]&&(e+=k*(0<c[0]?2:1));0<d[1]&&(e+=k*(0<c[1]?2:1));360>n&&(e+=(d[0]>c[0]?2:0)+
(d[1]>c[1]?2:0));if(0>b)return e;var l=h*Math.PI/180,m=n/k*Math.PI/180;h=new Float32Array(k+1);for(var r=new Float32Array(k+1),u=0;u<=k;++u)r[u]=Math.cos(l+u*m),h[u]=Math.sin(l+u*m);b=b?new A:new y(e);var x;"TGeoCtub"==a._typename&&(x=function(b,c,d){var f=0>d?a.fNlow:a.fNhigh;return(0>d?-a.fDz:a.fDz)-(b*f[0]+c*f[1])/f[2]});for(e=0;2>e&&(1!==e||f);++e){l=0===e?d:c;m=e;u=1-e;var w=1,pa=0;l[0]!==l[1]&&(pa=Math.atan2(l[1]-l[0],2*a.fDZ),w=Math.cos(pa),pa=Math.sin(pa));1===e&&(w*=-1,pa*=-1);var q=0;0>=
l[0]?q=2:0>=l[1]&&(q=1);for(var p=0;p<k;++p)b.addFace4(l[0]*r[p+m],l[0]*h[p+m],a.fDZ,l[1]*r[p+m],l[1]*h[p+m],-a.fDZ,l[1]*r[p+u],l[1]*h[p+u],-a.fDZ,l[0]*r[p+u],l[0]*h[p+u],a.fDZ,q),x&&b.recalcZ(x),b.setNormal_12_34(w*r[p+m],w*h[p+m],pa,w*r[p+u],w*h[p+u],pa,q)}for(f=0;2>f;++f)if(!(0>=d[f])){e=f;l=1-f;m=0==f?1:-1;u=0>=c[f]?2:0;2!=u||360!==n||x||b.startPolygon(0===f);for(w=0;w<k;++w)b.addFace4(c[f]*r[w+e],c[f]*h[w+e],m*a.fDZ,d[f]*r[w+e],d[f]*h[w+e],m*a.fDZ,d[f]*r[w+l],d[f]*h[w+l],m*a.fDZ,c[f]*r[w+l],
c[f]*h[w+l],m*a.fDZ,u),x?(b.recalcZ(x),b.calcNormal()):b.setNormal(0,0,m);b.stopPolygon()}360>n&&(b.addFace4(c[1]*r[0],c[1]*h[0],-a.fDZ,d[1]*r[0],d[1]*h[0],-a.fDZ,d[0]*r[0],d[0]*h[0],a.fDZ,c[0]*r[0],c[0]*h[0],a.fDZ,d[0]===c[0]?2:c[1]===d[1]?1:0),x&&b.recalcZ(x),b.calcNormal(),b.addFace4(c[0]*r[k],c[0]*h[k],a.fDZ,d[0]*r[k],d[0]*h[k],a.fDZ,d[1]*r[k],d[1]*h[k],-a.fDZ,c[1]*r[k],c[1]*h[k],-a.fDZ,d[0]===c[0]?1:c[1]===d[1]?2:0),x&&b.recalcZ(x),b.calcNormal());return b.create()}function Tb(a,b){if(!a||!a.fN||
!a.fP)return null;var d=new e.Vector3(a.fP[0],a.fP[1],a.fP[2]);a=new e.Vector3(a.fN[0],a.fN[1],a.fN[2]);a.normalize();var c=1E10;if(b){if(b){var f=null;b instanceof v.Geometry?f=b.tree.collectPolygons([]):b.polygons&&(f=b.polygons);if(null!==f){b=new e.Box3;for(var h=0;h<f.length;++h)for(var n=f[h],k=n.vertices.length,g=0;g<k;++g)b.expandByPoint(n.vertices[g]);f=b}else b.boundingBox||b.computeBoundingBox(),f=b.boundingBox.clone()}else f=null;f&&(c=1E3*f.getSize(new e.Vector3).length())}f=new e.Vector3(-c,
-c/2,0);b=new e.Vector3(0,c,0);h=new e.Vector3(c,-c/2,0);c=new e.Vector3(0,0,-c);n=new e.Geometry;n.vertices.push(f,b,h,c);n.faces.push(new e.Face3(0,2,1));n.faces.push(new e.Face3(0,1,3));n.faces.push(new e.Face3(1,2,3));n.faces.push(new e.Face3(2,0,3));n.lookAt(a);n.computeFaceNormals();f.add(d);b.add(d);h.add(d);c.add(d);return n}function Z(a){return a?a instanceof v.Geometry?a.tree.numPolygons():"BufferGeometry"==a.type?(a=a.getAttribute("position"))&&a.count?Math.round(a.count/3):0:a.polygons?
a.polygons.length:a.faces.length:0}function He(a,b){if(0>b)return Ja(a.fNode.fLeft,-10)+Ja(a.fNode.fRight,-10);var d=!1,c=g.createMatrix(a.fNode.fLeftMat);var f=g.createMatrix(a.fNode.fRightMat);0===b?b=4E3:d=!0;c&&-.9>c.determinant()&&g.warn("Axis reflection in left composite shape - not supported");f&&-.9>f.determinant()&&g.warn("Axis reflections in right composite shape - not supported");var h="TGeoHalfSpace"==a.fNode.fLeft._typename?Tb(a.fNode.fLeft):Ja(a.fNode.fLeft,b);if(!h)return null;var n=
Z(h),k=0;h._exceed_limit&&(n+=b);if(n<b){var e="TGeoHalfSpace"==a.fNode.fRight._typename?Tb(a.fNode.fRight,h):Ja(a.fNode.fRight,b);k=Z(e)}if(n+k>=b||!e)return h.polygons&&(h=v.CreateBufferGeometry(h.polygons)),c&&h.applyMatrix4(c),h._exceed_limit=!0,h;b=new v.Geometry(h,c,g.CompressComp?0:void 0);f=new v.Geometry(e,f,b.maxid);b.maxid=f.maxid;switch(a.fNode._typename){case "TGeoIntersection":b.direct_intersect(f);break;case "TGeoUnion":b.direct_union(f);break;case "TGeoSubtraction":b.direct_subtract(f);
break;default:g.warn("unsupported bool operation "+a.fNode._typename+", use first geom")}0===Z(b)&&(g.warn("Zero faces in comp shape left: "+a.fNode.fLeft._typename+" "+Z(h)+" faces right: "+a.fNode.fRight._typename+" "+Z(e)+" faces  use first"),b=new v.Geometry(h,c));return d?{polygons:b.toPolygons()}:b.toBufferGeometry()}function Ub(a){function b(a){return void 0===a?"???":a==Math.round(a)&&1E7>a?Math.round(a):f?a.toExponential(4):a.toPrecision(7)}var d=[],c=null;void 0!==a.fVolume?c=a.fVolume.fShape:
void 0!==a.fShape?c=a.fShape:void 0!==a.fShapeBits&&void 0!==a.fShapeId&&(c=a);if(!c)return d.push(a._typename),d;a=Math.max(c.fDX,c.fDY,c.fDZ);var f=1E7<a||1E-7>a;d.push(c._typename);d.push("DX="+b(c.fDX)+" DY="+b(c.fDY)+" DZ="+b(c.fDZ));switch(c._typename){case "TGeoPara":d.push("Alpha="+c.fAlpha+" Phi="+c.fPhi+" Theta="+c.fTheta);break;case "TGeoTrd2":d.push("Dy1="+b(c.fDy1)+" Dy2="+b(c.fDy1));case "TGeoTrd1":d.push("Dx1="+b(c.fDx1)+" Dx2="+b(c.fDx1));break;case "TGeoSphere":d.push("Rmin="+b(c.fRmin)+
" Rmax="+b(c.fRmax));d.push("Phi1="+c.fPhi1+" Phi2="+c.fPhi2);d.push("Theta1="+c.fTheta1+" Theta2="+c.fTheta2);break;case "TGeoConeSeg":d.push("Phi1="+c.fPhi1+" Phi2="+c.fPhi2);case "TGeoCone":d.push("Rmin1="+b(c.fRmin1)+" Rmax1="+b(c.fRmax1));d.push("Rmin2="+b(c.fRmin2)+" Rmax2="+b(c.fRmax2));break;case "TGeoCtub":case "TGeoTubeSeg":d.push("Phi1="+c.fPhi1+" Phi2="+c.fPhi2);case "TGeoEltu":case "TGeoTube":d.push("Rmin="+b(c.fRmin)+" Rmax="+b(c.fRmax));break;case "TGeoTorus":d.push("Rmin="+b(c.fRmin)+
" Rmax="+b(c.fRmax));d.push("Phi1="+c.fPhi1+" Dphi="+c.fDphi);break;case "TGeoParaboloid":d.push("Rlo="+b(c.fRlo)+" Rhi="+b(c.fRhi));d.push("A="+b(c.fA)+" B="+b(c.fB));break;case "TGeoHype":d.push("Rmin="+b(c.fRmin)+" Rmax="+b(c.fRmax));d.push("StIn="+b(c.fStIn)+" StOut="+b(c.fStOut));break;case "TGeoScaledShape":d=Ub(c.fShape),c.fScale&&d.unshift("Scale X="+c.fScale.fScale[0]+" Y="+c.fScale.fScale[1]+" Z="+c.fScale.fScale[2])}return d}function Vb(a){var b=new e.Matrix4;a.updateMatrixWorld();a.matrixWorldInverse.getInverse(a.matrixWorld);
b.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse);return b}function t(a,b){this.toplevel=!0;this.name_prefix="";this.maxdepth=1;this.vislevel=4;this.maxnodes=1E4;a?(a.$geoh&&(this.toplevel=!1),this.createClones(a)):b&&(this.nodes=b)}function Wb(a,b){var d=new e.Vector3(1,1,-1);if(void 0===a.geomZ)if("BufferGeometry"==a.geom.type){var c=a.geom.getAttribute("position").array,f=a.geom.getAttribute("normal").array,h=a.geom.getIndex();if(h){h=h.array;var n=a.geom.drawRange.start,k=a.geom.drawRange.count;
n+k>h.length&&(k=h.length-n);for(var g=new Float32Array(3*k),l=new Float32Array(3*k),m=0;m<k;++m){var r=h[n+m];(0>r||3*r>=c.length)&&console.log("strange index",3*r,c.length);g[3*m]=c[3*r];g[3*m+1]=c[3*r+1];g[3*m+2]=c[3*r+2];l[3*m]=f[3*r];l[3*m+1]=f[3*r+1];l[3*m+2]=f[3*r+2]}c=g;f=l}h=c.length;k=0;g=new Float32Array(h);l=new Float32Array(h);for(n=0;n<h;n+=3)g[n]=c[n+k],g[n+1]=c[n+1+k],g[n+2]=-c[n+2+k],l[n]=f[n+k],l[n+1]=f[n+1+k],l[n+2]=-f[n+2+k],k+=3,6===k&&(k=-3);a.geomZ=new e.BufferGeometry;a.geomZ.setAttribute("position",
new e.BufferAttribute(g,3));a.geomZ.setAttribute("normal",new e.BufferAttribute(l,3))}else for(a.geomZ=a.geom.clone(),a.geomZ.scale(d.x,d.y,d.z),h=0;h<a.geomZ.faces.length;)c=geom.faces[h++],f=c.b,c.b=c.c,c.c=f;a=new e.Mesh(a.geomZ,b);a.scale.copy(d);a.updateMatrix();a._flippedMesh=!0;return a}function Xb(a,b,d){if(!a||!a.geometry)return b;b||(b=new e.Box3,b.makeEmpty());d||a.updateMatrixWorld();var c=new e.Vector3,f=a.geometry;if(f.isGeometry){f=f.vertices;for(var h=0,n=f.length;h<n;h++)c.copy(f[h]),
d||c.applyMatrix4(a.matrixWorld),b.expandByPoint(c)}else if(f.isBufferGeometry&&(f=f.attributes.position,void 0!==f))for(h=0,n=f.count;h<n;h++)c.fromBufferAttribute(f,h),d||c.applyMatrix4(a.matrixWorld),b.expandByPoint(c);return b}var g={GradPerSegm:6,CompressComp:!0,CompLimit:20};g.BITS={kVisOverride:JSROOT.BIT(0),kVisNone:JSROOT.BIT(1),kVisThis:JSROOT.BIT(2),kVisDaughters:JSROOT.BIT(3),kVisOneLevel:JSROOT.BIT(4),kVisStreamed:JSROOT.BIT(5),kVisTouched:JSROOT.BIT(6),kVisOnScreen:JSROOT.BIT(7),kVisContainers:JSROOT.BIT(12),
kVisOnly:JSROOT.BIT(13),kVisBranch:JSROOT.BIT(14),kVisRaytrace:JSROOT.BIT(15)};g.TestBit=function(a,b){a=a.fGeoAtt;return void 0===a?!1:0!==(a&b)};g.SetBit=function(a,b,d){void 0!==a.fGeoAtt&&(a.fGeoAtt=d?a.fGeoAtt|b:a.fGeoAtt&~b)};g.ToggleBit=function(a,b){void 0!==a.fGeoAtt&&(a.fGeoAtt^=b&16777215)};g.setInvisibleAll=function(a,b){void 0===b&&(b=!0);g.SetBit(a,g.BITS.kVisThis,!b);if(a.fNodes)for(var d=0;d<a.fNodes.arr.length;++d)g.SetBit(a.fNodes.arr[d].fVolume,g.BITS.kVisThis,!b)};g.warn=function(a){void 0===
g._warn_msgs&&(g._warn_msgs={});void 0===g._warn_msgs[a]&&(g._warn_msgs[a]=!0,console.warn(a))};g.getNodeKind=function(a){return void 0===a||null===a||"object"!==typeof a?-1:"fShape"in a&&"fTrans"in a?1:0};g.countNumShapes=function(a){return a?"TGeoCompositeShape"!==a._typename?1:g.countNumShapes(a.fNode.fLeft)+g.countNumShapes(a.fNode.fRight):0};g.produceNormal=function(a,b,d,c,f,h,n,k,g){a=new e.Vector3(a,b,d);c=new e.Vector3(c,f,h);n=new e.Vector3(n,k,g);k=new e.Vector3;g=new e.Vector3;k.subVectors(n,
c);g.subVectors(a,c);k.cross(g);return k};y.prototype.addFace3=function(a,b,d,c,f,h,n,e,g){var k=this.indx,m=this.pos;m[k]=a;m[k+1]=b;m[k+2]=d;m[k+3]=c;m[k+4]=f;m[k+5]=h;m[k+6]=n;m[k+7]=e;m[k+8]=g;this.last4=!1;this.indx=k+9};y.prototype.startPolygon=function(){};y.prototype.stopPolygon=function(){};y.prototype.addFace4=function(a,b,d,c,f,h,n,k,e,l,g,r,u){var x=this.indx,m=this.pos;1!==u&&(m[x]=a,m[x+1]=b,m[x+2]=d,m[x+3]=c,m[x+4]=f,m[x+5]=h,m[x+6]=n,m[x+7]=k,m[x+8]=e,x+=9);2!==u&&(m[x]=a,m[x+1]=b,
m[x+2]=d,m[x+3]=n,m[x+4]=k,m[x+5]=e,m[x+6]=l,m[x+7]=g,m[x+8]=r,x+=9);this.last4=x!==this.indx+9;this.indx=x};y.prototype.setNormal4=function(a,b,d,c,f,h,n,k,e,l,g,r,u){if(this.last4&&u)return console.error("missmatch between addFace4 and setNormal4 calls");var m=this.indx-(this.last4?18:9),w=this.norm;1!==u&&(w[m]=a,w[m+1]=b,w[m+2]=d,w[m+3]=c,w[m+4]=f,w[m+5]=h,w[m+6]=n,w[m+7]=k,w[m+8]=e,m+=9);2!==u&&(w[m]=a,w[m+1]=b,w[m+2]=d,w[m+3]=n,w[m+4]=k,w[m+5]=e,w[m+6]=l,w[m+7]=g,w[m+8]=r)};y.prototype.recalcZ=
function(a){for(var b=this.pos,d=this.indx,c=d-(this.last4?18:9);c<d;)b[c+2]=a(b[c],b[c+1],b[c+2]),c+=3};y.prototype.calcNormal=function(){this.cb||(this.pA=new e.Vector3,this.pB=new e.Vector3,this.pC=new e.Vector3,this.cb=new e.Vector3,this.ab=new e.Vector3);this.pA.fromArray(this.pos,this.indx-9);this.pB.fromArray(this.pos,this.indx-6);this.pC.fromArray(this.pos,this.indx-3);this.cb.subVectors(this.pC,this.pB);this.ab.subVectors(this.pA,this.pB);this.cb.cross(this.ab);this.setNormal(this.cb.x,this.cb.y,
this.cb.z)};y.prototype.setNormal=function(a,b,d){var c=this.indx-9,f=this.norm;f[c]=f[c+3]=f[c+6]=a;f[c+1]=f[c+4]=f[c+7]=b;f[c+2]=f[c+5]=f[c+8]=d;this.last4&&(c-=9,f[c]=f[c+3]=f[c+6]=a,f[c+1]=f[c+4]=f[c+7]=b,f[c+2]=f[c+5]=f[c+8]=d)};y.prototype.setNormal_12_34=function(a,b,d,c,f,h,n){void 0===n&&(n=0);var e=this.indx-(0<n?9:18),g=this.norm;1!==n&&(g[e]=a,g[e+1]=b,g[e+2]=d,g[e+3]=a,g[e+4]=b,g[e+5]=d,g[e+6]=c,g[e+7]=f,g[e+8]=h,e+=9);2!==n&&(g[e]=a,g[e+1]=b,g[e+2]=d,g[e+3]=c,g[e+4]=f,g[e+5]=h,g[e+6]=
c,g[e+7]=f,g[e+8]=h)};y.prototype.create=function(){this.nfaces!==this.indx/9&&console.error("Mismatch with created "+this.nfaces+" and filled "+this.indx/9+" number of faces");var a=new e.BufferGeometry;a.setAttribute("position",new e.BufferAttribute(this.pos,3));a.setAttribute("normal",new e.BufferAttribute(this.norm,3));return a};A.prototype.startPolygon=function(a){this.multi=1;this.mnormal=a};A.prototype.stopPolygon=function(){this.multi&&(this.multi=0,console.error("Polygon should be already closed at this moment"))};
A.prototype.addFace3=function(a,b,d,c,f,h,e,k,g){this.addFace4(a,b,d,c,f,h,e,k,g,e,k,g,2)};A.prototype.addFace4=function(a,b,d,c,f,h,e,g,Y,l,m,r,u){void 0===u&&(u=0);this.v1=new v.Vertex(a,b,d,0,0,0);this.v2=1===u?null:new v.Vertex(c,f,h,0,0,0);this.v3=new v.Vertex(e,g,Y,0,0,0);this.v4=2===u?null:new v.Vertex(l,m,r,0,0,0);this.reduce=u;if(this.multi)2!==u&&console.error("polygon not supported for not-reduced faces"),1===this.multi++?(u=new v.Polygon,u.vertices.push(this.mnormal?this.v2:this.v3),this.polygons.push(u)):
(u=this.polygons[this.polygons.length-1],1E-12<(this.mnormal?this.v2:this.v3).diff(this.mnormal?u.vertices[u.vertices.length-1]:u.vertices[0])&&console.error("vertex missmatch when building polygon")),1E-12>(this.mnormal?this.v3:this.v2).diff(this.mnormal?u.vertices[0]:u.vertices[u.vertices.length-1])?this.multi=0:this.mnormal?u.vertices.push(this.v3):u.vertices.unshift(this.v2);else{a=new v.Polygon;switch(u){case 0:a.vertices.push(this.v1,this.v2,this.v3,this.v4);break;case 1:a.vertices.push(this.v1,
this.v3,this.v4);break;case 2:a.vertices.push(this.v1,this.v2,this.v3)}this.polygons.push(a)}};A.prototype.setNormal4=function(a,b,d,c,f,h,e,g,Y,l,m,r){this.v1.setnormal(a,b,d);this.v2&&this.v2.setnormal(c,f,h);this.v3.setnormal(e,g,Y);this.v4&&this.v4.setnormal(l,m,r)};A.prototype.setNormal_12_34=function(a,b,d,c,f,h){this.v1.setnormal(a,b,d);this.v2&&this.v2.setnormal(a,b,d);this.v3.setnormal(c,f,h);this.v4&&this.v4.setnormal(c,f,h)};A.prototype.calcNormal=function(){this.cb||(this.pA=new e.Vector3,
this.pB=new e.Vector3,this.pC=new e.Vector3,this.cb=new e.Vector3,this.ab=new e.Vector3);this.pA.set(this.v1.x,this.v1.y,this.v1.z);1!==this.reduce?(this.pB.set(this.v2.x,this.v2.y,this.v2.z),this.pC.set(this.v3.x,this.v3.y,this.v3.z)):(this.pB.set(this.v3.x,this.v3.y,this.v3.z),this.pC.set(this.v4.x,this.v4.y,this.v4.z));this.cb.subVectors(this.pC,this.pB);this.ab.subVectors(this.pA,this.pB);this.cb.cross(this.ab);this.setNormal(this.cb.x,this.cb.y,this.cb.z)};A.prototype.setNormal=function(a,b,
d){this.v1.setnormal(a,b,d);this.v2&&this.v2.setnormal(a,b,d);this.v3.setnormal(a,b,d);this.v4&&this.v4.setnormal(a,b,d)};A.prototype.recalcZ=function(a){this.v1.z=a(this.v1.x,this.v1.y,this.v1.z);this.v2&&(this.v2.z=a(this.v2.x,this.v2.y,this.v2.z));this.v3.z=a(this.v3.x,this.v3.y,this.v3.z);this.v4&&(this.v4.z=a(this.v4.x,this.v4.y,this.v4.z))};A.prototype.create=function(){return{polygons:this.polygons}};g.createMatrix=function(a){if(!a)return null;switch(a._typename){case "TGeoTranslation":var b=
a.fTranslation;break;case "TGeoRotation":var d=a.fRotationMatrix;break;case "TGeoScale":var c=a.fScale;break;case "TGeoGenTrans":c=a.fScale;case "TGeoCombiTrans":b=a.fTranslation;a.fRotation&&(d=a.fRotation.fRotationMatrix);break;case "TGeoHMatrix":b=a.fTranslation;d=a.fRotationMatrix;c=a.fScale;break;case "TGeoIdentity":break;default:console.warn("unsupported matrix "+a._typename)}if(!b&&!d&&!c)return null;a=new e.Matrix4;d&&a.set(d[0],d[1],d[2],0,d[3],d[4],d[5],0,d[6],d[7],d[8],0,0,0,0,1);b&&a.setPosition(b[0],
b[1],b[2]);c&&a.scale(new e.Vector3(c[0],c[1],c[2]));return a};g.getNodeMatrix=function(a,b){var d=null;if(1===a)d=new e.Matrix4,b.fTrans&&(d.set(b.fTrans[0],b.fTrans[4],b.fTrans[8],0,b.fTrans[1],b.fTrans[5],b.fTrans[9],0,b.fTrans[2],b.fTrans[6],b.fTrans[10],0,0,0,0,1),d.setPosition(b.fTrans[12],b.fTrans[13],b.fTrans[14]));else if(b.fMatrix)d=g.createMatrix(b.fMatrix);else if("TGeoNodeOffset"==b._typename&&b.fFinder)switch(a=JSROOT.BIT(14),0!==(b.fFinder.fBits&a)&&g.warn("Unsupported reflected pattern "+
b.fFinder._typename),b.fFinder._typename){case "TGeoPatternX":case "TGeoPatternY":case "TGeoPatternZ":case "TGeoPatternParaX":case "TGeoPatternParaY":case "TGeoPatternParaZ":a=b.fFinder.fStart+(b.fIndex+.5)*b.fFinder.fStep;d=new e.Matrix4;switch(b.fFinder._typename[b.fFinder._typename.length-1]){case "X":d.setPosition(a,0,0);break;case "Y":d.setPosition(0,a,0);break;case "Z":d.setPosition(0,0,a)}break;case "TGeoPatternCylPhi":d=Math.PI/180*(b.fFinder.fStart+(b.fIndex+.5)*b.fFinder.fStep);b=Math.cos(d);
a=Math.sin(d);d=new e.Matrix4;d.set(b,-a,0,0,a,b,0,0,0,0,1,0,0,0,0,1);break;case "TGeoPatternCylR":d=new e.Matrix4;break;case "TGeoPatternTrapZ":a=b.fFinder.fStart+(b.fIndex+.5)*b.fFinder.fStep;d=new e.Matrix4;d.setPosition(b.fFinder.fTxz*a,b.fFinder.fTyz*a,a);break;default:g.warn("Unsupported pattern type "+b.fFinder._typename)}return d};g.numGeometryFaces=function(a){return a?a instanceof v.Geometry?a.tree.numPolygons():"BufferGeometry"==a.type?(a=a.getAttribute("position"))&&a.count?Math.round(a.count/
3):0:a.polygons?a.polygons.length:a.faces.length:0};g.numGeometryVertices=function(a){return a?a instanceof v.Geometry?3*a.tree.numPolygons():"BufferGeometry"==a.type?(a=a.getAttribute("position"))?a.count:0:a.polygons?4*a.polygons.length:a.vertices.length:0};var Ja=function(a,b){void 0===b&&(b=0);try{switch(a._typename){case "TGeoBBox":if(0>b)var d=12;else{var c=a.fDX,f=a.fDY,h=a.fDZ,n=b?new A:new y(12);n.addFace4(c,f,h,c,-f,h,c,-f,-h,c,f,-h);n.setNormal(1,0,0);n.addFace4(-c,f,-h,-c,-f,-h,-c,-f,
h,-c,f,h);n.setNormal(-1,0,0);n.addFace4(-c,f,-h,-c,f,h,c,f,h,c,f,-h);n.setNormal(0,1,0);n.addFace4(-c,-f,h,-c,-f,-h,c,-f,-h,c,-f,h);n.setNormal(0,-1,0);n.addFace4(-c,f,h,-c,-f,h,c,-f,h,c,f,h);n.setNormal(0,0,1);n.addFace4(c,f,-h,c,-f,-h,-c,-f,-h,-c,f,-h);n.setNormal(0,0,-1);d=n.create()}return d;case "TGeoPara":if(0>b)var k=12;else{var Y=a.fTxy,l=a.fTxz,m=a.fTyz;k=nb([-a.fZ*l-Y*a.fY-a.fX,-a.fY-a.fZ*m,-a.fZ,-a.fZ*l+Y*a.fY-a.fX,a.fY-a.fZ*m,-a.fZ,-a.fZ*l+Y*a.fY+a.fX,a.fY-a.fZ*m,-a.fZ,-a.fZ*l-Y*a.fY+
a.fX,-a.fY-a.fZ*m,-a.fZ,a.fZ*l-Y*a.fY-a.fX,-a.fY+a.fZ*m,a.fZ,a.fZ*l+Y*a.fY-a.fX,a.fY+a.fZ*m,a.fZ,a.fZ*l+Y*a.fY+a.fX,a.fY+a.fZ*m,a.fZ,a.fZ*l-Y*a.fY+a.fX,-a.fY+a.fZ*m,a.fZ],b)}return k;case "TGeoTrd1":case "TGeoTrd2":if(0>b)var r=12;else{var u;if("TGeoTrd1"==a._typename)var x=u=a.fDY;else x=a.fDy1,u=a.fDy2;r=nb([-a.fDx1,x,-a.fDZ,a.fDx1,x,-a.fDZ,a.fDx1,-x,-a.fDZ,-a.fDx1,-x,-a.fDZ,-a.fDx2,u,a.fDZ,a.fDx2,u,a.fDZ,a.fDx2,-u,a.fDZ,-a.fDx2,-u,a.fDZ],b)}return r;case "TGeoArb8":case "TGeoTrap":case "TGeoGtra":var w=
b;if(0>w)var pa=12;else{for(var q=[a.fXY[0][0],a.fXY[0][1],-a.fDZ,a.fXY[1][0],a.fXY[1][1],-a.fDZ,a.fXY[2][0],a.fXY[2][1],-a.fDZ,a.fXY[3][0],a.fXY[3][1],-a.fDZ,a.fXY[4][0],a.fXY[4][1],a.fDZ,a.fXY[5][0],a.fXY[5][1],a.fDZ,a.fXY[6][0],a.fXY[6][1],a.fDZ,a.fXY[7][0],a.fXY[7][1],a.fDZ],p=[4,7,6,6,5,4,3,7,4,4,0,3,5,1,0,0,4,5,6,2,1,1,5,6,7,3,2,2,6,7,1,2,3,3,0,1],t=0;t<q.length;t+=q.length/2)for(var v=t;v<t+q.length/2-3;v+=3)for(var ob=v+3;ob<t+q.length/2;ob+=3)if(q[v]===q[ob]&&q[v+1]===q[ob+1]&&q[v+2]===q[ob+
2])for(var Z=0;Z<p.length;++Z)p[Z]===ob/3&&(p[Z]=v/3);for(var Ac=[],Tb=0,C=0;C<p.length;C+=3){var Ub=100*p[C]+10*p[C+1]+p[C+2],Vb=100*p[C+1]+10*p[C+2]+p[C],Wb=100*p[C+2]+10*p[C]+p[C+1];p[C]==p[C+1]||p[C]==p[C+2]||p[C+1]==p[C+2]||0<=Ac.indexOf(Ub)||0<=Ac.indexOf(Vb)||0<=Ac.indexOf(Wb)?p[C]=p[C+1]=p[C+2]=-1:(Ac.push(Ub,Vb,Wb),Tb++)}for(var Ta=w?new A:new y(Tb),qa=0;qa<p.length;qa+=6){var ja=3*p[qa],wa=3*p[qa+1],xa=3*p[qa+2],Ka=3*p[qa+3],ya=3*p[qa+4],pb=3*p[qa+5],Ua=null;if(0<=ja&&0<=Ka&&w)if(0===qa)Ua=
new e.Vector3(0,0,1);else if(30===qa)Ua=new e.Vector3(0,0,-1);else{var wd=g.produceNormal(q[ja],q[ja+1],q[ja+2],q[wa],q[wa+1],q[wa+2],q[xa],q[xa+1],q[xa+2]);wd.normalize();var Xb=g.produceNormal(q[Ka],q[Ka+1],q[Ka+2],q[ya],q[ya+1],q[ya+2],q[pb],q[pb+1],q[pb+2]);Xb.normalize();1E-12>wd.distanceToSquared(Xb)&&(Ua=wd)}null!==Ua?(Ta.addFace4(q[ja],q[ja+1],q[ja+2],q[wa],q[wa+1],q[wa+2],q[xa],q[xa+1],q[xa+2],q[ya],q[ya+1],q[ya+2]),Ta.setNormal(Ua.x,Ua.y,Ua.z)):(0<=ja&&(Ta.addFace3(q[ja],q[ja+1],q[ja+2],
q[wa],q[wa+1],q[wa+2],q[xa],q[xa+1],q[xa+2]),Ta.calcNormal()),0<=Ka&&(Ta.addFace3(q[Ka],q[Ka+1],q[Ka+2],q[ya],q[ya+1],q[ya+2],q[pb],q[pb+1],q[pb+2]),Ta.calcNormal()))}pa=Ta.create()}return pa;case "TGeoSphere":var Bc=b,B=[a.fRmax,a.fRmin],Ie=a.fPhi1,xd=a.fPhi2-a.fPhi1,Je=a.fTheta1,Ke=a.fTheta2-a.fTheta1,G=a.fNseg,I=a.fNz,La=0>=B[1];if(0<Bc){var yd=(La?2:4)*G*I/Bc;1<yd&&(G=Math.max(4,Math.floor(G/Math.sqrt(yd))),I=Math.max(4,Math.floor(I/Math.sqrt(yd))))}var Cc=G*I*2,Dc=2*G,Ec=2*G,Ud=360===xd?0:I*
(La?2:4);La&&(Ec=Dc=G);if(0>Bc)var Vd=Cc*(La?1:2)+Dc+Ec+Ud;else{for(var J=new Float32Array(G+1),K=new Float32Array(G+1),z=new Float32Array(I+1),L=new Float32Array(I+1),Yb=0;Yb<=I;++Yb){var Wd=(Je+Ke/I*Yb)*Math.PI/180;z[Yb]=Math.sin(Wd);L[Yb]=Math.cos(Wd)}for(var Zb=0;Zb<=G;++Zb){var Xd=(Ie+xd/G*Zb)*Math.PI/180;J[Zb]=Math.sin(Xd);K[Zb]=Math.cos(Xd)}1E-10>=Math.abs(z[0])&&(Cc-=G,Dc=0);1E-10>=Math.abs(z[I])&&(Cc-=G,Ec=0);for(var Le=Cc*(La?1:2)+Dc+Ec+Ud,Va=Bc?new A:new y(Le),qb=0;2>qb&&(1!==qb||!La);++qb)for(var aa=
B[qb],ba=0===qb?1:-1,Yd=1-qb,Me=1-Yd,Fc=0;Fc<I;++Fc){var W=Fc+Yd,X=Fc+Me,Gc=0;1E-10>=Math.abs(z[W])?Gc=1:1E-10>=Math.abs(z[X])&&(Gc=2);for(var E=0;E<G;++E)Va.addFace4(aa*z[W]*K[E],aa*z[W]*J[E],aa*L[W],aa*z[W]*K[E+1],aa*z[W]*J[E+1],aa*L[W],aa*z[X]*K[E+1],aa*z[X]*J[E+1],aa*L[X],aa*z[X]*K[E],aa*z[X]*J[E],aa*L[X],Gc),Va.setNormal4(ba*z[W]*K[E],ba*z[W]*J[E],ba*L[W],ba*z[W]*K[E+1],ba*z[W]*J[E+1],ba*L[W],ba*z[X]*K[E+1],ba*z[X]*J[E+1],ba*L[X],ba*z[X]*K[E],ba*z[X]*J[E],ba*L[X],Gc)}for(var rb=0;rb<=I;rb+=I)if(1E-10<=
Math.abs(z[rb]))for(var Ma=z[rb],Hc=L[rb],$b=0===rb?0:1,Ic=1-$b,ra=0;ra<G;++ra)Va.addFace4(B[1]*Ma*K[ra+$b],B[1]*Ma*J[ra+$b],B[1]*Hc,B[0]*Ma*K[ra+$b],B[0]*Ma*J[ra+$b],B[0]*Hc,B[0]*Ma*K[ra+Ic],B[0]*Ma*J[ra+Ic],B[0]*Hc,B[1]*Ma*K[ra+Ic],B[1]*Ma*J[ra+Ic],B[1]*Hc,La?2:0),Va.calcNormal();if(360>xd)for(var ac=0;ac<=G;ac+=G)for(var Jc=J[ac],Kc=K[ac],Wa=0===ac?1:0,sb=1-Wa,M=0;M<I;++M)Va.addFace4(B[1]*z[M+Wa]*Kc,B[1]*z[M+Wa]*Jc,B[1]*L[M+Wa],B[0]*z[M+Wa]*Kc,B[0]*z[M+Wa]*Jc,B[0]*L[M+Wa],B[0]*z[M+sb]*Kc,B[0]*
z[M+sb]*Jc,B[0]*L[M+sb],B[1]*z[M+sb]*Kc,B[1]*z[M+sb]*Jc,B[1]*L[M+sb],La?2:0),Va.calcNormal();Vd=Va.create()}return Vd;case "TGeoCone":case "TGeoConeSeg":case "TGeoTube":case "TGeoTubeSeg":case "TGeoCtub":return Td(a,b);case "TGeoEltu":var Zd=b,Na=Math.max(4,Math.round(360/g.GradPerSegm));if(0>Zd)var $d=4*Na;else{for(var Oa=new Float32Array(Na+1),Pa=new Float32Array(Na+1),bc=0;bc<=Na;++bc){var ae=bc/Na*2*Math.PI;Oa[bc]=a.fRmin*Math.cos(ae);Pa[bc]=a.fRmax*Math.sin(ae)}for(var cc=Zd?new A:new y(4*Na),
be,ce,tb=1,ub=0,ca=0;ca<Na;++ca){cc.addFace4(Oa[ca],Pa[ca],+a.fDZ,Oa[ca],Pa[ca],-a.fDZ,Oa[ca+1],Pa[ca+1],-a.fDZ,Oa[ca+1],Pa[ca+1],a.fDZ);be=tb;ce=ub;tb=Oa[ca+1]*a.fRmax/a.fRmin;ub=Pa[ca+1]*a.fRmin/a.fRmax;var de=Math.sqrt(tb*tb+ub*ub);tb/=de;ub/=de;cc.setNormal_12_34(be,ce,0,tb,ub,0)}for(var dc=0;2>dc;++dc)for(var Lc=0===dc?1:-1,ee=dc,fe=1-dc,vb=0;vb<Na;++vb)cc.addFace3(0,0,Lc*a.fDZ,Oa[vb+ee],Pa[vb+ee],Lc*a.fDZ,Oa[vb+fe],Pa[vb+fe],Lc*a.fDZ),cc.setNormal(0,0,Lc);$d=cc.create()}return $d;case "TGeoTorus":var wb=
b,D=a.fR,ka=Math.max(6,Math.round(360/g.GradPerSegm)),la=Math.max(8,Math.round(a.fDphi/g.GradPerSegm)),xb=(0<a.fRmin?4:2)*ka*(la+(360!==a.fDphi?1:0));if(0>wb)var ge=xb;else{0<wb&&xb>wb&&(ka=Math.floor(ka/Math.sqrt(xb/wb)),la=Math.floor(la/Math.sqrt(xb/wb)),xb=(0<a.fRmin?4:2)*ka*(la+(360!==a.fDphi?1:0)));for(var za=new Float32Array(ka+1),H=new Float32Array(ka+1),da=new Float32Array(la+1),ea=new Float32Array(la+1),yb=0;yb<=ka;++yb)za[yb]=Math.sin(yb/ka*2*Math.PI),H[yb]=Math.cos(yb/ka*2*Math.PI);for(var ec=
0;ec<=la;++ec){var he=(a.fPhi1+a.fDphi*ec/la)/180*Math.PI;da[ec]=Math.sin(he);ea[ec]=Math.cos(he)}for(var fc=wb?new A:new y(xb),Xa=new e.Vector3,Ya=new e.Vector3,Za=new e.Vector3,$a=new e.Vector3,Mc=new e.Vector3,Nc=new e.Vector3,Oc=new e.Vector3,Pc=new e.Vector3,Qc=new e.Vector3,Rc=new e.Vector3,zb=0;2>zb&&!(0<zb&&0>=a.fRmin);++zb)for(var fa=0<zb?a.fRmin:a.fRmax,ie=1-zb,Ne=1-ie,ha=0<zb?-1:1,Sc=0;Sc<la;++Sc){var Ab=Sc+ie,Bb=Sc+Ne;Qc.x=D*ea[Ab];Qc.y=D*da[Ab];Rc.x=D*ea[Bb];Rc.y=D*da[Bb];for(var N=0;N<
ka;++N)Xa.x=(D+fa*H[N])*ea[Ab],Xa.y=(D+fa*H[N])*da[Ab],Xa.z=fa*za[N],Ya.x=(D+fa*H[N+1])*ea[Ab],Ya.y=(D+fa*H[N+1])*da[Ab],Ya.z=fa*za[N+1],Za.x=(D+fa*H[N+1])*ea[Bb],Za.y=(D+fa*H[N+1])*da[Bb],Za.z=fa*za[N+1],$a.x=(D+fa*H[N])*ea[Bb],$a.y=(D+fa*H[N])*da[Bb],$a.z=fa*za[N],fc.addFace4(Xa.x,Xa.y,Xa.z,Ya.x,Ya.y,Ya.z,Za.x,Za.y,Za.z,$a.x,$a.y,$a.z),Mc.subVectors(Xa,Qc).normalize(),Nc.subVectors(Ya,Qc).normalize(),Oc.subVectors(Za,Rc).normalize(),Pc.subVectors($a,Rc).normalize(),fc.setNormal4(ha*Mc.x,ha*Mc.y,
ha*Mc.z,ha*Nc.x,ha*Nc.y,ha*Nc.z,ha*Oc.x,ha*Oc.y,ha*Oc.z,ha*Pc.x,ha*Pc.y,ha*Pc.z)}if(360!==a.fDphi)for(var O=0;O<=la;O+=la)for(var Cb=a.fRmax,Db=a.fRmin,ab=0<O?0:1,Eb=1-ab,Oe=0<a.fRmin?0:1,je=0<O?1:-1,P=0;P<ka;++P)fc.addFace4((D+Cb*H[P+ab])*ea[O],(D+Cb*H[P+ab])*da[O],Cb*za[P+ab],(D+Db*H[P+ab])*ea[O],(D+Db*H[P+ab])*da[O],Db*za[P+ab],(D+Db*H[P+Eb])*ea[O],(D+Db*H[P+Eb])*da[O],Db*za[P+Eb],(D+Cb*H[P+Eb])*ea[O],(D+Cb*H[P+Eb])*da[O],Cb*za[P+Eb],Oe),fc.setNormal(-je*da[O],je*ea[O],0);ge=fc.create()}return ge;
case "TGeoPcon":case "TGeoPgon":var ke=b,Pe=a.fPhi1,Tc=a.fDphi;if("TGeoPgon"==a._typename){var Q=a.fNedges;var bb=1/Math.cos(Math.PI/180*Tc/Q/2)}else Q=Math.max(5,Math.round(Tc/g.GradPerSegm)),bb=1;for(var zd=new Int16Array(2*a.fNz),le=0,cb=!1,Ad=0;Ad<a.fNz;++Ad)0<a.fRmin[Ad]&&(cb=!0);if(0>ke)var me=(cb?4:2)*Q*(a.fNz-1);else{for(var Aa=360===Tc?null:[],db=0;2>db;++db)for(var Uc=0===db?"fRmax":"fRmin",R=0;R<a.fNz;++R){var Bd=a.fZ[R],Fb=a[Uc][R];zd[2*R+db]=0;0<R&&R<a.fNz-1&&(a.fZ[R-1]===Bd&&a[Uc][R-
1]===Fb||a[Uc][R+1]===Fb&&a[Uc][R-1]===Fb)||(0<R&&(0===db||cb)&&(zd[2*R+db]=1,le++),null!==Aa&&(0===db?Aa.push(new e.Vector2(bb*Fb,Bd)):Fb<a.fRmax[R]&&Aa.unshift(new e.Vector2(bb*Fb,Bd))))}var Vc=le*Q*2;a.fRmin[0]!==a.fRmax[0]&&(Vc+=Q*(cb?2:1));a.fRmin[a.fNz-1]!==a.fRmax[a.fNz-1]&&(Vc+=Q*(cb?2:1));var ma=null;if(null!==Aa){if(Aa.length===2*a.fNz){ma=[];for(var Qa=a.fNz-1;0<Qa;--Qa)if(a.fZ[Qa]!==a.fZ[Qa-1]){var Cd=2*a.fNz-1-Qa;ma.push([Cd,Qa-1,Qa]);ma.push([Cd,Cd+1,Qa-1])}}else ma=e.ShapeUtils.triangulateShape(Aa,
[]);Vc+=2*ma.length}for(var ne=Pe*Math.PI/180,oe=Tc/Q*Math.PI/180,S=new Float32Array(Q+1),T=new Float32Array(Q+1),Gb=0;Gb<=Q;++Gb)T[Gb]=Math.cos(ne+Gb*oe),S[Gb]=Math.sin(ne+Gb*oe);for(var Ba=ke?new A:new y(Vc),eb=0;2>eb;++eb)for(var pe=0===eb?"fRmax":"fRmin",Wc=a.fZ[0],fb=bb*a[pe][0],Hb=1-eb,Ib=eb,gc=0;gc<a.fNz;++gc)if(0!==zd[2*gc+eb]){var Xc=a.fZ[gc],gb=bb*a[pe][gc],Jb=1,Yc=0;if(gb!==fb){var qe=Math.atan2(gb-fb,Xc-Wc);Jb=Math.cos(qe);Yc=Math.sin(qe)}0<eb&&(Jb*=-1,Yc*=-1);for(var U=0;U<Q;++U)Ba.addFace4(fb*
T[U+Hb],fb*S[U+Hb],Wc,gb*T[U+Hb],gb*S[U+Hb],Xc,gb*T[U+Ib],gb*S[U+Ib],Xc,fb*T[U+Ib],fb*S[U+Ib],Wc),Ba.setNormal_12_34(Jb*T[U+Hb],Jb*S[U+Hb],Yc,Jb*T[U+Ib],Jb*S[U+Ib],Yc);Wc=Xc;fb=gb}for(var Ra=0;Ra<a.fNz;Ra+=a.fNz-1){var hc=bb*a.fRmin[Ra],ic=bb*a.fRmax[Ra];if(hc!==ic){var Zc=a.fZ[Ra],jc=0===Ra?1:0,$c=1-jc,Qe=0===Ra?-1:1;cb||ma||Ba.startPolygon(0<Ra);for(var sa=0;sa<Q;++sa)Ba.addFace4(hc*T[sa+jc],hc*S[sa+jc],Zc,ic*T[sa+jc],ic*S[sa+jc],Zc,ic*T[sa+$c],ic*S[sa+$c],Zc,hc*T[sa+$c],hc*S[sa+$c],Zc,cb?0:2),
Ba.setNormal(0,0,Qe);Ba.stopPolygon()}}if(ma)for(var Ca=0;Ca<=Q;Ca+=Q)for(var re=0===Ca?1:2,Re=3-re,kc=0;kc<ma.length;++kc){var Dd=Aa[ma[kc][0]],Ed=Aa[ma[kc][re]],Fd=Aa[ma[kc][Re]];Ba.addFace3(Dd.x*T[Ca],Dd.x*S[Ca],Dd.y,Ed.x*T[Ca],Ed.x*S[Ca],Ed.y,Fd.x*T[Ca],Fd.x*S[Ca],Fd.y);Ba.calcNormal()}me=Ba.create()}return me;case "TGeoXtru":var se=b,Gd=(a.fNz-1)*a.fNvert*2;if(0>se)var te=Gd+3*a.fNvert;else{for(var hb=[],ad=0;ad<a.fNvert;++ad)hb.push(new e.Vector2(a.fX[ad],a.fY[ad]));var lc=e.ShapeUtils.triangulateShape(hb,
[]);lc.length<hb.length-2?(g.warn("Problem with XTRU shape "+a.fName+" with "+hb.length+" vertices"),lc=[]):Gd+=2*lc.length;for(var mc=se?new A:new y(Gd),ta=0;ta<a.fNz-1;++ta)for(var ue=a.fZ[ta],bd=a.fScale[ta],ve=a.fZ[ta+1],cd=a.fScale[ta+1],we=a.fX0[ta],xe=a.fX0[ta+1],ye=a.fY0[ta],ze=a.fY0[ta+1],ib=0;ib<a.fNvert;++ib){var dd=(ib+1)%a.fNvert;mc.addFace4(bd*a.fX[ib]+we,bd*a.fY[ib]+ye,ue,cd*a.fX[ib]+xe,cd*a.fY[ib]+ze,ve,cd*a.fX[dd]+xe,cd*a.fY[dd]+ze,ve,bd*a.fX[dd]+we,bd*a.fY[dd]+ye,ue);mc.calcNormal()}for(var Da=
0;Da<=a.fNz-1;Da+=a.fNz-1)for(var Hd=a.fZ[Da],Kb=a.fScale[Da],Id=a.fX0[Da],Jd=a.fY0[Da],Kd=0;Kd<lc.length;++Kd){var Ld=lc[Kd],Ae=hb[Ld[0]],Be=hb[Ld[0===Da?2:1]],Ce=hb[Ld[0===Da?1:2]];mc.addFace3(Kb*Ae.x+Id,Kb*Ae.y+Jd,Hd,Kb*Be.x+Id,Kb*Be.y+Jd,Hd,Kb*Ce.x+Id,Kb*Ce.y+Jd,Hd);mc.setNormal(0,0,0===Da?-1:1)}te=mc.create()}return te;case "TGeoParaboloid":var ed=b,ia=Math.max(4,Math.round(360/g.GradPerSegm)),na=30;if(0<ed){var Md=2*ia*(na+1)/ed;1<Md&&(ia=Math.max(5,Math.floor(ia/Math.sqrt(Md))),na=Math.max(5,
Math.floor(na/Math.sqrt(Md))))}var nc=-a.fDZ,oc=a.fDZ,pc=a.fRlo,fd=a.fRhi;0<=a.fA?a.fB>nc&&(nc=a.fB):a.fB<oc&&(oc=a.fB);var De=Math.atan2(nc,pc),Se=Math.atan2(oc,fd),gd=(na+1)*ia*2;0===pc&&(gd-=2*ia);0===fd&&(gd-=2*ia);if(0>ed)var Ee=gd;else{for(var Ea=new Float32Array(ia+1),Fa=new Float32Array(ia+1),Lb=0;Lb<=ia;++Lb)Fa[Lb]=Math.cos(Lb/ia*2*Math.PI),Ea[Lb]=Math.sin(Lb/ia*2*Math.PI);for(var hd=ed?new A:new y(gd),Nd=nc,jb=0,qc=0,Od=-1,Ga=0;Ga<=na+1;++Ga){var kb=0,V=0,Mb=0,id=-1;if(0!==Ga||0!==pc){if(Ga===
na+1&&0===jb)break;switch(Ga){case 0:kb=nc;V=pc;break;case na:kb=oc;V=fd;break;case na+1:kb=oc;V=0;break;default:var jd=Math.tan(De+(Se-De)*Ga/na);V=.5*(jd+Math.sqrt(jd*jd-4*a.fA*a.fB))/a.fA;1E-6>V&&(V=0);kb=V*jd}Mb=a.fA*V;id=0<a.fA?-1:1;var rc=0;0===jb?rc=1:0===V&&(rc=2);for(var F=0;F<ia;++F)hd.addFace4(V*Fa[F],V*Ea[F],kb,jb*Fa[F],jb*Ea[F],Nd,jb*Fa[F+1],jb*Ea[F+1],Nd,V*Fa[F+1],V*Ea[F+1],kb,rc),0===rc||1===Ga&&0===pc||Ga===na+1&&0===fd?hd.setNormal4(Mb*Fa[F],Mb*Ea[F],id,qc*Fa[F],qc*Ea[F],Od,qc*Fa[F+
1],qc*Ea[F+1],Od,Mb*Fa[F+1],Mb*Ea[F+1],id,rc):hd.setNormal(0,0,Ga<na?-1:1);Nd=kb;jb=V;qc=Mb;Od=id}}Ee=hd.create()}return Ee;case "TGeoHype":var lb=b;if(0===a.fTin&&0===a.fTout)var Pd=Td(a,lb);else{var oa=Math.max(4,Math.round(360/g.GradPerSegm)),mb=30,Nb=oa*(mb+1)*(0<a.fRmin?4:2);if(0>lb)Pd=Nb;else{0<lb&&lb>Nb&&(oa=Math.max(4,Math.floor(oa/Math.sqrt(Nb/lb))),mb=Math.max(4,Math.floor(mb/Math.sqrt(Nb/lb))),Nb=oa*(mb+1)*(0<a.fRmin?4:2));for(var Ha=new Float32Array(oa+1),Ia=new Float32Array(oa+1),Ob=
0;Ob<=oa;++Ob)Ia[Ob]=Math.cos(Ob/oa*2*Math.PI),Ha[Ob]=Math.sin(Ob/oa*2*Math.PI);for(var sc=lb?new A:new y(Nb),Pb=0;2>Pb&&!(0<Pb&&0>=a.fRmin);++Pb)for(var kd=0<Pb?a.fRmin:a.fRmax,Fe=0<Pb?a.fTinsq:a.fToutsq,tc=1-Pb,ld=1-tc,md=0;md<mb;++md)for(var nd=-a.fDz+md/mb*2*a.fDz,od=-a.fDz+(md+1)/mb*2*a.fDz,pd=Math.sqrt(kd*kd+Fe*nd*nd),qd=Math.sqrt(kd*kd+Fe*od*od),ua=0;ua<oa;++ua)sc.addFace4(pd*Ia[ua+tc],pd*Ha[ua+tc],nd,qd*Ia[ua+tc],qd*Ha[ua+tc],od,qd*Ia[ua+ld],qd*Ha[ua+ld],od,pd*Ia[ua+ld],pd*Ha[ua+ld],nd),sc.calcNormal();
for(var uc=0;2>uc;++uc)for(var Sa=0===uc?a.fDz:-a.fDz,rd=Math.sqrt(a.fRmax*a.fRmax+a.fToutsq*Sa*Sa),sd=0<a.fRmin?Math.sqrt(a.fRmin*a.fRmin+a.fTinsq*Sa*Sa):0,Te=0<a.fRmin?0:1,vc=1-uc,td=1-vc,va=0;va<oa;++va)sc.addFace4(rd*Ia[va+vc],rd*Ha[va+vc],Sa,sd*Ia[va+vc],sd*Ha[va+vc],Sa,sd*Ia[va+td],sd*Ha[va+td],Sa,rd*Ia[va+td],rd*Ha[va+td],Sa,Te),sc.setNormal(0,0,0===uc?1:-1);Pd=sc.create()}}return Pd;case "TGeoTessellated":for(var wc=0,Qd=0;Qd<a.fFacets.length;++Qd)wc=4==a.fFacets[Qd].fNvert?wc+2:wc+1;if(0>
b)var Ge=wc;else{for(var ud=b?new A:new y(wc),Rd=0;Rd<a.fFacets.length;++Rd){var xc=a.fFacets[Rd],Qb=a.fVertices[xc.fIvert[0]].fVec,Rb=a.fVertices[xc.fIvert[1]].fVec,Sb=a.fVertices[xc.fIvert[2]].fVec;if(4==xc.fNvert){var Sd=a.fVertices[xc.fIvert[3]].fVec;ud.addFace4(Qb[0],Qb[1],Qb[2],Rb[0],Rb[1],Rb[2],Sb[0],Sb[1],Sb[2],Sd[0],Sd[1],Sd[2])}else ud.addFace3(Qb[0],Qb[1],Qb[2],Rb[0],Rb[1],Rb[2],Sb[0],Sb[1],Sb[2]);ud.calcNormal()}Ge=ud.create()}return Ge;case "TGeoCompositeShape":return He(a,b);case "TGeoShapeAssembly":break;
case "TGeoScaledShape":var vd=Ja(a.fShape,b);a.fScale&&0<=b&&"object"===typeof vd&&"function"===typeof vd.scale&&vd.scale(a.fScale.fScale[0],a.fScale.fScale[1],a.fScale.fScale[2]);return vd;case "TGeoHalfSpace":if(0>b)return 1;default:g.warn("unsupported shape type "+a._typename)}}catch(yc){var zc="";void 0!==yc.stack&&(zc=yc.stack.split("\n")[0],zc=0<=zc.indexOf(yc.message)?yc.stack.split("\n")[1]:" at: "+zc);g.warn(a._typename+" err: "+yc.message+zc)}return 0>b?0:null};g.compareStacks=function(a,
b){if(!a||!b)return 0;if(a===b)return a.length;for(var d=Math.min(a.length,b.length),c=0;c<d;++c)if(a[c]!==b[c])return c;return d};g.isSameStack=function(a,b){if(!a||!b)return!1;if(a===b)return!0;if(a.length!==b.length)return!1;for(var d=0;d<a.length;++d)if(a[d]!==b[d])return!1;return!0};t.prototype.setVisLevel=function(a){this.vislevel=a&&Number.isInteger(a)?a:4};t.prototype.getVisLevel=function(){return this.vislevel};t.prototype.setMaxVisNodes=function(a){this.maxnodes=Number.isFinite(a)?a:1E4};
t.prototype.getMaxVisNodes=function(){return this.maxnodes};t.prototype.updateNode=function(a){a&&Number.isInteger(a.id)&&a.id<this.nodes.length&&(this.nodes[a.id]=a)};t.prototype.getNodeShape=function(a){if(!this.origin||!this.nodes)return null;var b=this.origin[a];a=this.nodes[a];if(!b||!a)return null;if(0===a.kind){if(b.fVolume)return b.fVolume.fShape}else return b.fShape;return null};t.prototype.cleanup=function(a,b){if(a)for(var d=0;d<a.length;++d)delete a[d].stack,a[d]=void 0;if(b)for(a=0;a<
b.length;++a)delete b[a].geom,b[a]=void 0;if(this.nodes)for(b=0;b<this.nodes.length;++b)this.nodes[b]&&delete this.nodes[b].chlds;delete this.nodes;delete this.origin;delete this.sortmap};t.prototype.createClones=function(a,b,d){if(!b){if(a&&"$$Shape$$"==a._typename)return this.createClonesForShape(a);this.origin=[];b=1;d=g.getNodeKind(a)}if(!(0>d||!a||"_refid"in a)){a._refid=this.origin.length;this.origin.push(a);b>this.maxdepth&&(this.maxdepth=b);var c=null;c=0===d?a.fVolume&&a.fVolume.fNodes?a.fVolume.fNodes.arr:
null:a.fElements?a.fElements.arr:null;if(null!==c)for(g.checkDuplicates(a,c),a=0;a<c.length;++a)this.createClones(c[a],b+1,d);if(!(1<b)){this.nodes=[];b=[];for(c=0;c<this.origin.length;++c)a={id:c,kind:d,vol:0,nfaces:0},this.nodes.push(a),b.push(a);for(c=0;c<this.origin.length;++c){var f=this.origin[c];a=this.nodes[c];var h=null,e=null;1===d?(e=f.fShape,f.fElements&&(h=f.fElements.arr)):f.fVolume&&(e=f.fVolume.fShape,f.fVolume.fNodes&&(h=f.fVolume.fNodes.arr));if(f=g.getNodeMatrix(d,f)){a.matrix=
f.elements;if(1===a.matrix[0]){f=!0;for(var k=1;k<a.matrix.length&&f;++k)f=a.matrix[k]===(5===k||10===k||15===k?1:0);f&&delete a.matrix}a.matrix&&1==d&&(a.abs_matrix=!0)}e&&(a.fDX=e.fDX,a.fDY=e.fDY,a.fDZ=e.fDZ,a.vol=e.fDX*e.fDY*e.fDZ,void 0===e.$nfaces&&(e.$nfaces=Ja(e,-1)),a.nfaces=e.$nfaces,0>=a.nfaces&&(a.vol=0));if(h)for(a.chlds=Array(h.length),e=0;e<h.length;++e)a.chlds[e]=h[e]._refid}for(d=0;d<this.origin.length;++d)delete this.origin[d]._refid;b.sort(function(a,b){return b.vol-a.vol});this.sortmap=
Array(this.nodes.length);for(d=0;d<this.nodes.length;++d)this.sortmap[d]=b[d].id,b[d].sortid=d}}};t.prototype.createClonesForShape=function(a){this.origin=[];this.plain_shape=a;this.nodes=[{id:0,sortid:0,kind:2,name:"Shape",nfaces:a.nfaces,fDX:1,fDY:1,fDZ:1,vol:1,vis:!0}]};t.prototype.countVisibles=function(){var a=0;if(this.nodes)for(var b=0;b<this.nodes.length;++b)this.nodes[b].vis&&a++;return a};t.prototype.markVisibles=function(a,b,d){if(this.plain_shape)return 1;if(!this.origin||!this.nodes)return 0;
for(var c=0,f=0;f<this.nodes.length;++f){var h=this.nodes[f],e=this.origin[f];h.vis=0;delete h.nochlds;0===h.kind?e.fVolume&&(a?(h.vis=g.TestBit(e.fVolume,g.BITS.kVisOnScreen)?99:0,0==f&&h.vis&&d&&(h.vis=0),b&&(g.SetBit(e.fVolume,g.BITS.kVisNone,!1),g.SetBit(e.fVolume,g.BITS.kVisThis,0<h.vis),g.SetBit(e.fVolume,g.BITS.kVisDaughters,!0))):(h.vis=!g.TestBit(e.fVolume,g.BITS.kVisNone)&&g.TestBit(e.fVolume,g.BITS.kVisThis)?99:0,g.TestBit(e,g.BITS.kVisDaughters)&&g.TestBit(e.fVolume,g.BITS.kVisDaughters)||
(h.nochlds=!0),0<h.vis&&h.chlds&&!h.nochlds&&(h.vis=1),0==f&&(d&&(h.vis=0),delete h.nochlds))):(h.vis=e.fRnrSelf?99:0,0===f&&1===this.nodes.length&&(h.vis=99),this.vislevel=9999);if(0>=h.vol||0>=h.nfaces)h.vis=0;h.vis&&c++}return c};t.prototype.produceIdShifts=function(){function a(b,c){if(0>c.idshift&&(c.idshift=0,c.chlds))for(var d=0;d<c.chlds.length;++d)c.idshift+=a(b,b[c.chlds[d]]);return c.idshift+1}for(var b=0;b<this.nodes.length;++b)this.nodes[b].idshift=-1;a(this.nodes,this.nodes[0])};t.prototype.getVisibleFlags=
function(){for(var a=Array(this.nodes.length),b=0;b<this.nodes.length;++b)a[b]={vis:this.nodes[b].vis,nochlds:this.nodes[b].nochlds};return a};t.prototype.setVisibleFlags=function(a){if(!this.nodes||!a||!a.length!=this.nodes.length)return 0;for(var b=0,d=0;d<this.nodes.length;++d){var c=this.nodes[d];c.vis=a[d].vis;c.nochlds=a[d].nochlds;c.vis&&b++}return b};t.prototype.scanVisible=function(a,b){if(!this.nodes)return 0;void 0===b&&(a||(a={}),b=a.vislvl||this.vislevel||4,88<b&&(b=88),a.stack=Array(100),
a.nodeid=0,a.counter=0,a.last=0,a.CopyStack=function(a){var b={nodeid:this.nodeid,seqid:this.counter,stack:Array(this.last)};a&&(b.factor=a);for(a=0;a<this.last;++a)b.stack[a]=this.stack[a+1];return b},a.domatrix&&(a.matrices=[],a.mpool=[new e.Matrix4],a.getmatrix=function(){return this.matrices[this.last]}));var d=0,c=this.nodes[a.nodeid];if(a.domatrix){a.mpool[a.last+1]||(a.mpool[a.last+1]=new e.Matrix4);var f=0<a.last?a.matrices[a.last-1]:new e.Matrix4;c.matrix?(a.matrices[a.last]=a.mpool[a.last].fromArray(f.elements),
a.matrices[a.last].multiply(a.mpool[a.last+1].fromArray(c.matrix))):a.matrices[a.last]=f}c.nochlds&&(b=0);c.vis>b&&(!a.func||a.func(c))&&d++;a.counter++;if(0<b&&c.chlds){a.last++;for(f=0;f<c.chlds.length;++f)a.nodeid=c.chlds[f],a.stack[a.last]=f,d+=this.scanVisible(a,b-1);a.last--}else a.counter+=c.idshift||0;0===a.last&&(delete a.last,delete a.stack,delete a.CopyStack,delete a.counter,delete a.matrices,delete a.mpool,delete a.getmatrix);return d};t.prototype.getNodeName=function(a){return this.origin?
(a=this.origin[a])?g.getObjectName(a):"":(a=this.nodes[a])?a.name:""};t.prototype.resolveStack=function(a,b){var d={id:0,obj:null,node:this.nodes[0],name:this.name_prefix};b&&(d.matrix=new e.Matrix4,d.node.matrix&&d.matrix.fromArray(d.node.matrix));this.origin&&(d.obj=this.origin[0]);if(a)for(var c=0;c<a.length;++c){d.id=d.node.chlds[a[c]];d.node=this.nodes[d.id];this.origin&&(d.obj=this.origin[d.id]);var f=this.getNodeName(d.id);f&&(d.name&&(d.name+="/"),d.name+=f);b&&d.node.matrix&&d.matrix.multiply((new e.Matrix4).fromArray(d.node.matrix))}return d};
t.prototype.buildStackByIds=function(a){if(!a)return null;if(0!==a[0])return console.error("wrong ids - first should be 0"),null;for(var b=this.nodes[0],d=[],c=1;c<a.length;++c){var f=a[c];if(!b)return null;b=b.chlds.indexOf(f);if(0>b)return console.error("wrong nodes ids "+a[c]+" is not child of "+a[c-1]),null;d.push(b);b=this.nodes[f]}return d};t.prototype.buildIdsByStack=function(a){if(!a)return null;for(var b=this.nodes[0],d=[0],c=0;c<a.length;++c)b=b.chlds[a[c]],d.push(b),b=this.nodes[b];return d};
t.prototype.isIdInStack=function(a,b){if(!a)return!0;for(var d=this.nodes[0],c=0;c<b.length;++c){d=d.chlds[b[c]];if(d==a)return!0;d=this.nodes[d]}return!1};t.prototype.findStackByName=function(a){a=a.split("/");var b=0,d=[];if(this.getNodeName(b)!==a[0])return null;for(var c=1;c<a.length;++c){var f=this.nodes[b];if(!f.chlds)return null;for(var e=0;e<f.chlds.length;++e){var g=f.chlds[e];if(this.getNodeName(g)===a[c]){d.push(e);b=g;break}}if(d.length===c-1)return null}return d};t.prototype.setDefaultColors=
function(a){if((this.use_dflt_colors=a)&&!this.dflt_table){a=[];for(var b=0;110>b;b++)a.push(920);a[3]=390;a[4]=a[5]=406;a[6]=a[7]=593;a[8]=a[9]=613;a[10]=a[11]=622;a[12]=921;a[13]=590;a[14]=807;a[16]=401;a[20]=390;a[24]=a[25]=a[26]=592;a[29]=809;a[79]=798;this.dflt_table=a}};t.prototype.getDrawEntryProperties=function(a){var b=this.nodes[a.nodeid];if(2===b.kind){b={name:b.name,nname:b.name,shape:null,material:null,chlds:null};var d=a.opacity||1;b.fillcolor=new e.Color(a.color?"rgb("+a.color+")":
"blue");b.material=new e.MeshLambertMaterial({transparent:1>d,opacity:d,wireframe:!1,color:b.fillcolor,side:e.FrontSide,vertexColors:e.NoColors,depthWrite:1==d});b.material.inherentOpacity=d;return b}if(!this.origin)return console.error("origin not there - kind",b.kind,a.nodeid,b),null;d=this.origin[a.nodeid];if(1===b.kind)return a={name:g.getObjectName(d),nname:g.getObjectName(d),shape:d.fShape,material:null,chlds:null},null!==d.fElements&&(a.chlds=d.fElements.arr),b=Math.min(1,d.fRGBA[3]),a.fillcolor=
new e.Color(d.fRGBA[0],d.fRGBA[1],d.fRGBA[2]),a.material=new e.MeshLambertMaterial({transparent:1>b,opacity:b,wireframe:!1,color:a.fillcolor,side:e.FrontSide,vertexColors:e.NoColors,depthWrite:1==b}),a.material.inherentOpacity=b,a;var c=d.fVolume;b={name:g.getObjectName(c),nname:g.getObjectName(d),volume:d.fVolume,shape:c.fShape,material:null,chlds:null};null!==d.fVolume.fNodes&&(b.chlds=d.fVolume.fNodes.arr);c&&(b.linewidth=c.fLineWidth);d=1;var f=JSROOT.Painter;f=f?f.root_colors:"white black red green blue yellow magenta cyan".split(" ");
a.custom_color?b.fillcolor=a.custom_color:1<c.fFillColor&&1==c.fLineColor?b.fillcolor=f[c.fFillColor]:0<=c.fLineColor&&(b.fillcolor=f[c.fLineColor]);c.fMedium&&c.fMedium.fMaterial&&(a=c.fMedium.fMaterial,c=a.fFillStyle,c=3E3>c||3100<c?0:c-3E3,this.use_dflt_colors&&(b.fillcolor=f[this.dflt_table[Math.round(a.fZ)]],.1>a.fDensity&&(c=60)),0<c&&(d=(100-c)/100),void 0===b.fillcolor&&(b.fillcolor=f[a.fFillColor]));void 0===b.fillcolor&&(b.fillcolor="lightgrey");b.material=new e.MeshLambertMaterial({transparent:1>
d,opacity:d,wireframe:!1,color:b.fillcolor,side:e.FrontSide,vertexColors:e.NoColors,depthWrite:1==d});b.material.inherentOpacity=d;return b};t.prototype.createObject3D=function(a,b,d){for(var c=this.nodes[0],f=b,h=0,g="object"==typeof d||"force"===d,k=0;k<=a.length;++k){var t=0<k?a[k-1]:0;0<k&&(c=this.nodes[c.chlds[t]]);var l=void 0;if(f.children)for(var m=0;m<f.children.length;++m)if(f.children[m].nchld===t){l=f.children[m];break}if(l)f=l,l.$jsroot_drawable&&h++;else{if(!g)return null;l=new e.Object3D;
c.abs_matrix?(l.absMatrix=new e.Matrix4,l.absMatrix.fromArray(c.matrix)):c.matrix&&(l.matrix.fromArray(c.matrix),l.matrix.decompose(l.position,l.quaternion,l.scale));l.nchld=t;f.add(l);0==k&&"object"==typeof d&&d.scale&&(0>d.scale.x||0>d.scale.y||0>d.scale.z)&&(l.scale.copy(d.scale),l.updateMatrix());l.updateMatrixWorld();f=l}}if("mesh"===d||"delete_mesh"===d){a=null;if(f)for(c=0;c<f.children.length&&!a;++c)h=f.children[c],"Mesh"===h.type&&void 0===h.nchld&&(a=h);if("mesh"===d||!a)return a;for(d=
f;a&&a!==b;)f=a.parent,f.remove(a),a=0==f.children.length?f:null;return d}f&&(f.$jsroot_drawable=!0,f.$jsroot_depth=h);return f};t.prototype.getVolumeBoundary=function(a,b,d){var c={min:0,max:1,sortidcut:0};if(!this.sortmap)return console.error("sorting map do not exist"),c;for(var f,e,g=0,k=0,t=0;t<this.sortmap.length&&g<d&&k<b;++t){var l=this.sortmap[t];0!==a[l]&&(e=this.nodes[l],f||(f=e),g+=a[l],k+=a[l]*e.nfaces)}if(!e)return console.error("no volumes selected"),c;c.max=f.vol;c.min=e.vol;c.sortidcut=
e.sortid;return c};t.prototype.collectVisibles=function(a,b){if(this.plain_shape)return{lst:[{nodeid:0,seqid:0,stack:[],factor:1,shapeid:0,server_shape:this.plain_shape}],complete:!0};var d={facecnt:0,viscnt:Array(this.nodes.length),vislvl:this.getVisLevel(),reset:function(){for(var a=this.facecnt=this.total=0;a<this.viscnt.length;++a)this.viscnt[a]=0},func:function(a){this.total++;this.facecnt+=a.nfaces;this.viscnt[a.id]++;return!0}};d.reset();var c=this.scanVisible(d),f=this.getMaxVisNodes();if(0<
f)for(;c>f&&1<d.vislvl;)d.vislvl--,d.reset(),c=this.scanVisible(d);this.actual_level=d.vislvl;var e=0,g=0,k=-1,t=10,l=this.nodes.length+1;console.log("Total visible nodes "+c+" numfaces "+d.facecnt);if(d.facecnt>a&&(c=this.getVolumeBoundary(d.viscnt,a*(b?.8:1),f*(b?.8:1)),e=c.min,g=c.max,l=c.sortidcut,b)){d.domatrix=!0;d.frustum=b;d.totalcam=0;d.func=function(a){a.vol<=e&&this.frustum.CheckShape(this.getmatrix(),a)&&(this.viscnt[a.id]++,this.totalcam+=a.nfaces);return!0};for(b=0;b<d.viscnt.length;++b)d.viscnt[b]=
0;this.scanVisible(d);k=d.totalcam>.2*a?this.getVolumeBoundary(d.viscnt,.2*a,.2*f).min:0;t=g/(0<k?0<k:e)}d.items=[];d.func=function(a){a.sortid<l?this.items.push(this.CopyStack()):0<=k&&a.vol>k&&this.frustum.CheckShape(this.getmatrix(),a)&&this.items.push(this.CopyStack(t));return!0};this.scanVisible(d);return{lst:d.items,complete:0===e}};t.prototype.mergeVisibles=function(a,b){for(var d=0,c=[],f=0;f<a.length&&d<b.length;++f){for(;d<b.length&&b[d].seqid<a[f].seqid;)c.push(b[d++]);d<b.length&&b[d].seqid===
a[f].seqid&&(b[d].done&&(a[f].done=!0),d++)}for(;d<b.length;)c.push(b[d++]);return c};t.prototype.collectShapes=function(a){if(this.plain_shape)return[this.plain_shape];for(var b=[],d=0;d<a.length;++d){var c=a[d],f=this.getNodeShape(c.nodeid);f&&(void 0===f._id?(f._id=b.length,b.push({id:f._id,shape:f,vol:this.nodes[c.nodeid].vol,refcnt:1,factor:1,ready:!1})):b[f._id].refcnt++,c.shape=b[f._id],c.factor&&c.factor>c.shape.factor&&(c.shape.factor=c.factor))}b.sort(function(a,b){return b.vol*b.factor-
a.vol*a.factor});for(d=0;d<b.length;++d)c=b[d],c.id=d,delete c.shape._id;for(d=0;d<a.length;++d)c=a[d],c.shape&&(c.shapeid=c.shape.id,delete c.shape);return b};t.prototype.mergeShapesLists=function(a,b){if(!a)return b;for(var d=0;d<a.length;++d){var c=a[d];c.shape._geom=c.geom;delete c.geom;void 0!==c.geomZ&&(c.shape._geomZ=c.geomZ,delete c.geomZ)}for(d=0;d<b.length;++d)c=b[d],void 0!==c.shape._geom&&(c.geom=c.shape._geom,delete c.shape._geom),void 0!==c.shape._geomZ&&(c.geomZ=c.shape._geomZ,delete c.shape._geomZ);
for(d=0;d<a.length;++d)c=a[d],delete c.shape._geom,delete c.shape._geomZ;return b};t.prototype.buildShapes=function(a,b,d){for(var c=0,f=(new Date).getTime(),e={done:!1,shapes:0,faces:0,notusedshapes:0},g=0;g<a.length;++g){var k=a[g];if(e.done)k.ready=!0;else if(k.ready||(k._typename="$$Shape$$",k.ready=!0,void 0===k.geom&&(k.geom=Ja(k.shape),k.geom&&c++),k.nfaces=Z(k.geom)),e.shapes++,k.used||e.notusedshapes++,e.faces+=k.nfaces*k.refcnt,e.faces>=b)e.done=!0;else if(c>.01*a.length&&void 0!==d&&(new Date).getTime()-
f>d)return e}e.done=!0;return e};g.getObjectName=function(a){return a&&a.fName?a.fName+(a.$geo_suffix?a.$geo_suffix:""):""};g.checkDuplicates=function(a,b){if(a){if(a.$geo_checked)return;a.$geo_checked=!0}a=[];for(var d=[],c=0;c<b.length;++c){var f=b[c];if(f&&f.fName){if(!f.$geo_suffix){var e=a.indexOf(f.fName);if(0<=e){for(var n=d[e]||1;0<=a.indexOf(f.fName+"#"+n);)++n;f.$geo_suffix="#"+n;d[e]=n+1}}a.push(g.getObjectName(f))}}};g.cleanupShape=function(a){a&&(a.geom&&"function"==typeof a.geom.dispose&&
a.geom.dispose(),a.geomZ&&"function"==typeof a.geomZ.dispose&&a.geomZ.dispose(),delete a.geom,delete a.geomZ)};g.produceRenderOrder=function(a,b,d,c){function f(a){a&&a.traverse(function(a){a.renderOrder=0;a.material&&(a.material.depthWrite=!0)})}function h(a,b,c){if(a.children)for(var d=0;d<a.children.length;++d){var e=a.children[d];e.$jsroot_order===b?e.material&&(e.material.transparent?(e.material.depthWrite=!1,c.push(e)):f(e)):(void 0===a.$jsroot_depth||a.$jsroot_depth<b)&&h(e,b,c)}}function g(a,
f,h){if(300<a.length){for(var g=0;g<a.length;++g)a[g].renderOrder=(f+h)/2;return!1}g=new e.Vector3;for(var k=0;k<a.length;++k){var n=a[k],l=n.$jsroot_box3;l||(n.$jsroot_box3=l=Xb(n));if("size"===d)n.$jsroot_distance=l.getSize(new e.Vector3);else if("pnt"===d)n.$jsroot_distance=b.distanceTo(l.getCenter(g));else{var m=Math.min(b.distanceTo(l.min),b.distanceTo(l.max)),p=new e.Vector3(l.min.x,l.min.y,l.max.z);m=Math.min(m,b.distanceTo(p));p.set(l.min.x,l.max.y,l.min.z);m=Math.min(m,b.distanceTo(p));p.set(l.max.x,
l.min.y,l.min.z);m=Math.min(m,b.distanceTo(p));p.set(l.max.x,l.max.y,l.min.z);m=Math.min(m,b.distanceTo(p));p.set(l.max.x,l.min.y,l.max.z);m=Math.min(m,b.distanceTo(p));p.set(l.min.x,l.max.y,l.max.z);m=Math.min(m,b.distanceTo(p));n.$jsroot_distance=m}}a.sort(function(a,b){return a.$jsroot_distance-b.$jsroot_distance});k=Array(a.length);for(n=0;n<a.length;++n)a[n].$jsroot_index=n,k[n]=a[n];if("ray"===d)for(n=a.length-1;0<=n;--n){l=a[n];p=l.$jsroot_box3.getCenter(g);for(m=0;2>m;++m){p.sub(b).normalize();
t.set(b,p);p=t.intersectObjects(a,!1);for(var r=[],v=0;v<p.length;++v)0>r.indexOf(p[v].object)&&r.push(p[v].object);p=r;0>p.indexOf(l)&&0<m&&console.log("MISS",c?c.resolveStack(l.stack).name:"???");if(0<=p.indexOf(l)||0<m)break;p=l.geometry.attributes.position.array;p=new e.Vector3((p[0]+p[3]+p[6])/3,(p[1]+p[4]+p[7])/3,(p[2]+p[5]+p[8])/3);p.applyMatrix4(l.matrixWorld)}for(l=0;l<intersects.length-1;++l)if(m=intersects[l+1],p=intersects[l].$jsroot_index,r=m.$jsroot_index,!(p<r)){for(;r<p;++r)k[r]=k[r+
1],k[r].$jsroot_index=r;k[p]=m;m.$jsroot_index=p}}for(a=0;a<k.length;++a)k[a].renderOrder=h-(a+1)/(k.length+1)*(h-f),delete k[a].$jsroot_index,delete k[a].$jsroot_distance;return!0}function k(a,b,c,d){var f=[],e=!1;h(a,b,f);if(f.length){if(c===d)for(a=0;a<f.length;++a)f[a].renderOrder=c;else(e=g(f,c,d))||(c=d=(c+d)/2);for(a=0;a<f.length;++a){var l=f[a].parent,n=c,m=d;e&&(m=f[a].renderOrder,n=m-(d-c)/(f.length+2));k(l,b+1,n,m)}}}var t=new e.Raycaster;d&&"dflt"!==d?k(a,0,1,1E6):f(a)};g.build=function(a,
b){if(!a)return null;b||(b={});b.numfaces||(b.numfaces=1E5);b.numnodes||(b.numnodes=1E3);b.frustum||(b.frustum=null);b.res_mesh=b.res_faces=0;var d=null,c=!1;"fShapeBits"in a&&"fShapeId"in a?(d=a,a=null):"TGeoVolumeAssembly"===a._typename||"TGeoVolume"===a._typename?d=a.fShape:"TEveGeoShapeExtract"===a._typename||"ROOT::Experimental::REveGeoShapeExtract"===a._typename?d=a.fShape:"TGeoManager"===a._typename?(a=a.fMasterVolume,c=!b.showtop,d=a.fShape):a.fVolume?d=a.fVolume.fShape:a=null;b.composite&&
d&&"TGeoCompositeShape"==d._typename&&d.fNode&&(a=g.buildCompositeVolume(d));!a&&d&&(a=JSROOT.extend(JSROOT.create("TEveGeoShapeExtract"),{fTrans:null,fShape:d,fRGBA:[0,1,0,1],fElements:null,fRnrSelf:!0}));if(!a)return null;0===a._typename.indexOf("TGeoVolume")&&(a={_typename:"TGeoNode",fVolume:a,fName:a.fName,$geoh:a.$geoh,_proxy:!0});a=new t(a);a.setVisLevel(b.vislevel);a.setMaxVisNodes(b.numnodes);b.dflt_colors&&a.setDefaultColors(!0);0>=(b.no_screen?0:a.markVisibles(!0))?a.markVisibles(!1,!1,
c):a.markVisibles(!0,!0,c);a.produceIdShifts();c=a.collectVisibles(b.numfaces,b.frustum).lst;d=a.collectShapes(c);a.buildShapes(d,b.numfaces);for(var f=new e.Object3D,h=0;h<c.length;++h){var n=c[h];if(!n.done){var k=d[n.shapeid];if(!k.ready){console.warn("shape marked as not ready when should");break}n.done=!0;k.used=!0;if(k.geom&&0!==k.nfaces){var v=a.getDrawEntryProperties(n);b.res_mesh++;b.res_faces+=k.nfaces;var l=a.createObject3D(n.stack,f,b);v.material.wireframe=b.wireframe;v.material.side=
b.doubleside?e.DoubleSide:e.FrontSide;k=-.9<(l.absMatrix||l.matrixWorld).determinant()?new e.Mesh(k.geom,v.material):Wb(k,v.material);k.name=a.getNodeName(n.nodeid);l.add(k);l.absMatrix&&(k.matrix.copy(l.absMatrix),k.matrix.decompose(l.position,l.quaternion,l.scale),k.updateMatrixWorld())}else a.createObject3D(n.stack,f,"delete_mesh")}}return f};g.projectGeometry=function(a,b,d,c,f){a.boundingBox||a.computeBoundingBox();var e=a.boundingBox.clone();e.applyMatrix4(b);c||(c=0);if(e.min[d]>=c&&e.max[d]>=
c||e.min[d]<=c&&e.max[d]<=c)return null;a=new v.Geometry(a,b,0,f);b=2*Math.max(Math.abs(e.min.x),Math.abs(e.max.x));f=2*Math.max(Math.abs(e.min.y),Math.abs(e.max.y));e=2*Math.max(Math.abs(e.min.z),Math.abs(e.max.z));var g=1E4;switch(d){case "x":g=Math.max(f,e);break;case "y":g=Math.max(b,e);break;case "z":g=Math.max(b,f)}d=v.CreateNormal(d,c,g);a.cut_from_plane(d);return d.toBufferGeometry()};g.countGeometryFaces=Z;g.createGeometry=Ja;g.createProjectionMatrix=Vb;g.createFrustum=function(a){if(!a)return null;
a instanceof e.PerspectiveCamera&&(a=Vb(a));var b=new e.Frustum;b.setFromProjectionMatrix(a);b.corners=new Float32Array([1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1,0,0,0]);b.test=new e.Vector3(0,0,0);b.CheckShape=function(a,b){var c=this.test,d=this.corners.length,e=this.corners,g;for(g=0;g<d;g+=3)if(c.x=e[g]*b.fDX,c.y=e[g+1]*b.fDY,c.z=e[g+2]*b.fDZ,this.containsPoint(c.applyMatrix4(a)))return!0;return!1};b.CheckBox=function(a){var b=this.test,d=0;b.set(a.min.x,a.min.y,a.min.z);this.containsPoint(b)&&
d++;b.set(a.min.x,a.min.y,a.max.z);this.containsPoint(b)&&d++;b.set(a.min.x,a.max.y,a.min.z);this.containsPoint(b)&&d++;b.set(a.min.x,a.max.y,a.max.z);this.containsPoint(b)&&d++;b.set(a.max.x,a.max.y,a.max.z);this.containsPoint(b)&&d++;b.set(a.max.x,a.min.y,a.max.z);this.containsPoint(b)&&d++;b.set(a.max.x,a.max.y,a.min.z);this.containsPoint(b)&&d++;b.set(a.max.x,a.max.y,a.max.z);this.containsPoint(b)&&d++;return 5<d};return b};g.createFlippedMesh=Wb;g.getBoundingBox=Xb;g.provideObjectInfo=Ub;g.ClonedNodes=
t;JSROOT.GEO=g;JSROOT.nodejs&&(module.exports=g);return g});
