JSROOT.define(["three"],function(t){function f(a,b,c,d,g,l){this.x=a;this.y=b;this.z=c;this.nx=d;this.ny=g;this.nz=l}function r(a){this.vertices=a||[];this.nsign=1;0<this.vertices.length&&this.calculateProperties()}function n(a,b){this.polygons=[];this.front=this.back=void 0;if(a){this.divider=a[0].clone();for(var c=a.length,d=[],g=[],l=0;l<c;++l)void 0!==b&&(a[l].id=b++,delete a[l].parent),this.divider.splitPolygon(a[l],this.polygons,this.polygons,d,g);void 0!==b&&(this.maxnodeid=b);0<d.length&&
(this.front=new n(d));0<g.length&&(this.back=new n(g))}}function q(a,b,c,d){if(a instanceof t.Geometry)this.matrix=null;else if(a instanceof t.Mesh)a.updateMatrix(),b=this.matrix=a.matrix.clone(),a=a.geometry;else{if(a instanceof n)return this.tree=a,this.matrix=null,this;if(a instanceof t.BufferGeometry){var g=a.getAttribute("position").array;a=a.getAttribute("normal").array;for(var l=[],p,h,m,e,k=0;k<g.length;k+=9)p=new r,h=new f(g[k],g[k+1],g[k+2],a[k],a[k+1],a[k+2]),b&&h.applyMatrix4(b),m=new f(g[k+
3],g[k+4],g[k+5],a[k+3],a[k+4],a[k+5]),b&&m.applyMatrix4(b),e=new f(g[k+6],g[k+7],g[k+8],a[k+6],a[k+7],a[k+8]),b&&e.applyMatrix4(b),d?p.vertices.push(h,e,m):p.vertices.push(h,m,e),p.calculateProperties(),l.push(p);this.tree=new n(l,c);void 0!==c&&(this.maxid=this.tree.maxnodeid);return this}if(a.polygons&&a.polygons[0]instanceof r){a=a.polygons;for(d=0;d<a.length;++d){g=a[d];if(b)for(l=0;l<g.vertices.length;++l)g.vertices[l].applyMatrix4(b);g.calculateProperties()}this.tree=new n(a,c);void 0!==c&&
(this.maxid=this.tree.maxnodeid);return this}throw Error("ThreeBSP: Given geometry is unsupported");}d=[];g=a.faces.length;for(k=0;k<g;++k)l=a.faces[k],m=l.normal,p=new r,e=l.vertexNormals&&3==l.vertexNormals.length,h=a.vertices[l.a],e&&(m=l.vertexNormals[0]),h=new f(h.x,h.y,h.z,m.x,m.y,m.z),b&&h.applyMatrix4(b),p.vertices.push(h),h=a.vertices[l.b],e&&(m=l.vertexNormals[1]),h=new f(h.x,h.y,h.z,m.x,m.y,m.z),b&&h.applyMatrix4(b),p.vertices.push(h),h=a.vertices[l.c],e&&(m=l.vertexNormals[2]),h=new f(h.x,
h.y,h.z,m.x,m.y,m.z),b&&h.applyMatrix4(b),p.vertices.push(h),p.calculateProperties(),d.push(p);this.tree=new n(d,c);void 0!==c&&(this.maxid=this.tree.maxnodeid)}f.prototype.setnormal=function(a,b,c){this.nx=a;this.ny=b;this.nz=c};f.prototype.clone=function(){return new f(this.x,this.y,this.z,this.nx,this.ny,this.nz)};f.prototype.add=function(a){this.x+=a.x;this.y+=a.y;this.z+=a.z;return this};f.prototype.subtract=function(a){this.x-=a.x;this.y-=a.y;this.z-=a.z;return this};f.prototype.multiplyScalar=
function(a){this.x*=a;this.y*=a;this.z*=a;return this};f.prototype.cross=function(a){var b=this.x,c=this.y,d=this.z;this.x=c*a.z-d*a.y;this.y=d*a.x-b*a.z;this.z=b*a.y-c*a.x;return this};f.prototype.normalize=function(){var a=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);this.x/=a;this.y/=a;this.z/=a;return this};f.prototype.dot=function(a){return this.x*a.x+this.y*a.y+this.z*a.z};f.prototype.diff=function(a){var b=this.x-a.x,c=this.y-a.y;a=this.z-a.z;var d=this.x*this.x+this.y*this.y+this.z*
this.z;return(b*b+c*c+a*a)/(0<d?d:1E-10)};f.prototype.interpolate=function(a,b){var c=1-b;return new f(this.x*c+a.x*b,this.y*c+a.y*b,this.z*c+a.z*b,this.nx*c+a.nx*b,this.ny*c+a.ny*b,this.nz*c+a.nz*b)};f.prototype.applyMatrix4=function(a){var b=this.x,c=this.y,d=this.z;a=a.elements;this.x=a[0]*b+a[4]*c+a[8]*d+a[12];this.y=a[1]*b+a[5]*c+a[9]*d+a[13];this.z=a[2]*b+a[6]*c+a[10]*d+a[14];b=this.nx;c=this.ny;d=this.nz;this.nx=a[0]*b+a[4]*c+a[8]*d;this.ny=a[1]*b+a[5]*c+a[9]*d;this.nz=a[2]*b+a[6]*c+a[10]*
d;return this};r.prototype.copyProperties=function(a,b){this.normal=a.normal;this.w=a.w;this.nsign=a.nsign;b&&void 0!==a.id&&(this.id=a.id,this.parent=a);return this};r.prototype.calculateProperties=function(){if(!this.normal){var a=this.vertices[0],b=this.vertices[1],c=this.vertices[2];this.nsign=1;this.normal=b.clone().subtract(a).cross(c.clone().subtract(a)).normalize();this.w=this.normal.clone().dot(a);return this}};r.prototype.clone=function(){for(var a=this.vertices.length,b=new r,c=0;c<a;++c)b.vertices.push(this.vertices[c].clone());
return b.copyProperties(this)};r.prototype.flip=function(){this.nsign*=-1;this.vertices.reverse();return this};r.prototype.classifyVertex=function(a){a=this.nsign*(this.normal.dot(a)-this.w);return-1E-5>a?2:1E-5<a?1:0};r.prototype.classifySide=function(a){var b,c=0,d=0,g=a.vertices.length;for(b=0;b<g;++b){var l=this.classifyVertex(a.vertices[b]);1===l?++c:2===l&&++d}return 0<c&&0===d?1:0===c&&0<d?2:0===c&&0===d?0:3};r.prototype.splitPolygon=function(a,b,c,d,g){var l=this.classifySide(a);if(0===l)(0<
this.nsign*a.nsign*this.normal.dot(a.normal)?b:c).push(a);else if(1===l)d.push(a);else if(2===l)g.push(a);else{b=a.vertices.length;c=this.normal.x;l=this.normal.y;var p=this.normal.z,h,m=[],e=[];for(h=0;h<b;++h){var k=(h+1)%b;var f=a.vertices[h];k=a.vertices[k];var n=this.classifyVertex(f);var q=this.classifyVertex(k);2!=n&&m.push(f);1!=n&&e.push(f);3===(n|q)&&(n=(this.w-(c*f.x+l*f.y+p*f.z))/(c*(k.x-f.x)+l*(k.y-f.y)+p*(k.z-f.z)),f=f.interpolate(k,n),m.push(f),e.push(f))}3<=m.length&&d.push((new r(m)).copyProperties(a,
!0));3<=e.length&&g.push((new r(e)).copyProperties(a,!0))}};n.isConvex=function(a){var b,c,d=a.length;for(b=0;b<d;++b)for(c=0;c<d;++c)if(b!==c&&2!==a[b].classifySide(a[c]))return!1;return!0};n.prototype.build=function(a){var b=a.length,c=[],d=[];this.divider||(this.divider=a[0].clone());for(var g=0;g<b;++g)this.divider.splitPolygon(a[g],this.polygons,this.polygons,c,d);0<c.length&&(this.front||(this.front=new n),this.front.build(c));0<d.length&&(this.back||(this.back=new n),this.back.build(d))};n.prototype.collectPolygons=
function(a){for(var b=this.polygons.length,c=0;c<b;++c)a.push(this.polygons[c]);this.front&&this.front.collectPolygons(a);this.back&&this.back.collectPolygons(a);return a};n.prototype.allPolygons=function(){var a=this.polygons.slice();this.front&&(a=a.concat(this.front.allPolygons()));this.back&&(a=a.concat(this.back.allPolygons()));return a};n.prototype.numPolygons=function(){var a=this.polygons.length;this.front&&(a+=this.front.numPolygons());this.back&&(a+=this.back.numPolygons());return a};n.prototype.clone=
function(){var a=new n;a.divider=this.divider.clone();a.polygons=this.polygons.map(function(a){return a.clone()});a.front=this.front&&this.front.clone();a.back=this.back&&this.back.clone();return a};n.prototype.invert=function(){for(var a=this.polygons.length,b=0;b<a;++b)this.polygons[b].flip();this.divider.flip();this.front&&this.front.invert();this.back&&this.back.invert();a=this.front;this.front=this.back;this.back=a;return this};n.prototype.clipPolygons=function(a){if(!this.divider)return a.slice();
for(var b=a.length,c=[],d=[],g=0;g<b;++g)this.divider.splitPolygon(a[g],c,d,c,d);this.front&&(c=this.front.clipPolygons(c));d=this.back?this.back.clipPolygons(d):[];return c.concat(d)};n.prototype.clipTo=function(a){this.polygons=a.clipPolygons(this.polygons);this.front&&this.front.clipTo(a);this.back&&this.back.clipTo(a)};var v=function(a){function b(a){l[h]=a.x;l[h+1]=a.y;l[h+2]=a.z;f[h]=m.nsign*a.nx;f[h+1]=m.nsign*a.ny;f[h+2]=m.nsign*a.nz;h+=3}var c,d,g=a.length;for(c=d=0;c<g;++c)d+=9*(a[c].vertices.length-
2);var l=new Float32Array(d),f=new Float32Array(d),h=0;for(c=0;c<g;++c){var m=a[c];for(d=2;d<m.vertices.length;++d)b(m.vertices[0]),b(m.vertices[d-1]),b(m.vertices[d])}a=new t.BufferGeometry;a.setAttribute("position",new t.BufferAttribute(l,3));a.setAttribute("normal",new t.BufferAttribute(f,3));return a};q.prototype.subtract=function(a){var b=this.tree.clone();a=a.tree.clone();b.invert();b.clipTo(a);a.clipTo(b);a.invert();a.clipTo(b);a.invert();b.build(a.allPolygons());b.invert();b=new q(b);b.matrix=
this.matrix;return b};q.prototype.union=function(a){var b=this.tree.clone();a=a.tree.clone();b.clipTo(a);a.clipTo(b);a.invert();a.clipTo(b);a.invert();b.build(a.allPolygons());b=new q(b);b.matrix=this.matrix;return b};q.prototype.intersect=function(a){var b=this.tree.clone();a=a.tree.clone();b.invert();a.clipTo(b);a.invert();b.clipTo(a);a.clipTo(b);b.build(a.allPolygons());b.invert();b=new q(b);b.matrix=this.matrix;return b};q.prototype.tryToCompress=function(a){if(void 0!==this.maxid){var b=[],c,
d=0,g,l=a.length,f,h,m,e;for(g=0;g<l;++g){var k=a[g];void 0!==k.id&&(void 0===b[k.id]&&(b[k.id]=[]),b[k.id].push(k))}for(g=0;g<b.length;++g)if(k=b[g],void 0!==k)for(l=k.length,c=1<l;c;)for(c=!1,m=0;m<l-1;++m)if((f=k[m])&&f.parent)for(e=m+1;e<l;++e)if((h=k[e])&&f.parent===h.parent&&f.nsign===h.nsign){f.nsign!==f.parent.nsign&&f.parent.flip();d++;k[m]=f.parent;k[e]=null;3>f.parent.vertices.length&&console.log("something wrong with parent");c=!0;break}if(0<d)for(a.splice(0,a.length),g=0;g<b.length;++g)if(k=
b[g],void 0!==k)for(m=0,l=k.length;m<l;++m)k[m]&&a.push(k[m])}};q.prototype.direct_subtract=function(a){var b=this.tree;a=a.tree;b.invert();b.clipTo(a);a.clipTo(b);a.invert();a.clipTo(b);a.invert();b.build(a.collectPolygons([]));b.invert();return this};q.prototype.direct_union=function(a){var b=this.tree;a=a.tree;b.clipTo(a);a.clipTo(b);a.invert();a.clipTo(b);a.invert();b.build(a.collectPolygons([]));return this};q.prototype.direct_intersect=function(a){var b=this.tree;a=a.tree;b.invert();a.clipTo(b);
a.invert();b.clipTo(a);a.clipTo(b);b.build(a.collectPolygons([]));b.invert();return this};q.prototype.cut_from_plane=function(a){var b=this.tree;a=a.tree;b.invert();a.clipTo(b);return this};q.prototype.toGeometry=function(){var a,b,c=this.matrix?(new t.Matrix4).getInverse(this.matrix):null,d=new t.Geometry,g=this.tree.collectPolygons([]),f=g.length,p={};for(a=0;a<f;++a){var h=g[a];var m=h.vertices.length;for(b=2;b<m;++b){var e=h.vertices[0];e=new t.Vector3(e.x,e.y,e.z);c&&e.applyMatrix4(c);if("undefined"!==
typeof p[e.x+","+e.y+","+e.z])var k=p[e.x+","+e.y+","+e.z];else d.vertices.push(e),k=p[e.x+","+e.y+","+e.z]=d.vertices.length-1;e=h.vertices[b-1];e=new t.Vector3(e.x,e.y,e.z);c&&e.applyMatrix4(c);if("undefined"!==typeof p[e.x+","+e.y+","+e.z])var n=p[e.x+","+e.y+","+e.z];else d.vertices.push(e),n=p[e.x+","+e.y+","+e.z]=d.vertices.length-1;e=h.vertices[b];e=new t.Vector3(e.x,e.y,e.z);c&&e.applyMatrix4(c);"undefined"!==typeof p[e.x+","+e.y+","+e.z]?e=p[e.x+","+e.y+","+e.z]:(d.vertices.push(e),e=p[e.x+
","+e.y+","+e.z]=d.vertices.length-1);k=new t.Face3(k,n,e,new t.Vector3(h.normal.x,h.normal.y,h.normal.z));d.faces.push(k)}}return d};q.prototype.scale=function(a,b,c){for(var d=this.tree.collectPolygons([]),g=0;g<d.length;++g){for(var f=d[g],n=0;n<f.vertices.length;++n){var h=f.vertices[n];h.x*=a;h.y*=b;h.z*=c}delete f.normal;f.calculateProperties()}};q.prototype.toPolygons=function(){var a=this.tree.collectPolygons([]);this.tryToCompress(a);for(var b=0;b<a.length;++b)delete a[b].id,delete a[b].parent;
return a};q.prototype.toBufferGeometry=function(){return v(this.toPolygons())};q.prototype.toMesh=function(a){var b=this.toGeometry();a=new t.Mesh(b,a);this.matrix&&(a.position.setFromMatrixPosition(this.matrix),a.rotation.setFromRotationMatrix(this.matrix));return a};var u={CreateNormal:function(a,b,c){if(!c||1E4>c)c=1E4;switch(a){case "x":var d=new f(b,-3*c,c,1,0,0);var g=new f(b,c,c,1,0,0);var l=new f(b,c,-3*c,1,0,0);break;case "y":d=new f(-3*c,b,c,0,1,0);l=new f(c,b,c,0,1,0);g=new f(c,b,-3*c,
0,1,0);break;case "z":d=new f(-3*c,c,b,0,0,1),g=new f(c,c,b,0,0,1),l=new f(c,-3*c,b,0,0,1)}a=new r([d,l,g]);a.calculateProperties();a=new n([a]);return new q(a)}};u.Vertex=f;u.Geometry=q;u.Polygon=r;u.CreateBufferGeometry=v;JSROOT.nodejs&&(module.exports=u);return u});
